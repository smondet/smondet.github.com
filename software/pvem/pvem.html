 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Pvem: Literate Implementation</title></head><body><div class="container"><h1>Pvem: Literate Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='pvem.html'>Literate Implementation</a></li><li><a href='implementation.html'>Implementation Notes</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Repository <a href='https://bitbucket.org/smondet/pvem'>at Bitbucket</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="comment">(** Reusable Error Monads *)</span><span class="text">
</span><span class="comment">(**

This whole module is about using {[
type ('a, 'b) t = [
  | `Ok of 'a
  | `Error of 'b
]
]}

*)</span><span class="text">

</span><span class="comment">(** The basic error monad signature. *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">ERROR_MONAD</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">return</span><span class="text">: '</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">bind</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> (&gt;&gt;=): ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">fail</span><span class="text">: '</span><span class="id">b</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">map</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; '</span><span class="id">c</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> (&gt;&gt;|): ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; '</span><span class="id">c</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">destruct</span><span class="text">:
    ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> -&gt; ([&gt; `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">a</span><span class="text"> | `</span><span class="kw2">Error</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">b</span><span class="text">] -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> (&gt;&gt;&lt;):
    ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> -&gt; ([&gt; `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">a</span><span class="text"> | `</span><span class="kw2">Error</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">b</span><span class="text">] -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(** The signature of the [Result] module: [ERROR_MONAD] + exposed result type. *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">RESULT</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">ERROR_MONAD</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> = [
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">a</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">b</span><span class="text">
  ]
</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(** Implementation of [RESULT] *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Result</span><span class="text"> : </span><span class="kw2">RESULT</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> = [
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">a</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">b</span><span class="text">
  ]

  </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="id">a</span><span class="text">  = `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">a</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail</span><span class="text"> </span><span class="id">b</span><span class="text"> = `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">b</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">

  </span><span class="kw">let</span><span class="text"> (&gt;&gt;=) = </span><span class="id">bind</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">)
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">

  </span><span class="kw">let</span><span class="text"> (&gt;&gt;|) = </span><span class="id">map</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">destruct</span><span class="text"> (</span><span class="kw1">#</span><span class="id">t</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="id">f</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (&gt;&gt;&lt;) = </span><span class="id">destruct</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(** The signature of a basic “thread” module called [Deferred] (like [Lwt]). *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">DEFERRED</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">

  </span><span class="kw">type</span><span class="text"> '</span><span class="id">a</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">bind</span><span class="text">: '</span><span class="id">a</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; '</span><span class="id">b</span><span class="text"> </span><span class="id">t</span><span class="text">) -&gt; '</span><span class="id">b</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">return</span><span class="text">: '</span><span class="id">a</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">catch</span><span class="text">: (</span><span class="kw3">unit</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text"> </span><span class="id">t</span><span class="text">) -&gt; (</span><span class="id">exn</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text"> </span><span class="id">t</span><span class="text">) -&gt; '</span><span class="id">a</span><span class="text"> </span><span class="id">t</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(** The result of the functor application: [With_deferred(Deferred)]. *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">DEFERRED_RESULT</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">


  </span><span class="kw">type</span><span class="text"> '</span><span class="id">a</span><span class="text"> </span><span class="id">deferred</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">ERROR_MONAD</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> = ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="kw2">Result</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="id">deferred</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_result</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="kw2">Result</span><span class="text">.</span><span class="id">t</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">catch_deferred</span><span class="text"> : (</span><span class="kw3">unit</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text"> </span><span class="id">deferred</span><span class="text">) -&gt; ('</span><span class="id">a</span><span class="text">, </span><span class="id">exn</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">wrap_deferred</span><span class="text"> : </span><span class="id">on_exn</span><span class="text">:(</span><span class="id">exn</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text">) -&gt; (</span><span class="kw3">unit</span><span class="text"> -&gt; '</span><span class="id">b</span><span class="text"> </span><span class="id">deferred</span><span class="text">) -&gt; ('</span><span class="id">b</span><span class="text">, '</span><span class="id">a</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">map_option</span><span class="text">: '</span><span class="id">a</span><span class="text"> </span><span class="id">option</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">r</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt;
    ('</span><span class="id">r</span><span class="text"> </span><span class="id">option</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">some</span><span class="text">: </span><span class="id">or_fail</span><span class="text">:'</span><span class="id">error</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text"> </span><span class="id">option</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_deferred</span><span class="text"> (</span><span class="kw2">Deferred</span><span class="text">: </span><span class="kw2">DEFERRED</span><span class="text">) :
  </span><span class="kw2">DEFERRED_RESULT</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> '</span><span class="id">a</span><span class="text"> </span><span class="id">deferred</span><span class="text"> = '</span><span class="id">a</span><span class="text"> </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">t</span><span class="text">
= </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> '</span><span class="id">a</span><span class="text"> </span><span class="id">deferred</span><span class="text"> = '</span><span class="id">a</span><span class="text"> </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">t</span><span class="text">
  </span><span class="comment">(* type ('a, 'b) result = ('a, 'b) Result.t *)</span><span class="text">
  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> = ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="kw2">Result</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">t</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="id">x</span><span class="text"> : (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">t</span><span class="text"> = </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">x</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> (</span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text">)
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">o</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">return</span><span class="text"> (</span><span class="kw2">Result</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="id">x</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> (&gt;&gt;=) = </span><span class="id">bind</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (&gt;&gt;&lt;) </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> : (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">t</span><span class="text"> = </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="id">m</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt;
    </span><span class="id">return</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> (&gt;&gt;|) = </span><span class="id">map</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_result</span><span class="text"> = </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">return</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">catch_deferred</span><span class="text"> </span><span class="id">f</span><span class="text"> : (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">t</span><span class="text"> =
    </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">catch</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> () -&gt;
         </span><span class="kw">let</span><span class="text"> </span><span class="id">a_exn_m</span><span class="text"> : '</span><span class="id">a</span><span class="text"> </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">t</span><span class="text"> = </span><span class="id">f</span><span class="text"> () </span><span class="kw">in</span><span class="text">
         </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">bind</span><span class="text"> </span><span class="id">a_exn_m</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">x</span><span class="text">)))
      (</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">wrap_deferred</span><span class="text"> </span><span class="kw4">~on_exn</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">caught</span><span class="text"> = </span><span class="id">catch_deferred</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">caught</span><span class="text"> &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (</span><span class="id">on_exn</span><span class="text"> </span><span class="id">e</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map_option</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
      </span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">
      &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (</span><span class="kw2">Some</span><span class="text"> </span><span class="id">o</span><span class="text">)
      | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">some</span><span class="text"> </span><span class="kw4">~or_fail</span><span class="text"> = </span><span class="kw">function</span><span class="text">
  | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">or_fail</span><span class="text">
  | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">s</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">destruct</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw2">Deferred</span><span class="text">.</span><span class="id">bind</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="kw">function</span><span class="text"> `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text">) | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text">))
  </span><span class="kw">let</span><span class="text"> (&gt;&gt;&lt;) = </span><span class="id">destruct</span><span class="text">

</span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>