 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Oredoc: Literate Implementation</title></head><body><div class="container"><h1>Oredoc: Literate Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul><li><a href='#YetAnotherMonad'>Yet Another Monad</a>
</li><li><a href='#IdentifyFilesByExtension'>Identify Files By Extension</a>
</li><li><a href='#MarkdownToHTML'>Markdown To HTML</a>
</li><li><a href='#ConvertingOCamltoHTML'>Converting OCaml to HTML</a>
</li><li><a href='#HTMLTemplate'>HTML Template</a>
</li><li><a href='#SomeUtilities'>Some Utilities</a>
</li><li><a href='#Configuration'>Configuration</a>
</li><li><a href='#MainEntryPoint'>Main Entry Point</a>
</li></ul><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='oredoc.html'>Literate Implementation</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Repository <a href='https://github.com/smondet/oredoc'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9">


<h1 id="ImplementationofOredoc">Implementation of Oredoc</h1>

<p>Usual “OCaml-configuration” header:</p>

<pre><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Legacy_string</span><span class="text"> = </span><span class="kw2">String</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">Sosa</span><span class="text">.</span><span class="kw2">Native_string</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">dbg</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="id">eprintf</span><span class="text"> </span><span class="string">"# %s\n"</span><span class="text">)) </span><span class="id">fmt</span><span class="text">


</span></pre>


<h2 id="YetAnotherMonad">Yet Another Monad</h2>

<p>The module <code>Meta_result</code> provides a funny monad that allows one to keep track
of things to do “later” during a computation.</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Meta_result</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> = {
    </span><span class="id">result</span><span class="text">: '</span><span class="id">a</span><span class="text">;
    </span><span class="id">more_things_todo</span><span class="text">: '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">;
  }

  </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> ?(</span><span class="id">more_things_todo</span><span class="text">=[]) </span><span class="id">result</span><span class="text"> = {</span><span class="id">result</span><span class="text">; </span><span class="id">more_things_todo</span><span class="text">}
  </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">next</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">m</span><span class="text">.</span><span class="id">result</span><span class="text"> </span><span class="kw">in</span><span class="text">
    { </span><span class="id">next</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="id">more_things_todo</span><span class="text"> = </span><span class="id">next</span><span class="text">.</span><span class="id">more_things_todo</span><span class="text"> @ </span><span class="id">m</span><span class="text">.</span><span class="id">more_things_todo</span><span class="text">}
  </span><span class="kw">let</span><span class="text"> (</span><span class="kw10">&gt;&gt;=</span><span class="text">) </span><span class="id">m</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="id">bind</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw4">~f</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span></pre>


<h2 id="IdentifyFilesByExtension">Identify Files By Extension</h2>

<p>This is used for both 1) deciding which treatment to apply to files and 2)
transforming relative links between them (in Markdown).</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">check_suffix</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="id">ext</span><span class="text">
    </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">chop_suffix</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="id">ext</span><span class="text">)
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">identify_file</span><span class="text"> </span><span class="id">filename</span><span class="text"> =
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text">:</span><span class="string">".md"</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt; `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">sub</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text">:</span><span class="string">".ml"</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt; `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">sub</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text">:</span><span class="string">".mli"</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt; `</span><span class="kw2">Ocaml_interface</span><span class="text"> </span><span class="id">sub</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; `</span><span class="kw2">Other</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span></pre>
<h2 id="MarkdownToHTML">Markdown To HTML</h2>

<p>Our wrapper around <a href='https://github.com/ocaml/omd'>Omd</a>, which adds a few
features/extensions:</p>
<ul><li>There is a special syntax to <span style="color: red; background-color: yellow; font-weight: bold">overhighlight</span> stuff.</li><li>Local links are transformed to be consistent between a repository view
(Github, Bitbucket) and the generated website.</li><li><a href='some_command___help.html' title='some-command --help'><code>some-command --help</code></a> will be transformed into a link too.</li></ul>
<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Markdown</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> '</span><span class="id">a</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = '</span><span class="id">a</span><span class="text"> </span><span class="kw">constraint</span><span class="text"> '</span><span class="id">a</span><span class="text"> = &lt;
    </span><span class="id">catch_module_paths</span><span class="text">: (</span><span class="kw3">string</span><span class="text"> * </span><span class="kw2">Re</span><span class="text">.</span><span class="id">re</span><span class="text"> * </span><span class="kw3">string</span><span class="text">) </span><span class="kw3">list</span><span class="text">;
    ..
  &gt;

  </span><span class="kw">let</span><span class="text"> </span><span class="id">code_url</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw2">String</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
      | </span><span class="string">'a'</span><span class="text"> .. </span><span class="string">'z'</span><span class="text"> | </span><span class="string">'A'</span><span class="text"> .. </span><span class="string">'Z'</span><span class="text"> | </span><span class="string">'0'</span><span class="text"> .. </span><span class="string">'9'</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">
      | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="string">'_'</span><span class="text">)
    ^ </span><span class="string">".html"</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">looks_like_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">catch_module_paths</span><span class="text">
      </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">re</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt; </span><span class="kw2">Re</span><span class="text">.</span><span class="id">execp</span><span class="text"> </span><span class="id">re</span><span class="text"> </span><span class="id">code</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">url_of_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_value</span><span class="text"> </span><span class="id">v</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">v</span><span class="text">.[</span><span class="numeric">0</span><span class="text">] </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">Char</span><span class="text">.</span><span class="id">lowercase</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="id">c</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> =
      </span><span class="kw">function</span><span class="text">
      | [] -&gt; </span><span class="string">""</span><span class="text">
      | [</span><span class="string">"t"</span><span class="text">]  -&gt; </span><span class="id">acc</span><span class="text"> ^ </span><span class="string">"html#TYPEt"</span><span class="text">
      | [</span><span class="id">one</span><span class="text">] </span><span class="kw1">when</span><span class="text"> </span><span class="id">is_value</span><span class="text"> </span><span class="id">one</span><span class="text"> -&gt; </span><span class="id">acc</span><span class="text"> ^ </span><span class="string">"html#VAL"</span><span class="text"> ^ </span><span class="id">one</span><span class="text">
      | [</span><span class="id">one</span><span class="text">] -&gt; </span><span class="id">acc</span><span class="text"> ^ </span><span class="id">one</span><span class="text"> ^ </span><span class="string">".html"</span><span class="text">
      | </span><span class="id">modul</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">acc</span><span class="text"> ^ </span><span class="id">modul</span><span class="text"> ^ </span><span class="string">"."</span><span class="text">) </span><span class="id">more</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">prefix</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">catch_module_paths</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">re</span><span class="text">, </span><span class="id">pr</span><span class="text">) -&gt;
          </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Re</span><span class="text">.</span><span class="id">execp</span><span class="text"> </span><span class="id">re</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">pr</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">)
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">""</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> (</span><span class="string">"api/"</span><span class="text"> ^ </span><span class="id">prefix</span><span class="text">) (</span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">'.'</span><span class="text">))


  </span><span class="kw">let</span><span class="text"> </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">highligh</span><span class="text"> : </span><span class="kw2">Omd_representation</span><span class="text">.</span><span class="id">extension</span><span class="text"> =
      </span><span class="kw1">object</span><span class="text">
        </span><span class="kw">method</span><span class="text"> </span><span class="id">parser_extension</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">read_tokens</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Omd_representation</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">highlight_style</span><span class="text"> =
            </span><span class="string">"color: red; background-color: yellow; font-weight: bold"</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="comment">(* dbg "highlight for: %s" (Omd_lexer.destring_of_tokens ~limit:5  read_tokens); *)</span><span class="text">
          </span><span class="kw">function</span><span class="text">
          | </span><span class="kw2">Exclamation</span><span class="text"> :: </span><span class="kw2">Word</span><span class="text"> </span><span class="id">w</span><span class="text"> :: </span><span class="kw2">Exclamation</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="id">in_red</span><span class="text"> = </span><span class="id">sprintf</span><span class="text">  </span><span class="string">"&lt;span style=%S&gt;%s&lt;/span&gt;"</span><span class="text"> </span><span class="id">highlight_style</span><span class="text"> </span><span class="id">w</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Raw</span><span class="text"> </span><span class="id">in_red</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="id">read_tokens</span><span class="text">, </span><span class="id">more</span><span class="text">)
          | </span><span class="id">m</span><span class="text"> -&gt;
            </span><span class="comment">(* dbg "none for: %s" (Omd_lexer.destring_of_tokens ~limit:4 m); *)</span><span class="text">
            </span><span class="kw2">None</span><span class="text">
        </span><span class="kw">method</span><span class="text"> </span><span class="id">to_string</span><span class="text"> = </span><span class="string">"highlight"</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">more_stuff_to_do</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">transform_links</span><span class="text"> (</span><span class="id">t</span><span class="text">: </span><span class="kw2">Omd</span><span class="text">.</span><span class="id">element</span><span class="text">) : </span><span class="kw2">Omd</span><span class="text">.</span><span class="id">element</span><span class="text">  =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Omd</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Paragraph</span><span class="text">  </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Paragraph</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Emph</span><span class="text">  </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Emph</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Bold</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Bold</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Ul</span><span class="text">  </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Ul</span><span class="text">  (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">Ol</span><span class="text">  </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Ol</span><span class="text">  (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">Ulp</span><span class="text"> </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Ulp</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">Olp</span><span class="text"> </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Olp</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">H1</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H1</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H2</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H2</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H3</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H3</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H4</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H4</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H5</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H5</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H6</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H6</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Blockquote</span><span class="text">  </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Blockquote</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Text</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Br</span><span class="text">
      | </span><span class="kw2">Hr</span><span class="text">
      | </span><span class="kw2">Img_ref</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Html</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Html_block</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Html_comment</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">NL</span><span class="text">
      | </span><span class="kw2">X</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Raw</span><span class="text"> </span><span class="numeric">_</span><span class="text"> | </span><span class="kw2">Raw_block</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Img</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">e</span><span class="text">
      | </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) </span><span class="kw1">when</span><span class="text">
          </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">code</span><span class="text"> - </span><span class="numeric">6</span><span class="text">) </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">6</span><span class="text">
          = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">"--help"</span><span class="text"> -&gt;
        </span><span class="comment">(* dbg "Code: %s %s" lang code; *)</span><span class="text">
        </span><span class="id">more_stuff_to_do</span><span class="text"> := `</span><span class="kw2">Create_man_page</span><span class="text"> </span><span class="id">code</span><span class="text"> :: !</span><span class="id">more_stuff_to_do</span><span class="text">;
        </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">code_url</span><span class="text"> </span><span class="id">code</span><span class="text">, [</span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">)], </span><span class="id">code</span><span class="text">)
      | </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">looks_like_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> -&gt;
        </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">url_of_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text">, [</span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">)], </span><span class="id">code</span><span class="text">)
      | </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) -&gt; </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">)
      | </span><span class="kw2">Code_block</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) </span><span class="kw1">as</span><span class="text"> </span><span class="id">code_block</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
          </span><span class="kw">let</span><span class="text"> (</span><span class="numeric">_</span><span class="text"> : </span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">lexer</span><span class="text">) = </span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">get_lexer</span><span class="text"> </span><span class="id">lang</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Raw</span><span class="text"> (
            </span><span class="string">"&lt;pre&gt;"</span><span class="text">
            ^ (</span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">to_xml</span><span class="text"> </span><span class="kw4">~lang</span><span class="text"> </span><span class="id">code</span><span class="text"> |&gt; </span><span class="kw2">Xtmpl_xml</span><span class="text">.</span><span class="id">to_string</span><span class="text">)
            ^ </span><span class="string">"&lt;/pre&gt;"</span><span class="text">)
        </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">code_block</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      | </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">7</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">"http://"</span><span class="text">
           || </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">8</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">"https://"</span><span class="text">
           || </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">6</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">"ftp://"</span><span class="text">
        -&gt; </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
      | </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">) -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text">.</span><span class="id">identify_file</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"./%s.html"</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text">),
               </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        | `</span><span class="kw2">Ocaml_interface</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">modname</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text"> |&gt; </span><span class="kw2">Legacy_string</span><span class="text">.</span><span class="id">capitalize</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"api/%s.html"</span><span class="text"> </span><span class="id">modname</span><span class="text">,
               </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        | `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s.html"</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text">),
               </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        | `</span><span class="kw2">Other</span><span class="text"> -&gt;
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        </span><span class="kw1">end</span><span class="text">
      | </span><span class="kw2">Ref</span><span class="text">  (</span><span class="id">ref_container</span><span class="text">, </span><span class="id">name</span><span class="text">, </span><span class="kw3">string</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">e</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">make_paragraphs</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">E</span><span class="text"> = </span><span class="kw2">Omd_parser</span><span class="text">.</span><span class="kw2">Default_env</span><span class="text">(</span><span class="kw1">struct</span><span class="text"> </span><span class="kw1">end</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Parser</span><span class="text"> = </span><span class="kw2">Omd_parser</span><span class="text">.</span><span class="kw2">Make</span><span class="text">(</span><span class="kw2">E</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Parser</span><span class="text">.</span><span class="id">make_paragraphs</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Meta_result</span><span class="text">.</span><span class="id">return</span><span class="text"> </span><span class="kw4">~more_things_todo</span><span class="text">:!</span><span class="id">more_stuff_to_do</span><span class="text"> (
      </span><span class="kw2">Omd_parser</span><span class="text">.</span><span class="id">default_parse</span><span class="text">
        </span><span class="kw4">~extensions</span><span class="text">:[</span><span class="id">highligh</span><span class="text">] (</span><span class="kw2">Omd_lexer</span><span class="text">.</span><span class="id">lex</span><span class="text"> </span><span class="id">content</span><span class="text">)
      |&gt; </span><span class="id">make_paragraphs</span><span class="text">
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_html</span><span class="text"> ~(</span><span class="id">configuration</span><span class="text">:</span><span class="numeric">_</span><span class="text"> </span><span class="id">configuration</span><span class="text">) </span><span class="id">content</span><span class="text"> =
    </span><span class="kw2">Meta_result</span><span class="text">.(
      </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text">
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="kw2">Omd</span><span class="text">.(</span><span class="id">to_html</span><span class="text"> </span><span class="id">p</span><span class="text">)
    )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw2">Meta_result</span><span class="text">.(
      </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text">
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="kw2">Omd</span><span class="text">.(</span><span class="id">to_html</span><span class="text"> (</span><span class="id">toc</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:[</span><span class="numeric">0</span><span class="text">] </span><span class="id">p</span><span class="text">))
    )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw2">Meta_result</span><span class="text">.(
      </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text">
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="kw2">Omd</span><span class="text">.(</span><span class="id">to_html</span><span class="text"> </span><span class="id">p</span><span class="text">, </span><span class="id">to_html</span><span class="text"> (</span><span class="id">toc</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]  </span><span class="id">p</span><span class="text">))
    )
    </span><span class="comment">(* Omd.(to_html p, to_html (toc  ~start:[1] p)) *)</span><span class="text">


</span><span class="kw1">end</span><span class="text">

</span></pre>


<h2 id="ConvertingOCamltoHTML">Converting OCaml to HTML</h2>

<p>OCaml code with special Markdown comments will be transformed into HTML.</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Ocaml</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Meta_result</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">remove_comments</span><span class="text"> </span><span class="id">s</span><span class="text"> =
      </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">6</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Higlo</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">parsed</span><span class="text"> = </span><span class="id">parse</span><span class="text"> </span><span class="kw4">~lang</span><span class="text">:</span><span class="string">"ocaml"</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">flush_tokens</span><span class="text"> </span><span class="id">revtoklist</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">revtoklist</span><span class="text">
          </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text"> </span><span class="kw2">Text</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">strip</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="string">""</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">)
      </span><span class="kw1">then</span><span class="text"> </span><span class="string">""</span><span class="text">
      </span><span class="kw1">else</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">html</span><span class="text"> =
          </span><span class="kw2">Xtmpl_xml</span><span class="text">.</span><span class="id">to_string</span><span class="text">
            (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">token_to_xml</span><span class="text"> </span><span class="id">revtoklist</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="string">"&lt;pre&gt;"</span><span class="text"> ^ </span><span class="id">html</span><span class="text"> ^ </span><span class="string">"&lt;/pre&gt;"</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc_tokens</span><span class="text"> </span><span class="id">acc_html</span><span class="text"> </span><span class="id">acc_toc</span><span class="text"> </span><span class="id">tokens</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">tokens</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt;
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">acc_toc</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"\n"</span><span class="text">
         |&gt; </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text">)
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">toc</span><span class="text"> -&gt;
        </span><span class="id">return</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">flush_tokens</span><span class="text"> </span><span class="id">acc_tokens</span><span class="text"> :: </span><span class="id">acc_html</span><span class="text">)
         |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"\n"</span><span class="text">, </span><span class="id">toc</span><span class="text">)
      | </span><span class="id">one</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">one</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Bcomment</span><span class="text"> </span><span class="id">com</span><span class="text">
        | </span><span class="kw2">Lcomment</span><span class="text"> </span><span class="id">com</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">com</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">"(*M"</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">html_code</span><span class="text"> = </span><span class="id">flush_tokens</span><span class="text"> </span><span class="id">acc_tokens</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">comment_content</span><span class="text"> = </span><span class="id">remove_comments</span><span class="text"> </span><span class="id">com</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">comment_content</span><span class="text">
          </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">html_comment</span><span class="text"> -&gt;
          </span><span class="id">loop</span><span class="text"> [] (</span><span class="id">html_comment</span><span class="text"> :: </span><span class="id">html_code</span><span class="text"> :: </span><span class="id">acc_html</span><span class="text">)
            (</span><span class="id">comment_content</span><span class="text"> :: </span><span class="id">acc_toc</span><span class="text">) </span><span class="id">more</span><span class="text">
        | </span><span class="id">tok</span><span class="text"> -&gt;
          </span><span class="id">loop</span><span class="text"> (</span><span class="id">tok</span><span class="text"> :: </span><span class="id">acc_tokens</span><span class="text">) </span><span class="id">acc_html</span><span class="text"> </span><span class="id">acc_toc</span><span class="text"> </span><span class="id">more</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> [] [] [] </span><span class="id">parsed</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span></pre>


<h2 id="HTMLTemplate">HTML Template</h2>
<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Template</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">link</span><span class="text"> </span><span class="id">css</span><span class="text"> =
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"&lt;link rel=\"stylesheet\" href=%S type=\"text/css\"&gt;"</span><span class="text"> </span><span class="id">css</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Meta_result</span><span class="text">.</span><span class="id">return</span><span class="text"> (
      </span><span class="string">" &lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt;"</span><span class="text">
      ^ </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"\n"</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">link</span><span class="text">)
      ^ </span><span class="string">"&lt;meta charset=\"utf-8\"&gt;"</span><span class="text">
      ^ </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"&lt;title&gt;%s&lt;/title&gt;"</span><span class="text"> </span><span class="id">title</span><span class="text">
      ^ </span><span class="string">"&lt;/head&gt;"</span><span class="text">
      ^ </span><span class="string">"&lt;body&gt;&lt;div class=\"container\"&gt;"</span><span class="text">
      ^ </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"&lt;h1&gt;%s&lt;/h1&gt;"</span><span class="text"> </span><span class="id">title</span><span class="text">
      ^ </span><span class="string">"&lt;div class=\"row\"&gt;\n\
         &lt;div class=\"col-md-3\"&gt;\n\
         &lt;h2&gt;Contents&lt;/h2&gt;"</span><span class="text">
      ^ </span><span class="id">toc</span><span class="text">
      ^ </span><span class="string">"&lt;h2&gt;Menu&lt;/h2&gt;"</span><span class="text">
      ^ </span><span class="id">menu</span><span class="text">
      ^ </span><span class="string">"&lt;/div&gt;&lt;div class=\"col-md-9\"&gt;"</span><span class="text">
      ^ </span><span class="id">content</span><span class="text">
      ^ </span><span class="string">"&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;html&gt;"</span><span class="text">)

</span><span class="kw1">end</span><span class="text">

</span></pre>


<h2 id="SomeUtilities">Some Utilities</h2>
<pre><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Utilities</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (//) = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">env</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">failwithf</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="id">fmt</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">succeed</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">command</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="numeric">0</span><span class="text"> -&gt; ()
    | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="id">failwithf</span><span class="text"> </span><span class="string">"Command %S did not succeed: %d"</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">other</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">succeedf</span><span class="text"> </span><span class="id">fmt</span><span class="text">= </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">succeed</span><span class="text"> </span><span class="id">fmt</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">all_files</span><span class="text"> </span><span class="id">dir</span><span class="text"> =
    </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">readdir</span><span class="text"> </span><span class="id">dir</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text">
    |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">d</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">p</span><span class="text"> = </span><span class="id">dir</span><span class="text"> // </span><span class="id">d</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">is_directory</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">p</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">read_file</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">open_in</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">buf</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> () =
      </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">add_channel</span><span class="text"> </span><span class="id">buf</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="numeric">1</span><span class="text">; </span><span class="id">loop</span><span class="text"> () </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; () </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> ();
    </span><span class="id">close_in</span><span class="text"> </span><span class="id">i</span><span class="text">;
    </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">buf</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">write_file</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw4">~content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">o</span><span class="text"> = </span><span class="id">open_out</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">output_string</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">content</span><span class="text">;
    </span><span class="id">close_out</span><span class="text"> </span><span class="id">o</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">parse_list_of_substitutions</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">subs</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">','</span><span class="text">) </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">subs</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">':'</span><span class="text">) (</span><span class="kw2">String</span><span class="text">.</span><span class="id">strip</span><span class="text"> </span><span class="id">sub</span><span class="text">) </span><span class="kw1">with</span><span class="text">
        | [</span><span class="id">one</span><span class="text">; </span><span class="id">two</span><span class="text">] -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">one</span><span class="text">, </span><span class="id">two</span><span class="text">)
        | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
      )

</span><span class="kw1">end</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Utilities</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="id">printf</span><span class="text"> </span><span class="string">"%s\n"</span><span class="text">)) </span><span class="id">fmt</span><span class="text">


</span></pre>


<h2 id="Configuration">Configuration</h2>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">default_stylesheets</span><span class="text"> = [
  </span><span class="string">"https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css"</span><span class="text">;
  </span><span class="string">"http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css"</span><span class="text">;
  </span><span class="string">"http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css"</span><span class="text">;
  </span><span class="comment">(* &lt;link rel="stylesheet" href="code_style.css" type="text/css"&gt; *)</span><span class="text">
]

</span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> =
  </span><span class="kw1">object</span><span class="text"> (</span><span class="id">self</span><span class="text">)
    </span><span class="kw">method</span><span class="text"> </span><span class="id">output_directory</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"OUTPUT_DIR"</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">"_doc"</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">input_files</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"INPUT"</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">""</span><span class="text">
      |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">','</span><span class="text">)
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">path</span><span class="text"> -&gt;
          </span><span class="kw1">try</span><span class="text">
            </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">is_directory</span><span class="text"> </span><span class="id">path</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> </span><span class="id">all_files</span><span class="text"> </span><span class="id">path</span><span class="text">
            </span><span class="kw1">else</span><span class="text"> [</span><span class="id">path</span><span class="text">]
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; [])
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">index_file</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"INDEX"</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">"README.md"</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">stylesheets</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"CSS"</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">','</span><span class="text">))
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="id">default_stylesheets</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">api_doc_directory</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"API"</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">title_prefix</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"TITLE_PREFIX"</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">""</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">title_substitutions</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"TITLE_SUBSTITUTIONS"</span><span class="text">
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">parse_list_of_substitutions</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">title</span><span class="text"> ?(</span><span class="id">with_prefix</span><span class="text">=</span><span class="constant">true</span><span class="text">) </span><span class="id">t</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">tt</span><span class="text"> =
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">title_substitutions</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
          | (</span><span class="id">a</span><span class="text">, </span><span class="id">b</span><span class="text">) </span><span class="kw1">when</span><span class="text">
              </span><span class="id">a</span><span class="text"> = </span><span class="id">t</span><span class="text"> || (</span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">chop_extension</span><span class="text"> </span><span class="id">a</span><span class="text"> = </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">) -&gt;
            </span><span class="kw2">Some</span><span class="text"> </span><span class="id">b</span><span class="text">
          | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)
        |&gt; </span><span class="kw">function</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">b</span><span class="text"> -&gt; </span><span class="id">b</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt;
          </span><span class="kw2">String</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text"> </span><span class="string">'_'</span><span class="text"> -&gt; </span><span class="string">' '</span><span class="text"> | </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s%s"</span><span class="text"> (</span><span class="kw1">if</span><span class="text"> </span><span class="id">with_prefix</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">title_prefix</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="string">""</span><span class="text">) </span><span class="id">tt</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">command_substitutions</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"COMMAND_SUBSTITUTIONS"</span><span class="text">
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">parse_list_of_substitutions</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">catch_module_paths</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"CATCH_MODULE_PATHS"</span><span class="text">
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">parse_list_of_substitutions</span><span class="text">
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">pattern</span><span class="text">, </span><span class="id">prefix</span><span class="text">) -&gt;
          </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">pattern</span><span class="text">, </span><span class="kw2">Re_posix</span><span class="text">.</span><span class="id">compile_pat</span><span class="text"> </span><span class="id">pattern</span><span class="text">, </span><span class="id">prefix</span><span class="text">)
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)
    </span><span class="kw">method</span><span class="text"> </span><span class="id">add_to_menu</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">"ADD_TO_MENU"</span><span class="text">
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">""</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">display</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">list_of_paths</span><span class="text"> </span><span class="id">l</span><span class="text"> =
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"  - %S"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"\n"</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">variable_note</span><span class="text"> </span><span class="id">var</span><span class="text"> =
        </span><span class="id">say</span><span class="text"> </span><span class="string">"  (%S is %s)"</span><span class="text"> </span><span class="id">var</span><span class="text">
          (</span><span class="kw1">match</span><span class="text"> </span><span class="id">env</span><span class="text"> </span><span class="id">var</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="string">"empty"</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%S"</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Output directory: %s"</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"OUTPUT_DIR"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Input files:\n%s"</span><span class="text">
        (</span><span class="id">list_of_paths</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">input_files</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"INPUT"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Style sheets:\n%s"</span><span class="text"> (</span><span class="id">list_of_paths</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"CSS"</span><span class="text">;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">api_doc_directory</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">"Getting API docs from: %S"</span><span class="text"> </span><span class="id">s</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">"No getting API docs (*Warning*)"</span><span class="text">
      </span><span class="kw1">end</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"API"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Title prefix: %S"</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">title_prefix</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"TITLE_PREFIX"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Command substitutions:"</span><span class="text">;
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">command_substitutions</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">b</span><span class="text">) -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">"  - %s → %s"</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"COMMAND_SUBSTITUTIONS"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Index file: %s"</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">index_file</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"INDEX"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Catch module paths:"</span><span class="text">;
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">catch_module_paths</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">a</span><span class="text">,</span><span class="numeric">_</span><span class="text">, </span><span class="id">b</span><span class="text">) -&gt;
          </span><span class="id">say</span><span class="text"> </span><span class="string">"  - %S → Prefix: %s"</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"CATCH_MODULE_PATHS"</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">"Add to the menu: %S"</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">add_to_menu</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">"ADD_TO_MENU"</span><span class="text">;
      ()
  </span><span class="kw1">end</span><span class="text">

</span></pre>


<h2 id="MainEntryPoint">Main Entry Point</h2>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">main</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Meta_result</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">succeedf</span><span class="text"> </span><span class="string">"mkdir -p %s"</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">api_doc_directory</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">succeedf</span><span class="text"> </span><span class="string">"rsync -a %s/ %s/api"</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">
  | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">"Warning, no API docs"</span><span class="text">
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">menu_md</span><span class="text"> =
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"- [Home](index.html)\n"</span><span class="text">
    :: (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">input_files</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">path</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text">.</span><span class="id">identify_file</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">m</span><span class="text">
        | `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">base</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="kw4">~with_prefix</span><span class="text">:</span><span class="constant">false</span><span class="text"> </span><span class="id">base</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"- [%s](%s.html)\n"</span><span class="text"> </span><span class="id">title</span><span class="text"> </span><span class="id">base</span><span class="text">
        | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="string">""</span><span class="text">))
    @ [
      (</span><span class="kw1">match</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">api_doc_directory</span><span class="text"> </span><span class="kw1">with</span><span class="text">
       | </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"- [API Documentation](./api/index.html)\n"</span><span class="text">
       | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="string">""</span><span class="text">);
      </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">add_to_menu</span><span class="text">; ]
    |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">""</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">first_pass_result</span><span class="text"> : (</span><span class="kw3">unit</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">t</span><span class="text"> =
    </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">menu_md</span><span class="text">
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">menu</span><span class="text"> -&gt;
    </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">index_file</span><span class="text">)
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="string">"Home"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="id">content</span><span class="text">
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">markdown_index</span><span class="text"> -&gt;
    </span><span class="id">write_file</span><span class="text"> (</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="string">"index.html"</span><span class="text">) </span><span class="kw4">~content</span><span class="text">:</span><span class="id">markdown_index</span><span class="text">;
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> ()) </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">input_files</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">path</span><span class="text"> -&gt;
      </span><span class="id">prev</span><span class="text"> </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text">.</span><span class="id">identify_file</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">base</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="id">base</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">path</span><span class="text">)
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
        </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="id">content</span><span class="text">
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="id">write_file</span><span class="text"> (</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s.html"</span><span class="text"> </span><span class="id">base</span><span class="text">) </span><span class="kw4">~content</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">impl</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">base</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">impl</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="id">base</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Ocaml</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">path</span><span class="text">)
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
        </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~menu</span><span class="text">  </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="id">content</span><span class="text">
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="id">write_file</span><span class="text"> (</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s.html"</span><span class="text"> </span><span class="id">base</span><span class="text">) </span><span class="kw4">~content</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
      | </span><span class="id">m</span><span class="text"> -&gt;
        </span><span class="id">succeedf</span><span class="text"> </span><span class="string">"cp %s %s/"</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">path</span><span class="text">) </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">List</span><span class="text">.</span><span class="id">dedup</span><span class="text"> </span><span class="id">first_pass_result</span><span class="text">.</span><span class="id">more_things_todo</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Create_man_page</span><span class="text"> </span><span class="id">cmd</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">actual_cmd</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">stripped</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">strip</span><span class="text"> </span><span class="id">cmd</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">command_substitutions</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">left</span><span class="text">, </span><span class="id">right</span><span class="text">) -&gt;
          </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">String</span><span class="text">.(</span><span class="id">sub</span><span class="text"> </span><span class="id">stripped</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">left</span><span class="text">)) </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">prefix</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">prefix</span><span class="text"> = </span><span class="id">left</span><span class="text"> -&gt;
            </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">right</span><span class="text">
                  ^ </span><span class="kw2">String</span><span class="text">.(</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">stripped</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">left</span><span class="text">)
                              </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">stripped</span><span class="text"> - </span><span class="id">length</span><span class="text"> </span><span class="id">left</span><span class="text">)))
          | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="id">stripped</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">output_file</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">code_url</span><span class="text"> </span><span class="id">cmd</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">bash_cmd</span><span class="text"> =
        </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"set -o pipefail ; %s=groff | groff -Thtml -mandoc &gt; %s"</span><span class="text">
          </span><span class="id">actual_cmd</span><span class="text"> </span><span class="id">output_file</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">succeedf</span><span class="text"> </span><span class="string">"bash -c %s"</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">bash_cmd</span><span class="text">)
    </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">e</span><span class="text"> -&gt;
      </span><span class="id">ignore</span><span class="text"> (
        </span><span class="id">succeedf</span><span class="text"> </span><span class="string">"(echo '```' ; %s ; echo '```') &gt; %s"</span><span class="text"> </span><span class="id">actual_cmd</span><span class="text"> </span><span class="id">output_file</span><span class="text">;
        </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">output_file</span><span class="text">)
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
        </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">menu_md</span><span class="text">
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">menu</span><span class="text"> -&gt;
        </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="kw4">~title</span><span class="text">:</span><span class="id">cmd</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text">:</span><span class="string">""</span><span class="text"> </span><span class="id">content</span><span class="text">
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="id">write_file</span><span class="text"> (</span><span class="id">output_file</span><span class="text">) </span><span class="kw4">~content</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
      );
    </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  ()


</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [ </span><span class="numeric">_</span><span class="text"> ] | [] -&gt;  </span><span class="id">main</span><span class="text"> ()
  | </span><span class="id">exec</span><span class="text"> :: </span><span class="string">"--help"</span><span class="text"> :: </span><span class="numeric">_</span><span class="text">
  | </span><span class="id">exec</span><span class="text"> :: </span><span class="string">"-h"</span><span class="text"> :: </span><span class="numeric">_</span><span class="text"> -&gt;
    </span><span class="id">say</span><span class="text"> </span><span class="string">"Usage: [ENV_VAR=...] %s"</span><span class="text"> </span><span class="id">exec</span><span class="text">;
    </span><span class="id">say</span><span class="text"> </span><span class="string">"Current configuration:"</span><span class="text">;
    </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">display</span><span class="text">
  | </span><span class="id">exec</span><span class="text"> :: </span><span class="id">other</span><span class="text"> -&gt;
    </span><span class="id">say</span><span class="text"> </span><span class="string">"Wrong command line"</span><span class="text">;
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">1</span><span class="text">
</span></pre></div></div></div></body><html>