 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css">
<link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css" type="text/css"><meta charset="utf-8"><title>Oredoc: Literate Implementation</title></head><body><div class="container"><h1>Oredoc: Literate Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul>
 <li><a href='#YetAnotherMonad'>Yet Another Monad</a>
 </li>
 <li><a href='#IdentifyFilesByExtension'>Identify Files By Extension </a>
 </li>
 <li><a href='#MarkdownToHTML'>Markdown To HTML</a>
 </li>
 <li><a href='#ConvertingOCamltoHTML'>Converting OCaml to HTML</a>
 </li>
 <li><a href='#HTMLTemplate'>HTML Template</a>
 </li>
 <li><a href='#SomeUtilities'>Some Utilities</a>
 </li>
 <li><a href='#Configuration'>Configuration</a>
 </li>
 <li><a href='#MainEntryPoint'>Main Entry Point</a>
 </li>
</ul>
<h2>Menu</h2><ul>
 <li><a href='index.html'>Home</a></li>
 <li><a href='oredoc.html'>Literate Implementation</a></li>
 <li><a href='./api/index.html'>API Documentation</a></li>
 <li>Repository <a href='https://github.com/smondet/oredoc'>at Github</a></li>
 <li>Up: <a href='../index.html'>Software Projects</a></li>
</ul>
</div><div class="col-md-9">

<h1 id="ImplementationofOredoc">Implementation of Oredoc</h1>
<p>Usual “OCaml-configuration” header:</p>

<pre><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Legacy_string</span><span class="text"> = </span><span class="kw2">String</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">Sosa</span><span class="text">.</span><span class="kw2">Native_string</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">dbg</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="id">eprintf</span><span class="text"> </span><span class="string">&quot;# %s\n&quot;</span><span class="text">)) </span><span class="id">fmt</span><span class="text">


</span></pre>

<h2 id="YetAnotherMonad">Yet Another Monad</h2>
<p>The module <code>Meta_result</code> provides a funny monad that allows one to keep track
of things to do “later” during a computation.</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Meta_result</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text"> = {
    </span><span class="id">result</span><span class="text">: '</span><span class="id">a</span><span class="text">;
    </span><span class="id">more_things_todo</span><span class="text">: '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">;
  }

  </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> ?(</span><span class="id">more_things_todo</span><span class="text">=[]) </span><span class="id">result</span><span class="text"> = {</span><span class="id">result</span><span class="text">; </span><span class="id">more_things_todo</span><span class="text">}
  </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">next</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">m</span><span class="text">.</span><span class="id">result</span><span class="text"> </span><span class="kw">in</span><span class="text">
    { </span><span class="id">next</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="id">more_things_todo</span><span class="text"> = </span><span class="id">next</span><span class="text">.</span><span class="id">more_things_todo</span><span class="text"> @ </span><span class="id">m</span><span class="text">.</span><span class="id">more_things_todo</span><span class="text">}
  </span><span class="kw">let</span><span class="text"> (&gt;&gt;=) </span><span class="id">m</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="id">bind</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw4">~f</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span></pre>

<h2 id="IdentifyFilesByExtension">Identify Files By Extension </h2>
<p>This is used for both 1) deciding which treatment to apply to files and 2)
transforming relative links between them (in Markdown).</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">check_suffix</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="id">ext</span><span class="text">
    </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">chop_suffix</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="id">ext</span><span class="text">)
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">identify_file</span><span class="text"> </span><span class="id">filename</span><span class="text"> =
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text">:</span><span class="string">&quot;.md&quot;</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt; `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">sub</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text">:</span><span class="string">&quot;.ml&quot;</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt; `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">sub</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check_and_remove_extension</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw4">~ext</span><span class="text">:</span><span class="string">&quot;.mli&quot;</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt; `</span><span class="kw2">Ocaml_interface</span><span class="text"> </span><span class="id">sub</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; `</span><span class="kw2">Other</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span></pre>
<h2 id="MarkdownToHTML">Markdown To HTML</h2>
<p>Our wrapper around <a href='https://github.com/ocaml/omd'>Omd</a>, which adds a few
features/extensions:</p>
<ul>
 <li>There is a special syntax to <span style="color: red; background-color: yellow; font-weight: bold">overhighlight</span> stuff.</li>
 <li>Local links are transformed to be consistent between a repository view
(Github, Bitbucket) and the generated website.</li>
 <li><a href='some_command___help.html' title='some-command --help'><code>some-command --help</code></a> will be transformed into a link too.</li>
</ul>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Markdown</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> '</span><span class="id">a</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = '</span><span class="id">a</span><span class="text"> </span><span class="kw">constraint</span><span class="text"> '</span><span class="id">a</span><span class="text"> = &lt;
    </span><span class="id">catch_module_paths</span><span class="text">: (</span><span class="kw3">string</span><span class="text"> * </span><span class="kw2">Re</span><span class="text">.</span><span class="id">re</span><span class="text"> * </span><span class="kw3">string</span><span class="text">) </span><span class="kw3">list</span><span class="text">;
    ..
  &gt;

  </span><span class="kw">let</span><span class="text"> </span><span class="id">code_url</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw2">String</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
      | </span><span class="string">'a'</span><span class="text"> .. </span><span class="string">'z'</span><span class="text"> | </span><span class="string">'A'</span><span class="text"> .. </span><span class="string">'Z'</span><span class="text"> | </span><span class="string">'0'</span><span class="text"> .. </span><span class="string">'9'</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">
      | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="string">'_'</span><span class="text">)
    ^ </span><span class="string">&quot;.html&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">looks_like_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">catch_module_paths</span><span class="text">
      </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">re</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt; </span><span class="kw2">Re</span><span class="text">.</span><span class="id">execp</span><span class="text"> </span><span class="id">re</span><span class="text"> </span><span class="id">code</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">url_of_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_value</span><span class="text"> </span><span class="id">v</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">v</span><span class="text">.[</span><span class="numeric">0</span><span class="text">] </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">Char</span><span class="text">.</span><span class="id">lowercase</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="id">c</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> =
      </span><span class="kw">function</span><span class="text">
      | [] -&gt; </span><span class="string">&quot;&quot;</span><span class="text">
      | [</span><span class="string">&quot;t&quot;</span><span class="text">]  -&gt; </span><span class="id">acc</span><span class="text"> ^ </span><span class="string">&quot;html#TYPEt&quot;</span><span class="text">
      | [</span><span class="id">one</span><span class="text">] </span><span class="kw1">when</span><span class="text"> </span><span class="id">is_value</span><span class="text"> </span><span class="id">one</span><span class="text"> -&gt; </span><span class="id">acc</span><span class="text"> ^ </span><span class="string">&quot;html#VAL&quot;</span><span class="text"> ^ </span><span class="id">one</span><span class="text">
      | [</span><span class="id">one</span><span class="text">] -&gt; </span><span class="id">acc</span><span class="text"> ^ </span><span class="id">one</span><span class="text"> ^ </span><span class="string">&quot;.html&quot;</span><span class="text">
      | </span><span class="id">modul</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">acc</span><span class="text"> ^ </span><span class="id">modul</span><span class="text"> ^ </span><span class="string">&quot;.&quot;</span><span class="text">) </span><span class="id">more</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">prefix</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">catch_module_paths</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">re</span><span class="text">, </span><span class="id">pr</span><span class="text">) -&gt;
          </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Re</span><span class="text">.</span><span class="id">execp</span><span class="text"> </span><span class="id">re</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">pr</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">)
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> (</span><span class="string">&quot;api/&quot;</span><span class="text"> ^ </span><span class="id">prefix</span><span class="text">) (</span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">'.'</span><span class="text">))


  </span><span class="kw">let</span><span class="text"> </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">highligh</span><span class="text"> : </span><span class="kw2">Omd_representation</span><span class="text">.</span><span class="id">extension</span><span class="text"> =
      </span><span class="kw1">object</span><span class="text">
        </span><span class="kw">method</span><span class="text"> </span><span class="id">parser_extension</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">read_tokens</span><span class="text"> = 
          </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Omd_representation</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">highlight_style</span><span class="text"> =
            </span><span class="string">&quot;color: red; background-color: yellow; font-weight: bold&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="comment">(* dbg &quot;highlight for: %s&quot; (Omd_lexer.destring_of_tokens ~limit:5  read_tokens); *)</span><span class="text">
          </span><span class="kw">function</span><span class="text"> 
          | </span><span class="kw2">Exclamation</span><span class="text"> :: </span><span class="kw2">Word</span><span class="text"> </span><span class="id">w</span><span class="text"> :: </span><span class="kw2">Exclamation</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="id">in_red</span><span class="text"> = </span><span class="id">sprintf</span><span class="text">  </span><span class="string">&quot;&lt;span style=%S&gt;%s&lt;/span&gt;&quot;</span><span class="text"> </span><span class="id">highlight_style</span><span class="text"> </span><span class="id">w</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Raw</span><span class="text"> </span><span class="id">in_red</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="id">read_tokens</span><span class="text">, </span><span class="id">more</span><span class="text">)
          | </span><span class="id">m</span><span class="text"> -&gt;
            </span><span class="comment">(* dbg &quot;none for: %s&quot; (Omd_lexer.destring_of_tokens ~limit:4 m); *)</span><span class="text">
            </span><span class="kw2">None</span><span class="text">
        </span><span class="kw">method</span><span class="text"> </span><span class="id">to_string</span><span class="text"> = </span><span class="string">&quot;highlight&quot;</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">more_stuff_to_do</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">transform_links</span><span class="text"> (</span><span class="id">t</span><span class="text">: </span><span class="kw2">Omd</span><span class="text">.</span><span class="id">element</span><span class="text">) : </span><span class="kw2">Omd</span><span class="text">.</span><span class="id">element</span><span class="text">  =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Omd</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text"> 
      | </span><span class="kw2">Paragraph</span><span class="text">  </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Paragraph</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Emph</span><span class="text">  </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Emph</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Bold</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Bold</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Ul</span><span class="text">  </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Ul</span><span class="text">  (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">Ol</span><span class="text">  </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Ol</span><span class="text">  (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">Ulp</span><span class="text"> </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Ulp</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">Olp</span><span class="text"> </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Olp</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">) </span><span class="id">tl</span><span class="text">)
      | </span><span class="kw2">H1</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H1</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H2</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H2</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H3</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H3</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H4</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H4</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H5</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H5</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">H6</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">H6</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Blockquote</span><span class="text">  </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Blockquote</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">)
      | </span><span class="kw2">Text</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Br</span><span class="text">
      | </span><span class="kw2">Hr</span><span class="text">
      | </span><span class="kw2">Img_ref</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Html</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Html_block</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Html_comment</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">NL</span><span class="text">
      | </span><span class="kw2">X</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Raw</span><span class="text"> </span><span class="numeric">_</span><span class="text"> | </span><span class="kw2">Raw_block</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | </span><span class="kw2">Img</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">e</span><span class="text">
      | </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) </span><span class="kw1">when</span><span class="text"> 
          </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">code</span><span class="text"> - </span><span class="numeric">6</span><span class="text">) </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">6</span><span class="text"> 
          = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;--help&quot;</span><span class="text"> -&gt;
        </span><span class="comment">(* dbg &quot;Code: %s %s&quot; lang code; *)</span><span class="text">
        </span><span class="id">more_stuff_to_do</span><span class="text"> := `</span><span class="kw2">Create_man_page</span><span class="text"> </span><span class="id">code</span><span class="text"> :: !</span><span class="id">more_stuff_to_do</span><span class="text">;
        </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">code_url</span><span class="text"> </span><span class="id">code</span><span class="text">, [</span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">)], </span><span class="id">code</span><span class="text">)
      | </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">looks_like_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> -&gt;
        </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">url_of_module_path</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text">, [</span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">)], </span><span class="id">code</span><span class="text">)
      | </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) -&gt; </span><span class="kw2">Code</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">)
      | </span><span class="kw2">Code_block</span><span class="text"> (</span><span class="id">lang</span><span class="text">, </span><span class="id">code</span><span class="text">) </span><span class="kw1">as</span><span class="text"> </span><span class="id">code_block</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
          </span><span class="kw">let</span><span class="text"> (</span><span class="numeric">_</span><span class="text"> : </span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">lexer</span><span class="text">) = </span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">get_lexer</span><span class="text"> </span><span class="id">lang</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Raw</span><span class="text"> (
            </span><span class="string">&quot;&lt;pre&gt;&quot;</span><span class="text">
            ^ (</span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">to_xtmpl</span><span class="text"> </span><span class="kw4">~lang</span><span class="text"> </span><span class="id">code</span><span class="text"> |&gt; </span><span class="kw2">Xtmpl</span><span class="text">.</span><span class="id">string_of_xmls</span><span class="text">)
            ^ </span><span class="string">&quot;&lt;/pre&gt;&quot;</span><span class="text">)
        </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">code_block</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      | </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">7</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;http://&quot;</span><span class="text">
           || </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">8</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;https://&quot;</span><span class="text">
           || </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">6</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;ftp://&quot;</span><span class="text">
        -&gt; </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
      | </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">) -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text">.</span><span class="id">identify_file</span><span class="text"> </span><span class="id">href</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;./%s.html&quot;</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text">),
               </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        | `</span><span class="kw2">Ocaml_interface</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">modname</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text"> |&gt; </span><span class="kw2">Legacy_string</span><span class="text">.</span><span class="id">capitalize</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;api/%s.html&quot;</span><span class="text"> </span><span class="id">modname</span><span class="text">,
               </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        | `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s.html&quot;</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text">),
               </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        | `</span><span class="kw2">Other</span><span class="text"> -&gt; 
          </span><span class="kw2">Url</span><span class="text"> (</span><span class="id">href</span><span class="text">, </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">title</span><span class="text">)
        </span><span class="kw1">end</span><span class="text">
      | </span><span class="kw2">Ref</span><span class="text">  (</span><span class="id">ref_container</span><span class="text">, </span><span class="id">name</span><span class="text">, </span><span class="kw3">string</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">e</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">make_paragraphs</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">E</span><span class="text"> = </span><span class="kw2">Omd_parser</span><span class="text">.</span><span class="kw2">Default_env</span><span class="text">(</span><span class="kw1">struct</span><span class="text"> </span><span class="kw1">end</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Parser</span><span class="text"> = </span><span class="kw2">Omd_parser</span><span class="text">.</span><span class="kw2">Make</span><span class="text">(</span><span class="kw2">E</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Parser</span><span class="text">.</span><span class="id">make_paragraphs</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Meta_result</span><span class="text">.</span><span class="id">return</span><span class="text"> </span><span class="kw4">~more_things_todo</span><span class="text">:!</span><span class="id">more_stuff_to_do</span><span class="text"> (
      </span><span class="kw2">Omd_parser</span><span class="text">.</span><span class="id">default_parse</span><span class="text">
        </span><span class="kw4">~extensions</span><span class="text">:[</span><span class="id">highligh</span><span class="text">] (</span><span class="kw2">Omd_lexer</span><span class="text">.</span><span class="id">lex</span><span class="text"> </span><span class="id">content</span><span class="text">)
      |&gt; </span><span class="id">make_paragraphs</span><span class="text">
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">transform_links</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_html</span><span class="text"> ~(</span><span class="id">configuration</span><span class="text">:</span><span class="numeric">_</span><span class="text"> </span><span class="id">configuration</span><span class="text">) </span><span class="id">content</span><span class="text"> = 
    </span><span class="kw2">Meta_result</span><span class="text">.(
      </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="kw2">Omd</span><span class="text">.(</span><span class="id">to_html</span><span class="text"> </span><span class="id">p</span><span class="text">)
    )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw2">Meta_result</span><span class="text">.(
      </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="kw2">Omd</span><span class="text">.(</span><span class="id">to_html</span><span class="text"> (</span><span class="id">toc</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:[</span><span class="numeric">0</span><span class="text">] </span><span class="id">p</span><span class="text">))
    )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text"> = 
    </span><span class="kw2">Meta_result</span><span class="text">.(
      </span><span class="id">preprocess</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">content</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="kw2">Omd</span><span class="text">.(</span><span class="id">to_html</span><span class="text"> </span><span class="id">p</span><span class="text">, </span><span class="id">to_html</span><span class="text"> (</span><span class="id">toc</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]  </span><span class="id">p</span><span class="text">))
    )
    </span><span class="comment">(* Omd.(to_html p, to_html (toc  ~start:[1] p)) *)</span><span class="text">


</span><span class="kw1">end</span><span class="text">

</span></pre>

<h2 id="ConvertingOCamltoHTML">Converting OCaml to HTML</h2>
<p>OCaml code with special Markdown comments will be transformed into HTML.</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Ocaml</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Meta_result</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">code</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">remove_comments</span><span class="text"> </span><span class="id">s</span><span class="text"> = 
      </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">6</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Higlo</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">parsed</span><span class="text"> = </span><span class="id">parse</span><span class="text"> </span><span class="kw4">~lang</span><span class="text">:</span><span class="string">&quot;ocaml&quot;</span><span class="text"> </span><span class="id">code</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">flush_tokens</span><span class="text"> </span><span class="id">revtoklist</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">revtoklist</span><span class="text"> 
          </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text"> </span><span class="kw2">Text</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">strip</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="string">&quot;&quot;</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">)
      </span><span class="kw1">then</span><span class="text"> </span><span class="string">&quot;&quot;</span><span class="text">
      </span><span class="kw1">else</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">html</span><span class="text"> =
          </span><span class="kw2">Xtmpl</span><span class="text">.</span><span class="id">string_of_xmls</span><span class="text">
            (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Higlo</span><span class="text">.</span><span class="id">token_to_xtmpl</span><span class="text"> </span><span class="id">revtoklist</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="string">&quot;&lt;pre&gt;&quot;</span><span class="text"> ^ </span><span class="id">html</span><span class="text"> ^ </span><span class="string">&quot;&lt;/pre&gt;&quot;</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc_tokens</span><span class="text"> </span><span class="id">acc_html</span><span class="text"> </span><span class="id">acc_toc</span><span class="text"> </span><span class="id">tokens</span><span class="text"> = 
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">tokens</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt; 
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">acc_toc</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;\n&quot;</span><span class="text"> 
         |&gt; </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text">)
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">toc</span><span class="text"> -&gt;
        </span><span class="id">return</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">flush_tokens</span><span class="text"> </span><span class="id">acc_tokens</span><span class="text"> :: </span><span class="id">acc_html</span><span class="text">) 
         |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;\n&quot;</span><span class="text">, </span><span class="id">toc</span><span class="text">)
      | </span><span class="id">one</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">one</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Bcomment</span><span class="text"> </span><span class="id">com</span><span class="text">
        | </span><span class="kw2">Lcomment</span><span class="text"> </span><span class="id">com</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">com</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;(*M&quot;</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">html_code</span><span class="text"> = </span><span class="id">flush_tokens</span><span class="text"> </span><span class="id">acc_tokens</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">comment_content</span><span class="text"> = </span><span class="id">remove_comments</span><span class="text"> </span><span class="id">com</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">comment_content</span><span class="text">
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">html_comment</span><span class="text"> -&gt;
          </span><span class="id">loop</span><span class="text"> [] (</span><span class="id">html_comment</span><span class="text"> :: </span><span class="id">html_code</span><span class="text"> :: </span><span class="id">acc_html</span><span class="text">) 
            (</span><span class="id">comment_content</span><span class="text"> :: </span><span class="id">acc_toc</span><span class="text">) </span><span class="id">more</span><span class="text">
        | </span><span class="id">tok</span><span class="text"> -&gt; 
          </span><span class="id">loop</span><span class="text"> (</span><span class="id">tok</span><span class="text"> :: </span><span class="id">acc_tokens</span><span class="text">) </span><span class="id">acc_html</span><span class="text"> </span><span class="id">acc_toc</span><span class="text"> </span><span class="id">more</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> [] [] [] </span><span class="id">parsed</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span></pre>

<h2 id="HTMLTemplate">HTML Template</h2>
<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Template</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="id">content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">link</span><span class="text"> </span><span class="id">css</span><span class="text"> =
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;&lt;link rel=\&quot;stylesheet\&quot; href=%S type=\&quot;text/css\&quot;&gt;&quot;</span><span class="text"> </span><span class="id">css</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Meta_result</span><span class="text">.</span><span class="id">return</span><span class="text"> (
      </span><span class="string">&quot; &lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt;&quot;</span><span class="text">
      ^ </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;\n&quot;</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">link</span><span class="text">)
      ^ </span><span class="string">&quot;&lt;meta charset=\&quot;utf-8\&quot;&gt;&quot;</span><span class="text">
      ^ </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;&lt;title&gt;%s&lt;/title&gt;&quot;</span><span class="text"> </span><span class="id">title</span><span class="text">
      ^ </span><span class="string">&quot;&lt;/head&gt;&quot;</span><span class="text">
      ^ </span><span class="string">&quot;&lt;body&gt;&lt;div class=\&quot;container\&quot;&gt;&quot;</span><span class="text"> 
      ^ </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span><span class="text"> </span><span class="id">title</span><span class="text">
      ^ </span><span class="string">&quot;&lt;div class=\&quot;row\&quot;&gt;\n\
         &lt;div class=\&quot;col-md-3\&quot;&gt;\n\
         &lt;h2&gt;Contents&lt;/h2&gt;&quot;</span><span class="text">
      ^ </span><span class="id">toc</span><span class="text">
      ^ </span><span class="string">&quot;&lt;h2&gt;Menu&lt;/h2&gt;&quot;</span><span class="text">
      ^ </span><span class="id">menu</span><span class="text">
      ^ </span><span class="string">&quot;&lt;/div&gt;&lt;div class=\&quot;col-md-9\&quot;&gt;&quot;</span><span class="text">
      ^ </span><span class="id">content</span><span class="text">
      ^ </span><span class="string">&quot;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;html&gt;&quot;</span><span class="text">)

</span><span class="kw1">end</span><span class="text">

</span></pre>

<h2 id="SomeUtilities">Some Utilities</h2>
<pre><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Utilities</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (//) = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">env</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">failwithf</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="id">fmt</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">succeed</span><span class="text"> </span><span class="id">s</span><span class="text"> = 
    </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">command</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="numeric">0</span><span class="text"> -&gt; ()
    | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="id">failwithf</span><span class="text"> </span><span class="string">&quot;Command %S did not succeed: %d&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">other</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">succeedf</span><span class="text"> </span><span class="id">fmt</span><span class="text">= </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">succeed</span><span class="text"> </span><span class="id">fmt</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">all_files</span><span class="text"> </span><span class="id">dir</span><span class="text"> =
    </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">readdir</span><span class="text"> </span><span class="id">dir</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> 
    |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">d</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">p</span><span class="text"> = </span><span class="id">dir</span><span class="text"> // </span><span class="id">d</span><span class="text"> </span><span class="kw">in</span><span class="text"> 
        </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">is_directory</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">p</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">read_file</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">open_in</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">buf</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> () =
      </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">add_channel</span><span class="text"> </span><span class="id">buf</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="numeric">1</span><span class="text">; </span><span class="id">loop</span><span class="text"> () </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; () </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> ();
    </span><span class="id">close_in</span><span class="text"> </span><span class="id">i</span><span class="text">;
    </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">buf</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">write_file</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw4">~content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">o</span><span class="text"> = </span><span class="id">open_out</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">output_string</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">content</span><span class="text">;
    </span><span class="id">close_out</span><span class="text"> </span><span class="id">o</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">parse_list_of_substitutions</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">subs</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">','</span><span class="text">) </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">subs</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">':'</span><span class="text">) (</span><span class="kw2">String</span><span class="text">.</span><span class="id">strip</span><span class="text"> </span><span class="id">sub</span><span class="text">) </span><span class="kw1">with</span><span class="text">
        | [</span><span class="id">one</span><span class="text">; </span><span class="id">two</span><span class="text">] -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">one</span><span class="text">, </span><span class="id">two</span><span class="text">)
        | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
      )

</span><span class="kw1">end</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Utilities</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="id">printf</span><span class="text"> </span><span class="string">&quot;%s\n&quot;</span><span class="text">)) </span><span class="id">fmt</span><span class="text">


</span></pre>

<h2 id="Configuration">Configuration</h2>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">default_stylesheets</span><span class="text"> = [
  </span><span class="string">&quot;https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css&quot;</span><span class="text">;
  </span><span class="string">&quot;http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css&quot;</span><span class="text">;
  </span><span class="string">&quot;http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css&quot;</span><span class="text">;
  </span><span class="comment">(* &lt;link rel=&quot;stylesheet&quot; href=&quot;code_style.css&quot; type=&quot;text/css&quot;&gt; *)</span><span class="text">
]

</span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = 
  </span><span class="kw1">object</span><span class="text"> (</span><span class="id">self</span><span class="text">)
    </span><span class="kw">method</span><span class="text"> </span><span class="id">output_directory</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;OUTPUT_DIR&quot;</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">&quot;_doc&quot;</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">input_files</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;INPUT&quot;</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text">
      |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">','</span><span class="text">)
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">path</span><span class="text"> -&gt;
          </span><span class="kw1">try</span><span class="text">
            </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">is_directory</span><span class="text"> </span><span class="id">path</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> </span><span class="id">all_files</span><span class="text"> </span><span class="id">path</span><span class="text">
            </span><span class="kw1">else</span><span class="text"> [</span><span class="id">path</span><span class="text">]
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; [])
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">index_file</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;INDEX&quot;</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">&quot;README.md&quot;</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">stylesheets</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;CSS&quot;</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">','</span><span class="text">))
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="id">default_stylesheets</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">api_doc_directory</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;API&quot;</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">title_prefix</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;TITLE_PREFIX&quot;</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">title_substitutions</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;TITLE_SUBSTITUTIONS&quot;</span><span class="text">
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">parse_list_of_substitutions</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">title</span><span class="text"> ?(</span><span class="id">with_prefix</span><span class="text">=</span><span class="constant">true</span><span class="text">) </span><span class="id">t</span><span class="text"> = 
      </span><span class="kw">let</span><span class="text"> </span><span class="id">tt</span><span class="text"> = 
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">title_substitutions</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
          | (</span><span class="id">a</span><span class="text">, </span><span class="id">b</span><span class="text">) </span><span class="kw1">when</span><span class="text"> 
              </span><span class="id">a</span><span class="text"> = </span><span class="id">t</span><span class="text"> || (</span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">chop_extension</span><span class="text"> </span><span class="id">a</span><span class="text"> = </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">) -&gt;
            </span><span class="kw2">Some</span><span class="text"> </span><span class="id">b</span><span class="text">
          | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)
        |&gt; </span><span class="kw">function</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">b</span><span class="text"> -&gt; </span><span class="id">b</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; 
          </span><span class="kw2">String</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text"> </span><span class="string">'_'</span><span class="text"> -&gt; </span><span class="string">' '</span><span class="text"> | </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s%s&quot;</span><span class="text"> (</span><span class="kw1">if</span><span class="text"> </span><span class="id">with_prefix</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">title_prefix</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;&quot;</span><span class="text">) </span><span class="id">tt</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">command_substitutions</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;COMMAND_SUBSTITUTIONS&quot;</span><span class="text"> 
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">parse_list_of_substitutions</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">catch_module_paths</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;CATCH_MODULE_PATHS&quot;</span><span class="text"> 
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">parse_list_of_substitutions</span><span class="text">
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">pattern</span><span class="text">, </span><span class="id">prefix</span><span class="text">) -&gt;
          </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">pattern</span><span class="text">, </span><span class="kw2">Re_posix</span><span class="text">.</span><span class="id">compile_pat</span><span class="text"> </span><span class="id">pattern</span><span class="text">, </span><span class="id">prefix</span><span class="text">)
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)
    </span><span class="kw">method</span><span class="text"> </span><span class="id">add_to_menu</span><span class="text"> =
      </span><span class="id">env</span><span class="text"> </span><span class="string">&quot;ADD_TO_MENU&quot;</span><span class="text">
      |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">display</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">list_of_paths</span><span class="text"> </span><span class="id">l</span><span class="text"> =
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;  - %S&quot;</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;\n&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">variable_note</span><span class="text"> </span><span class="id">var</span><span class="text"> =
        </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;  (%S is %s)&quot;</span><span class="text"> </span><span class="id">var</span><span class="text">
          (</span><span class="kw1">match</span><span class="text"> </span><span class="id">env</span><span class="text"> </span><span class="id">var</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="string">&quot;empty&quot;</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Output directory: %s&quot;</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;OUTPUT_DIR&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Input files:\n%s&quot;</span><span class="text">
        (</span><span class="id">list_of_paths</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">input_files</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;INPUT&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Style sheets:\n%s&quot;</span><span class="text"> (</span><span class="id">list_of_paths</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;CSS&quot;</span><span class="text">;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">api_doc_directory</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Getting API docs from: %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;No getting API docs (*Warning*)&quot;</span><span class="text">
      </span><span class="kw1">end</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;API&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Title prefix: %S&quot;</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">title_prefix</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;TITLE_PREFIX&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Command substitutions:&quot;</span><span class="text">;
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">command_substitutions</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">b</span><span class="text">) -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;  - %s → %s&quot;</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;COMMAND_SUBSTITUTIONS&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Index file: %s&quot;</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">index_file</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;INDEX&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Catch module paths:&quot;</span><span class="text">;
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">catch_module_paths</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">a</span><span class="text">,</span><span class="numeric">_</span><span class="text">, </span><span class="id">b</span><span class="text">) -&gt;
          </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;  - %S → Prefix: %s&quot;</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">);
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;CATCH_MODULE_PATHS&quot;</span><span class="text">;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Add to the menu: %S&quot;</span><span class="text"> </span><span class="id">self</span><span class="kw1">#</span><span class="id">add_to_menu</span><span class="text">;
      </span><span class="id">variable_note</span><span class="text"> </span><span class="string">&quot;ADD_TO_MENU&quot;</span><span class="text">;
      ()
  </span><span class="kw1">end</span><span class="text">

</span></pre>

<h2 id="MainEntryPoint">Main Entry Point</h2>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">main</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Meta_result</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">succeedf</span><span class="text"> </span><span class="string">&quot;mkdir -p %s&quot;</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">api_doc_directory</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">succeedf</span><span class="text"> </span><span class="string">&quot;rsync -a %s/ %s/api&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">
  | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Warning, no API docs&quot;</span><span class="text">
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">menu_md</span><span class="text"> =
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;- [Home](index.html)\n&quot;</span><span class="text"> 
    :: (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">input_files</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">path</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text">.</span><span class="id">identify_file</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">m</span><span class="text">
        | `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">base</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="kw4">~with_prefix</span><span class="text">:</span><span class="constant">false</span><span class="text"> </span><span class="id">base</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;- [%s](%s.html)\n&quot;</span><span class="text"> </span><span class="id">title</span><span class="text"> </span><span class="id">base</span><span class="text">
        | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="string">&quot;&quot;</span><span class="text">))
    @ [
      (</span><span class="kw1">match</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">api_doc_directory</span><span class="text"> </span><span class="kw1">with</span><span class="text">
       | </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;- [API Documentation](./api/index.html)\n&quot;</span><span class="text">
       | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="string">&quot;&quot;</span><span class="text">);
      </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">add_to_menu</span><span class="text">; ]
    |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">first_pass_result</span><span class="text"> : (</span><span class="kw3">unit</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">t</span><span class="text"> =
    </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">menu_md</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">menu</span><span class="text"> -&gt;
    </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">index_file</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="string">&quot;Home&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="id">content</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">markdown_index</span><span class="text"> -&gt;
    </span><span class="id">write_file</span><span class="text"> (</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="string">&quot;index.html&quot;</span><span class="text">) </span><span class="kw4">~content</span><span class="text">:</span><span class="id">markdown_index</span><span class="text">;
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> ()) </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">input_files</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">path</span><span class="text"> -&gt;
      </span><span class="id">prev</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">File_kind</span><span class="text">.</span><span class="id">identify_file</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Markdown</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">base</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="id">base</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">path</span><span class="text">)
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
        </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="id">content</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="id">write_file</span><span class="text"> (</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s.html&quot;</span><span class="text"> </span><span class="id">base</span><span class="text">) </span><span class="kw4">~content</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Ocaml_implementation</span><span class="text"> </span><span class="id">impl</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">base</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">impl</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">title</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">title</span><span class="text"> </span><span class="id">base</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Ocaml</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">path</span><span class="text">)
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
        </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~title</span><span class="text"> </span><span class="kw4">~menu</span><span class="text">  </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text"> </span><span class="id">content</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="id">write_file</span><span class="text"> (</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s.html&quot;</span><span class="text"> </span><span class="id">base</span><span class="text">) </span><span class="kw4">~content</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
      | </span><span class="id">m</span><span class="text"> -&gt; 
        </span><span class="id">succeedf</span><span class="text"> </span><span class="string">&quot;cp %s %s/&quot;</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">path</span><span class="text">) </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">List</span><span class="text">.</span><span class="id">dedup</span><span class="text"> </span><span class="id">first_pass_result</span><span class="text">.</span><span class="id">more_things_todo</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Create_man_page</span><span class="text"> </span><span class="id">cmd</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">actual_cmd</span><span class="text"> = 
      </span><span class="kw">let</span><span class="text"> </span><span class="id">stripped</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">strip</span><span class="text"> </span><span class="id">cmd</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">command_substitutions</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">left</span><span class="text">, </span><span class="id">right</span><span class="text">) -&gt;
          </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">String</span><span class="text">.(</span><span class="id">sub</span><span class="text"> </span><span class="id">stripped</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">left</span><span class="text">)) </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">prefix</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">prefix</span><span class="text"> = </span><span class="id">left</span><span class="text"> -&gt;
            </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">right</span><span class="text">
                  ^ </span><span class="kw2">String</span><span class="text">.(</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">stripped</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">left</span><span class="text">)
                              </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">stripped</span><span class="text"> - </span><span class="id">length</span><span class="text"> </span><span class="id">left</span><span class="text">)))
          | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="id">stripped</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">output_file</span><span class="text"> = </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">output_directory</span><span class="text"> // </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">code_url</span><span class="text"> </span><span class="id">cmd</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text"> 
      </span><span class="id">succeedf</span><span class="text"> </span><span class="string">&quot;set -o pipefail ; %s=groff | groff -Thtml -mandoc &gt; %s&quot;</span><span class="text"> </span><span class="id">actual_cmd</span><span class="text"> </span><span class="id">output_file</span><span class="text">;
    </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">e</span><span class="text"> -&gt; 
      </span><span class="id">ignore</span><span class="text"> (
        </span><span class="id">succeedf</span><span class="text"> </span><span class="string">&quot;(echo '```' ; %s ; echo '```') &gt; %s&quot;</span><span class="text"> </span><span class="id">actual_cmd</span><span class="text"> </span><span class="id">output_file</span><span class="text">;
        </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html_and_toc</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="id">read_file</span><span class="text"> </span><span class="id">output_file</span><span class="text">)
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="id">content</span><span class="text">, </span><span class="id">toc</span><span class="text">) -&gt;
        </span><span class="kw2">Markdown</span><span class="text">.</span><span class="id">to_html</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="id">menu_md</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">menu</span><span class="text"> -&gt;
        </span><span class="kw2">Template</span><span class="text">.</span><span class="id">make_page</span><span class="text"> </span><span class="kw4">~menu</span><span class="text"> </span><span class="kw4">~title</span><span class="text">:</span><span class="id">cmd</span><span class="text"> </span><span class="kw4">~stylesheets</span><span class="text">:</span><span class="id">configuration</span><span class="kw1">#</span><span class="id">stylesheets</span><span class="text"> </span><span class="kw4">~toc</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text"> </span><span class="id">content</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="id">write_file</span><span class="text"> (</span><span class="id">output_file</span><span class="text">) </span><span class="kw4">~content</span><span class="text">;
        </span><span class="id">return</span><span class="text"> ()
      );
    </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  ()


</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [ </span><span class="numeric">_</span><span class="text"> ] | [] -&gt;  </span><span class="id">main</span><span class="text"> ()
  | </span><span class="id">exec</span><span class="text"> :: </span><span class="string">&quot;--help&quot;</span><span class="text"> :: </span><span class="numeric">_</span><span class="text"> 
  | </span><span class="id">exec</span><span class="text"> :: </span><span class="string">&quot;-h&quot;</span><span class="text"> :: </span><span class="numeric">_</span><span class="text"> -&gt;
    </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Usage: [ENV_VAR=...] %s&quot;</span><span class="text"> </span><span class="id">exec</span><span class="text">;
    </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Current configuration:&quot;</span><span class="text">;
    </span><span class="id">configuration</span><span class="kw1">#</span><span class="id">display</span><span class="text">
  | </span><span class="id">exec</span><span class="text"> :: </span><span class="id">other</span><span class="text"> -&gt;
    </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">;
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">1</span><span class="text">

</span></pre></div></div></div></body><html>