<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Oredoc" rel="Chapter" href="Oredoc.html"><title>Oredoc API : Oredoc</title>
</head>
<body>
<code class="code"><br>
<span class="comment">(*M<br>
<br>
Implementation&nbsp;of&nbsp;Oredoc<br>
========================<br>
<br>
Usual&nbsp;“OCaml-configuration”&nbsp;header:<br>
<br>
M*)</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Legacy_string</span>&nbsp;=&nbsp;<span class="constructor">String</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">String</span>&nbsp;=&nbsp;<span class="constructor">Sosa</span>.<span class="constructor">Native_string</span><br>
<span class="keyword">let</span>&nbsp;dbg&nbsp;fmt&nbsp;=&nbsp;<span class="constructor">Printf</span>.(ksprintf&nbsp;(eprintf&nbsp;<span class="string">"#&nbsp;%s\n"</span>))&nbsp;fmt<br>
<br>
<br>
<span class="comment">(*M<br>
<br>
Yet&nbsp;Another&nbsp;Monad<br>
-----------------<br>
<br>
The&nbsp;module&nbsp;`Meta_result`&nbsp;provides&nbsp;a&nbsp;funny&nbsp;monad&nbsp;that&nbsp;allows&nbsp;one&nbsp;to&nbsp;keep&nbsp;track<br>
of&nbsp;things&nbsp;to&nbsp;do&nbsp;“later”&nbsp;during&nbsp;a&nbsp;computation.<br>
<br>
M*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Meta_result</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;(<span class="keywordsign">'</span>a,&nbsp;<span class="keywordsign">'</span>b)&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;result:&nbsp;<span class="keywordsign">'</span>a;<br>
&nbsp;&nbsp;&nbsp;&nbsp;more_things_todo:&nbsp;<span class="keywordsign">'</span>b&nbsp;list;<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;return&nbsp;?(more_things_todo=[])&nbsp;result&nbsp;=&nbsp;{result;&nbsp;more_things_todo}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bind&nbsp;m&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;next&nbsp;=&nbsp;f&nbsp;m.result&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;next&nbsp;<span class="keyword">with</span>&nbsp;more_things_todo&nbsp;=&nbsp;next.more_things_todo&nbsp;@&nbsp;m.more_things_todo}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(&gt;&gt;=)&nbsp;m&nbsp;f&nbsp;=&nbsp;bind&nbsp;m&nbsp;~f<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="comment">(*M<br>
<br>
Identify&nbsp;Files&nbsp;By&nbsp;Extension&nbsp;<br>
---------------------------<br>
<br>
This&nbsp;is&nbsp;used&nbsp;for&nbsp;both&nbsp;1)&nbsp;deciding&nbsp;which&nbsp;treatment&nbsp;to&nbsp;apply&nbsp;to&nbsp;files&nbsp;and&nbsp;2)<br>
transforming&nbsp;relative&nbsp;links&nbsp;between&nbsp;them&nbsp;(in&nbsp;Markdown).<br>
<br>
M*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">File_kind</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;check_and_remove_extension&nbsp;filename&nbsp;~ext&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;filename&nbsp;ext<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;filename&nbsp;ext)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;identify_file&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;check_and_remove_extension&nbsp;filename&nbsp;~ext:<span class="string">".md"</span>&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;sub&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Markdown</span>&nbsp;sub<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;check_and_remove_extension&nbsp;filename&nbsp;~ext:<span class="string">".ml"</span>&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;sub&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ocaml_implementation</span>&nbsp;sub<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;check_and_remove_extension&nbsp;filename&nbsp;~ext:<span class="string">".mli"</span>&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;sub&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ocaml_interface</span>&nbsp;sub<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Other</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="comment">(*M<br>
Markdown&nbsp;To&nbsp;HTML<br>
----------------<br>
<br>
Our&nbsp;wrapper&nbsp;around&nbsp;[Omd](https://github.com/ocaml/omd),&nbsp;which&nbsp;adds&nbsp;a&nbsp;few<br>
features/extensions:<br>
<br>
-&nbsp;There&nbsp;is&nbsp;a&nbsp;special&nbsp;syntax&nbsp;to&nbsp;!overhighlight!&nbsp;stuff.<br>
-&nbsp;Local&nbsp;links&nbsp;are&nbsp;transformed&nbsp;to&nbsp;be&nbsp;consistent&nbsp;between&nbsp;a&nbsp;repository&nbsp;view<br>
(Github,&nbsp;Bitbucket)&nbsp;and&nbsp;the&nbsp;generated&nbsp;website.<br>
-&nbsp;`some-command&nbsp;--help`&nbsp;will&nbsp;be&nbsp;transformed&nbsp;into&nbsp;a&nbsp;link&nbsp;too.<br>
<br>
M*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Markdown</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;configuration&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="keyword">constraint</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;=&nbsp;&lt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;catch_module_paths:&nbsp;(string&nbsp;*&nbsp;<span class="constructor">Re</span>.re&nbsp;*&nbsp;string)&nbsp;list;<br>
&nbsp;&nbsp;&nbsp;&nbsp;..<br>
&nbsp;&nbsp;&gt;<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;code_url&nbsp;code&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.map&nbsp;code&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'a'</span>&nbsp;..&nbsp;<span class="string">'z'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'A'</span>&nbsp;..&nbsp;<span class="string">'Z'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'0'</span>&nbsp;..&nbsp;<span class="string">'9'</span>&nbsp;<span class="keyword">as</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">'_'</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">".html"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;looks_like_module_path&nbsp;~configuration&nbsp;code&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.exists&nbsp;configuration<span class="keywordsign">#</span>catch_module_paths<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(_,&nbsp;re,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Re</span>.execp&nbsp;re&nbsp;code)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;url_of_module_path&nbsp;~configuration&nbsp;code&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_value&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;v.[0]&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;c&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">Char</span>.lowercase&nbsp;c&nbsp;=&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;acc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[<span class="string">"t"</span>]&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;acc&nbsp;^&nbsp;<span class="string">"html#TYPEt"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[one]&nbsp;<span class="keyword">when</span>&nbsp;is_value&nbsp;one&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;acc&nbsp;^&nbsp;<span class="string">"html#VAL"</span>&nbsp;^&nbsp;one<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[one]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;acc&nbsp;^&nbsp;one&nbsp;^&nbsp;<span class="string">".html"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;modul&nbsp;::&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;loop&nbsp;(acc&nbsp;^&nbsp;modul&nbsp;^&nbsp;<span class="string">"."</span>)&nbsp;more<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;configuration<span class="keywordsign">#</span>catch_module_paths&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(_,&nbsp;re,&nbsp;pr)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Re</span>.execp&nbsp;re&nbsp;code&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;pr&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">""</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;(<span class="string">"api/"</span>&nbsp;^&nbsp;prefix)&nbsp;(<span class="constructor">String</span>.split&nbsp;code&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'.'</span>))<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;preprocess&nbsp;~configuration&nbsp;content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;highligh&nbsp;:&nbsp;<span class="constructor">Omd_representation</span>.extension&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;parser_extension&nbsp;t&nbsp;read_tokens&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Omd_representation</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;highlight_style&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"color:&nbsp;red;&nbsp;background-color:&nbsp;yellow;&nbsp;font-weight:&nbsp;bold"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;dbg&nbsp;"highlight&nbsp;for:&nbsp;%s"&nbsp;(Omd_lexer.destring_of_tokens&nbsp;~limit:5&nbsp;&nbsp;read_tokens);&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Exclamation</span>&nbsp;::&nbsp;<span class="constructor">Word</span>&nbsp;w&nbsp;::&nbsp;<span class="constructor">Exclamation</span>&nbsp;::&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_red&nbsp;=&nbsp;sprintf&nbsp;&nbsp;<span class="string">"&lt;span&nbsp;style=%S&gt;%s&lt;/span&gt;"</span>&nbsp;highlight_style&nbsp;w&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Raw</span>&nbsp;in_red&nbsp;::&nbsp;t,&nbsp;read_tokens,&nbsp;more)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;dbg&nbsp;"none&nbsp;for:&nbsp;%s"&nbsp;(Omd_lexer.destring_of_tokens&nbsp;~limit:4&nbsp;m);&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;to_string&nbsp;=&nbsp;<span class="string">"highlight"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;more_stuff_to_do&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;transform_links&nbsp;(t:&nbsp;<span class="constructor">Omd</span>.element)&nbsp;:&nbsp;<span class="constructor">Omd</span>.element&nbsp;&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Omd</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t&nbsp;<span class="keyword">with</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paragraph</span>&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Paragraph</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Emph</span>&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Emph</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bold</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Bold</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Ul</span>&nbsp;&nbsp;tl&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ul</span>&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="constructor">List</span>.map&nbsp;~f:transform_links)&nbsp;tl)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Ol</span>&nbsp;&nbsp;tl&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ol</span>&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="constructor">List</span>.map&nbsp;~f:transform_links)&nbsp;tl)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Ulp</span>&nbsp;tl&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ulp</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="constructor">List</span>.map&nbsp;~f:transform_links)&nbsp;tl)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Olp</span>&nbsp;tl&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Olp</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="constructor">List</span>.map&nbsp;~f:transform_links)&nbsp;tl)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">H1</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">H1</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">H2</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">H2</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">H3</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">H3</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">H4</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">H4</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">H5</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">H5</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">H6</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">H6</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Blockquote</span>&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Blockquote</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Text</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Br</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hr</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Img_ref</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Html</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Html_block</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Html_comment</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">NL</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">X</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Raw</span>&nbsp;_&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Raw_block</span>&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Img</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;e<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Code</span>&nbsp;(lang,&nbsp;code)&nbsp;<span class="keyword">when</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.sub&nbsp;code&nbsp;~index:(<span class="constructor">String</span>.length&nbsp;code&nbsp;-&nbsp;6)&nbsp;~length:6&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"--help"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;dbg&nbsp;"Code:&nbsp;%s&nbsp;%s"&nbsp;lang&nbsp;code;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;more_stuff_to_do&nbsp;:=&nbsp;<span class="keywordsign">`</span><span class="constructor">Create_man_page</span>&nbsp;code&nbsp;::&nbsp;!more_stuff_to_do;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Url</span>&nbsp;(code_url&nbsp;code,&nbsp;[<span class="constructor">Code</span>&nbsp;(lang,&nbsp;code)],&nbsp;code)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Code</span>&nbsp;(lang,&nbsp;code)&nbsp;<span class="keyword">when</span>&nbsp;looks_like_module_path&nbsp;~configuration&nbsp;code&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Url</span>&nbsp;(url_of_module_path&nbsp;~configuration&nbsp;code,&nbsp;[<span class="constructor">Code</span>&nbsp;(lang,&nbsp;code)],&nbsp;code)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Code</span>&nbsp;(lang,&nbsp;code)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Code</span>&nbsp;(lang,&nbsp;code)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Code_block</span>&nbsp;(lang,&nbsp;code)&nbsp;<span class="keyword">as</span>&nbsp;code_block&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(_&nbsp;:&nbsp;<span class="constructor">Higlo</span>.lexer)&nbsp;=&nbsp;<span class="constructor">Higlo</span>.get_lexer&nbsp;lang&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Raw</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&lt;pre&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;(<span class="constructor">Higlo</span>.to_xtmpl&nbsp;~lang&nbsp;code&nbsp;|&gt;&nbsp;<span class="constructor">Xtmpl</span>.string_of_xmls)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;/pre&gt;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;code_block<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Url</span>&nbsp;(href,&nbsp;t,&nbsp;title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;href&nbsp;0&nbsp;7&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"http://"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;href&nbsp;0&nbsp;8&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"https://"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;href&nbsp;0&nbsp;6&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"ftp://"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Url</span>&nbsp;(href,&nbsp;t,&nbsp;title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Url</span>&nbsp;(href,&nbsp;t,&nbsp;title)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">File_kind</span>.identify_file&nbsp;href&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Markdown</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Url</span>&nbsp;(sprintf&nbsp;<span class="string">"./%s.html"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;m),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t,&nbsp;title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ocaml_interface</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;modname&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;m&nbsp;|&gt;&nbsp;<span class="constructor">Legacy_string</span>.capitalize&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Url</span>&nbsp;(sprintf&nbsp;<span class="string">"api/%s.html"</span>&nbsp;modname,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t,&nbsp;title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ocaml_implementation</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Url</span>&nbsp;(sprintf&nbsp;<span class="string">"%s.html"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;m),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t,&nbsp;title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Other</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Url</span>&nbsp;(href,&nbsp;<span class="constructor">List</span>.map&nbsp;~f:transform_links&nbsp;t,&nbsp;title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Ref</span>&nbsp;&nbsp;(ref_container,&nbsp;name,&nbsp;string,&nbsp;_)&nbsp;<span class="keyword">as</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;e<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_paragraphs&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">E</span>&nbsp;=&nbsp;<span class="constructor">Omd_parser</span>.<span class="constructor">Default_env</span>(<span class="keyword">struct</span>&nbsp;<span class="keyword">end</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Parser</span>&nbsp;=&nbsp;<span class="constructor">Omd_parser</span>.<span class="constructor">Make</span>(<span class="constructor">E</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Parser</span>.make_paragraphs&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Meta_result</span>.return&nbsp;~more_things_todo:!more_stuff_to_do&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Omd_parser</span>.default_parse<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~extensions:[highligh]&nbsp;(<span class="constructor">Omd_lexer</span>.lex&nbsp;content)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;make_paragraphs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:transform_links)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_html&nbsp;~(configuration:_&nbsp;configuration)&nbsp;content&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Meta_result</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preprocess&nbsp;~configuration&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="constructor">Omd</span>.(to_html&nbsp;p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_toc&nbsp;~configuration&nbsp;content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Meta_result</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preprocess&nbsp;~configuration&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="constructor">Omd</span>.(to_html&nbsp;(toc&nbsp;~start:[0]&nbsp;p))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_html_and_toc&nbsp;~configuration&nbsp;content&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Meta_result</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preprocess&nbsp;~configuration&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="constructor">Omd</span>.(to_html&nbsp;p,&nbsp;to_html&nbsp;(toc&nbsp;~start:[1]&nbsp;&nbsp;p))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Omd.(to_html&nbsp;p,&nbsp;to_html&nbsp;(toc&nbsp;&nbsp;~start:[1]&nbsp;p))&nbsp;*)</span><br>
<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="comment">(*M<br>
<br>
Converting&nbsp;OCaml&nbsp;to&nbsp;HTML<br>
------------------------<br>
<br>
OCaml&nbsp;code&nbsp;with&nbsp;special&nbsp;Markdown&nbsp;comments&nbsp;will&nbsp;be&nbsp;transformed&nbsp;into&nbsp;HTML.<br>
<br>
M*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Ocaml</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Meta_result</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_html&nbsp;~configuration&nbsp;code&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;remove_comments&nbsp;s&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.sub_exn&nbsp;s&nbsp;~index:3&nbsp;~length:(<span class="constructor">String</span>.length&nbsp;s&nbsp;-&nbsp;6)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Higlo</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;parsed&nbsp;=&nbsp;parse&nbsp;~lang:<span class="string">"ocaml"</span>&nbsp;code&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;flush_tokens&nbsp;revtoklist&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">List</span>.for_all&nbsp;revtoklist&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="constructor">Text</span>&nbsp;t&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">String</span>.strip&nbsp;t&nbsp;=&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;html&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Xtmpl</span>.string_of_xmls<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.rev_map&nbsp;~f:<span class="constructor">Higlo</span>.token_to_xtmpl&nbsp;revtoklist)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&lt;pre&gt;"</span>&nbsp;^&nbsp;html&nbsp;^&nbsp;<span class="string">"&lt;/pre&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;acc_tokens&nbsp;acc_html&nbsp;acc_toc&nbsp;tokens&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;tokens&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.rev&nbsp;acc_toc&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"\n"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Markdown</span>.to_toc&nbsp;~configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;toc&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(<span class="constructor">List</span>.rev&nbsp;(flush_tokens&nbsp;acc_tokens&nbsp;::&nbsp;acc_html)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"\n"</span>,&nbsp;toc)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;one&nbsp;::&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;one&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bcomment</span>&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Lcomment</span>&nbsp;com&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">String</span>.sub&nbsp;com&nbsp;~index:0&nbsp;~length:3&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"(*M"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;html_code&nbsp;=&nbsp;flush_tokens&nbsp;acc_tokens&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;comment_content&nbsp;=&nbsp;remove_comments&nbsp;com&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Markdown</span>.to_html&nbsp;~configuration&nbsp;comment_content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;html_comment&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;[]&nbsp;(html_comment&nbsp;::&nbsp;html_code&nbsp;::&nbsp;acc_html)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(comment_content&nbsp;::&nbsp;acc_toc)&nbsp;more<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;tok&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;(tok&nbsp;::&nbsp;acc_tokens)&nbsp;acc_html&nbsp;acc_toc&nbsp;more<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;[]&nbsp;[]&nbsp;[]&nbsp;parsed<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="comment">(*M<br>
<br>
HTML&nbsp;Template<br>
-------------<br>
<br>
M*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Template</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_page&nbsp;~title&nbsp;~stylesheets&nbsp;~toc&nbsp;~menu&nbsp;content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;link&nbsp;css&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"&lt;link&nbsp;rel=\"stylesheet\"&nbsp;href=%S&nbsp;type=\"text/css\"&gt;"</span>&nbsp;css&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Meta_result</span>.return&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&lt;!DOCTYPE&nbsp;html&gt;&nbsp;&lt;html&gt;&nbsp;&lt;head&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"\n"</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;stylesheets&nbsp;~f:link)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;meta&nbsp;charset=\"utf-8\"&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"&lt;title&gt;%s&lt;/title&gt;"</span>&nbsp;title<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;/head&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;body&gt;&lt;div&nbsp;class=\"container\"&gt;"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"&lt;h1&gt;%s&lt;/h1&gt;"</span>&nbsp;title<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;div&nbsp;class=\"row\"&gt;\n&lt;div&nbsp;class=\"col-md-3\"&gt;\n&lt;h2&gt;Contents&lt;/h2&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;toc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;h2&gt;Menu&lt;/h2&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;menu<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;/div&gt;&lt;div&nbsp;class=\"col-md-9\"&gt;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;html&gt;"</span>)<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="comment">(*M<br>
<br>
Some&nbsp;Utilities<br>
--------------<br>
<br>
M*)</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Utilities</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(//)&nbsp;=&nbsp;<span class="constructor">Filename</span>.concat<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Sys</span>.getenv&nbsp;s)&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;failwithf&nbsp;fmt&nbsp;=&nbsp;ksprintf&nbsp;failwith&nbsp;fmt<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;succeed&nbsp;s&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Sys</span>.command&nbsp;s&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwithf&nbsp;<span class="string">"Command&nbsp;%S&nbsp;did&nbsp;not&nbsp;succeed:&nbsp;%d"</span>&nbsp;s&nbsp;other<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;succeedf&nbsp;fmt=&nbsp;ksprintf&nbsp;succeed&nbsp;fmt<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;all_files&nbsp;dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.readdir&nbsp;dir&nbsp;|&gt;&nbsp;<span class="constructor">Array</span>.to_list&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.filter_map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;d&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;p&nbsp;=&nbsp;dir&nbsp;//&nbsp;d&nbsp;<span class="keyword">in</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Sys</span>.is_directory&nbsp;p&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">Some</span>&nbsp;p)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;read_file&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;open_in&nbsp;f&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buf&nbsp;=&nbsp;<span class="constructor">Buffer</span>.create&nbsp;42&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Buffer</span>.add_channel&nbsp;buf&nbsp;i&nbsp;1;&nbsp;loop&nbsp;()&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;close_in&nbsp;i;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Buffer</span>.contents&nbsp;buf<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;write_file&nbsp;f&nbsp;~content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;o&nbsp;=&nbsp;open_out&nbsp;f&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;output_string&nbsp;o&nbsp;content;<br>
&nbsp;&nbsp;&nbsp;&nbsp;close_out&nbsp;o<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;parse_list_of_substitutions&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;subs&nbsp;=&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">','</span>)&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.filter_map&nbsp;subs&nbsp;~f:(<span class="keyword">fun</span>&nbsp;sub&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">':'</span>)&nbsp;(<span class="constructor">String</span>.strip&nbsp;sub)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[one;&nbsp;two]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(one,&nbsp;two)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Utilities</span><br>
<span class="keyword">let</span>&nbsp;say&nbsp;fmt&nbsp;=&nbsp;<span class="constructor">Printf</span>.(ksprintf&nbsp;(printf&nbsp;<span class="string">"%s\n"</span>))&nbsp;fmt<br>
<br>
<br>
<span class="comment">(*M<br>
<br>
Configuration<br>
-------------<br>
<br>
M*)</span><br>
<span class="keyword">let</span>&nbsp;default_stylesheets&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;<span class="string">"https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css"</span>;<br>
&nbsp;&nbsp;<span class="string">"http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css"</span>;<br>
&nbsp;&nbsp;<span class="string">"http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css"</span>;<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;&lt;link&nbsp;rel="stylesheet"&nbsp;href="code_style.css"&nbsp;type="text/css"&gt;&nbsp;*)</span><br>
]<br>
<br>
<span class="keyword">let</span>&nbsp;configuration&nbsp;=&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">object</span>&nbsp;(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;output_directory&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"OUTPUT_DIR"</span>&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"_doc"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;input_files&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"INPUT"</span>&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">','</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Sys</span>.is_directory&nbsp;path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;all_files&nbsp;path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;[path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.concat<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;index_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"INDEX"</span>&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"README.md"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;stylesheets&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"CSS"</span>&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.map&nbsp;~f:(<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">','</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:default_stylesheets<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;api_doc_directory&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"API"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;title_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"TITLE_PREFIX"</span>&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;title_substitutions&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"TITLE_SUBSTITUTIONS"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:[]&nbsp;~f:parse_list_of_substitutions<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;title&nbsp;?(with_prefix=<span class="keyword">true</span>)&nbsp;t&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tt&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;self<span class="keywordsign">#</span>title_substitutions&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keyword">when</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;t&nbsp;<span class="keywordsign">||</span>&nbsp;(<span class="keyword">try</span>&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;a&nbsp;=&nbsp;t&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.map&nbsp;t&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="string">'_'</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">'&nbsp;'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s%s"</span>&nbsp;(<span class="keyword">if</span>&nbsp;with_prefix&nbsp;<span class="keyword">then</span>&nbsp;self<span class="keywordsign">#</span>title_prefix&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)&nbsp;tt<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;command_substitutions&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"COMMAND_SUBSTITUTIONS"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:[]&nbsp;~f:parse_list_of_substitutions<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;catch_module_paths&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"CATCH_MODULE_PATHS"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:[]&nbsp;~f:parse_list_of_substitutions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.filter_map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(pattern,&nbsp;prefix)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(pattern,&nbsp;<span class="constructor">Re_posix</span>.compile_pat&nbsp;pattern,&nbsp;prefix)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;add_to_menu&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"ADD_TO_MENU"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list_of_paths&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;l&nbsp;~f:(sprintf&nbsp;<span class="string">"&nbsp;&nbsp;-&nbsp;%S"</span>)&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"\n"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;variable_note&nbsp;var&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"&nbsp;&nbsp;(%S&nbsp;is&nbsp;%s)"</span>&nbsp;var<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;env&nbsp;var&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"empty"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%S"</span>&nbsp;s)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Output&nbsp;directory:&nbsp;%s"</span>&nbsp;self<span class="keywordsign">#</span>output_directory;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"OUTPUT_DIR"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Input&nbsp;files:\n%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(list_of_paths&nbsp;self<span class="keywordsign">#</span>input_files);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"INPUT"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Style&nbsp;sheets:\n%s"</span>&nbsp;(list_of_paths&nbsp;self<span class="keywordsign">#</span>stylesheets);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"CSS"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;self<span class="keywordsign">#</span>api_doc_directory&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"Getting&nbsp;API&nbsp;docs&nbsp;from:&nbsp;%S"</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"No&nbsp;getting&nbsp;API&nbsp;docs&nbsp;(*Warning*)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"API"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Title&nbsp;prefix:&nbsp;%S"</span>&nbsp;self<span class="keywordsign">#</span>title_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"TITLE_PREFIX"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Command&nbsp;substitutions:"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;self<span class="keywordsign">#</span>command_substitutions&nbsp;(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"&nbsp;&nbsp;-&nbsp;%s&nbsp;→&nbsp;%s"</span>&nbsp;a&nbsp;b);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"COMMAND_SUBSTITUTIONS"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Index&nbsp;file:&nbsp;%s"</span>&nbsp;self<span class="keywordsign">#</span>index_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"INDEX"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Catch&nbsp;module&nbsp;paths:"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;self<span class="keywordsign">#</span>catch_module_paths&nbsp;(<span class="keyword">fun</span>&nbsp;(a,_,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"&nbsp;&nbsp;-&nbsp;%S&nbsp;→&nbsp;Prefix:&nbsp;%s"</span>&nbsp;a&nbsp;b);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"CATCH_MODULE_PATHS"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Add&nbsp;to&nbsp;the&nbsp;menu:&nbsp;%S"</span>&nbsp;self<span class="keywordsign">#</span>add_to_menu;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variable_note&nbsp;<span class="string">"ADD_TO_MENU"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="comment">(*M<br>
<br>
Main&nbsp;Entry&nbsp;Point<br>
----------------<br>
<br>
M*)</span><br>
<span class="keyword">let</span>&nbsp;main&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Meta_result</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;succeedf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;configuration<span class="keywordsign">#</span>output_directory;<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;configuration<span class="keywordsign">#</span>api_doc_directory&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;succeedf&nbsp;<span class="string">"rsync&nbsp;-a&nbsp;%s/&nbsp;%s/api"</span>&nbsp;s&nbsp;configuration<span class="keywordsign">#</span>output_directory<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"Warning,&nbsp;no&nbsp;API&nbsp;docs"</span><br>
&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;menu_md&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"-&nbsp;[Home](index.html)\n"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;(<span class="constructor">List</span>.map&nbsp;configuration<span class="keywordsign">#</span>input_files&nbsp;~f:(<span class="keyword">fun</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">File_kind</span>.identify_file&nbsp;path&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Markdown</span>&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ocaml_implementation</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;base&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;configuration<span class="keywordsign">#</span>title&nbsp;~with_prefix:<span class="keyword">false</span>&nbsp;base&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"-&nbsp;[%s](%s.html)\n"</span>&nbsp;title&nbsp;base<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;configuration<span class="keywordsign">#</span>api_doc_directory&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"-&nbsp;[API&nbsp;Documentation](./api/index.html)\n"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration<span class="keywordsign">#</span>add_to_menu;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">""</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;first_pass_result&nbsp;:&nbsp;(unit,&nbsp;_)&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Markdown</span>.to_html&nbsp;~configuration&nbsp;menu_md<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;menu&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Markdown</span>.to_html_and_toc&nbsp;~configuration&nbsp;(read_file&nbsp;configuration<span class="keywordsign">#</span>index_file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(content,&nbsp;toc)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;configuration<span class="keywordsign">#</span>title&nbsp;<span class="string">"Home"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Template</span>.make_page&nbsp;~menu&nbsp;~title&nbsp;~stylesheets:configuration<span class="keywordsign">#</span>stylesheets&nbsp;~toc&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;markdown_index&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;write_file&nbsp;(configuration<span class="keywordsign">#</span>output_directory&nbsp;//&nbsp;<span class="string">"index.html"</span>)&nbsp;~content:markdown_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.fold&nbsp;~init:(return&nbsp;())&nbsp;configuration<span class="keywordsign">#</span>input_files&nbsp;~f:<span class="keyword">begin</span>&nbsp;<span class="keyword">fun</span>&nbsp;prev&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">File_kind</span>.identify_file&nbsp;path&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Markdown</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;base&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;m&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;configuration<span class="keywordsign">#</span>title&nbsp;base&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Markdown</span>.to_html_and_toc&nbsp;~configuration&nbsp;(read_file&nbsp;path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(content,&nbsp;toc)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Template</span>.make_page&nbsp;~menu&nbsp;~title&nbsp;~stylesheets:configuration<span class="keywordsign">#</span>stylesheets&nbsp;~toc&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;content&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_file&nbsp;(configuration<span class="keywordsign">#</span>output_directory&nbsp;//&nbsp;sprintf&nbsp;<span class="string">"%s.html"</span>&nbsp;base)&nbsp;~content;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ocaml_implementation</span>&nbsp;impl&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;base&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;impl&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;configuration<span class="keywordsign">#</span>title&nbsp;base&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ocaml</span>.to_html&nbsp;~configuration&nbsp;(read_file&nbsp;path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(content,&nbsp;toc)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Template</span>.make_page&nbsp;~title&nbsp;~menu&nbsp;&nbsp;~stylesheets:configuration<span class="keywordsign">#</span>stylesheets&nbsp;~toc&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;content&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_file&nbsp;(configuration<span class="keywordsign">#</span>output_directory&nbsp;//&nbsp;sprintf&nbsp;<span class="string">"%s.html"</span>&nbsp;base)&nbsp;~content;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;succeedf&nbsp;<span class="string">"cp&nbsp;%s&nbsp;%s/"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;path)&nbsp;configuration<span class="keywordsign">#</span>output_directory;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">List</span>.dedup&nbsp;first_pass_result.more_things_todo&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.iter&nbsp;~f:<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Create_man_page</span>&nbsp;cmd&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;actual_cmd&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stripped&nbsp;=&nbsp;<span class="constructor">String</span>.strip&nbsp;cmd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;configuration<span class="keywordsign">#</span>command_substitutions&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(left,&nbsp;right)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.(sub&nbsp;stripped&nbsp;~index:0&nbsp;~length:(length&nbsp;left))&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;prefix&nbsp;<span class="keyword">when</span>&nbsp;prefix&nbsp;=&nbsp;left&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(right<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="constructor">String</span>.(sub_exn&nbsp;stripped&nbsp;~index:(length&nbsp;left)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~length:(length&nbsp;stripped&nbsp;-&nbsp;length&nbsp;left)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>)&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:stripped<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file&nbsp;=&nbsp;configuration<span class="keywordsign">#</span>output_directory&nbsp;//&nbsp;<span class="constructor">Markdown</span>.code_url&nbsp;cmd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bash_cmd&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"set&nbsp;-o&nbsp;pipefail&nbsp;;&nbsp;%s=groff&nbsp;|&nbsp;groff&nbsp;-Thtml&nbsp;-mandoc&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actual_cmd&nbsp;output_file&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;succeedf&nbsp;<span class="string">"bash&nbsp;-c&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;bash_cmd)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;succeedf&nbsp;<span class="string">"(echo&nbsp;'```'&nbsp;;&nbsp;%s&nbsp;;&nbsp;echo&nbsp;'```')&nbsp;&gt;&nbsp;%s"</span>&nbsp;actual_cmd&nbsp;output_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Markdown</span>.to_html_and_toc&nbsp;~configuration&nbsp;(read_file&nbsp;output_file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(content,&nbsp;toc)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Markdown</span>.to_html&nbsp;~configuration&nbsp;menu_md<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;menu&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Template</span>.make_page&nbsp;~menu&nbsp;~title:cmd&nbsp;~stylesheets:configuration<span class="keywordsign">#</span>stylesheets&nbsp;~toc:<span class="string">""</span>&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;content&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_file&nbsp;(output_file)&nbsp;~content;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;()<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Array</span>.to_list&nbsp;<span class="constructor">Sys</span>.argv&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[&nbsp;_&nbsp;]&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;main&nbsp;()<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;exec&nbsp;::&nbsp;<span class="string">"--help"</span>&nbsp;::&nbsp;_&nbsp;<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;exec&nbsp;::&nbsp;<span class="string">"-h"</span>&nbsp;::&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Usage:&nbsp;[ENV_VAR=...]&nbsp;%s"</span>&nbsp;exec;<br>
&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Current&nbsp;configuration:"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration<span class="keywordsign">#</span>display<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;exec&nbsp;::&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Wrong&nbsp;command&nbsp;line"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;1<br>
<br>
</code></body></html>