 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Nonstd: Literate Implementation</title></head><body><div class="container"><h1>Nonstd: Literate Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='nonstd.html'>Literate Implementation</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Repository <a href='https://bitbucket.org/smondet/nonstd'>at Bitbucket</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="text">
</span><span class="kw">external</span><span class="text"> (|&gt;) : '</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; '</span><span class="id">b</span><span class="text">) -&gt; '</span><span class="id">b</span><span class="text"> = </span><span class="string">&quot;%revapply&quot;</span><span class="text">

</span><span class="kw">include</span><span class="text"> </span><span class="kw2">Printf</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">List</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="comment">(* This module takes code from Janestreet's Core library:

    Copyright (C) 2008-
      Jane Street Holding, LLC
      1 New York Plaza, 33rd Floor
      New York, NY 10004
      USA

    email: opensource@janestreet.com

    The contents of some files in this distribution was derived from external
    sources with compatible licenses. The original copyright and license
    notice was preserved in the affected files.

    See https://github.com/janestreet/core/blob/master/COPYRIGHT.txt
  *)</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">ListLabels</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">hd_exn</span><span class="text"> = </span><span class="id">hd</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">hd</span><span class="text"> = </span><span class="kw">function</span><span class="text"> </span><span class="id">o</span><span class="text"> :: </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">o</span><span class="text"> | [] -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">tl_exn</span><span class="text"> = </span><span class="id">tl</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">tl</span><span class="text"> = </span><span class="kw">function</span><span class="text"> [] -&gt; </span><span class="kw2">None</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">t</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">nth</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">nth_aux</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | [] -&gt; </span><span class="kw2">None</span><span class="text">
        | </span><span class="id">a</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">nth_aux</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="id">n</span><span class="numeric">-1</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">nth_aux</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">nth_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">nth</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt;
      </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">invalid_arg</span><span class="text"> </span><span class="string">&quot;List.nth_exn %d called on list of length %d&quot;</span><span class="text">
        </span><span class="id">n</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text">)
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">a</span><span class="text"> -&gt; </span><span class="id">a</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="id">fold_left</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">rev_filter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">find</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">accu</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="id">accu</span><span class="text">
    | </span><span class="id">x</span><span class="text"> :: </span><span class="id">l</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">find</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> (</span><span class="id">x</span><span class="text"> :: </span><span class="id">accu</span><span class="text">) </span><span class="id">l</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">find</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">accu</span><span class="text"> </span><span class="id">l</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">find</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> [] </span><span class="id">t</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">filter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">rev</span><span class="text"> (</span><span class="id">rev_filter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find_map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="id">x</span><span class="text"> :: </span><span class="id">l</span><span class="text"> -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> </span><span class="id">l</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">r</span><span class="text"> -&gt; </span><span class="id">r</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="id">t</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="id">x</span><span class="text"> :: </span><span class="id">l</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">l</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="id">t</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">find</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">findi</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">t</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt; </span><span class="kw2">None</span><span class="text">
      | </span><span class="id">x</span><span class="text"> :: </span><span class="id">l</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">i</span><span class="text">, </span><span class="id">x</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">l</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** changing the order of arguments on some standard [List] functions. *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">exists</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">exists</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_all</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">for_all</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">

  </span><span class="comment">(** For the container interface. *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">fold_left</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~init</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold_left</span><span class="text"> = </span><span class="id">fold</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_array</span><span class="text"> = </span><span class="kw2">Array</span><span class="text">.</span><span class="id">of_list</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_list</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Tail recursive versions of standard [List] module *)</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">slow_append</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> = </span><span class="id">rev_append</span><span class="text"> (</span><span class="id">rev</span><span class="text"> </span><span class="id">l1</span><span class="text">) </span><span class="id">l2</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">count_append</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="id">count</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; </span><span class="id">l1</span><span class="text">
    | </span><span class="numeric">_</span><span class="text"> -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | []               -&gt;                         </span><span class="id">l2</span><span class="text">
      | [</span><span class="id">x1</span><span class="text">]             -&gt; </span><span class="id">x1</span><span class="text">                   :: </span><span class="id">l2</span><span class="text">
      | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">]         -&gt; </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text">             :: </span><span class="id">l2</span><span class="text">
      | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">]     -&gt; </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text">       :: </span><span class="id">l2</span><span class="text">
      | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">; </span><span class="id">x4</span><span class="text">] -&gt; </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">l2</span><span class="text">
      | </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">x5</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
        </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">x5</span><span class="text"> ::
          (</span><span class="kw1">if</span><span class="text"> </span><span class="id">count</span><span class="text"> &gt; </span><span class="numeric">1000</span><span class="text">
           </span><span class="kw1">then</span><span class="text"> </span><span class="id">slow_append</span><span class="text"> </span><span class="id">tl</span><span class="text"> </span><span class="id">l2</span><span class="text">
           </span><span class="kw1">else</span><span class="text"> </span><span class="id">count_append</span><span class="text"> </span><span class="id">tl</span><span class="text"> </span><span class="id">l2</span><span class="text"> (</span><span class="id">count</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">append</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> = </span><span class="id">count_append</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="numeric">0</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">map_slow</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">rev</span><span class="text"> (</span><span class="id">rev_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">count_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">ctr</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; []
    | [</span><span class="id">x1</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">; </span><span class="id">x4</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x4</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">; </span><span class="id">f4</span><span class="text">]
    | </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">x5</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x4</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f5</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x5</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">f1</span><span class="text"> :: </span><span class="id">f2</span><span class="text"> :: </span><span class="id">f3</span><span class="text"> :: </span><span class="id">f4</span><span class="text"> :: </span><span class="id">f5</span><span class="text"> ::
        (</span><span class="kw1">if</span><span class="text"> </span><span class="id">ctr</span><span class="text"> &gt; </span><span class="numeric">1000</span><span class="text">
         </span><span class="kw1">then</span><span class="text"> </span><span class="id">map_slow</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl</span><span class="text">
         </span><span class="kw1">else</span><span class="text"> </span><span class="id">count_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">count_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="numeric">0</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold_right</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> =
    </span><span class="id">fold</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">a</span><span class="text">) </span><span class="kw4">~init</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">l</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">rev_mapi</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~i</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">acc</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="id">acc</span><span class="text">
    | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">h</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">t</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="id">i</span><span class="text"> [] </span><span class="id">l</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">count_mapi</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">ctr</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; []
    | [</span><span class="id">x1</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">ctr</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">ctr</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">ctr</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">2</span><span class="text">) </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">; </span><span class="id">x4</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">ctr</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">2</span><span class="text">) </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">3</span><span class="text">) </span><span class="id">x4</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">; </span><span class="id">f4</span><span class="text">]
    | </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">x5</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">ctr</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">2</span><span class="text">) </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">3</span><span class="text">) </span><span class="id">x4</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f5</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">4</span><span class="text">) </span><span class="id">x5</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">f1</span><span class="text"> :: </span><span class="id">f2</span><span class="text"> :: </span><span class="id">f3</span><span class="text"> :: </span><span class="id">f4</span><span class="text"> :: </span><span class="id">f5</span><span class="text"> ::
        (</span><span class="kw1">if</span><span class="text"> </span><span class="id">ctr</span><span class="text"> &gt; </span><span class="numeric">5000</span><span class="text">
          </span><span class="kw1">then</span><span class="text"> </span><span class="id">rev_mapi</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~i</span><span class="text">:(</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">5</span><span class="text">) </span><span class="id">tl</span><span class="text">
          </span><span class="kw1">else</span><span class="text"> </span><span class="id">count_mapi</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">5</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">mapi</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">count_mapi</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="numeric">0</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map2_slow</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">rev_map2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">count_map2_exn</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="id">ctr</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">l1</span><span class="text">, </span><span class="id">l2</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [], [] -&gt; []
    | [</span><span class="id">x1</span><span class="text">], [</span><span class="id">y1</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="id">y1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">], [</span><span class="id">y1</span><span class="text">; </span><span class="id">y2</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="id">y1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="id">y2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">], [</span><span class="id">y1</span><span class="text">; </span><span class="id">y2</span><span class="text">; </span><span class="id">y3</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="id">y1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="id">y2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="id">y3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">]
    | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">; </span><span class="id">x4</span><span class="text">], [</span><span class="id">y1</span><span class="text">; </span><span class="id">y2</span><span class="text">; </span><span class="id">y3</span><span class="text">; </span><span class="id">y4</span><span class="text">] -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="id">y1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="id">y2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="id">y3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x4</span><span class="text"> </span><span class="id">y4</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">; </span><span class="id">f4</span><span class="text">]
    | </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">x5</span><span class="text"> :: </span><span class="id">tl1</span><span class="text">,
      </span><span class="id">y1</span><span class="text"> :: </span><span class="id">y2</span><span class="text"> :: </span><span class="id">y3</span><span class="text"> :: </span><span class="id">y4</span><span class="text"> :: </span><span class="id">y5</span><span class="text"> :: </span><span class="id">tl2</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="id">y1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="id">y2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="id">y3</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x4</span><span class="text"> </span><span class="id">y4</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f5</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x5</span><span class="text"> </span><span class="id">y5</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">f1</span><span class="text"> :: </span><span class="id">f2</span><span class="text"> :: </span><span class="id">f3</span><span class="text"> :: </span><span class="id">f4</span><span class="text"> :: </span><span class="id">f5</span><span class="text"> ::
        (</span><span class="kw1">if</span><span class="text"> </span><span class="id">ctr</span><span class="text"> &gt; </span><span class="numeric">1000</span><span class="text">
          </span><span class="kw1">then</span><span class="text"> </span><span class="id">map2_slow</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl1</span><span class="text"> </span><span class="id">tl2</span><span class="text">
          </span><span class="kw1">else</span><span class="text"> </span><span class="id">count_map2_exn</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl1</span><span class="text"> </span><span class="id">tl2</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))
    | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;count_map2&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map2_exn</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">count_map2_exn</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="numeric">0</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">iteri</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="id">ignore</span><span class="text"> (</span><span class="id">fold</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text">; </span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">foldi</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> =
    </span><span class="id">snd</span><span class="text"> (</span><span class="id">fold</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="numeric">0</span><span class="text">, </span><span class="id">init</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">i</span><span class="text">, </span><span class="id">acc</span><span class="text">) </span><span class="id">v</span><span class="text"> -&gt; (</span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">, </span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">v</span><span class="text">)))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">filteri</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">foldi</span><span class="text"> </span><span class="id">l</span><span class="text">
                </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">pos</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt;
                    </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">pos</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">x</span><span class="text"> :: </span><span class="id">acc</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">acc</span><span class="text">)
                </span><span class="kw4">~init</span><span class="text">:[])

  </span><span class="kw">let</span><span class="text"> </span><span class="id">reduce</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [] -&gt; </span><span class="kw2">None</span><span class="text">
  | </span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">fold</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="id">hd</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">concat_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">aux</span><span class="text"> </span><span class="id">acc</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">acc</span><span class="text">
    | </span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="id">aux</span><span class="text"> (</span><span class="id">rev_append</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">hd</span><span class="text">) </span><span class="id">acc</span><span class="text">) </span><span class="id">tl</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">aux</span><span class="text"> [] </span><span class="id">l</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">concat_mapi</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">aux</span><span class="text"> </span><span class="id">cont</span><span class="text"> </span><span class="id">acc</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">acc</span><span class="text">
    | </span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="id">aux</span><span class="text"> (</span><span class="id">cont</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">rev_append</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">cont</span><span class="text"> </span><span class="id">hd</span><span class="text">) </span><span class="id">acc</span><span class="text">) </span><span class="id">tl</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">aux</span><span class="text"> </span><span class="numeric">0</span><span class="text"> [] </span><span class="id">l</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">merge</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~cmp</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">l1</span><span class="text">,</span><span class="id">l2</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [], </span><span class="id">l2</span><span class="text"> -&gt; </span><span class="id">rev_append</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">l2</span><span class="text">
      | </span><span class="id">l1</span><span class="text">, [] -&gt; </span><span class="id">rev_append</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">l1</span><span class="text">
      | </span><span class="id">h1</span><span class="text"> :: </span><span class="id">t1</span><span class="text">, </span><span class="id">h2</span><span class="text"> :: </span><span class="id">t2</span><span class="text"> -&gt;
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">cmp</span><span class="text"> </span><span class="id">h1</span><span class="text"> </span><span class="id">h2</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text">
        </span><span class="kw1">then</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">h1</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">t1</span><span class="text"> </span><span class="id">l2</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">h2</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">l1</span><span class="text"> </span><span class="id">t2</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> [] </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">last</span><span class="text"> </span><span class="kw3">list</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="kw3">list</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [</span><span class="id">x</span><span class="text">] -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">x</span><span class="text">
  | </span><span class="numeric">_</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="id">last</span><span class="text"> </span><span class="id">tl</span><span class="text">
  | [] -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">remove_consecutive_duplicates</span><span class="text"> </span><span class="kw3">list</span><span class="text"> </span><span class="kw4">~equal</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="kw3">list</span><span class="text"> </span><span class="id">accum</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="kw3">list</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; </span><span class="id">accum</span><span class="text">
    | </span><span class="id">hd</span><span class="text"> :: [] -&gt; </span><span class="id">hd</span><span class="text"> :: </span><span class="id">accum</span><span class="text">
    | </span><span class="id">hd1</span><span class="text"> :: </span><span class="id">hd2</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">equal</span><span class="text"> </span><span class="id">hd1</span><span class="text"> </span><span class="id">hd2</span><span class="text">
      </span><span class="kw1">then</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">hd2</span><span class="text"> :: </span><span class="id">tl</span><span class="text">) </span><span class="id">accum</span><span class="text">
      </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">hd2</span><span class="text"> :: </span><span class="id">tl</span><span class="text">) (</span><span class="id">hd1</span><span class="text"> :: </span><span class="id">accum</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">rev</span><span class="text"> (</span><span class="id">loop</span><span class="text"> </span><span class="kw3">list</span><span class="text"> [])

  </span><span class="kw">let</span><span class="text"> </span><span class="id">dedup</span><span class="text"> ?(</span><span class="id">compare</span><span class="text">=</span><span class="kw2">Pervasives</span><span class="text">.</span><span class="id">compare</span><span class="text">) </span><span class="kw3">list</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">equal</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">x</span><span class="text">' = </span><span class="id">compare</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">x</span><span class="text">' = </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sorted</span><span class="text"> = </span><span class="id">sort</span><span class="text"> </span><span class="kw4">~cmp</span><span class="text">:</span><span class="id">compare</span><span class="text"> </span><span class="kw3">list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">remove_consecutive_duplicates</span><span class="text"> </span><span class="kw4">~equal</span><span class="text"> </span><span class="id">sorted</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">contains_dup</span><span class="text"> ?</span><span class="id">compare</span><span class="text"> </span><span class="id">lst</span><span class="text"> = </span><span class="id">length</span><span class="text"> (</span><span class="id">dedup</span><span class="text"> ?</span><span class="id">compare</span><span class="text"> </span><span class="id">lst</span><span class="text">) &lt;&gt; </span><span class="id">length</span><span class="text"> </span><span class="id">lst</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find_a_dup</span><span class="text"> ?(</span><span class="id">compare</span><span class="text">=</span><span class="kw2">Pervasives</span><span class="text">.</span><span class="id">compare</span><span class="text">) </span><span class="id">l</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sorted</span><span class="text"> = </span><span class="id">sort</span><span class="text"> </span><span class="kw4">~cmp</span><span class="text">:</span><span class="id">compare</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      [] | [</span><span class="numeric">_</span><span class="text">] -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="id">hd1</span><span class="text"> :: </span><span class="id">hd2</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">compare</span><span class="text"> </span><span class="id">hd1</span><span class="text"> </span><span class="id">hd2</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">hd1</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">hd2</span><span class="text"> :: </span><span class="id">tl</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="id">sorted</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">init</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> []
    </span><span class="kw1">else</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">accum</span><span class="text"> =
        </span><span class="kw1">assert</span><span class="text"> (</span><span class="id">i</span><span class="text"> &gt;= </span><span class="numeric">0</span><span class="text">);
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">accum</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">i</span><span class="numeric">-1</span><span class="text">) (</span><span class="id">f</span><span class="text"> (</span><span class="id">i</span><span class="numeric">-1</span><span class="text">) :: </span><span class="id">accum</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text"> []

  </span><span class="kw">let</span><span class="text"> </span><span class="id">rev_filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">accum</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt; </span><span class="id">accum</span><span class="text">
      | </span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">hd</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> </span><span class="id">tl</span><span class="text"> (</span><span class="id">x</span><span class="text"> :: </span><span class="id">accum</span><span class="text">)
        | </span><span class="kw2">None</span><span class="text">   -&gt; </span><span class="id">loop</span><span class="text"> </span><span class="id">tl</span><span class="text"> </span><span class="id">accum</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="id">l</span><span class="text"> []
  </span><span class="kw">let</span><span class="text"> </span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">rev_filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">filter_opt</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">partition_map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">fst</span><span class="text"> </span><span class="id">snd</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt; (</span><span class="id">rev</span><span class="text"> </span><span class="id">fst</span><span class="text">, </span><span class="id">rev</span><span class="text"> </span><span class="id">snd</span><span class="text">)
      | </span><span class="id">x</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Fst</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="id">y</span><span class="text"> :: </span><span class="id">fst</span><span class="text">) </span><span class="id">snd</span><span class="text">
        | `</span><span class="kw2">Snd</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">fst</span><span class="text"> (</span><span class="id">y</span><span class="text"> :: </span><span class="id">snd</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="id">t</span><span class="text"> [] []


  </span><span class="kw">let</span><span class="text"> </span><span class="id">split_n</span><span class="text"> </span><span class="id">t_orig</span><span class="text"> </span><span class="id">n</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text">
      ([], </span><span class="id">t_orig</span><span class="text">)
    </span><span class="kw1">else</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">accum</span><span class="text"> =
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text">
          (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">accum</span><span class="text">, </span><span class="id">t</span><span class="text">)
        </span><span class="kw1">else</span><span class="text">
          </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | [] -&gt; (</span><span class="id">t_orig</span><span class="text">, []) </span><span class="comment">(* in this case, t_orig = List.rev accum *)</span><span class="text">
          | </span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">) </span><span class="id">tl</span><span class="text"> (</span><span class="id">hd</span><span class="text"> :: </span><span class="id">accum</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="id">t_orig</span><span class="text"> []
  </span><span class="kw">let</span><span class="text"> </span><span class="id">take</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">fst</span><span class="text"> (</span><span class="id">split_n</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">drop</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">snd</span><span class="text"> (</span><span class="id">split_n</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">n</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">split_while</span><span class="text"> </span><span class="id">xs</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | </span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">hd</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">hd</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">tl</span><span class="text">
    | </span><span class="id">t</span><span class="text"> -&gt; (</span><span class="id">rev</span><span class="text"> </span><span class="id">acc</span><span class="text">, </span><span class="id">t</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> [] </span><span class="id">xs</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">take_while</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">fst</span><span class="text"> (</span><span class="id">split_while</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">drop_while</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">snd</span><span class="text"> (</span><span class="id">split_while</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">)


</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Array</span><span class="text"> = </span><span class="kw2">ArrayLabels</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Option</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">No_value</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">value</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~default</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text"> | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">default</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">value_exn</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~msg</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">o</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">No_value</span><span class="text"> </span><span class="id">msg</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">value_map</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~default</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">default</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = 
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (</span><span class="kw10">&gt;&gt;=</span><span class="text">) </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw4">~f</span><span class="text">


</span><span class="kw1">end</span><span class="text">


</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Int</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">int</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> (</span><span class="id">a</span><span class="text">: </span><span class="kw3">int</span><span class="text">) (</span><span class="id">b</span><span class="text">: </span><span class="kw3">int</span><span class="text">) = </span><span class="id">compare</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">string_of_int</span><span class="text"> </span><span class="id">i</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_string</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">int_of_string</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

</span><span class="kw1">end</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Float</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">float</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> (</span><span class="id">a</span><span class="text">: </span><span class="kw3">float</span><span class="text">) (</span><span class="id">b</span><span class="text">: </span><span class="kw3">float</span><span class="text">) = </span><span class="id">compare</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">string_of_float</span><span class="text"> </span><span class="id">i</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_string</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">float_of_string</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
</span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>