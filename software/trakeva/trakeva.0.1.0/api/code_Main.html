<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Trakeva" rel="Chapter" href="Trakeva.html">
<link title="Trakeva_cache" rel="Chapter" href="Trakeva_cache.html">
<link title="Trakeva_of_uri" rel="Chapter" href="Trakeva_of_uri.html">
<link title="Trakeva_postgresql" rel="Chapter" href="Trakeva_postgresql.html">
<link title="Trakeva_sqlite" rel="Chapter" href="Trakeva_sqlite.html"><title>Trakeva API : Main</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;2015,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Pvem_lwt_unix</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Pvem_lwt_unix</span>.<span class="constructor">Deferred_result</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">String</span>&nbsp;=&nbsp;<span class="constructor">Sosa</span>.<span class="constructor">Native_string</span>&nbsp;<br>
<span class="keyword">let</span>&nbsp;(//)&nbsp;=&nbsp;<span class="constructor">Filename</span>.concat<br>
<br>
<span class="keyword">let</span>&nbsp;say&nbsp;fmt&nbsp;=&nbsp;ksprintf&nbsp;(printf&nbsp;<span class="string">"%s\n%!"</span>)&nbsp;fmt<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Test</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">exception</span>&nbsp;<span class="constructor">Tests_failed</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;max_failures&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"MAX_FAILURES"</span>&nbsp;|&gt;&nbsp;int_of_string&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;2_000_000<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;failed_tests&nbsp;=&nbsp;ref&nbsp;[]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fail&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;failed_tests&nbsp;:=&nbsp;s&nbsp;::&nbsp;!failed_tests;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">List</span>.length&nbsp;!failed_tests&nbsp;&gt;&nbsp;max_failures&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;!failed_tests&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eprintf&nbsp;<span class="string">"Failed&nbsp;test:&nbsp;%S\n%!"</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Tests_failed</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">else</span>&nbsp;()<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;new_tmp_dir&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;db_file&nbsp;=&nbsp;<span class="constructor">Filename</span>.temp_file&nbsp;&nbsp;<span class="string">"trakeva_tmp_test"</span>&nbsp;<span class="string">".d"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.command&nbsp;(sprintf&nbsp;<span class="string">"rm&nbsp;-rf&nbsp;%s"</span>&nbsp;db_file)&nbsp;|&gt;&nbsp;ignore;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.command&nbsp;(sprintf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;db_file)&nbsp;|&gt;&nbsp;ignore;<br>
&nbsp;&nbsp;&nbsp;&nbsp;db_file<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_monad&nbsp;name&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Lwt_main</span>.run&nbsp;(f&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Database</span>&nbsp;e)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;fail&nbsp;<span class="string">"%S&nbsp;ends&nbsp;with&nbsp;error:&nbsp;%s"</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Trakeva</span>.<span class="constructor">Error</span>.to_string&nbsp;e)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;check&nbsp;names&nbsp;c&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;c&nbsp;<span class="keyword">then</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;ksprintf&nbsp;fail&nbsp;<span class="string">"test.assert&nbsp;failed:&nbsp;%s"</span>&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;→&nbsp;"</span>&nbsp;names)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;now&nbsp;()&nbsp;=&nbsp;<span class="constructor">Unix</span>.gettimeofday&nbsp;()<br>
<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">TEST_DATABASE</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;test_name:&nbsp;string<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">DB</span>:&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">KEY_VALUE_STORE</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;debug_mode&nbsp;:&nbsp;bool&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">In_memory</span>&nbsp;:&nbsp;<span class="constructor">TEST_DATABASE</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_name&nbsp;=&nbsp;<span class="string">"in-mem"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;debug_mode&nbsp;_&nbsp;=&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">DB</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nocol:&nbsp;(string,&nbsp;string)&nbsp;<span class="constructor">Hashtbl</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cols:&nbsp;(string,&nbsp;(string,&nbsp;string)&nbsp;<span class="constructor">Hashtbl</span>.t)&nbsp;<span class="constructor">Hashtbl</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;load&nbsp;_&nbsp;=&nbsp;return&nbsp;{nocol&nbsp;=&nbsp;<span class="constructor">Hashtbl</span>.create&nbsp;42;&nbsp;cols&nbsp;=&nbsp;<span class="constructor">Hashtbl</span>.create&nbsp;42}&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;close&nbsp;_&nbsp;=&nbsp;return&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_collection&nbsp;t&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t.nocol<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Hashtbl</span>.find&nbsp;t.cols&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;newone&nbsp;=&nbsp;<span class="constructor">Hashtbl</span>.create&nbsp;42&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.add&nbsp;t.cols&nbsp;s&nbsp;newone;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newone<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get&nbsp;?collection&nbsp;t&nbsp;~key&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;col&nbsp;=&nbsp;get_collection&nbsp;t&nbsp;collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Hashtbl</span>.find&nbsp;col&nbsp;key)&nbsp;|&gt;&nbsp;return&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_all&nbsp;t&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;col&nbsp;=&nbsp;get_collection&nbsp;t&nbsp;(<span class="constructor">Some</span>&nbsp;collection)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;l&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.iter&nbsp;(<span class="keyword">fun</span>&nbsp;k&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l&nbsp;:=&nbsp;k&nbsp;::&nbsp;!l)&nbsp;col;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;!l<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iterator&nbsp;t&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;allref&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;!allref&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_all&nbsp;t&nbsp;collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;all&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a&nbsp;=&nbsp;ref&nbsp;all&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allref&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;a;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;all&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!all&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;h&nbsp;::&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;all&nbsp;:=&nbsp;t;&nbsp;return&nbsp;(<span class="constructor">Some</span>&nbsp;h)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;act&nbsp;t&nbsp;~action&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Key_in_collection</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Set</span>&nbsp;({key;&nbsp;collection},&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;col&nbsp;=&nbsp;get_collection&nbsp;t&nbsp;collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.replace&nbsp;col&nbsp;key&nbsp;v;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unset</span>&nbsp;{key;&nbsp;collection}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;col&nbsp;=&nbsp;get_collection&nbsp;t&nbsp;collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.remove&nbsp;col&nbsp;key;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Check</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sequence</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.fold&nbsp;l&nbsp;~init:<span class="keyword">true</span>&nbsp;~f:(<span class="keyword">fun</span>&nbsp;prev&nbsp;act&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;prev&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;go&nbsp;act)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;go&nbsp;action&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span><br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;open_close_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;:&nbsp;<span class="constructor">TEST_DATABASE</span>)&nbsp;uri_string&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.load&nbsp;uri_string<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;db&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.close&nbsp;db<br>
<br>
<span class="keyword">let</span>&nbsp;basic_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;:&nbsp;<span class="constructor">TEST_DATABASE</span>)&nbsp;uri_string&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;local_assert&nbsp;name&nbsp;c&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.check&nbsp;(name&nbsp;::&nbsp;test_name&nbsp;::&nbsp;uri_string&nbsp;::&nbsp;[])&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.load&nbsp;uri_string<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;db&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_get&nbsp;?(handle=db)&nbsp;?collection&nbsp;k&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get&nbsp;handle&nbsp;?collection&nbsp;~key:k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;opt&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"get&nbsp;%s/%s"</span>&nbsp;(<span class="constructor">Option</span>.value&nbsp;collection&nbsp;~default:<span class="string">""</span>)&nbsp;k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(f&nbsp;opt);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_none&nbsp;=&nbsp;((=)&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_get&nbsp;<span class="string">"k"</span>&nbsp;is_none&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"k"</span>&nbsp;is_none&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection:<span class="string">"c"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;local_assert&nbsp;<span class="string">"all&nbsp;c"</span>&nbsp;(list&nbsp;=&nbsp;[]);<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_actions&nbsp;res&nbsp;actions&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;action&nbsp;=&nbsp;seq&nbsp;actions&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.act&nbsp;db&nbsp;~action<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;r&nbsp;<span class="keyword">when</span>&nbsp;r&nbsp;=&nbsp;res&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Test</span>.fail&nbsp;<span class="string">"Action&nbsp;%s&nbsp;should&nbsp;be&nbsp;Not_done"</span>&nbsp;(to_string&nbsp;action);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Test</span>.fail&nbsp;<span class="string">"Action&nbsp;%s&nbsp;should&nbsp;be&nbsp;Done"</span>&nbsp;(to_string&nbsp;action);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;&nbsp;<span class="string">"k"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;contains&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;unset&nbsp;<span class="string">"k"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k1"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"thekey"</span>&nbsp;~collection:<span class="string">"c1"</span>&nbsp;<span class="string">"v1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"thekey"</span>&nbsp;~collection:<span class="string">"c2"</span>&nbsp;<span class="string">"v2"</span>;<br>
&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;?collection:<span class="constructor">None</span>&nbsp;<span class="string">"thekey"</span>&nbsp;((=)&nbsp;<span class="constructor">None</span>)&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c1"</span>&nbsp;<span class="string">"thekey"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v1"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c2"</span>&nbsp;<span class="string">"thekey"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v2"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;contains&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k1"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_not_set&nbsp;<span class="string">"k"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k2"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V2"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k3"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V3"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k4"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k5"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V5"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection:<span class="string">"c"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;local_assert&nbsp;<span class="string">"full&nbsp;collection&nbsp;'c'"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.sort&nbsp;~cmp:<span class="constructor">String</span>.compare&nbsp;list&nbsp;=&nbsp;[<span class="string">"k1"</span>;&nbsp;<span class="string">"k2"</span>;&nbsp;<span class="string">"k3"</span>;&nbsp;<span class="string">"k4"</span>;&nbsp;<span class="string">"k5"</span>]);<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;key&nbsp;=&nbsp;<span class="string">"K"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;insane&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buf&nbsp;=&nbsp;<span class="constructor">Bytes</span>.make&nbsp;256&nbsp;<span class="string">'\000'</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;255&nbsp;<span class="keyword">do</span>&nbsp;<span class="constructor">Bytes</span>.set&nbsp;buf&nbsp;i&nbsp;(char_of_int&nbsp;i)&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bytes</span>.to_string&nbsp;buf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key&nbsp;<span class="string">"\""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key&nbsp;<span class="string">"\\\""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key&nbsp;<span class="string">"\"'\""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:insane&nbsp;insane;<br>
&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;?collection:<span class="constructor">None</span>&nbsp;insane&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;insane))<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_list&nbsp;res_stream&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go&nbsp;acc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res_stream&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;acc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;go&nbsp;(v&nbsp;::&nbsp;acc)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;[]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list_equal&nbsp;l1&nbsp;l2&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prep&nbsp;=&nbsp;<span class="constructor">List</span>.sort&nbsp;~cmp:<span class="constructor">Pervasives</span>.compare&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;prep&nbsp;l1&nbsp;=&nbsp;prep&nbsp;l2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"[%s]&nbsp;≠&nbsp;[%s]"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;&nbsp;~sep:<span class="string">",&nbsp;"</span>&nbsp;l1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;&nbsp;~sep:<span class="string">",&nbsp;"</span>&nbsp;l2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;check_iterator_like_get_all&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;to_list&nbsp;stream<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;all&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;all_too&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"iter&nbsp;%s"</span>&nbsp;collection)&nbsp;(list_equal&nbsp;all&nbsp;all_too);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;check_iterator_like_get_all&nbsp;<span class="string">"c"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;check_iterator_like_get_all&nbsp;<span class="string">"cc"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;now&nbsp;test&nbsp;going&nbsp;through&nbsp;a&nbsp;collection&nbsp;with&nbsp;`iterator`&nbsp;while<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifying&nbsp;the&nbsp;values&nbsp;of&nbsp;the&nbsp;collection.<br>
&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_self_collection&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;keyvalues&nbsp;=&nbsp;<span class="constructor">List</span>.init&nbsp;10&nbsp;~f:(sprintf&nbsp;<span class="string">"kv%d"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;actions&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;keyvalues&nbsp;~f:(<span class="keyword">fun</span>&nbsp;kv&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;set&nbsp;~collection&nbsp;~key:kv&nbsp;kv)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;actions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;keyvalues<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iterate_and_set&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go_through&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream&nbsp;()&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;kv&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;say&nbsp;"%s&nbsp;got&nbsp;some&nbsp;%S&nbsp;in&nbsp;the&nbsp;stream"&nbsp;Test_db.test_name&nbsp;kv;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~collection&nbsp;~key:kv&nbsp;(<span class="string">"SET"</span>&nbsp;^&nbsp;kv)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_rw_interleave&nbsp;collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_self_collection&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;keyvalues&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;iterate_and_set&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;check_iterator_like_get_all&nbsp;collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;allnew&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;let&nbsp;modified&nbsp;=&nbsp;List.map&nbsp;keyvalues&nbsp;(fun&nbsp;v&nbsp;-&gt;&nbsp;"SET"&nbsp;^&nbsp;v)&nbsp;in&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"test_rw_interleave&nbsp;%s"</span>&nbsp;collection)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(list_equal&nbsp;keyvalues&nbsp;allnew);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Test_db.debug_mode&nbsp;true;&nbsp;*)</span><br>
&nbsp;&nbsp;test_rw_interleave&nbsp;<span class="string">"ccc"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;now&nbsp;try&nbsp;to&nbsp;delete&nbsp;all&nbsp;values&nbsp;in&nbsp;a&nbsp;collection&nbsp;while&nbsp;iterating&nbsp;on&nbsp;it.<br>
&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iterate_and_delete&nbsp;~collection&nbsp;~at&nbsp;~all&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go_through&nbsp;remaining&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream&nbsp;()&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;kv&nbsp;<span class="keyword">when</span>&nbsp;remaining&nbsp;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s&nbsp;got&nbsp;some&nbsp;%S&nbsp;in&nbsp;the&nbsp;stream"</span>&nbsp;<span class="constructor">Test_db</span>.test_name&nbsp;kv;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;all&nbsp;~f:(<span class="keyword">fun</span>&nbsp;key&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unset&nbsp;~collection&nbsp;key))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;(-1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;kv&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s&nbsp;got&nbsp;some&nbsp;%S&nbsp;in&nbsp;the&nbsp;stream&nbsp;:&nbsp;remaining:&nbsp;%d"</span>&nbsp;<span class="constructor">Test_db</span>.test_name&nbsp;kv&nbsp;remaining;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;(remaining&nbsp;-&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;at<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_delete_iterleave&nbsp;collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_self_collection&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;keyvalues&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;iterate_and_delete<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~collection&nbsp;~all:keyvalues&nbsp;~at:(<span class="constructor">List</span>.length&nbsp;keyvalues&nbsp;/&nbsp;2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;allnew&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(<span class="string">"test_delete_iterleave"</span>)&nbsp;(allnew&nbsp;=&nbsp;[]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_delete_iterleave&nbsp;<span class="string">"aaa"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Read&nbsp;and&nbsp;write&nbsp;concurrently:&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bunch_of_ints&nbsp;=&nbsp;<span class="constructor">List</span>.init&nbsp;100&nbsp;~f:(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Deferred_list</span>.for_concurrent&nbsp;bunch_of_ints&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;n&nbsp;<span class="keyword">when</span>&nbsp;n&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%d"</span>&nbsp;n&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~key:v&nbsp;v]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get&nbsp;db&nbsp;~key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;((_&nbsp;:&nbsp;unit&nbsp;list),&nbsp;errors)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;errors&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"concurrent&nbsp;errors:&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;more&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Database</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Get</span>&nbsp;_,&nbsp;m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Database</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Act</span>&nbsp;_,&nbsp;m)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">";&nbsp;"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;msg&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Test_db.debug_mode&nbsp;false;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.close&nbsp;db<br>
<br>
<span class="keyword">let</span>&nbsp;benchmark_01&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;:&nbsp;<span class="constructor">TEST_DATABASE</span>)&nbsp;uri_string<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(collection&nbsp;=&nbsp;200)&nbsp;?(big_string_kb&nbsp;=&nbsp;10)&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;benches&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add_bench&nbsp;s&nbsp;t&nbsp;=&nbsp;benches&nbsp;:=&nbsp;(s,&nbsp;t)&nbsp;::&nbsp;!benches&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.load&nbsp;uri_string<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;db&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bench_function&nbsp;s&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Test</span>.now&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;e&nbsp;=&nbsp;<span class="constructor">Test</span>.now&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;add_bench&nbsp;s&nbsp;(e&nbsp;-.&nbsp;b);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bench_action&nbsp;~action&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;bench_function&nbsp;s&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">DB</span>.act&nbsp;db&nbsp;~action:(seq&nbsp;action))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;action&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.init&nbsp;collection&nbsp;(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:(sprintf&nbsp;<span class="string">"k%d"</span>&nbsp;i)&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"small"</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;bench_action&nbsp;~action&nbsp;(sprintf&nbsp;<span class="string">"%d&nbsp;small&nbsp;strings"</span>&nbsp;collection)<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bench_in_collection&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;bench_action<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"Set&nbsp;%d&nbsp;%d KB&nbsp;strings&nbsp;into&nbsp;%s"</span>&nbsp;collection&nbsp;big_string_kb&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~action:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.init&nbsp;collection&nbsp;(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;value&nbsp;=&nbsp;<span class="constructor">String</span>.make&nbsp;(big_string_kb&nbsp;*&nbsp;1_000)&nbsp;<span class="string">'B'</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:(sprintf&nbsp;<span class="string">"k%d"</span>&nbsp;i)&nbsp;~collection:name&nbsp;value))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;bench_function&nbsp;(sprintf&nbsp;<span class="string">"Get&nbsp;all&nbsp;collection&nbsp;%s"</span>&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;cc&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;l&nbsp;=&nbsp;<span class="constructor">List</span>.length&nbsp;cc&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.check&nbsp;[<span class="string">"bench01"</span>;&nbsp;<span class="string">"length"</span>;&nbsp;name;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;l]&nbsp;(l&nbsp;=&nbsp;collection);<br>
&nbsp;&nbsp;&nbsp;&nbsp;bench_function&nbsp;(sprintf&nbsp;<span class="string">"Iterate&nbsp;on&nbsp;all&nbsp;collection&nbsp;%s"</span>&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection:name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;obj&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;loop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;bench_function&nbsp;(sprintf&nbsp;<span class="string">"Get&nbsp;all&nbsp;%s&nbsp;one&nbsp;by&nbsp;one"</span>&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;n&nbsp;=&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;key&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"k%d"</span>&nbsp;(n&nbsp;-&nbsp;1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get&nbsp;~collection:name&nbsp;&nbsp;db&nbsp;~key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.check&nbsp;[<span class="string">"bench01"</span>;&nbsp;key;&nbsp;<span class="string">"not&nbsp;none"</span>;&nbsp;]&nbsp;(v&nbsp;&lt;&gt;&nbsp;<span class="constructor">None</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;(n&nbsp;-&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;collection)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;bench_in_collection&nbsp;<span class="string">"C1"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;bench_in_collection&nbsp;<span class="string">"C2"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;bench_in_collection&nbsp;<span class="string">"C3"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;bench_in_collection&nbsp;<span class="string">"C3"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.close&nbsp;db<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;return&nbsp;(test_name,&nbsp;<span class="constructor">List</span>.rev&nbsp;!benches)<br>
<br>
&nbsp;&nbsp;<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Test_sqlite</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_name&nbsp;=&nbsp;<span class="string">"Test_sqlite"</span>&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">DB</span>&nbsp;=&nbsp;<span class="constructor">Trakeva_sqlite</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;debug_mode&nbsp;v&nbsp;=&nbsp;<span class="constructor">Trakeva_sqlite</span>.debug&nbsp;:=&nbsp;v<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Test_sqlite_with_greedy_cache</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_name&nbsp;=&nbsp;<span class="string">"Test_sqlite_with_greedy_cache"</span>&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">DB</span>&nbsp;=&nbsp;<span class="constructor">Trakeva_cache</span>.<span class="constructor">Add</span>(<span class="constructor">Trakeva_sqlite</span>)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;debug_mode&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_sqlite</span>.debug&nbsp;:=&nbsp;v;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_cache</span>.debug&nbsp;:=&nbsp;v;<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Test_postgresql</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_name&nbsp;=&nbsp;<span class="string">"Test_postgresql"</span>&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">DB</span>&nbsp;=&nbsp;<span class="constructor">Trakeva_of_uri</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;debug_mode&nbsp;v&nbsp;=&nbsp;<span class="constructor">Trakeva_postgresql</span>.debug&nbsp;:=&nbsp;v<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;pg_server&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cmdf&nbsp;fmt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ret&nbsp;=&nbsp;<span class="constructor">Sys</span>.command&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;ret&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;()&nbsp;<span class="keyword">else</span>&nbsp;failwith&nbsp;(sprintf&nbsp;<span class="string">"command&nbsp;%S&nbsp;returned&nbsp;%d"</span>&nbsp;s&nbsp;ret)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;fmt&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dir&nbsp;=&nbsp;&nbsp;<span class="string">"/tmp/trakeva_test/"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;port&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"POSTGRESQL_PORT"</span>&nbsp;|&gt;&nbsp;int_of_string&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;4242&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;dir;<br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;dir;<br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"initdb&nbsp;-D&nbsp;%s"</span>&nbsp;dir;<br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"PGPORT=%d&nbsp;pg_ctl&nbsp;start&nbsp;-l&nbsp;%s/log&nbsp;-D&nbsp;%s"</span>&nbsp;port&nbsp;dir&nbsp;dir;<br>
&nbsp;&nbsp;say&nbsp;<span class="string">"Starting&nbsp;postgresql&nbsp;test&nbsp;server&nbsp;on&nbsp;port&nbsp;%d&nbsp;with&nbsp;%s"</span>&nbsp;port&nbsp;dir;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;()&nbsp;=&nbsp;cmdf&nbsp;<span class="string">"PGPORT=%d&nbsp;pg_ctl&nbsp;-D&nbsp;%s&nbsp;-m&nbsp;fast&nbsp;stop"</span>&nbsp;port&nbsp;dir&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;at_exit&nbsp;stop;<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;stop&nbsp;=&nbsp;stop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;status&nbsp;=&nbsp;cmdf&nbsp;<span class="string">"PGPORT=%d&nbsp;pg_ctl&nbsp;-D&nbsp;%s&nbsp;status"</span>&nbsp;port&nbsp;dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;port&nbsp;=&nbsp;port<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;conninfo&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"postgresql:///template1?port=%d"</span>&nbsp;port<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;independent_pg_test&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">PG</span>&nbsp;=&nbsp;<span class="constructor">Postgresql</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pg&nbsp;=&nbsp;pg_server&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;conninfo&nbsp;=&nbsp;pg<span class="keywordsign">#</span>conninfo&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Unix</span>.sleep&nbsp;1;<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;handle&nbsp;=&nbsp;<span class="keyword">new</span>&nbsp;<span class="constructor">PG</span>.connection&nbsp;~conninfo&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create_table&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"CREATE&nbsp;TABLE&nbsp;IF&nbsp;NOT&nbsp;EXISTS&nbsp;%s&nbsp;(collection&nbsp;BYTEA,&nbsp;key&nbsp;BYTEA,&nbsp;value&nbsp;BYTEA,&nbsp;UNIQUE&nbsp;(collection,&nbsp;key))"</span>&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;handle<span class="keywordsign">#</span>exec&nbsp;(create_table&nbsp;<span class="string">"test"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;show_res&nbsp;name&nbsp;res&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s\n&nbsp;&nbsp;status:&nbsp;%s&nbsp;|&nbsp;error:&nbsp;%s&nbsp;|&nbsp;tuples:&nbsp;%d&nbsp;×&nbsp;%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;(<span class="constructor">PG</span>.result_status&nbsp;res<span class="keywordsign">#</span>status)&nbsp;res<span class="keywordsign">#</span>error&nbsp;res<span class="keywordsign">#</span>ntuples&nbsp;res<span class="keywordsign">#</span>nfields;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;res<span class="keywordsign">#</span>ntuples&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(%s)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.init&nbsp;res<span class="keywordsign">#</span>nfields&nbsp;(<span class="keyword">fun</span>&nbsp;j&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;res<span class="keywordsign">#</span>getisnull&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"Null"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;sprintf&nbsp;<span class="string">"%S"</span>&nbsp;(<span class="constructor">PG</span>.unescape_bytea&nbsp;(res<span class="keywordsign">#</span>getvalue&nbsp;i&nbsp;j)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">",&nbsp;"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;show_res&nbsp;<span class="string">"create-table"</span>&nbsp;res;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;handle<span class="keywordsign">#</span>exec&nbsp;(create_table&nbsp;<span class="string">"test"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;show_res&nbsp;<span class="string">"create-table&nbsp;again"</span>&nbsp;res;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;execl&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;l&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(sql,&nbsp;args)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;as_array&nbsp;=&nbsp;<span class="constructor">Array</span>.of_list&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;as_array&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Null</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">PG</span>.null&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;binary_params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;as_array&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Null</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle<span class="keywordsign">#</span>exec&nbsp;sql&nbsp;~params&nbsp;~binary_params<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">String</span>.split&nbsp;sql&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'\n'</span>)&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.hd_exn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show_res&nbsp;name&nbsp;res<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add&nbsp;c&nbsp;k&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"BEGIN"</span>,&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"LOCK&nbsp;TABLE&nbsp;test&nbsp;IN&nbsp;ACCESS&nbsp;EXCLUSIVE&nbsp;MODE"</span>,&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"UPDATE&nbsp;test&nbsp;SET&nbsp;value&nbsp;=&nbsp;$3&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;AND&nbsp;key&nbsp;=&nbsp;$2"</span>,&nbsp;[c;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;k;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;v];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{sql<span class="keywordsign">|</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">INSERT</span>&nbsp;<span class="constructor">INTO</span>&nbsp;test&nbsp;(collection,&nbsp;key,&nbsp;value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">SELECT</span>&nbsp;$1,&nbsp;$2,&nbsp;$3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">WHERE</span>&nbsp;<span class="constructor">NOT</span>&nbsp;<span class="constructor">EXISTS</span>&nbsp;(<span class="constructor">SELECT</span>&nbsp;1&nbsp;<span class="constructor">FROM</span>&nbsp;test&nbsp;<span class="constructor">WHERE</span>&nbsp;collection&nbsp;=&nbsp;$1&nbsp;<span class="constructor">AND</span>&nbsp;key&nbsp;=&nbsp;$2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>sql},&nbsp;[c;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;k;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;v];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"END"</span>,&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K1"</span>&nbsp;<span class="string">"V1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K2"</span>&nbsp;<span class="string">"V2"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K3"</span>&nbsp;<span class="string">"V3\000\001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K2"</span>&nbsp;<span class="string">"V4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"DELETE&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;key&nbsp;=&nbsp;$2&nbsp;AND&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"K1"</span>];<br>
&nbsp;&nbsp;&nbsp;&nbsp;];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">Null</span>)&nbsp;<span class="string">"K1"</span>&nbsp;<span class="string">"VVVVVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"null"</span>)&nbsp;<span class="string">"K2"</span>&nbsp;<span class="string">"VVVvvvvvvvVVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">Null</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;is&nbsp;null"</span>,&nbsp;[];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">Null</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.run_monad&nbsp;<span class="string">"pgtest"</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.load&nbsp;conninfo<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;trak&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get&nbsp;trak&nbsp;~key:<span class="string">"K"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"get&nbsp;OK"</span>;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"what???&nbsp;%S"</span>&nbsp;s;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.act&nbsp;trak&nbsp;&nbsp;(seq&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"K"</span>&nbsp;<span class="string">"VVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K"</span>&nbsp;<span class="string">"VVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"K1"</span>&nbsp;<span class="string">"VVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset&nbsp;<span class="string">"K1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_not_set&nbsp;<span class="string">"K1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get&nbsp;trak&nbsp;~key:<span class="string">"K"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"2nd&nbsp;get&nbsp;NOT&nbsp;OK"</span>;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"OK:&nbsp;%S"</span>&nbsp;s;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tab&nbsp;=&nbsp;<span class="constructor">Trakeva_postgresql</span>.table_name&nbsp;trak&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[sprintf&nbsp;<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;%s&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>&nbsp;tab,&nbsp;[<span class="keywordsign">`</span><span class="constructor">Null</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.act&nbsp;trak&nbsp;&nbsp;(seq&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K"</span>&nbsp;&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K1"</span>&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K2"</span>&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K3"</span>&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get_all&nbsp;trak&nbsp;~collection:<span class="string">"C"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list_of_keys&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"list_of_keys:&nbsp;%s"</span>&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">",&nbsp;"</span>&nbsp;list_of_keys);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[sprintf&nbsp;<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;%s&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>&nbsp;tab,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;<span class="constructor">Trakeva_postgresql</span>.iterator&nbsp;trak&nbsp;~collection:<span class="string">"C"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;key&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get&nbsp;trak&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s&nbsp;-&gt;&nbsp;%s"</span>&nbsp;key&nbsp;(<span class="constructor">Option</span>.value&nbsp;v&nbsp;~default:<span class="string">"????"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Iterator&nbsp;done"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["BEGIN",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[sprintf&nbsp;"DECLARE&nbsp;cur1&nbsp;CURSOR&nbsp;FOR&nbsp;(SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;%s&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null))"&nbsp;tab,&nbsp;[`V&nbsp;"C"];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(*&nbsp;execl&nbsp;["OPEN&nbsp;cur1",&nbsp;[]];&nbsp;*)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["CLOSE&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["END",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;handle<span class="keywordsign">#</span>finish;<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">PG</span>.<span class="constructor">Error</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"Error:&nbsp;%s"</span>&nbsp;(<span class="constructor">PG</span>.string_of_error&nbsp;e)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"Exn:&nbsp;%s"</span>&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)<br>
&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;say&nbsp;<span class="string">"EXITING"</span>;<br>
&nbsp;&nbsp;exit&nbsp;0<br>
<span class="comment">(*<br>
let&nbsp;()&nbsp;=&nbsp;pg#stop&nbsp;<br>
let&nbsp;()&nbsp;=&nbsp;pg#status<br>
*)</span><br>
<br>
<span class="keyword">let</span>&nbsp;has_arg&nbsp;arlg&nbsp;possible&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">List</span>.exists&nbsp;arlg&nbsp;~f:(<span class="constructor">List</span>.mem&nbsp;~set:possible)<br>
<br>
<span class="keyword">let</span>&nbsp;find_arg&nbsp;argl&nbsp;~name&nbsp;~convert&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;argl&nbsp;(<span class="keyword">fun</span>&nbsp;arg&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'='</span>)&nbsp;arg&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:<span class="constructor">String</span>.strip&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;n&nbsp;::&nbsp;c&nbsp;::&nbsp;[]&nbsp;<span class="keyword">when</span>&nbsp;n&nbsp;=&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;convert&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;argl&nbsp;=&nbsp;<span class="constructor">Sys</span>.argv&nbsp;|&gt;&nbsp;<span class="constructor">Array</span>.to_list&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.tl_exn&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;independent_pg_test&nbsp;();&nbsp;*)</span><br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sqlite_path&nbsp;=&nbsp;<span class="string">"/tmp/trakeva-sqlite-test"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Sys</span>.command&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;sqlite_path&nbsp;|&gt;&nbsp;ignore;<br>
&nbsp;&nbsp;<span class="constructor">Test</span>.run_monad&nbsp;<span class="string">"basic/sqlite"</span>&nbsp;(basic_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_sqlite</span>)&nbsp;sqlite_path);<br>
<br>
&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Sys</span>.command&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;sqlite_path&nbsp;|&gt;&nbsp;ignore;<br>
&nbsp;&nbsp;<span class="constructor">Test</span>.run_monad&nbsp;<span class="string">"basic/sqlite-with-cache"</span>&nbsp;(basic_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_sqlite_with_greedy_cache</span>)&nbsp;sqlite_path);<br>
<br>
&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;conninfo&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"POSTGRESQL_CONNECTION_INFO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pg&nbsp;=&nbsp;pg_server&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Unix</span>.sleep&nbsp;1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pg<span class="keywordsign">#</span>conninfo<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.run_monad&nbsp;<span class="string">"basic/postgres"</span>&nbsp;(basic_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_postgresql</span>)&nbsp;conninfo);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;pg#stop;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">end</span>;<br>
<br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;has_arg&nbsp;argl&nbsp;[<span class="string">"bench"</span>;&nbsp;<span class="string">"benchmarks"</span>]&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Sys</span>.command&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;sqlite_path&nbsp;|&gt;&nbsp;ignore;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;collection&nbsp;=&nbsp;find_arg&nbsp;argl&nbsp;~name:<span class="string">"collection"</span>&nbsp;~convert:<span class="constructor">Int</span>.of_string&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;big_string_kb&nbsp;=&nbsp;find_arg&nbsp;argl&nbsp;~name:<span class="string">"kb"</span>&nbsp;~convert:<span class="constructor">Int</span>.of_string&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;timeout&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;find_arg&nbsp;argl&nbsp;~name:<span class="string">"timeout"</span>&nbsp;~convert:<span class="constructor">Float</span>.of_string<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:10.<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bench_with_timeout&nbsp;file&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Sys</span>.command&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;sqlite_path&nbsp;|&gt;&nbsp;ignore;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">System</span>.with_timeout&nbsp;timeout&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;(_,&nbsp;res)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;res<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Timeout</span>&nbsp;t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;[<span class="string">"Timeout"</span>,&nbsp;t]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">System</span>&nbsp;(_,&nbsp;<span class="keywordsign">`</span><span class="constructor">Exn</span>&nbsp;e))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;e<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Database</span>&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;other)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail&nbsp;other<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.run_monad&nbsp;<span class="string">"bench01"</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bench_with_timeout&nbsp;<span class="string">"/tmp/trakeva-bench-sqlite"</span>&nbsp;(<span class="keyword">fun</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;benchmark_01&nbsp;?collection&nbsp;?big_string_kb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_sqlite</span>)&nbsp;path&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;sqlite_bench01&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bench_with_timeout&nbsp;<span class="string">"/tmp/trakeva-bench-sqlite-with-cache"</span>&nbsp;(<span class="keyword">fun</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;benchmark_01&nbsp;?collection&nbsp;?big_string_kb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_sqlite_with_greedy_cache</span>)&nbsp;path&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;sqlite_cached_bench01&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bench_with_timeout&nbsp;<span class="string">""</span>&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;benchmark_01&nbsp;?collection&nbsp;?big_string_kb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">In_memory</span>)&nbsp;<span class="string">""</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;in_mem_bench01&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Bench01&nbsp;sqlite:&nbsp;%F\tsqlite+cache:&nbsp;%F\tin-mem:&nbsp;%F"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.fold&nbsp;sqlite_bench01&nbsp;~init:0.&nbsp;~f:(<span class="keyword">fun</span>&nbsp;p&nbsp;(_,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;+.&nbsp;f))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.fold&nbsp;sqlite_cached_bench01&nbsp;~init:0.&nbsp;~f:(<span class="keyword">fun</span>&nbsp;p&nbsp;(_,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;+.&nbsp;f))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.fold&nbsp;in_mem_bench01&nbsp;~init:0.&nbsp;~f:(<span class="keyword">fun</span>&nbsp;p&nbsp;(_,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;p&nbsp;+.&nbsp;f))&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;sqlite_bench01&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(n,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"sqlite\t%s\t%F s"</span>&nbsp;n&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;sqlite_cached_bench01&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(n,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"sqliteGC\t%s\t%F s"</span>&nbsp;n&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;in_mem_bench01&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(n,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"in_mem\t%s\t%F s"</span>&nbsp;n&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;);<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;!<span class="constructor">Test</span>.failed_tests&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"No&nbsp;tests&nbsp;failed&nbsp;\\o/&nbsp;(arg-list:&nbsp;[%s])"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"."</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;argl&nbsp;~f:(sprintf&nbsp;<span class="string">"%S"</span>)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;0<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;some&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Some&nbsp;tests&nbsp;failed&nbsp;(arg-list:&nbsp;[%s]):"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"."</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;argl&nbsp;~f:(sprintf&nbsp;<span class="string">"%S"</span>)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;some&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s"</span>&nbsp;t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s"</span>&nbsp;(<span class="constructor">String</span>.make&nbsp;80&nbsp;<span class="string">'-'</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;3<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
</code></body></html>