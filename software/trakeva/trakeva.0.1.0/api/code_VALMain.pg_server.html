<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Trakeva" rel="Chapter" href="Trakeva.html">
<link title="Trakeva_cache" rel="Chapter" href="Trakeva_cache.html">
<link title="Trakeva_of_uri" rel="Chapter" href="Trakeva_of_uri.html">
<link title="Trakeva_postgresql" rel="Chapter" href="Trakeva_postgresql.html">
<link title="Trakeva_sqlite" rel="Chapter" href="Trakeva_sqlite.html"><title>Trakeva API : Main.pg_server</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;pg_server&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cmdf&nbsp;fmt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ret&nbsp;=&nbsp;<span class="constructor">Sys</span>.command&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;ret&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;()&nbsp;<span class="keyword">else</span>&nbsp;failwith&nbsp;(sprintf&nbsp;<span class="string">"command&nbsp;%S&nbsp;returned&nbsp;%d"</span>&nbsp;s&nbsp;ret)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;fmt&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dir&nbsp;=&nbsp;&nbsp;<span class="string">"/tmp/trakeva_test/"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;port&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"POSTGRESQL_PORT"</span>&nbsp;|&gt;&nbsp;int_of_string&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;4242&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;dir;<br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;dir;<br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"initdb&nbsp;-D&nbsp;%s"</span>&nbsp;dir;<br>
&nbsp;&nbsp;cmdf&nbsp;<span class="string">"PGPORT=%d&nbsp;pg_ctl&nbsp;start&nbsp;-l&nbsp;%s/log&nbsp;-D&nbsp;%s"</span>&nbsp;port&nbsp;dir&nbsp;dir;<br>
&nbsp;&nbsp;say&nbsp;<span class="string">"Starting&nbsp;postgresql&nbsp;test&nbsp;server&nbsp;on&nbsp;port&nbsp;%d&nbsp;with&nbsp;%s"</span>&nbsp;port&nbsp;dir;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;()&nbsp;=&nbsp;cmdf&nbsp;<span class="string">"PGPORT=%d&nbsp;pg_ctl&nbsp;-D&nbsp;%s&nbsp;-m&nbsp;fast&nbsp;stop"</span>&nbsp;port&nbsp;dir&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;at_exit&nbsp;stop;<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;stop&nbsp;=&nbsp;stop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;status&nbsp;=&nbsp;cmdf&nbsp;<span class="string">"PGPORT=%d&nbsp;pg_ctl&nbsp;-D&nbsp;%s&nbsp;status"</span>&nbsp;port&nbsp;dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;port&nbsp;=&nbsp;port<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;conninfo&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"postgresql:///template1?port=%d"</span>&nbsp;port<br>
&nbsp;&nbsp;<span class="keyword">end</span></code></body></html>