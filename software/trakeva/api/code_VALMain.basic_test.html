<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Trakeva_git_commands" rel="Chapter" href="Trakeva_git_commands.html">
<link title="Trakeva_interface" rel="Chapter" href="Trakeva_interface.html">
<link title="Trakeva_sqlite" rel="Chapter" href="Trakeva_sqlite.html"><title>Trakeva API : Main.basic_test</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;basic_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;:&nbsp;<span class="constructor">TEST_DATABASE</span>)&nbsp;uri_string&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva_interface</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;local_assert&nbsp;name&nbsp;c&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.check&nbsp;(name&nbsp;::&nbsp;test_name&nbsp;::&nbsp;uri_string&nbsp;::&nbsp;[])&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.load&nbsp;uri_string<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;db&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_get&nbsp;?(handle=db)&nbsp;?collection&nbsp;k&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get&nbsp;handle&nbsp;?collection&nbsp;~key:k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;opt&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"get&nbsp;%s/%s"</span>&nbsp;(<span class="constructor">Option</span>.value&nbsp;collection&nbsp;~default:<span class="string">""</span>)&nbsp;k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(f&nbsp;opt);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_none&nbsp;=&nbsp;((=)&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_get&nbsp;<span class="string">"k"</span>&nbsp;is_none&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"k"</span>&nbsp;is_none&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection:<span class="string">"c"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;local_assert&nbsp;<span class="string">"all&nbsp;c"</span>&nbsp;(list&nbsp;=&nbsp;[]);<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_actions&nbsp;res&nbsp;actions&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;action&nbsp;=&nbsp;seq&nbsp;actions&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.act&nbsp;db&nbsp;~action<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;r&nbsp;<span class="keyword">when</span>&nbsp;r&nbsp;=&nbsp;res&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Test</span>.fail&nbsp;<span class="string">"Action&nbsp;%s&nbsp;should&nbsp;be&nbsp;Not_done"</span>&nbsp;(to_string&nbsp;action);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Test</span>.fail&nbsp;<span class="string">"Action&nbsp;%s&nbsp;should&nbsp;be&nbsp;Done"</span>&nbsp;(to_string&nbsp;action);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;&nbsp;<span class="string">"k"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;contains&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;unset&nbsp;<span class="string">"k"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k1"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;contains&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k1"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_not_set&nbsp;<span class="string">"k"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k2"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V2"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k3"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V3"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k4"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k5"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V5"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection:<span class="string">"c"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;local_assert&nbsp;<span class="string">"full&nbsp;collection&nbsp;'c'"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.sort&nbsp;~cmp:<span class="constructor">String</span>.compare&nbsp;list&nbsp;=&nbsp;[<span class="string">"V"</span>;&nbsp;<span class="string">"V2"</span>;&nbsp;<span class="string">"V3"</span>;&nbsp;<span class="string">"V4"</span>;&nbsp;<span class="string">"V5"</span>]);<br>
&nbsp;&nbsp;<span class="constructor">DB</span>.close&nbsp;db</code></body></html>