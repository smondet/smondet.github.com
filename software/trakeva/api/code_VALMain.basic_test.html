<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Trakeva" rel="Chapter" href="Trakeva.html">
<link title="Trakeva_cache" rel="Chapter" href="Trakeva_cache.html">
<link title="Trakeva_sqlite" rel="Chapter" href="Trakeva_sqlite.html"><title>Trakeva API : Main.basic_test</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;basic_test&nbsp;(<span class="keyword">module</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;:&nbsp;<span class="constructor">TEST_DATABASE</span>)&nbsp;uri_string&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Test_db</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;local_assert&nbsp;name&nbsp;c&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.check&nbsp;(name&nbsp;::&nbsp;test_name&nbsp;::&nbsp;uri_string&nbsp;::&nbsp;[])&nbsp;c&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.load&nbsp;uri_string<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;db&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_get&nbsp;?(handle=db)&nbsp;?collection&nbsp;k&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get&nbsp;handle&nbsp;?collection&nbsp;~key:k<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;opt&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"get&nbsp;%s/%s"</span>&nbsp;(<span class="constructor">Option</span>.value&nbsp;collection&nbsp;~default:<span class="string">""</span>)&nbsp;k)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(f&nbsp;opt);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_none&nbsp;=&nbsp;((=)&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_get&nbsp;<span class="string">"k"</span>&nbsp;is_none&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"k"</span>&nbsp;is_none&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection:<span class="string">"c"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;local_assert&nbsp;<span class="string">"all&nbsp;c"</span>&nbsp;(list&nbsp;=&nbsp;[]);<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_actions&nbsp;res&nbsp;actions&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;action&nbsp;=&nbsp;seq&nbsp;actions&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.act&nbsp;db&nbsp;~action<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;r&nbsp;<span class="keyword">when</span>&nbsp;r&nbsp;=&nbsp;res&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Test</span>.fail&nbsp;<span class="string">"Action&nbsp;%s&nbsp;should&nbsp;be&nbsp;Not_done"</span>&nbsp;(to_string&nbsp;action);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;<span class="constructor">Test</span>.fail&nbsp;<span class="string">"Action&nbsp;%s&nbsp;should&nbsp;be&nbsp;Done"</span>&nbsp;(to_string&nbsp;action);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;&nbsp;<span class="string">"k"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;contains&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;unset&nbsp;<span class="string">"k"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k1"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"thekey"</span>&nbsp;~collection:<span class="string">"c1"</span>&nbsp;<span class="string">"v1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"thekey"</span>&nbsp;~collection:<span class="string">"c2"</span>&nbsp;<span class="string">"v2"</span>;<br>
&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;?collection:<span class="constructor">None</span>&nbsp;<span class="string">"thekey"</span>&nbsp;((=)&nbsp;<span class="constructor">None</span>)&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c1"</span>&nbsp;<span class="string">"thekey"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v1"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_get&nbsp;~collection:<span class="string">"c2"</span>&nbsp;<span class="string">"thekey"</span>&nbsp;((=)&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="string">"v2"</span>))&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;contains&nbsp;~key:<span class="string">"k"</span>&nbsp;<span class="string">"v"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k1"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_not_set&nbsp;<span class="string">"k"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k2"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V2"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k3"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V3"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k4"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"k5"</span>&nbsp;~collection:<span class="string">"c"</span>&nbsp;<span class="string">"V5"</span>;<br>
&nbsp;&nbsp;]&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection:<span class="string">"c"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;local_assert&nbsp;<span class="string">"full&nbsp;collection&nbsp;'c'"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.sort&nbsp;~cmp:<span class="constructor">String</span>.compare&nbsp;list&nbsp;=&nbsp;[<span class="string">"k1"</span>;&nbsp;<span class="string">"k2"</span>;&nbsp;<span class="string">"k3"</span>;&nbsp;<span class="string">"k4"</span>;&nbsp;<span class="string">"k5"</span>]);<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;key&nbsp;=&nbsp;<span class="string">"K"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key&nbsp;<span class="string">"\""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key&nbsp;<span class="string">"\\\""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key&nbsp;<span class="string">"\"'\""</span>;<br>
&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_list&nbsp;res_stream&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go&nbsp;acc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res_stream&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;acc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;go&nbsp;(v&nbsp;::&nbsp;acc)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;[]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list_equal&nbsp;l1&nbsp;l2&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prep&nbsp;=&nbsp;<span class="constructor">List</span>.sort&nbsp;~cmp:<span class="constructor">Pervasives</span>.compare&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;prep&nbsp;l1&nbsp;=&nbsp;prep&nbsp;l2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"[%s]&nbsp;≠&nbsp;[%s]"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;&nbsp;~sep:<span class="string">",&nbsp;"</span>&nbsp;l1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;&nbsp;~sep:<span class="string">",&nbsp;"</span>&nbsp;l2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;check_iterator_like_get_all&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;to_list&nbsp;stream<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;all&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;all_too&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"iter&nbsp;%s"</span>&nbsp;collection)&nbsp;(list_equal&nbsp;all&nbsp;all_too);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;check_iterator_like_get_all&nbsp;<span class="string">"c"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;check_iterator_like_get_all&nbsp;<span class="string">"cc"</span>&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;now&nbsp;test&nbsp;going&nbsp;through&nbsp;a&nbsp;collection&nbsp;with&nbsp;`iterator`&nbsp;while<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifying&nbsp;the&nbsp;values&nbsp;of&nbsp;the&nbsp;collection.<br>
&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_self_collection&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;keyvalues&nbsp;=&nbsp;<span class="constructor">List</span>.init&nbsp;10&nbsp;~f:(sprintf&nbsp;<span class="string">"kv%d"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;actions&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;keyvalues&nbsp;~f:(<span class="keyword">fun</span>&nbsp;kv&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;set&nbsp;~collection&nbsp;~key:kv&nbsp;kv)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;actions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;keyvalues<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iterate_and_set&nbsp;~collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go_through&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream&nbsp;()&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;kv&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;say&nbsp;"%s&nbsp;got&nbsp;some&nbsp;%S&nbsp;in&nbsp;the&nbsp;stream"&nbsp;Test_db.test_name&nbsp;kv;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~collection&nbsp;~key:kv&nbsp;(<span class="string">"SET"</span>&nbsp;^&nbsp;kv)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_rw_interleave&nbsp;collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_self_collection&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;keyvalues&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;iterate_and_set&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;check_iterator_like_get_all&nbsp;collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;allnew&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;let&nbsp;modified&nbsp;=&nbsp;List.map&nbsp;keyvalues&nbsp;(fun&nbsp;v&nbsp;-&gt;&nbsp;"SET"&nbsp;^&nbsp;v)&nbsp;in&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(sprintf&nbsp;<span class="string">"test_rw_interleave&nbsp;%s"</span>&nbsp;collection)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(list_equal&nbsp;keyvalues&nbsp;allnew);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Test_db.debug_mode&nbsp;true;&nbsp;*)</span><br>
&nbsp;&nbsp;test_rw_interleave&nbsp;<span class="string">"ccc"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;now&nbsp;try&nbsp;to&nbsp;delete&nbsp;all&nbsp;values&nbsp;in&nbsp;a&nbsp;collection&nbsp;while&nbsp;iterating&nbsp;on&nbsp;it.<br>
&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iterate_and_delete&nbsp;~collection&nbsp;~at&nbsp;~all&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream&nbsp;=&nbsp;<span class="constructor">DB</span>.iterator&nbsp;db&nbsp;~collection&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go_through&nbsp;remaining&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream&nbsp;()&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;kv&nbsp;<span class="keyword">when</span>&nbsp;remaining&nbsp;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s&nbsp;got&nbsp;some&nbsp;%S&nbsp;in&nbsp;the&nbsp;stream"</span>&nbsp;<span class="constructor">Test_db</span>.test_name&nbsp;kv;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;all&nbsp;~f:(<span class="keyword">fun</span>&nbsp;key&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unset&nbsp;~collection&nbsp;key))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;(-1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;kv&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s&nbsp;got&nbsp;some&nbsp;%S&nbsp;in&nbsp;the&nbsp;stream&nbsp;:&nbsp;remaining:&nbsp;%d"</span>&nbsp;<span class="constructor">Test_db</span>.test_name&nbsp;kv&nbsp;remaining;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;(remaining&nbsp;-&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;go_through&nbsp;at<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_delete_iterleave&nbsp;collection&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_self_collection&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;keyvalues&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;iterate_and_delete<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~collection&nbsp;~all:keyvalues&nbsp;~at:(<span class="constructor">List</span>.length&nbsp;keyvalues&nbsp;/&nbsp;2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get_all&nbsp;db&nbsp;~collection<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;allnew&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;(<span class="string">"test_delete_iterleave"</span>)&nbsp;(allnew&nbsp;=&nbsp;[]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;test_delete_iterleave&nbsp;<span class="string">"aaa"</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Read&nbsp;and&nbsp;write&nbsp;concurrently:&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bunch_of_ints&nbsp;=&nbsp;<span class="constructor">List</span>.init&nbsp;100&nbsp;~f:(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Deferred_list</span>.for_concurrent&nbsp;bunch_of_ints&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;n&nbsp;<span class="keyword">when</span>&nbsp;n&nbsp;<span class="keyword">mod</span>&nbsp;2&nbsp;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%d"</span>&nbsp;n&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_actions&nbsp;<span class="keywordsign">`</span><span class="constructor">Done</span>&nbsp;[set&nbsp;~key:v&nbsp;v]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">DB</span>.get&nbsp;db&nbsp;~key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;((_&nbsp;:&nbsp;unit&nbsp;list),&nbsp;errors)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;errors&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"concurrent&nbsp;errors:&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;more&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Database</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Get</span>&nbsp;_,&nbsp;m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Database</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Act</span>&nbsp;_,&nbsp;m)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">";&nbsp;"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;local_assert&nbsp;msg&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Test_db.debug_mode&nbsp;false;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="constructor">DB</span>.close&nbsp;db</code></body></html>