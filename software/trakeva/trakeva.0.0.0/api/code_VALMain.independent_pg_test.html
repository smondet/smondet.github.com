<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Trakeva" rel="Chapter" href="Trakeva.html">
<link title="Trakeva_cache" rel="Chapter" href="Trakeva_cache.html">
<link title="Trakeva_of_uri" rel="Chapter" href="Trakeva_of_uri.html">
<link title="Trakeva_postgresql" rel="Chapter" href="Trakeva_postgresql.html">
<link title="Trakeva_sqlite" rel="Chapter" href="Trakeva_sqlite.html"><title>Trakeva API : Main.independent_pg_test</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;independent_pg_test&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">PG</span>&nbsp;=&nbsp;<span class="constructor">Postgresql</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pg&nbsp;=&nbsp;pg_server&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;conninfo&nbsp;=&nbsp;pg<span class="keywordsign">#</span>conninfo&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Unix</span>.sleep&nbsp;1;<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;handle&nbsp;=&nbsp;<span class="keyword">new</span>&nbsp;<span class="constructor">PG</span>.connection&nbsp;~conninfo&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create_table&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"CREATE&nbsp;TABLE&nbsp;IF&nbsp;NOT&nbsp;EXISTS&nbsp;%s&nbsp;(collection&nbsp;BYTEA,&nbsp;key&nbsp;BYTEA,&nbsp;value&nbsp;BYTEA,&nbsp;UNIQUE&nbsp;(collection,&nbsp;key))"</span>&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;handle<span class="keywordsign">#</span>exec&nbsp;(create_table&nbsp;<span class="string">"test"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;show_res&nbsp;name&nbsp;res&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s\n&nbsp;&nbsp;status:&nbsp;%s&nbsp;|&nbsp;error:&nbsp;%s&nbsp;|&nbsp;tuples:&nbsp;%d&nbsp;Ã—&nbsp;%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;(<span class="constructor">PG</span>.result_status&nbsp;res<span class="keywordsign">#</span>status)&nbsp;res<span class="keywordsign">#</span>error&nbsp;res<span class="keywordsign">#</span>ntuples&nbsp;res<span class="keywordsign">#</span>nfields;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;res<span class="keywordsign">#</span>ntuples&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(%s)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.init&nbsp;res<span class="keywordsign">#</span>nfields&nbsp;(<span class="keyword">fun</span>&nbsp;j&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;res<span class="keywordsign">#</span>getisnull&nbsp;i&nbsp;j&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"Null"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;sprintf&nbsp;<span class="string">"%S"</span>&nbsp;(<span class="constructor">PG</span>.unescape_bytea&nbsp;(res<span class="keywordsign">#</span>getvalue&nbsp;i&nbsp;j)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">",&nbsp;"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;show_res&nbsp;<span class="string">"create-table"</span>&nbsp;res;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;handle<span class="keywordsign">#</span>exec&nbsp;(create_table&nbsp;<span class="string">"test"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;show_res&nbsp;<span class="string">"create-table&nbsp;again"</span>&nbsp;res;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;execl&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;l&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(sql,&nbsp;args)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;as_array&nbsp;=&nbsp;<span class="constructor">Array</span>.of_list&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;as_array&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Null</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">PG</span>.null&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;binary_params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Array</span>.map&nbsp;as_array&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Null</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle<span class="keywordsign">#</span>exec&nbsp;sql&nbsp;~params&nbsp;~binary_params<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">String</span>.split&nbsp;sql&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'\n'</span>)&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.hd_exn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show_res&nbsp;name&nbsp;res<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add&nbsp;c&nbsp;k&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"BEGIN"</span>,&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"LOCK&nbsp;TABLE&nbsp;test&nbsp;IN&nbsp;ACCESS&nbsp;EXCLUSIVE&nbsp;MODE"</span>,&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"UPDATE&nbsp;test&nbsp;SET&nbsp;value&nbsp;=&nbsp;$3&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;AND&nbsp;key&nbsp;=&nbsp;$2"</span>,&nbsp;[c;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;k;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;v];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{sql<span class="keywordsign">|</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">INSERT</span>&nbsp;<span class="constructor">INTO</span>&nbsp;test&nbsp;(collection,&nbsp;key,&nbsp;value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">SELECT</span>&nbsp;$1,&nbsp;$2,&nbsp;$3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">WHERE</span>&nbsp;<span class="constructor">NOT</span>&nbsp;<span class="constructor">EXISTS</span>&nbsp;(<span class="constructor">SELECT</span>&nbsp;1&nbsp;<span class="constructor">FROM</span>&nbsp;test&nbsp;<span class="constructor">WHERE</span>&nbsp;collection&nbsp;=&nbsp;$1&nbsp;<span class="constructor">AND</span>&nbsp;key&nbsp;=&nbsp;$2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>sql},&nbsp;[c;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;k;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;v];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"END"</span>,&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K1"</span>&nbsp;<span class="string">"V1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K2"</span>&nbsp;<span class="string">"V2"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K3"</span>&nbsp;<span class="string">"V3\000\001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>)&nbsp;<span class="string">"K2"</span>&nbsp;<span class="string">"V4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"DELETE&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;key&nbsp;=&nbsp;$2&nbsp;AND&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>;&nbsp;<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"K1"</span>];<br>
&nbsp;&nbsp;&nbsp;&nbsp;];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">Null</span>)&nbsp;<span class="string">"K1"</span>&nbsp;<span class="string">"VVVVVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;(<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"null"</span>)&nbsp;<span class="string">"K2"</span>&nbsp;<span class="string">"VVVvvvvvvvVVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">Null</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;is&nbsp;null"</span>,&nbsp;[];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">Null</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Test</span>.run_monad&nbsp;<span class="string">"pgtest"</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.load&nbsp;conninfo<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;trak&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get&nbsp;trak&nbsp;~key:<span class="string">"K"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"get&nbsp;OK"</span>;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"what???&nbsp;%S"</span>&nbsp;s;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Trakeva</span>.<span class="constructor">Action</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.act&nbsp;trak&nbsp;&nbsp;(seq&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"K"</span>&nbsp;<span class="string">"VVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K"</span>&nbsp;<span class="string">"VVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~key:<span class="string">"K1"</span>&nbsp;<span class="string">"VVV"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset&nbsp;<span class="string">"K1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_not_set&nbsp;<span class="string">"K1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get&nbsp;trak&nbsp;~key:<span class="string">"K"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"2nd&nbsp;get&nbsp;NOT&nbsp;OK"</span>;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"OK:&nbsp;%S"</span>&nbsp;s;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tab&nbsp;=&nbsp;<span class="constructor">Trakeva_postgresql</span>.table_name&nbsp;trak&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[sprintf&nbsp;<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;%s&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>&nbsp;tab,&nbsp;[<span class="keywordsign">`</span><span class="constructor">Null</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.act&nbsp;trak&nbsp;&nbsp;(seq&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K"</span>&nbsp;&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K1"</span>&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K2"</span>&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key:<span class="string">"K3"</span>&nbsp;<span class="string">"\000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get_all&nbsp;trak&nbsp;~collection:<span class="string">"C"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;list_of_keys&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"list_of_keys:&nbsp;%s"</span>&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">",&nbsp;"</span>&nbsp;list_of_keys);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[sprintf&nbsp;<span class="string">"SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;%s&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null)"</span>&nbsp;tab,&nbsp;[<span class="keywordsign">`</span><span class="constructor">V</span>&nbsp;<span class="string">"C"</span>];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;<span class="constructor">Trakeva_postgresql</span>.iterator&nbsp;trak&nbsp;~collection:<span class="string">"C"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;key&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Trakeva_postgresql</span>.get&nbsp;trak&nbsp;~collection:<span class="string">"C"</span>&nbsp;~key<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"%s&nbsp;-&gt;&nbsp;%s"</span>&nbsp;key&nbsp;(<span class="constructor">Option</span>.value&nbsp;v&nbsp;~default:<span class="string">"????"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;say&nbsp;<span class="string">"Iterator&nbsp;done"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["BEGIN",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;[sprintf&nbsp;"DECLARE&nbsp;cur1&nbsp;CURSOR&nbsp;FOR&nbsp;(SELECT&nbsp;collection,&nbsp;key,&nbsp;value&nbsp;FROM&nbsp;%s&nbsp;WHERE&nbsp;collection&nbsp;=&nbsp;$1&nbsp;or&nbsp;($1&nbsp;is&nbsp;null&nbsp;AND&nbsp;collection&nbsp;is&nbsp;null))"&nbsp;tab,&nbsp;[`V&nbsp;"C"];];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(*&nbsp;execl&nbsp;["OPEN&nbsp;cur1",&nbsp;[]];&nbsp;*)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["FETCH&nbsp;NEXT&nbsp;FROM&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["CLOSE&nbsp;cur1",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;execl&nbsp;["END",&nbsp;[]];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;handle<span class="keywordsign">#</span>finish;<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">PG</span>.<span class="constructor">Error</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"Error:&nbsp;%s"</span>&nbsp;(<span class="constructor">PG</span>.string_of_error&nbsp;e)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;say&nbsp;<span class="string">"Exn:&nbsp;%s"</span>&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)<br>
&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;say&nbsp;<span class="string">"EXITING"</span>;<br>
&nbsp;&nbsp;exit&nbsp;0</code></body></html>