 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Pvem_lwt_unix: Literate Implementation</title></head><body><div class="container"><h1>Pvem_lwt_unix: Literate Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul>
 <li><a href='index.html'>Home</a></li>
 <li><a href='pvem_lwt_unix.html'>Literate Implementation</a></li>
 <li><a href='./api/index.html'>API Documentation</a></li>
 <li>Repository <a href='https://bitbucket.org/smondet/pvem_lwt_unix'>at Bitbucket</a></li>
 <li>Up: <a href='../index.html'>Software Projects</a></li>
</ul>
</div><div class="col-md-9"><pre><span class="comment">(**************************************************************************)</span><span class="text">
</span><span class="comment">(*  Copyright (c) 2012, 2013,                                             *)</span><span class="text">
</span><span class="comment">(*                           Sebastien Mondet &lt;seb@mondet.org&gt;,           *)</span><span class="text">
</span><span class="comment">(*                           Ashish Agarwal &lt;agarwal1975@gmail.com&gt;.      *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Permission to use, copy, modify, and/or distribute this software for  *)</span><span class="text">
</span><span class="comment">(*  any purpose with or without fee is hereby granted, provided that the  *)</span><span class="text">
</span><span class="comment">(*  above  copyright notice  and this  permission notice  appear  in all  *)</span><span class="text">
</span><span class="comment">(*  copies.                                                               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  THE  SOFTWARE IS  PROVIDED  &quot;AS  IS&quot; AND  THE  AUTHOR DISCLAIMS  ALL  *)</span><span class="text">
</span><span class="comment">(*  WARRANTIES  WITH  REGARD  TO  THIS SOFTWARE  INCLUDING  ALL  IMPLIED  *)</span><span class="text">
</span><span class="comment">(*  WARRANTIES  OF MERCHANTABILITY AND  FITNESS. IN  NO EVENT  SHALL THE  *)</span><span class="text">
</span><span class="comment">(*  AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL  *)</span><span class="text">
</span><span class="comment">(*  DAMAGES OR ANY  DAMAGES WHATSOEVER RESULTING FROM LOSS  OF USE, DATA  *)</span><span class="text">
</span><span class="comment">(*  OR PROFITS,  WHETHER IN AN  ACTION OF CONTRACT, NEGLIGENCE  OR OTHER  *)</span><span class="text">
</span><span class="comment">(*  TORTIOUS ACTION,  ARISING OUT  OF OR IN  CONNECTION WITH THE  USE OR  *)</span><span class="text">
</span><span class="comment">(*  PERFORMANCE OF THIS SOFTWARE.                                         *)</span><span class="text">
</span><span class="comment">(**************************************************************************)</span><span class="text">


</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Deferred_result</span><span class="text"> = </span><span class="kw2">Pvem</span><span class="text">.</span><span class="kw2">With_deferred</span><span class="text">(</span><span class="kw2">Lwt</span><span class="text">)

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Deferred_result</span><span class="text">



</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">IO</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** Useful I/O functions. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">path</span><span class="text"> = </span><span class="kw3">string</span><span class="text">
  </span><span class="comment">(** The type of file paths *)</span><span class="text">

  </span><span class="comment">(** {3 Whole Files} *)</span><span class="text">

  </span><span class="comment">(** Write a string to a file. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">write_file</span><span class="text">: </span><span class="id">path</span><span class="text"> -&gt; </span><span class="id">content</span><span class="text">:</span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">, [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Write_file_exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">path</span><span class="text"> * </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Read a string from a file. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">read_file</span><span class="text">: </span><span class="id">path</span><span class="text"> -&gt;
    (</span><span class="kw3">string</span><span class="text">, [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Read_file_exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">path</span><span class="text"> * </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** {3 Access To Channels } *)</span><span class="text">

  </span><span class="comment">(** Run a function [f] on an output channel, if the channel comes from
      a [`File f], it will be closed before returning (in case of success,
      or error, but not for exceptions). *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">with_out_channel</span><span class="text">:
    ?</span><span class="id">buffer_size</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    </span><span class="id">f</span><span class="text">:(</span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">output_channel</span><span class="text"> -&gt;
       ('</span><span class="id">a</span><span class="text">,
        [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text">
             [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] ]
        </span><span class="kw1">as</span><span class="text"> '</span><span class="id">err</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt;
    [ `</span><span class="kw2">Append_to_file</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
    | `</span><span class="kw2">Create_file</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
    | `</span><span class="kw2">Overwrite_file</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
    | `</span><span class="kw2">Channel</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">output_channel</span><span class="text"> | `</span><span class="kw2">Stderr</span><span class="text"> | `</span><span class="kw2">Stdout</span><span class="text">] -&gt;
    ('</span><span class="id">a</span><span class="text">, '</span><span class="id">err</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Safely call [Lwt_io.fprint]. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">write</span><span class="text">: </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">output_channel</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> -&gt; (</span><span class="kw3">unit</span><span class="text">, [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Flush an output channel. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">flush</span><span class="text">: </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">output_channel</span><span class="text"> -&gt;  (</span><span class="kw3">unit</span><span class="text">, [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Run a function [f] on an input channel, if the channel comes from
      a [`File f], it will be closed before returning (in case of success,
      or error, but not for exceptions). *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">with_in_channel</span><span class="text">:
    [ `</span><span class="kw2">Channel</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">input_channel</span><span class="text"> | `</span><span class="kw2">File</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> | `</span><span class="kw2">Stdin</span><span class="text"> ] -&gt;
    ?</span><span class="id">buffer_size</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    </span><span class="id">f</span><span class="text">:(</span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">input_channel</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ] </span><span class="kw1">as</span><span class="text"> '</span><span class="id">err</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt;
    ('</span><span class="id">a</span><span class="text">, '</span><span class="id">err</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Read [count] bytes from an input-channel (default: “as much as possible”,
      c.f. {{:http://ocsigen.org/lwt/api/Lwt_io#VALread}Lwt_io.read}). *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">read</span><span class="text">: ?</span><span class="id">count</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">input_channel</span><span class="text"> -&gt;
    (</span><span class="kw3">string</span><span class="text">, [&gt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">error_to_string</span><span class="text">: 
    [&lt; `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&lt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> 
              | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
              | `</span><span class="kw2">Read_file_exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">exn</span><span class="text"> 
              | `</span><span class="kw2">Write_file_exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">exn</span><span class="text"> 
              | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] ] -&gt; </span><span class="kw3">string</span><span class="text">
  </span><span class="comment">(** Get a human-readable string out of an error produced by this module. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">SYSTEM</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** Basic system access functions. *)</span><span class="text">

  </span><span class="comment">(** Block for a given amount of seconds ([Lwt_unix.sleep]). *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">sleep</span><span class="text">: </span><span class="kw3">float</span><span class="text"> -&gt; (</span><span class="kw3">unit</span><span class="text">, [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Sleep</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">float</span><span class="text">]  * [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ]]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Manipulate [/bin/sh] commands (flavors of [Unix.system]).  *)</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Shell</span><span class="text"> : </span><span class="kw1">sig</span><span class="text">

    </span><span class="comment">(** Make [/bin/sh] execute a command, fail if it does not return 0. *)</span><span class="text">
    </span><span class="kw">val</span><span class="text"> </span><span class="id">do_or_fail</span><span class="text">: </span><span class="kw3">string</span><span class="text"> -&gt;
      (</span><span class="kw3">unit</span><span class="text">,
       [&gt; `</span><span class="kw2">Shell</span><span class="text"> </span><span class="kw">of</span><span class="text">
            </span><span class="kw3">string</span><span class="text"> * [&gt; `</span><span class="kw2">Exited</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> | `</span><span class="kw2">Signaled</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Stopped</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ]
       ]) </span><span class="id">t</span><span class="text">

    </span><span class="comment">(** Execute a shell command and return its standard output, standard error,
        and exit code
        [stdout, stderr]. *)</span><span class="text">
    </span><span class="kw">val</span><span class="text"> </span><span class="id">execute</span><span class="text">:
      </span><span class="kw3">string</span><span class="text"> -&gt;
      (</span><span class="kw3">string</span><span class="text"> * </span><span class="kw3">string</span><span class="text"> * [ `</span><span class="kw2">Exited</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Signaled</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Stopped</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ],
       [&gt; `</span><span class="kw2">Shell</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ]]) </span><span class="id">t</span><span class="text">

    </span><span class="kw">val</span><span class="text"> </span><span class="id">status_to_string</span><span class="text">:
      [&lt; `</span><span class="kw2">Exited</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> | `</span><span class="kw2">Signaled</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Stopped</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ] -&gt;
      </span><span class="kw3">string</span><span class="text">
    </span><span class="comment">(** Convert a status (or an error) to a human-readable string *)</span><span class="text">

  </span><span class="kw1">end</span><span class="text">

  </span><span class="comment">(** Execute a function [f] with a timeout (in seconds). If [f] throws
      an exception it will be passed as [`System (_, e)], if the functions
      timeouts the error will be [`Timeout time]. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">with_timeout</span><span class="text"> : </span><span class="kw3">float</span><span class="text"> -&gt;
    </span><span class="id">f</span><span class="text">:(</span><span class="kw3">unit</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, [&gt; `</span><span class="kw2">Timeout</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">float</span><span class="text">
                    | `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">With_timeout</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">float</span><span class="text"> ] * [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] 
                    ] </span><span class="kw1">as</span><span class="text"> '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; 
    ('</span><span class="id">a</span><span class="text">, '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Create a new empty directory or fail if it already exists
      (i.e. like [mkdir]). The default permissions are [0o700]. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">make_new_directory</span><span class="text">: ?</span><span class="id">perm</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text">
          [&gt; `</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] *
            [&gt; `</span><span class="kw2">Already_exists</span><span class="text"> | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text">
            | `</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Create as many directories as needed (can be 0) to ensure that the
      directory path exists (like [mkdir -p]). The default permissions
      are [0o700].  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">ensure_directory_path</span><span class="text">: ?</span><span class="id">perm</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text">
          [&gt; `</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] *
            [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> | `</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Quick information on files. *)</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">file_info</span><span class="text"> =
    [ `</span><span class="kw2">Absent</span><span class="text">
    | `</span><span class="kw2">Regular_file</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
    | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
    | `</span><span class="kw2">Block_device</span><span class="text">
    | `</span><span class="kw2">Character_device</span><span class="text">
    | `</span><span class="kw2">Directory</span><span class="text">
    | `</span><span class="kw2">Fifo</span><span class="text">
    | `</span><span class="kw2">Socket</span><span class="text">]

  </span><span class="kw">val</span><span class="text"> </span><span class="id">file_info_to_string</span><span class="text">: </span><span class="id">file_info</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text">
  </span><span class="comment">(** Convert file information to a string *)</span><span class="text">

  </span><span class="comment">(** Get information about a path (whether it exists, its size, or
      sym-link destination). If [follow_symlink] is [false]
      (default) use [lstat] (so the result can be [`Symlink _]), if [true]
      call [stat] (information about the target).  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">file_info</span><span class="text"> :
    ?</span><span class="id">follow_symlink</span><span class="text">:</span><span class="kw3">bool</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="id">file_info</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] * [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Get all the children of a directory, through a [next] stream-like
      function. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">list_directory</span><span class="text">: </span><span class="kw3">string</span><span class="text"> -&gt;
    [ `</span><span class="kw2">Stream</span><span class="text"> </span><span class="kw">of</span><span class="text">
        (</span><span class="kw3">unit</span><span class="text"> -&gt;
         (</span><span class="kw3">string</span><span class="text"> </span><span class="id">option</span><span class="text">,
          [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] * [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">) ]

  </span><span class="comment">(** Remove a file or a directory recursively. [remove] does not fail
      if the file does not exist.  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">remove</span><span class="text">: </span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
                   | `</span><span class="kw2">Remove</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
                   | `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] * 
            [&gt;  `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Make a symbolic link [link_path] pointing at
      [target]. [make_symlink] fails if the file [link_path] already
      exists. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">make_symlink</span><span class="text">: </span><span class="id">target</span><span class="text">:</span><span class="kw3">string</span><span class="text"> -&gt; </span><span class="id">link_path</span><span class="text">:</span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Make_symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="kw3">string</span><span class="text">]
                   * [&gt; `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
                     | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Specification of a “destination” for [copy] and [move]. *)</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">file_destination</span><span class="text"> = [
    | `</span><span class="kw2">Into</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> </span><span class="comment">(** [`Into path] means copy 'file' into the {b directory} path. *)</span><span class="text">
    | `</span><span class="kw2">Onto</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> </span><span class="comment">(** [`Onto path] means copy 'file' {b as} [path]. *)</span><span class="text">
  ]

  </span><span class="comment">(** Copy files or directories (recursively).

      If [ignore_strange] is true [copy] won't fail on block/character
      devices, fifos or sockets (defaults to [false]).

      The [buffer_size] (default [64_000]) is used both for reading and
      writing files.

      On can [`Fail] on symbolic links, [`Follow] them, or [`Redo] a new
      symlink with the same target.

  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">copy</span><span class="text">:
    ?</span><span class="id">ignore_strange</span><span class="text">:</span><span class="kw3">bool</span><span class="text"> -&gt;
    ?</span><span class="id">symlinks</span><span class="text">:[ `</span><span class="kw2">Fail</span><span class="text"> | `</span><span class="kw2">Follow</span><span class="text"> | `</span><span class="kw2">Redo</span><span class="text"> ] -&gt;
    ?</span><span class="id">buffer_size</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    ?</span><span class="id">if_exists</span><span class="text">:[ `</span><span class="kw2">Fail</span><span class="text"> | `</span><span class="kw2">Overwrite</span><span class="text"> | `</span><span class="kw2">Update</span><span class="text"> ] -&gt;
    </span><span class="id">src</span><span class="text">:</span><span class="kw3">string</span><span class="text"> -&gt; </span><span class="id">file_destination</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text">
          [&gt; `</span><span class="kw2">Copy</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Make_symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Remove</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] *
            [&gt; `</span><span class="kw2">Already_exists</span><span class="text">
            | `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ]
            | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text">
            | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
            | `</span><span class="kw2">Not_a_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">Wrong_file_kind</span><span class="text"> </span><span class="kw">of</span><span class="text">
                </span><span class="kw3">string</span><span class="text"> *
                  [&gt; `</span><span class="kw2">Block_device</span><span class="text"> | `</span><span class="kw2">Character_device</span><span class="text">
                  | `</span><span class="kw2">Fifo</span><span class="text"> | `</span><span class="kw2">Socket</span><span class="text"> | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Try to move [src] to [dest] using [Lwt_unix.rename], if it works,
      return [`Moved] if it does not work but [copy] could work
      (i.e. both paths are not in the same {i device}) return
      [`Must_copy]. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">move_in_same_device</span><span class="text">:
    ?</span><span class="id">if_exists</span><span class="text">:[ `</span><span class="kw2">Fail</span><span class="text"> | `</span><span class="kw2">Overwrite</span><span class="text"> | `</span><span class="kw2">Update</span><span class="text"> ] -&gt;
    </span><span class="id">src</span><span class="text">:</span><span class="kw3">string</span><span class="text"> -&gt; </span><span class="id">file_destination</span><span class="text"> -&gt;
    ([ `</span><span class="kw2">Moved</span><span class="text"> | `</span><span class="kw2">Must_copy</span><span class="text"> ],
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">Move</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> | `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ]
                   * [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text">
                     | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Heavy-weight function trying to mimic the behavior the UNIX command “mv”
      (c.f. {{:http://www.openbsd.org/cgi-bin/cvsweb/src/bin/mv/mv.c?rev=1.35;content-type=text%2Fplain;only_with_tag=HEAD}mv.c}):
      it tries [move_in_same_device] and if it returns [`Must_copy] it
      calls [copy] and [remove] (if [copy] fails, the [remove] won't
      happen but there will be no clean-up of the files already
      copied).
  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">move</span><span class="text">:
    ?</span><span class="id">ignore_strange</span><span class="text">:</span><span class="kw3">bool</span><span class="text"> -&gt;
    ?</span><span class="id">symlinks</span><span class="text">:[ `</span><span class="kw2">Fail</span><span class="text"> | `</span><span class="kw2">Follow</span><span class="text"> | `</span><span class="kw2">Redo</span><span class="text"> ] -&gt;
    ?</span><span class="id">buffer_size</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    ?</span><span class="id">if_exists</span><span class="text">:[ `</span><span class="kw2">Fail</span><span class="text"> | `</span><span class="kw2">Overwrite</span><span class="text"> | `</span><span class="kw2">Update</span><span class="text"> ] -&gt;
    </span><span class="id">src</span><span class="text">:</span><span class="kw3">string</span><span class="text"> -&gt; </span><span class="id">file_destination</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">,
     [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text">
          [&gt; `</span><span class="kw2">Copy</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Move</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Remove</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Make_symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="kw3">string</span><span class="text">
          | `</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] *
            [&gt; `</span><span class="kw2">Already_exists</span><span class="text">
            | `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&gt; `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ]
            | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text">
            | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
            | `</span><span class="kw2">Not_a_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
            | `</span><span class="kw2">Wrong_file_kind</span><span class="text"> </span><span class="kw">of</span><span class="text">
                </span><span class="kw3">string</span><span class="text"> *
                  [&gt; `</span><span class="kw2">Block_device</span><span class="text"> | `</span><span class="kw2">Character_device</span><span class="text">
                  | `</span><span class="kw2">Fifo</span><span class="text"> | `</span><span class="kw2">Socket</span><span class="text"> | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] ] ]) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Representation of a hierarchy of files ([`Leaf]) and directories ([`Node]). *)</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">file_tree</span><span class="text"> = [
    | `</span><span class="kw2">Node</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">file_tree</span><span class="text"> </span><span class="kw3">list</span><span class="text">
    | `</span><span class="kw2">Leaf</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">file_info</span><span class="text">
  ]

  </span><span class="comment">(** Obtain the [file_tree] starting at a given path. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">file_tree</span><span class="text"> :
    ?</span><span class="id">follow_symlinks</span><span class="text">:</span><span class="kw3">bool</span><span class="text"> -&gt;
    </span><span class="kw3">string</span><span class="text"> -&gt;
    (</span><span class="id">file_tree</span><span class="text">, [&gt; `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text">
                     [&gt; `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
                     | `</span><span class="kw2">File_tree</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
                     | `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] *
                       [&gt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text">
                       | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">] ]) </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">error_to_string</span><span class="text">:
    [&lt; `</span><span class="kw2">Shell</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> *
           [&lt; `</span><span class="kw2">Exited</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> | `</span><span class="kw2">Signaled</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="kw2">Stopped</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ]
    | `</span><span class="kw2">System</span><span class="text"> </span><span class="kw">of</span><span class="text">
         [&lt; `</span><span class="kw2">Copy</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">File_info</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">File_tree</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">Make_symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">Move</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
         | `</span><span class="kw2">Remove</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ]
         * [&lt; `</span><span class="kw2">Already_exists</span><span class="text"> 
           | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> 
           | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
           | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
           | `</span><span class="kw2">IO</span><span class="text"> </span><span class="kw">of</span><span class="text"> [&lt; `</span><span class="kw2">Exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">exn</span><span class="text"> 
                    | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
                    | `</span><span class="kw2">Read_file_exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">exn</span><span class="text"> 
                    | `</span><span class="kw2">Write_file_exn</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">exn</span><span class="text"> 
                    | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] 
           | `</span><span class="kw2">Not_a_directory</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> 
           | `</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> 
           | `</span><span class="kw2">Wrong_file_kind</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">file_info</span><span class="text">
           | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> ] 
    ] -&gt; </span><span class="kw3">string</span><span class="text">
  </span><span class="comment">(** Make a human-readable string for any error in this module. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">


</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">DEFERRED_LIST</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
</span><span class="comment">(** Monadic “operations” on lists. *)</span><span class="text">

  </span><span class="comment">(** Sequentially launch [f] on the first argument and
      get out of the loop at the first error.
      The function returns the list of results if all succeed, or the
      first error.
  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">while_sequential</span><span class="text">: '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Sequentially launch [f] on the first argument and process the
      whole list even if there are errors.
      The function returns the list of successes and the list of errors.  *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">for_sequential</span><span class="text">: '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text"> * '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Like [for_sequential] but all the threads are launched concurrently. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">for_concurrent</span><span class="text">: '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text"> * '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** Like [for_concurrent] but with the index in the list passed to the
      function. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">for_concurrent_with_index</span><span class="text">:
    '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="kw3">int</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text"> * '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">

  </span><span class="comment">(** [pick_and_cancel] is a wrapper for [Lwt.pick]. *)</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">pick_and_cancel</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">LIGHT</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** Basic traffic lights. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** The traffic signal handle (uses {!Lwt.task}). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">create</span><span class="text">: </span><span class="kw3">unit</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Create a “red” traffic light. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">try_to_pass</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; (</span><span class="kw3">unit</span><span class="text">, '</span><span class="id">a</span><span class="text">) </span><span class="kw2">Deferred_result</span><span class="text">.</span><span class="id">t</span><span class="text">
  </span><span class="comment">(** [try_to_pass t] will block until [t] is “green” or will return
      immediately if [t] is already green. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">green</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">
  </span><span class="comment">(** [green t] sets the light to “green”, this will wake up all the threads
    waiting on [try_to_pass t]. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Internal_pervasives</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (|&gt;) </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">StringLabels</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">List</span><span class="text"> = </span><span class="kw2">ListLabels</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Filename</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
    </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">string_rexists</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="id">n</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text"> =
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text">
          </span><span class="kw2">None</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">.[</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">] </span><span class="kw1">then</span><span class="text">
          </span><span class="kw2">Some</span><span class="text"> </span><span class="id">n</span><span class="text">
        </span><span class="kw1">else</span><span class="text">
          </span><span class="id">loop</span><span class="text"> (</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">skip_end_slashes</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">string_rexists</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text"> &lt;&gt; </span><span class="string">'/'</span><span class="text">) </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt; `</span><span class="kw2">Ends_at</span><span class="text"> </span><span class="id">v</span><span class="text">
      | </span><span class="kw2">None</span><span class="text">   -&gt; `</span><span class="kw2">All_slashes</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">split</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | </span><span class="string">&quot;&quot;</span><span class="text"> -&gt; </span><span class="string">&quot;.&quot;</span><span class="text">, </span><span class="string">&quot;.&quot;</span><span class="text">
    | </span><span class="id">s</span><span class="text"> -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">skip_end_slashes</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">All_slashes</span><span class="text"> -&gt; </span><span class="string">&quot;/&quot;</span><span class="text">, </span><span class="string">&quot;/&quot;</span><span class="text">
      | `</span><span class="kw2">Ends_at</span><span class="text"> </span><span class="id">basename_end</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">string_rexists</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text"> = </span><span class="string">'/'</span><span class="text">) </span><span class="kw4">~from</span><span class="text">:</span><span class="id">basename_end</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="string">&quot;.&quot;</span><span class="text">, </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="kw4">~pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:</span><span class="id">basename_end</span><span class="text"> </span><span class="id">s</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">basename_start</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">basename</span><span class="text"> =
            </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~pos</span><span class="text">:</span><span class="id">basename_start</span><span class="text">
              </span><span class="kw4">~len</span><span class="text">:(</span><span class="id">basename_end</span><span class="text"> - </span><span class="id">basename_start</span><span class="text">)
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">dirname</span><span class="text"> =
            </span><span class="kw1">match</span><span class="text"> </span><span class="id">skip_end_slashes</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="id">basename_start</span><span class="text"> </span><span class="kw1">with</span><span class="text">
            | `</span><span class="kw2">All_slashes</span><span class="text"> -&gt; </span><span class="string">&quot;/&quot;</span><span class="text">
            | `</span><span class="kw2">Ends_at</span><span class="text"> </span><span class="id">dirname_end</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="kw4">~pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:</span><span class="id">dirname_end</span><span class="text"> </span><span class="id">s</span><span class="text">
          </span><span class="kw">in</span><span class="text">
          </span><span class="id">dirname</span><span class="text">, </span><span class="id">basename</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">parts</span><span class="text"> </span><span class="id">filename</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">filename</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">split</span><span class="text"> </span><span class="id">filename</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="string">&quot;.&quot;</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">base</span><span class="text">, </span><span class="string">&quot;.&quot;</span><span class="text"> -&gt; </span><span class="id">base</span><span class="text"> :: </span><span class="id">acc</span><span class="text">
        | </span><span class="string">&quot;/&quot;</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">base</span><span class="text">, </span><span class="string">&quot;/&quot;</span><span class="text"> -&gt; </span><span class="id">base</span><span class="text"> :: </span><span class="id">acc</span><span class="text">
        | </span><span class="id">rest</span><span class="text">, </span><span class="id">dir</span><span class="text"> -&gt;
          </span><span class="id">loop</span><span class="text"> (</span><span class="id">dir</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">rest</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">loop</span><span class="text"> [] </span><span class="id">filename</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">exn</span><span class="text"> = </span><span class="kw2">Printexc</span><span class="text">.</span><span class="id">to_string</span><span class="text">
</span><span class="kw1">end</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Internal_pervasives</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Printf</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">IO</span><span class="text"> : </span><span class="kw2">IO</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">path</span><span class="text"> = </span><span class="kw3">string</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail_io</span><span class="text"> </span><span class="id">e</span><span class="text"> = </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">IO</span><span class="text"> </span><span class="id">e</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">wrap_deferred_io</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="id">wrap_deferred</span><span class="text"> </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">IO</span><span class="text"> (`</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">)) (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">f</span><span class="text"> ())

  </span><span class="kw">let</span><span class="text"> </span><span class="id">error_to_string</span><span class="text"> = </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">IO</span><span class="text"> </span><span class="id">err</span><span class="text"> -&gt;
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">err</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">  -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;IO-Exception %s&quot;</span><span class="text"> (</span><span class="id">exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
    | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Wrong-path: %S&quot;</span><span class="text"> </span><span class="id">e</span><span class="text">
    | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;File already exists: %S&quot;</span><span class="text"> </span><span class="id">e</span><span class="text">
    | `</span><span class="kw2">Read_file_exn</span><span class="text"> (</span><span class="id">p</span><span class="text">, </span><span class="id">e</span><span class="text">) -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Exception while reading %S: %s&quot;</span><span class="text"> </span><span class="id">p</span><span class="text"> (</span><span class="id">exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
    | `</span><span class="kw2">Write_file_exn</span><span class="text"> (</span><span class="id">p</span><span class="text">, </span><span class="id">e</span><span class="text">) -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Exception while writing %S: %s&quot;</span><span class="text"> </span><span class="id">p</span><span class="text"> (</span><span class="id">exn</span><span class="text"> </span><span class="id">e</span><span class="text">)

  </span><span class="comment">(******************************************************************************)</span><span class="text">
  </span><span class="comment">(* Channels *)</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">with_out_channel</span><span class="text"> ?</span><span class="id">buffer_size</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">out</span><span class="text"> =
    </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">open_file</span><span class="text"> </span><span class="kw4">~flags</span><span class="text"> </span><span class="id">file</span><span class="text"> =
        </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">open_file</span><span class="text"> </span><span class="kw4">~mode</span><span class="text">:</span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">output</span><span class="text"> ?</span><span class="id">buffer_size</span><span class="text"> </span><span class="kw4">~flags</span><span class="text"> </span><span class="id">file</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">out</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Stdout</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">stdout</span><span class="text">
      | `</span><span class="kw2">Stderr</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">stderr</span><span class="text">
      | `</span><span class="kw2">Channel</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">c</span><span class="text">
      | `</span><span class="kw2">Append_to_file</span><span class="text"> </span><span class="id">file</span><span class="text"> -&gt;
        </span><span class="id">open_file</span><span class="text"> </span><span class="kw4">~flags</span><span class="text">:</span><span class="kw2">Unix</span><span class="text">.([ </span><span class="kw2">O_CREAT</span><span class="text">; </span><span class="kw2">O_WRONLY</span><span class="text">; </span><span class="kw2">O_APPEND</span><span class="text"> ]) </span><span class="id">file</span><span class="text">
      | `</span><span class="kw2">Overwrite_file</span><span class="text"> </span><span class="id">file</span><span class="text"> -&gt;
        </span><span class="id">open_file</span><span class="text"> </span><span class="kw4">~flags</span><span class="text">:</span><span class="kw2">Unix</span><span class="text">.([ </span><span class="kw2">O_CREAT</span><span class="text">; </span><span class="kw2">O_WRONLY</span><span class="text">; </span><span class="kw2">O_TRUNC</span><span class="text"> ]) </span><span class="id">file</span><span class="text">
      | `</span><span class="kw2">Create_file</span><span class="text"> </span><span class="id">file</span><span class="text"> -&gt;
        </span><span class="id">open_file</span><span class="text"> </span><span class="kw4">~flags</span><span class="text">:</span><span class="kw2">Unix</span><span class="text">.([ </span><span class="kw2">O_CREAT</span><span class="text">; </span><span class="kw2">O_WRONLY</span><span class="text">; </span><span class="kw2">O_EXCL</span><span class="text"> ]) </span><span class="id">file</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">outchan</span><span class="text"> -&gt;
      </span><span class="kw1">begin</span><span class="text">
        </span><span class="id">f</span><span class="text"> </span><span class="id">outchan</span><span class="text">
        &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
        | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
          </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">close</span><span class="text"> </span><span class="id">outchan</span><span class="text">)
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
          </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
        | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">out</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | `</span><span class="kw2">Append_to_file</span><span class="text"> </span><span class="numeric">_</span><span class="text">
          | `</span><span class="kw2">Overwrite_file</span><span class="text"> </span><span class="numeric">_</span><span class="text">
          | `</span><span class="kw2">Create_file</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
            </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">close</span><span class="text"> </span><span class="id">outchan</span><span class="text">)
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
            </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
          | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">IO</span><span class="text"> (`</span><span class="kw2">Exn</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">ENOENT</span><span class="text">, </span><span class="numeric">_</span><span class="text">, </span><span class="id">path</span><span class="text">)))) -&gt;
      </span><span class="id">fail_io</span><span class="text"> (`</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="id">path</span><span class="text">)
    | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">IO</span><span class="text"> (`</span><span class="kw2">Exn</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EEXIST</span><span class="text">, </span><span class="numeric">_</span><span class="text">, </span><span class="id">path</span><span class="text">)))) -&gt;
      </span><span class="id">fail_io</span><span class="text"> (`</span><span class="kw2">File_exists</span><span class="text"> </span><span class="id">path</span><span class="text">)
    | `</span><span class="kw2">Error</span><span class="text">  </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">write</span><span class="text"> </span><span class="id">out</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">fprint</span><span class="text"> </span><span class="id">out</span><span class="text"> </span><span class="id">s</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">flush</span><span class="text"> </span><span class="id">out</span><span class="text"> = </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">flush</span><span class="text"> </span><span class="id">out</span><span class="text">)


  </span><span class="kw">let</span><span class="text"> </span><span class="id">with_in_channel</span><span class="text"> </span><span class="id">inspec</span><span class="text"> ?</span><span class="id">buffer_size</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">inspec</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Stdin</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">stdin</span><span class="text">
    | `</span><span class="kw2">Channel</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">c</span><span class="text">
    | `</span><span class="kw2">File</span><span class="text"> </span><span class="id">file</span><span class="text"> -&gt;
      </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
          </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">open_file</span><span class="text"> </span><span class="kw4">~mode</span><span class="text">:</span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">input</span><span class="text"> ?</span><span class="id">buffer_size</span><span class="text"> </span><span class="id">file</span><span class="text">)
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">inchan</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text">
      </span><span class="id">f</span><span class="text"> </span><span class="id">inchan</span><span class="text">
      &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
        </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">close</span><span class="text"> </span><span class="id">inchan</span><span class="text">)
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
      | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">inspec</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">File</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
          </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">close</span><span class="text"> </span><span class="id">inchan</span><span class="text">)
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
          </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">read</span><span class="text"> ?</span><span class="id">count</span><span class="text"> </span><span class="id">i</span><span class="text"> =
    </span><span class="id">wrap_deferred_io</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">read</span><span class="text"> ?</span><span class="id">count</span><span class="text"> </span><span class="id">i</span><span class="text">)

  </span><span class="comment">(******************************************************************************)</span><span class="text">
  </span><span class="comment">(* Whole Files *)</span><span class="text">

  </span><span class="kw">let</span><span class="text">  </span><span class="id">write_file</span><span class="text"> </span><span class="id">file</span><span class="text"> </span><span class="kw4">~content</span><span class="text"> =
    </span><span class="id">catch_deferred</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">with_file</span><span class="text"> </span><span class="kw4">~mode</span><span class="text">:</span><span class="id">output</span><span class="text"> </span><span class="id">file</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">write</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">content</span><span class="text">))
    &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail_io</span><span class="text"> (`</span><span class="kw2">Write_file_exn</span><span class="text"> (</span><span class="id">file</span><span class="text">, </span><span class="id">e</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">read_file</span><span class="text"> </span><span class="id">file</span><span class="text"> =
    </span><span class="id">catch_deferred</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">with_file</span><span class="text"> </span><span class="kw4">~mode</span><span class="text">:</span><span class="id">input</span><span class="text"> </span><span class="id">file</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">read</span><span class="text"> </span><span class="id">i</span><span class="text">))
     &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail_io</span><span class="text"> (`</span><span class="kw2">Read_file_exn</span><span class="text"> (</span><span class="id">file</span><span class="text">, </span><span class="id">e</span><span class="text">))

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">System</span><span class="text"> : </span><span class="kw2">SYSTEM</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">wrap_deferred_system</span><span class="text"> </span><span class="id">cmd</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="id">wrap_deferred</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">System</span><span class="text"> (</span><span class="id">cmd</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail_sys</span><span class="text"> </span><span class="id">r</span><span class="text"> = </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> </span><span class="id">r</span><span class="text">)

  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Shell</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">discriminate_process_status</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">ret</span><span class="text"> =
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">ret</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WEXITED</span><span class="text"> </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WEXITED</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Shell</span><span class="text"> (</span><span class="id">s</span><span class="text">, `</span><span class="kw2">Exited</span><span class="text"> </span><span class="id">n</span><span class="text">))
      | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WSIGNALED</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Shell</span><span class="text"> (</span><span class="id">s</span><span class="text">, `</span><span class="kw2">Signaled</span><span class="text"> </span><span class="id">n</span><span class="text">))
      | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WSTOPPED</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Shell</span><span class="text"> (</span><span class="id">s</span><span class="text">, `</span><span class="kw2">Stopped</span><span class="text"> </span><span class="id">n</span><span class="text">))
    </span><span class="kw1">end</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">status_to_string</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Exited</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Exited with %d&quot;</span><span class="text"> </span><span class="id">i</span><span class="text">
    | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Exception %s&quot;</span><span class="text"> (</span><span class="id">exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
    | `</span><span class="kw2">Signaled</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Signaled (%d)&quot;</span><span class="text"> </span><span class="id">i</span><span class="text">
    | `</span><span class="kw2">Stopped</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Stopped (%d)&quot;</span><span class="text"> </span><span class="id">i</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">do_or_fail</span><span class="text"> </span><span class="id">s</span><span class="text"> =
      </span><span class="id">wrap_deferred</span><span class="text">  </span><span class="kw2">Lwt_io</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">system</span><span class="text"> </span><span class="id">s</span><span class="text">)
        </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">Shell</span><span class="text"> (</span><span class="id">s</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">ret</span><span class="text"> -&gt;
      </span><span class="id">discriminate_process_status</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">ret</span><span class="text">


    </span><span class="kw">let</span><span class="text"> </span><span class="id">execute</span><span class="text"> </span><span class="id">s</span><span class="text"> =
      </span><span class="id">wrap_deferred</span><span class="text"> </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">Shell</span><span class="text"> (</span><span class="id">s</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
        </span><span class="kw2">Lwt</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">inprocess</span><span class="text"> = </span><span class="kw2">Lwt_process</span><span class="text">.(</span><span class="id">open_process_full</span><span class="text"> (</span><span class="id">shell</span><span class="text"> </span><span class="id">s</span><span class="text">)) </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Lwt_list</span><span class="text">.</span><span class="id">map_p</span><span class="text"> </span><span class="kw2">Lwt_io</span><span class="text">.</span><span class="id">read</span><span class="text">
            [</span><span class="id">inprocess</span><span class="kw1">#</span><span class="id">stdout</span><span class="text">; </span><span class="id">inprocess</span><span class="kw1">#</span><span class="id">stderr</span><span class="text">; ]
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">output</span><span class="text"> -&gt;
          </span><span class="id">inprocess</span><span class="kw1">#</span><span class="id">status</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">status</span><span class="text"> -&gt;
          </span><span class="id">return</span><span class="text"> (</span><span class="id">status</span><span class="text">, </span><span class="id">output</span><span class="text">))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="id">ret</span><span class="text">, </span><span class="id">output</span><span class="text">) -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">code</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">ret</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WEXITED</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt;   (`</span><span class="kw2">Exited</span><span class="text"> </span><span class="id">n</span><span class="text">)
        | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WSIGNALED</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt; (`</span><span class="kw2">Signaled</span><span class="text"> </span><span class="id">n</span><span class="text">)
        | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">WSTOPPED</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt;  (`</span><span class="kw2">Stopped</span><span class="text"> </span><span class="id">n</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">output</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [</span><span class="id">out</span><span class="text">; </span><span class="id">err</span><span class="text">] -&gt; </span><span class="id">return</span><span class="text"> (</span><span class="id">out</span><span class="text">, </span><span class="id">err</span><span class="text">, </span><span class="id">code</span><span class="text">)
      | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw1">end</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">sleep</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="id">wrap_deferred_system</span><span class="text"> (`</span><span class="kw2">Sleep</span><span class="text"> </span><span class="id">f</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">sleep</span><span class="text"> </span><span class="id">f</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">with_timeout</span><span class="text"> </span><span class="id">time</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">catch</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">with_timeout</span><span class="text"> </span><span class="id">time</span><span class="text"> </span><span class="id">f</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="kw2">Timeout</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Timeout</span><span class="text"> </span><span class="id">time</span><span class="text">)
      | </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail_sys</span><span class="text"> (`</span><span class="kw2">With_timeout</span><span class="text"> </span><span class="id">time</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">mkdir_or_fail</span><span class="text"> ?(</span><span class="id">perm</span><span class="text">=</span><span class="numeric">0o700</span><span class="text">) </span><span class="id">dirname</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">fail_here</span><span class="text"> </span><span class="id">e</span><span class="text"> =
      </span><span class="id">fail_sys</span><span class="text"> (`</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="id">dirname</span><span class="text">, </span><span class="id">e</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">catch</span><span class="text">
      </span><span class="kw2">Lwt</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">mkdir</span><span class="text"> </span><span class="id">dirname</span><span class="text"> </span><span class="id">perm</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> ()))
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EACCES</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt;
        </span><span class="id">fail_here</span><span class="text"> (`</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="id">perm</span><span class="text">)
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EEXIST</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt;
        </span><span class="id">fail_here</span><span class="text"> (`</span><span class="kw2">Already_exists</span><span class="text">)
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EISDIR</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt;
        </span><span class="comment">(* Bypass MacOSX bug https://github.com/janestreet/core/issues/7 *)</span><span class="text">
        </span><span class="id">fail_here</span><span class="text"> (`</span><span class="kw2">Already_exists</span><span class="text">)
      | </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail_here</span><span class="text"> (`</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">mkdir_even_if_exists</span><span class="text"> ?(</span><span class="id">perm</span><span class="text">=</span><span class="numeric">0o700</span><span class="text">) </span><span class="id">dirname</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">fail_here</span><span class="text"> </span><span class="id">e</span><span class="text"> =
      </span><span class="id">fail_sys</span><span class="text"> (`</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="id">dirname</span><span class="text">, </span><span class="id">e</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">catch</span><span class="text">
      </span><span class="kw2">Lwt</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">mkdir</span><span class="text"> </span><span class="id">dirname</span><span class="text"> </span><span class="id">perm</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> ()))
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EACCES</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt;
        </span><span class="id">fail_here</span><span class="text"> (`</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="id">perm</span><span class="text">)
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EISDIR</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt;
        </span><span class="comment">(* Bypass MacOSX bug https://github.com/janestreet/core/issues/7 *)</span><span class="text">
        </span><span class="id">return</span><span class="text"> ()
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EEXIST</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt; </span><span class="id">return</span><span class="text"> ()
      | </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail_here</span><span class="text"> (`</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">make_new_directory</span><span class="text"> ?</span><span class="id">perm</span><span class="text"> </span><span class="id">dirname</span><span class="text"> =
    </span><span class="id">mkdir_or_fail</span><span class="text"> ?</span><span class="id">perm</span><span class="text"> </span><span class="id">dirname</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">ensure_directory_path</span><span class="text"> ?</span><span class="id">perm</span><span class="text"> </span><span class="id">dirname</span><span class="text"> =
    </span><span class="comment">(* Code inspired by Core.Std.Unix *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">init</span><span class="text">, </span><span class="id">dirs</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">parts</span><span class="text"> </span><span class="id">dirname</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt; </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Sys.mkdir_p: BUG! Filename.parts %s -&gt; []&quot;</span><span class="text"> </span><span class="id">dirname</span><span class="text">
      | </span><span class="id">init</span><span class="text"> :: </span><span class="id">dirs</span><span class="text"> -&gt; (</span><span class="id">init</span><span class="text">, </span><span class="id">dirs</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">mkdir_even_if_exists</span><span class="text"> ?</span><span class="id">perm</span><span class="text"> </span><span class="id">init</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text"> </span><span class="id">dirs</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> </span><span class="id">init</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="id">part</span><span class="text"> -&gt;
        </span><span class="id">m</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">previous</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">dir</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="id">previous</span><span class="text"> </span><span class="id">part</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">mkdir_even_if_exists</span><span class="text"> ?</span><span class="id">perm</span><span class="text"> </span><span class="id">dir</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">return</span><span class="text"> </span><span class="id">dir</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
    </span><span class="id">return</span><span class="text"> ()

  </span><span class="kw">type</span><span class="text"> </span><span class="id">file_info</span><span class="text"> =
    [ `</span><span class="kw2">Absent</span><span class="text">
    | `</span><span class="kw2">Regular_file</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
    | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
    | `</span><span class="kw2">Block_device</span><span class="text">
    | `</span><span class="kw2">Character_device</span><span class="text">
    | `</span><span class="kw2">Directory</span><span class="text">
    | `</span><span class="kw2">Fifo</span><span class="text">
    | `</span><span class="kw2">Socket</span><span class="text">]

</span><span class="comment">(*
  WARNING: this is a work-around for issue [329] with Lwt_unix.readlink.
  When it is fixed, we should go back to Lwt_unix.

  [329]: http://ocsigen.org/trac/ticket/329
*)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">lwt_unix_readlink</span><span class="text"> </span><span class="id">l</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Lwt</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Lwt_preemptive</span><span class="text">.</span><span class="id">detach</span><span class="text"> </span><span class="kw2">Unix</span><span class="text">.</span><span class="id">readlink</span><span class="text"> </span><span class="id">l</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">file_info</span><span class="text"> ?(</span><span class="id">follow_symlink</span><span class="text">=</span><span class="constant">false</span><span class="text">) </span><span class="id">path</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">stat_fun</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">follow_symlink</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">stat</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">lstat</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="comment">(* eprintf &quot;(l)stat %s? \n%!&quot; path; *)</span><span class="text">
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">catch</span><span class="text">
      </span><span class="kw2">Lwt</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">stat_fun</span><span class="text"> </span><span class="id">path</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">Unix_stats</span><span class="text"> </span><span class="id">s</span><span class="text">)))
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">ENOENT</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt; </span><span class="id">return</span><span class="text"> `</span><span class="kw2">Absent</span><span class="text">
      | </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail_sys</span><span class="text"> (`</span><span class="kw2">File_info</span><span class="text"> </span><span class="id">path</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Lwt_unix</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Absent</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> `</span><span class="kw2">Absent</span><span class="text">
    | `</span><span class="kw2">Unix_stats</span><span class="text"> </span><span class="id">stats</span><span class="text"> -&gt;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">stats</span><span class="text">.</span><span class="id">st_kind</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">S_DIR</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Directory</span><span class="text">)
      | </span><span class="kw2">S_REG</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Regular_file</span><span class="text"> (</span><span class="id">stats</span><span class="text">.</span><span class="id">st_size</span><span class="text">))
      | </span><span class="kw2">S_LNK</span><span class="text"> -&gt;
        </span><span class="comment">(* eprintf &quot;readlink %s? \n%!&quot; path; *)</span><span class="text">
        </span><span class="kw1">begin</span><span class="text">
          </span><span class="id">catch_deferred</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">lwt_unix_readlink</span><span class="text"> </span><span class="id">path</span><span class="text">)
          &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
          | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">s</span><span class="text">
          | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">File_info</span><span class="text"> </span><span class="id">path</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">destination</span><span class="text"> -&gt;
        </span><span class="comment">(* eprintf &quot;readlink %s worked \n%!&quot; path; *)</span><span class="text">
        </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Symlink</span><span class="text"> </span><span class="id">destination</span><span class="text">)
      | </span><span class="kw2">S_CHR</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Character_device</span><span class="text">)
      | </span><span class="kw2">S_BLK</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Block_device</span><span class="text">)
      | </span><span class="kw2">S_FIFO</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Fifo</span><span class="text">)
      | </span><span class="kw2">S_SOCK</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Socket</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">list_directory</span><span class="text"> </span><span class="id">path</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">f_stream</span><span class="text"> = </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">files_of_directory</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">next</span><span class="text"> </span><span class="id">s</span><span class="text"> =
      </span><span class="id">wrap_deferred</span><span class="text"> </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">List_directory</span><span class="text"> </span><span class="id">path</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
        </span><span class="kw2">Lwt</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="id">catch</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_stream</span><span class="text">.</span><span class="id">next</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> (</span><span class="kw2">Some</span><span class="text"> </span><span class="id">n</span><span class="text">))
              (</span><span class="kw">function</span><span class="text"> </span><span class="kw2">Lwt_stream</span><span class="text">.</span><span class="kw2">Empty</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="kw2">None</span><span class="text"> | </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    `</span><span class="kw2">Stream</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; (</span><span class="id">next</span><span class="text"> </span><span class="id">f_stream</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">remove</span><span class="text"> </span><span class="id">path</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">remove_aux</span><span class="text"> </span><span class="id">path</span><span class="text"> =
      </span><span class="id">file_info</span><span class="text"> </span><span class="id">path</span><span class="text">
      &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Absent</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Block_device</span><span class="text">
      | `</span><span class="kw2">Character_device</span><span class="text">
      | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | `</span><span class="kw2">Fifo</span><span class="text">
      | `</span><span class="kw2">Socket</span><span class="text">
      | `</span><span class="kw2">Regular_file</span><span class="text"> </span><span class="numeric">_</span><span class="text">-&gt; </span><span class="id">wrap_deferred_system</span><span class="text"> (`</span><span class="kw2">Remove</span><span class="text"> </span><span class="id">path</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">unlink</span><span class="text"> </span><span class="id">path</span><span class="text">)
      | `</span><span class="kw2">Directory</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> `</span><span class="kw2">Stream</span><span class="text"> </span><span class="id">next_dir</span><span class="text"> = </span><span class="id">list_directory</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> () =
          </span><span class="id">next_dir</span><span class="text"> ()
          &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;..&quot;</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;.&quot;</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> ()
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">name</span><span class="text"> -&gt;
            </span><span class="id">remove_aux</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="id">name</span><span class="text">)
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="id">loop</span><span class="text"> ()
          | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="id">loop</span><span class="text"> ()
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">wrap_deferred_system</span><span class="text"> (`</span><span class="kw2">Remove</span><span class="text"> </span><span class="id">path</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">rmdir</span><span class="text"> </span><span class="id">path</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">remove_aux</span><span class="text"> </span><span class="id">path</span><span class="text">
    &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; </span><span class="id">return</span><span class="text"> ()
    | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">System_exn</span><span class="text"> </span><span class="id">e</span><span class="text">) -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Remove</span><span class="text"> </span><span class="id">path</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
    | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> </span><span class="id">e</span><span class="text">) -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> </span><span class="id">e</span><span class="text">)
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">make_symlink</span><span class="text"> </span><span class="kw4">~target</span><span class="text"> </span><span class="kw4">~link_path</span><span class="text"> =
    </span><span class="id">wrap_deferred</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">symlink</span><span class="text"> </span><span class="id">target</span><span class="text"> </span><span class="id">link_path</span><span class="text">)
      </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">e</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EEXIST</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt;
            (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Make_symlink</span><span class="text"> (</span><span class="id">target</span><span class="text">, </span><span class="id">link_path</span><span class="text">), `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="id">link_path</span><span class="text">))
          | </span><span class="id">e</span><span class="text"> -&gt;  (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Make_symlink</span><span class="text"> (</span><span class="id">target</span><span class="text">, </span><span class="id">link_path</span><span class="text">), `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
          </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">type</span><span class="text"> </span><span class="id">file_destination</span><span class="text"> = [
    | `</span><span class="kw2">Into</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
    | `</span><span class="kw2">Onto</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text">
  ]
  </span><span class="kw">let</span><span class="text"> </span><span class="id">path_of_destination</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">dst</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Into</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt; </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">concat</span><span class="text"> </span><span class="id">p</span><span class="text"> (</span><span class="id">basename</span><span class="text"> </span><span class="id">src</span><span class="text">))
    | `</span><span class="kw2">Onto</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt; </span><span class="id">p</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">copy</span><span class="text">
      ?(</span><span class="id">ignore_strange</span><span class="text">=</span><span class="constant">false</span><span class="text">) ?(</span><span class="id">symlinks</span><span class="text">=`</span><span class="kw2">Fail</span><span class="text">) ?(</span><span class="id">buffer_size</span><span class="text">=</span><span class="numeric">64_000</span><span class="text">)
      ?(</span><span class="id">if_exists</span><span class="text">=`</span><span class="kw2">Fail</span><span class="text">)
      </span><span class="kw4">~src</span><span class="text"> </span><span class="id">dst</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">copy_aux</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> =
      </span><span class="id">file_info</span><span class="text"> </span><span class="id">src</span><span class="text">
      &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Absent</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="id">src</span><span class="text">)
      | `</span><span class="kw2">Block_device</span><span class="text">
      | `</span><span class="kw2">Character_device</span><span class="text">
      | `</span><span class="kw2">Fifo</span><span class="text">
      | `</span><span class="kw2">Socket</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">k</span><span class="text"> -&gt;
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">ignore_strange</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">return</span><span class="text"> () </span><span class="kw1">else</span><span class="text"> </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Wrong_file_kind</span><span class="text"> (</span><span class="id">src</span><span class="text">, </span><span class="id">k</span><span class="text">))
      | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="id">content</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">symlinks</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Fail</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Wrong_file_kind</span><span class="text"> (</span><span class="id">src</span><span class="text">, `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="id">content</span><span class="text">))
        | `</span><span class="kw2">Follow</span><span class="text"> -&gt; </span><span class="id">copy_aux</span><span class="text"> </span><span class="kw4">~src</span><span class="text">:</span><span class="id">content</span><span class="text"> </span><span class="kw4">~dst</span><span class="text">
        | `</span><span class="kw2">Redo</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">link_path</span><span class="text"> = </span><span class="id">path_of_destination</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">if_exists</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | `</span><span class="kw2">Fail</span><span class="text"> -&gt; </span><span class="comment">(* make_symlink already fails on existing files *)</span><span class="text">
            </span><span class="id">return</span><span class="text"> ()
          | `</span><span class="kw2">Overwrite</span><span class="text">
          | `</span><span class="kw2">Update</span><span class="text"> -&gt; </span><span class="id">remove</span><span class="text"> </span><span class="id">link_path</span><span class="text"> </span><span class="comment">(* remove does not fail on missing files *)</span><span class="text">
          </span><span class="kw1">end</span><span class="text">
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
          </span><span class="id">make_symlink</span><span class="text"> </span><span class="kw4">~target</span><span class="text">:</span><span class="id">content</span><span class="text"> </span><span class="kw4">~link_path</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      | `</span><span class="kw2">Regular_file</span><span class="text"> </span><span class="numeric">_</span><span class="text">-&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">output_path</span><span class="text"> = </span><span class="id">path_of_destination</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">open_spec</span><span class="text"> =
          </span><span class="kw1">match</span><span class="text"> </span><span class="id">if_exists</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | `</span><span class="kw2">Fail</span><span class="text"> -&gt; `</span><span class="kw2">Create_file</span><span class="text"> </span><span class="id">output_path</span><span class="text">
          | `</span><span class="kw2">Overwrite</span><span class="text"> | `</span><span class="kw2">Update</span><span class="text"> -&gt; `</span><span class="kw2">Overwrite_file</span><span class="text"> </span><span class="id">output_path</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">IO</span><span class="text">.</span><span class="id">with_out_channel</span><span class="text"> </span><span class="kw4">~buffer_size</span><span class="text"> </span><span class="id">open_spec</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">outchan</span><span class="text"> -&gt;
            </span><span class="kw2">IO</span><span class="text">.</span><span class="id">with_in_channel</span><span class="text"> </span><span class="kw4">~buffer_size</span><span class="text"> (`</span><span class="kw2">File</span><span class="text"> </span><span class="id">src</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">inchan</span><span class="text"> -&gt;
                </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> () =
                  </span><span class="kw2">IO</span><span class="text">.</span><span class="id">read</span><span class="text"> </span><span class="kw4">~count</span><span class="text">:</span><span class="id">buffer_size</span><span class="text"> </span><span class="id">inchan</span><span class="text">
                  &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
                  | </span><span class="string">&quot;&quot;</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
                  | </span><span class="id">buf</span><span class="text"> -&gt;
                    </span><span class="kw2">IO</span><span class="text">.</span><span class="id">write</span><span class="text"> </span><span class="id">outchan</span><span class="text"> </span><span class="id">buf</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
                    </span><span class="id">loop</span><span class="text"> ()
                  </span><span class="kw1">end</span><span class="text">
                </span><span class="kw">in</span><span class="text">
                </span><span class="id">loop</span><span class="text"> ()))
      | `</span><span class="kw2">Directory</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">new_dir</span><span class="text"> = </span><span class="id">path_of_destination</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">file_info</span><span class="text"> </span><span class="id">new_dir</span><span class="text">
        &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
        | `</span><span class="kw2">Absent</span><span class="text"> -&gt;
          </span><span class="id">make_new_directory</span><span class="text"> </span><span class="id">new_dir</span><span class="text">
        | </span><span class="id">smth_else</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">if_exists</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | `</span><span class="kw2">Fail</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">File_exists</span><span class="text"> </span><span class="id">new_dir</span><span class="text">)
          | `</span><span class="kw2">Overwrite</span><span class="text"> -&gt;
            </span><span class="id">remove</span><span class="text"> </span><span class="id">new_dir</span><span class="text">
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="id">make_new_directory</span><span class="text"> </span><span class="id">new_dir</span><span class="text">
          | `</span><span class="kw2">Update</span><span class="text"> -&gt;
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">smth_else</span><span class="text"> = `</span><span class="kw2">Directory</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> </span><span class="id">return</span><span class="text"> ()
            </span><span class="kw1">else</span><span class="text"> </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">Not_a_directory</span><span class="text"> </span><span class="id">new_dir</span><span class="text">)
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="kw">let</span><span class="text"> `</span><span class="kw2">Stream</span><span class="text"> </span><span class="id">next_dir</span><span class="text"> = </span><span class="id">list_directory</span><span class="text"> </span><span class="id">src</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> () =
          </span><span class="id">next_dir</span><span class="text"> ()
          &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;..&quot;</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;.&quot;</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> ()
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">name</span><span class="text"> -&gt;
            </span><span class="id">copy_aux</span><span class="text">
              </span><span class="kw4">~src</span><span class="text">:(</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="id">src</span><span class="text"> </span><span class="id">name</span><span class="text">)
              </span><span class="kw4">~dst</span><span class="text">:(`</span><span class="kw2">Into</span><span class="text"> </span><span class="id">new_dir</span><span class="text">)
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="id">loop</span><span class="text"> ()
          | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="id">loop</span><span class="text"> ()
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    (</span><span class="id">copy_aux</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text">
     &gt;&gt;&lt; </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
     | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; </span><span class="id">return</span><span class="text"> ()
     | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">err</span><span class="text"> -&gt;
       </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">err</span><span class="text"> </span><span class="kw1">with</span><span class="text">
       | `</span><span class="kw2">IO</span><span class="text"> (`</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">) -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Copy</span><span class="text"> </span><span class="id">src</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
       | `</span><span class="kw2">IO</span><span class="text"> (`</span><span class="kw2">File_exists</span><span class="text"> </span><span class="numeric">_</span><span class="text">)
       | `</span><span class="kw2">IO</span><span class="text"> (`</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="numeric">_</span><span class="text">)
       | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="numeric">_</span><span class="text">
       | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="numeric">_</span><span class="text">
       | `</span><span class="kw2">Not_a_directory</span><span class="text"> </span><span class="numeric">_</span><span class="text">
       | `</span><span class="kw2">Wrong_file_kind</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Copy</span><span class="text"> </span><span class="id">src</span><span class="text">, </span><span class="id">e</span><span class="text">))
       | `</span><span class="kw2">System</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> </span><span class="id">e</span><span class="text">)
       </span><span class="kw1">end</span><span class="text">
     </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">move_in_same_device</span><span class="text"> ?(</span><span class="id">if_exists</span><span class="text">=`</span><span class="kw2">Fail</span><span class="text">) </span><span class="kw4">~src</span><span class="text"> </span><span class="id">dst</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">real_dest</span><span class="text"> = </span><span class="id">path_of_destination</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">if_exists</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Fail</span><span class="text"> -&gt;
      </span><span class="id">file_info</span><span class="text"> </span><span class="id">real_dest</span><span class="text">
      &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Absent</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Move</span><span class="text"> </span><span class="id">src</span><span class="text">, `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="id">real_dest</span><span class="text">))
      </span><span class="kw1">end</span><span class="text">
    | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="comment">(* Unix.rename does overwriting *)</span><span class="text"> </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">catch</span><span class="text">
      </span><span class="kw2">Lwt</span><span class="text">.(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw2">Lwt_unix</span><span class="text">.</span><span class="id">rename</span><span class="text"> </span><span class="id">src</span><span class="text"> </span><span class="id">real_dest</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> `</span><span class="kw2">Moved</span><span class="text">))
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">EXDEV</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt; </span><span class="id">return</span><span class="text"> `</span><span class="kw2">Must_copy</span><span class="text">
      | </span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">Unix_error</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="kw2">ENOTEMPTY</span><span class="text">, </span><span class="id">cmd</span><span class="text">, </span><span class="id">arg</span><span class="text">)  -&gt; </span><span class="id">return</span><span class="text"> `</span><span class="kw2">Must_copy</span><span class="text">
      | </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">Move</span><span class="text"> </span><span class="id">src</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">move</span><span class="text"> ?</span><span class="id">ignore_strange</span><span class="text"> ?</span><span class="id">symlinks</span><span class="text"> ?</span><span class="id">buffer_size</span><span class="text"> ?</span><span class="id">if_exists</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="id">dst</span><span class="text"> =
    </span><span class="id">move_in_same_device</span><span class="text"> ?</span><span class="id">if_exists</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="id">dst</span><span class="text">
    &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
    | `</span><span class="kw2">Moved</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
    | `</span><span class="kw2">Must_copy</span><span class="text"> -&gt;
      </span><span class="id">copy</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> ?</span><span class="id">buffer_size</span><span class="text"> ?</span><span class="id">ignore_strange</span><span class="text"> ?</span><span class="id">symlinks</span><span class="text"> ?</span><span class="id">if_exists</span><span class="text"> </span><span class="id">dst</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">remove</span><span class="text"> </span><span class="id">src</span><span class="text">
    </span><span class="kw1">end</span><span class="text">


  </span><span class="kw">type</span><span class="text"> </span><span class="id">file_tree</span><span class="text"> = [
    | `</span><span class="kw2">Node</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">file_tree</span><span class="text"> </span><span class="kw3">list</span><span class="text">
    | `</span><span class="kw2">Leaf</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">string</span><span class="text"> * </span><span class="id">file_info</span><span class="text">
  ]

  </span><span class="kw">let</span><span class="text"> </span><span class="id">file_tree</span><span class="text"> ?(</span><span class="id">follow_symlinks</span><span class="text">=</span><span class="constant">false</span><span class="text">) </span><span class="id">path</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">directory</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">p</span><span class="text">, </span><span class="id">l</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">file</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">p</span><span class="text">, </span><span class="id">l</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">find_aux</span><span class="text"> ?</span><span class="id">name_to_report</span><span class="text"> </span><span class="id">path</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">name_to_report</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">file_info</span><span class="text"> </span><span class="id">path</span><span class="text">
      &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Absent</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="id">path</span><span class="text">)
      | `</span><span class="kw2">Block_device</span><span class="text">
      | `</span><span class="kw2">Character_device</span><span class="text">
      | `</span><span class="kw2">Fifo</span><span class="text">
      | `</span><span class="kw2">Regular_file</span><span class="text"> </span><span class="numeric">_</span><span class="text">
      | `</span><span class="kw2">Socket</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">k</span><span class="text"> -&gt; </span><span class="id">file</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">k</span><span class="text">
      | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="id">content</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">k</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">follow_symlinks</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="constant">true</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">continue</span><span class="text"> =
            </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">is_relative</span><span class="text"> </span><span class="id">content</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="id">content</span><span class="text">)
            </span><span class="kw1">else</span><span class="text"> </span><span class="id">content</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">find_aux</span><span class="text"> </span><span class="kw4">~name_to_report</span><span class="text">:(</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">path</span><span class="text">) </span><span class="id">continue</span><span class="text">
        | </span><span class="constant">false</span><span class="text"> -&gt;
          </span><span class="id">file</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">k</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      | `</span><span class="kw2">Directory</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> `</span><span class="kw2">Stream</span><span class="text"> </span><span class="id">next_dir</span><span class="text"> = </span><span class="id">list_directory</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> =
          </span><span class="id">next_dir</span><span class="text"> ()
          &gt;&gt;= </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">function</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;..&quot;</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="string">&quot;.&quot;</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">name</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">name</span><span class="text"> :: </span><span class="id">acc</span><span class="text">)
          | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">acc</span><span class="text">
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="id">loop</span><span class="text"> []
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">sub_list</span><span class="text"> -&gt;
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text">
          </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> []) (</span><span class="kw2">List</span><span class="text">.</span><span class="id">sort</span><span class="text"> </span><span class="kw4">~cmp</span><span class="text">:</span><span class="kw2">String</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">sub_list</span><span class="text">)
          </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">dir</span><span class="text"> -&gt;
              </span><span class="id">prev</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
              </span><span class="id">find_aux</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="id">dir</span><span class="text">)
              &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">newone</span><span class="text"> -&gt;
              </span><span class="id">return</span><span class="text"> (</span><span class="id">newone</span><span class="text"> :: </span><span class="id">l</span><span class="text">))
        &gt;&gt;| </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">sub_tree</span><span class="text"> -&gt;
        </span><span class="id">directory</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">sub_tree</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    (</span><span class="id">find_aux</span><span class="text"> </span><span class="id">path</span><span class="text">
     &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
     | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
     | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
       </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">e</span><span class="text"> </span><span class="kw1">with</span><span class="text">
       | `</span><span class="kw2">Io_exn</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">File_tree</span><span class="text"> </span><span class="id">path</span><span class="text">, `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text">))
       | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> (`</span><span class="kw2">File_tree</span><span class="text"> </span><span class="id">path</span><span class="text">, </span><span class="id">e</span><span class="text">))
       | `</span><span class="kw2">System</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="kw2">System</span><span class="text"> </span><span class="id">e</span><span class="text">)
       </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">file_info_to_string</span><span class="text"> = </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Absent</span><span class="text"> -&gt; </span><span class="string">&quot;Absent&quot;</span><span class="text">
  | `</span><span class="kw2">Regular_file</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Regular file (size %d B)&quot;</span><span class="text"> </span><span class="id">i</span><span class="text">
  | `</span><span class="kw2">Symlink</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Sym-link to %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
  | `</span><span class="kw2">Block_device</span><span class="text"> -&gt; </span><span class="string">&quot;Block device&quot;</span><span class="text">
  | `</span><span class="kw2">Character_device</span><span class="text"> -&gt; </span><span class="string">&quot;Character device&quot;</span><span class="text">
  | `</span><span class="kw2">Directory</span><span class="text"> -&gt; </span><span class="string">&quot;Directory&quot;</span><span class="text">
  | `</span><span class="kw2">Fifo</span><span class="text"> -&gt; </span><span class="string">&quot;FIFO&quot;</span><span class="text">
  | `</span><span class="kw2">Socket</span><span class="text"> -&gt; </span><span class="string">&quot;Socket&quot;</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">error_to_string</span><span class="text"> = </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">System</span><span class="text"> (</span><span class="id">where</span><span class="text">, </span><span class="id">what</span><span class="text">) -&gt;
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;System error while %s: %s&quot;</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">where</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">File_info</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;getting info on %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Make_directory</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;making directory %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
         </span><span class="comment">(* | `IO of [ `File_exists of string | `Wrong_path of string ] *)</span><span class="text">
      | `</span><span class="kw2">File_tree</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;getting file tree from %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Move</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;moving %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Copy</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;copying %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Make_symlink</span><span class="text"> (</span><span class="id">s1</span><span class="text">, </span><span class="id">s2</span><span class="text">) -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Making symlink from target %S to %s&quot;</span><span class="text"> </span><span class="id">s1</span><span class="text"> </span><span class="id">s2</span><span class="text">
      | `</span><span class="kw2">Remove</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;removing %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">List_directory</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;listing directory %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Already_exists</span><span class="text"> -&gt; </span><span class="string">&quot;Already exists&quot;</span><span class="text">
      | `</span><span class="kw2">IO</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;I/O Error %S&quot;</span><span class="text"> (</span><span class="kw2">IO</span><span class="text">.</span><span class="id">error_to_string</span><span class="text"> </span><span class="id">e</span><span class="text">)
      | `</span><span class="kw2">File_not_found</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;File not found (%S)&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Not_a_directory</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Not a directory (%S)&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">File_exists</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;File exists (%S)&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Wrong_path</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Wrong path (%S)&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">
      | `</span><span class="kw2">Wrong_file_kind</span><span class="text"> (</span><span class="id">s</span><span class="text">, </span><span class="id">k</span><span class="text">) -&gt;
        </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Wrong kind of file (%S: %s)&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> (</span><span class="id">file_info_to_string</span><span class="text"> </span><span class="id">k</span><span class="text">)
      | `</span><span class="kw2">Exn</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Exception %s&quot;</span><span class="text"> (</span><span class="id">exn</span><span class="text"> </span><span class="id">e</span><span class="text">)
      | `</span><span class="kw2">Wrong_access_rights</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;wrong access rights: 0o%o&quot;</span><span class="text"> </span><span class="id">o</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
  | `</span><span class="kw2">Shell</span><span class="text"> (</span><span class="id">cmd</span><span class="text">, </span><span class="id">err</span><span class="text">) -&gt;
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Shell command %S failed: %s&quot;</span><span class="text"> </span><span class="id">cmd</span><span class="text">
      (</span><span class="kw2">Shell</span><span class="text">.</span><span class="id">status_to_string</span><span class="text"> </span><span class="id">err</span><span class="text">)

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Deferred_list</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="comment">(** Returns the list of results if all succeed, or the first error. *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">while_sequential</span><span class="text">:
    '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">
    = </span><span class="kw">fun</span><span class="text"> (</span><span class="kw">type</span><span class="text"> </span><span class="id">b</span><span class="text">) (</span><span class="id">l</span><span class="text">: '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text">) ~(</span><span class="id">f</span><span class="text">: '</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, </span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Map_sequential</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
        </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Local_exception</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">b</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">ms</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">f</span><span class="text"> =
          </span><span class="id">wrap_deferred</span><span class="text">
            (</span><span class="kw">fun</span><span class="text"> () -&gt;
               </span><span class="kw2">Lwt_list</span><span class="text">.</span><span class="id">map_s</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
                   </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">bind</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">o</span><span class="text">) (</span><span class="kw">function</span><span class="text">
                     | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">oo</span><span class="text"> -&gt; </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">return</span><span class="text"> </span><span class="id">oo</span><span class="text">
                     | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">ee</span><span class="text"> -&gt; </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="kw2">Local_exception</span><span class="text"> </span><span class="id">ee</span><span class="text">))) </span><span class="id">l</span><span class="text">)
            </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">function</span><span class="text">
              | </span><span class="kw2">Local_exception</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">e</span><span class="text">
              | </span><span class="id">e</span><span class="text"> -&gt;
                </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Expecting only Local_exception, but got: %s&quot;</span><span class="text">
                  (</span><span class="kw2">Printexc</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) ())
      </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Map_sequential</span><span class="text">.</span><span class="id">ms</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">f</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_sequential</span><span class="text">:
    '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text"> * '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">
    = </span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">oks</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">errors</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> ()) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prevm</span><span class="text"> </span><span class="id">elt</span><span class="text"> -&gt;
          </span><span class="id">prevm</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
          </span><span class="id">f</span><span class="text"> </span><span class="id">elt</span><span class="text"> &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
          | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">oks</span><span class="text"> := </span><span class="id">o</span><span class="text"> :: !</span><span class="id">oks</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
          | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">errors</span><span class="text"> := </span><span class="id">e</span><span class="text"> :: !</span><span class="id">errors</span><span class="text">; </span><span class="id">return</span><span class="text"> ())
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">return</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">oks</span><span class="text">, </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">errors</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_concurrent</span><span class="text">:
    '</span><span class="id">a</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">c</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">t</span><span class="text">) -&gt; ('</span><span class="id">c</span><span class="text"> </span><span class="kw3">list</span><span class="text"> * '</span><span class="id">b</span><span class="text"> </span><span class="kw3">list</span><span class="text">, '</span><span class="id">d</span><span class="text">) </span><span class="id">t</span><span class="text">
    = </span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">oks</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">errors</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Lwt</span><span class="text">.(
        </span><span class="kw2">Lwt_list</span><span class="text">.</span><span class="id">map_p</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">elt</span><span class="text"> -&gt;
            </span><span class="id">f</span><span class="text"> </span><span class="id">elt</span><span class="text"> &gt;&gt;= </span><span class="kw">function</span><span class="text">
            | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">oks</span><span class="text"> := </span><span class="id">o</span><span class="text"> :: !</span><span class="id">oks</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
            | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">errors</span><span class="text"> := </span><span class="id">e</span><span class="text"> :: !</span><span class="id">errors</span><span class="text">; </span><span class="id">return</span><span class="text"> ()) </span><span class="id">l</span><span class="text">
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
        </span><span class="id">return</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> ())
      )
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">return</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">oks</span><span class="text">, </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">errors</span><span class="text">)


  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_concurrent_with_index</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">with_indexes</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mapi</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">a</span><span class="text"> -&gt; (</span><span class="id">i</span><span class="text">, </span><span class="id">a</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="id">for_concurrent</span><span class="text"> </span><span class="id">with_indexes</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">i</span><span class="text">, </span><span class="id">a</span><span class="text">) -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">a</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">pick_and_cancel</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">error</span><span class="text">) </span><span class="id">t</span><span class="text"> = </span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">pick</span><span class="text"> </span><span class="id">l</span><span class="text">

  </span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Light</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = {
    </span><span class="kw">mutable</span><span class="text"> </span><span class="id">lwt_t</span><span class="text">: </span><span class="kw3">unit</span><span class="text"> </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">t</span><span class="text">;
    </span><span class="kw">mutable</span><span class="text"> </span><span class="id">lwt_u</span><span class="text">: </span><span class="kw3">unit</span><span class="text"> </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">u</span><span class="text">;
    </span><span class="kw">mutable</span><span class="text"> </span><span class="id">color</span><span class="text">: [`</span><span class="kw2">Red</span><span class="text"> | `</span><span class="kw2">Green</span><span class="text">];
  }
  </span><span class="kw">let</span><span class="text"> </span><span class="id">create</span><span class="text"> () =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">lwt_t</span><span class="text">, </span><span class="id">lwt_u</span><span class="text"> = </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">task</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    {</span><span class="id">lwt_u</span><span class="text">; </span><span class="id">lwt_t</span><span class="text">; </span><span class="id">color</span><span class="text"> = `</span><span class="kw2">Red</span><span class="text">}

  </span><span class="kw">let</span><span class="text"> </span><span class="id">try_to_pass</span><span class="text"> </span><span class="id">w</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">w</span><span class="text">.</span><span class="id">color</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Green</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
    | `</span><span class="kw2">Red</span><span class="text"> -&gt;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">state</span><span class="text"> </span><span class="id">w</span><span class="text">.</span><span class="id">lwt_t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Lwt</span><span class="text">.</span><span class="kw2">Sleep</span><span class="text"> -&gt; ()
      | </span><span class="kw2">Lwt</span><span class="text">.</span><span class="kw2">Return</span><span class="text"> () | </span><span class="kw2">Lwt</span><span class="text">.</span><span class="kw2">Fail</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
        </span><span class="comment">(* we need to renew the “task” *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="id">u</span><span class="text"> = </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">task</span><span class="text"> () </span><span class="kw">in</span><span class="text">
        </span><span class="id">w</span><span class="text">.</span><span class="id">lwt_t</span><span class="text"> &lt;- </span><span class="id">t</span><span class="text">;
        </span><span class="id">w</span><span class="text">.</span><span class="id">lwt_u</span><span class="text"> &lt;- </span><span class="id">u</span><span class="text">;
      </span><span class="kw1">end</span><span class="text">;
      </span><span class="id">wrap_deferred</span><span class="text"> </span><span class="kw4">~on_exn</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">e</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">w</span><span class="text">.</span><span class="id">lwt_t</span><span class="text">)
      &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Error</span><span class="text"> </span><span class="kw2">Lwt</span><span class="text">.</span><span class="kw2">Canceled</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">other</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;BUG: THIS SHOULD NOT HAPPEN&quot;</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; </span><span class="id">return</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">green</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="id">t</span><span class="text">.</span><span class="id">color</span><span class="text"> &lt;- `</span><span class="kw2">Green</span><span class="text">;
    </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">wakeup_exn</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">lwt_u</span><span class="text"> </span><span class="kw2">Lwt</span><span class="text">.</span><span class="kw2">Canceled</span><span class="text">
  </span><span class="comment">(* We use Lwt.Canceled so that can re-wake-up sleepers at will
    see https://github.com/ocsigen/lwt/blob/master/src/core/lwt.ml#L312
    where Lwt.Canceled is ignored *)</span><span class="text">


</span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>