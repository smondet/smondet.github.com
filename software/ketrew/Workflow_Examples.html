 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: Workflow Examples</title></head><body><div class="container"><h1>Ketrew: Workflow Examples</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul><li><a href='#WorkflowExamples'>Workflow Examples</a>
</li><li><a href='#Workflows'>Workflows</a>
<ul><li><a href='#SimpleExampleWithLSF'>Simple Example With LSF</a>
</li><li><a href='#DaemonizeWithNohupSetsid'>Daemonize With Nohup/Setsid</a>
</li><li><a href='#DaemonizeWithThePythonHack'>Daemonize With “The Python Hack”</a>
</li><li><a href='#GetaContainerfronApacheYarn'>Get a Container fron “Apache Yarn”</a>
</li><li><a href='#AFirstDependencyChain'>A First Dependency Chain</a>
</li><li><a href='#WithaCondition'>With a Condition</a>
</li><li><a href='#ExampleBackupWorkflow'>Example “Backup” Workflow</a>
</li><li><a href='#BuildKetrewOnaVagrantVM'>Build Ketrew On a Vagrant VM</a>
</li></ul>
</li><li><a href='#MainOftheModule'>“Main” Of the Module</a>
</li></ul><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li><li><a href='Database_Backends.html'>Database Backends</a></li><li><a href='Developer_Documentation.html'>Developer Documentation</a></li><li><a href='FAQ.html'>FAQ</a></li><li><a href='Glossary.html'>Glossary</a></li><li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li><li><a href='Server_Commands.html'>Server Commands</a></li><li><a href='Standalone_Mode.html'>Standalone Mode</a></li><li><a href='The_Configuration_File.html'>The Configuration File</a></li><li><a href='The_HTTP_API.html'>The HTTP API</a></li><li><a href='Workflow_Examples.html'>Workflow Examples</a></li><li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li><li><a href='dummy_plugin.html'>Plugin Example</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for <a href='./doc.0.0.0/index.html'>version 0.0.0</a></li><li>Documentation for <a href='./doc.1.0.0/index.html'>version 1.0.0</a></li><li>Documentation for <a href='./doc.1.1.0/index.html'>version 1.1.0</a></li><li>Documentation for <a href='./doc.1.1.1/index.html'>version 1.1.1</a></li><li>Documentation for <a href='./doc.2.0.0/index.html'>version 2.0.0</a></li><li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="comment">(**************************************************************************)</span><span class="text">
</span><span class="comment">(*    Copyright 2014, 2015:                                               *)</span><span class="text">
</span><span class="comment">(*          Sebastien Mondet &lt;seb@mondet.org&gt;,                            *)</span><span class="text">
</span><span class="comment">(*          Leonid Rozenberg &lt;leonidr@gmail.com&gt;,                         *)</span><span class="text">
</span><span class="comment">(*          Arun Ahuja &lt;aahuja11@gmail.com&gt;,                              *)</span><span class="text">
</span><span class="comment">(*          Jeff Hammerbacher &lt;jeff.hammerbacher@gmail.com&gt;               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);       *)</span><span class="text">
</span><span class="comment">(*  you may not use this file except in compliance with the License.      *)</span><span class="text">
</span><span class="comment">(*  You may obtain a copy of the License at                               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*      http://www.apache.org/licenses/LICENSE-2.0                        *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Unless required by applicable law or agreed to in writing, software   *)</span><span class="text">
</span><span class="comment">(*  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,     *)</span><span class="text">
</span><span class="comment">(*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or       *)</span><span class="text">
</span><span class="comment">(*  implied.  See the License for the specific language governing         *)</span><span class="text">
</span><span class="comment">(*  permissions and limitations under the License.                        *)</span><span class="text">
</span><span class="comment">(**************************************************************************)</span><span class="text">

</span></pre>


<h2 id="WorkflowExamples">Workflow Examples</h2>

<p>This “test” provides a few functions that create increasingly complex workflows.
It gets compiled to a command line application that submits the workflows to
the Ketrew engine.</p>
<p>First, the mandatory license:</p>
<pre><code>Copyright 2014, Sebastien Mondet &lt;seb@mondet.org&gt;

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied.  See the License for the specific language governing
permissions and limitations under the License.</code></pre><p>And some preliminary OCaml settings:</p>

<pre><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">Sosa</span><span class="text">.</span><span class="kw2">Native_string</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">printf</span><span class="text"> </span><span class="string">&quot;%s\n%!&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text">
</span></pre>


<h2 id="Workflows">Workflows</h2>

<h3 id="SimpleExampleWithLSF">Simple Example With LSF</h3>

<p>This function is a more “parametrized” version of the example in the
<code>README.md</code> file (<code>host</code> and <code>queue</code> come from the command line).
It actually calls <code>submit</code> directly itself.</p>

<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">run_command_with_lsf</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~queue</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;run_command_with_lsf&quot;</span><span class="text">
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">lsf</span><span class="text"> (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd</span><span class="text">)
               </span><span class="kw4">~queue</span><span class="text"> </span><span class="kw4">~wall_limit</span><span class="text">:</span><span class="string">&quot;1:30&quot;</span><span class="text"> </span><span class="kw4">~processors</span><span class="text">:(`</span><span class="kw2">Min_max</span><span class="text"> (</span><span class="numeric">1</span><span class="text">,</span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~host</span><span class="text">)
  )

</span></pre>


<h3 id="DaemonizeWithNohupSetsid">Daemonize With Nohup/Setsid</h3>

<p>This function is like <code>run_command_with_lsf</code> but uses
<code>daemonize</code> with the “nohup-setsid” method instead of the batch scheduler.</p>

<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">run_command_with_nohup</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;NhSs: %S&quot;</span><span class="text"> </span><span class="id">cmd</span><span class="text">)
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Nohup_setsid</span><span class="text">  (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~host</span><span class="text">)
  )
</span></pre>


<p>This kind of “daemonized” job should work on any decent Unix system.</p>
<h3 id="DaemonizeWithThePythonHack">Daemonize With “The Python Hack”</h3>

<p>This function is like <code>run_command_with_nohup</code> but uses
the “python daemon” method instead.</p>

<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">run_command_with_python_method</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Pyd: %S&quot;</span><span class="text"> </span><span class="id">cmd</span><span class="text">)
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd</span><span class="text">)
               </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
               </span><span class="kw4">~call_script</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">script</span><span class="text"> -&gt; [</span><span class="string">&quot;bash&quot;</span><span class="text">; </span><span class="string">&quot;--verbose&quot;</span><span class="text">; </span><span class="id">script</span><span class="text">]))
  )
</span></pre>


<p>The <code>`Python_daemon</code> way of daemonizing was hacked together because
MacOSX does not support the <code>nohup</code> and <code>setsid</code> commands any more.</p>
<h3 id="GetaContainerfronApacheYarn">Get a Container fron “Apache Yarn”</h3>

<p>This function is like <code>run_command_with_lsf</code> but uses the
<a href='api/Ketrew.Yarn.html' title='Ketrew.Yarn'><code>Ketrew.Yarn</code></a> backend.
<a href='http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/YARN.html'>Yarn</a>
comes from the Hadoop ecosystem and is used to request resources.</p>

<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">run_command_with_yarn</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">make</span><span class="text"> =
    </span><span class="id">yarn_distributed_shell</span><span class="text"> 
      </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~container_memory</span><span class="text">:(`</span><span class="kw2">GB</span><span class="text"> </span><span class="numeric">12</span><span class="text">)
      </span><span class="kw4">~timeout</span><span class="text">:(`</span><span class="kw2">Seconds</span><span class="text"> </span><span class="numeric">3600</span><span class="text">)
      </span><span class="kw4">~application_name</span><span class="text">:</span><span class="string">&quot;YarnKetrewExample&quot;</span><span class="text">
      </span><span class="comment">(* do not put spaces up there, it can break Yarn *)</span><span class="text">
      (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Yarn: %S&quot;</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~make</span><span class="text">
  )

</span></pre>


<h3 id="AFirstDependencyChain">A First Dependency Chain</h3>

<p>This function runs a workflow with no less than 2 nodes!</p>
<ul><li><code>node2</code> depends on <code>node1</code>.</li><li>We call <code>submit_workflow</code> on <code>node2</code> (the last one, i.e. the root of
 the dependency arborescence).</li><li><code>node1</code> will run and if it succeeds <code>node2</code> will run.</li></ul>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">run_2_commands_with_python_method</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd1</span><span class="text"> </span><span class="id">cmd2</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">node1</span><span class="text"> =
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Pyd: %S&quot;</span><span class="text"> </span><span class="id">cmd1</span><span class="text">)
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd1</span><span class="text">) </span><span class="kw4">~host</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">node2</span><span class="text"> =
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Pyd: %S&quot;</span><span class="text"> </span><span class="id">cmd2</span><span class="text">)
      </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">node1</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd2</span><span class="text">) </span><span class="kw4">~host</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> </span><span class="id">node2</span><span class="text">
</span></pre>
<p>For example:</p>
<pre><code>&lt;test-exec&gt; two-py /tmp &quot;du -sh $HOME&quot; &quot;du -sh $HOME/tmp/&quot;</code></pre><p>will run <code>du -sh</code> in <code>$HOME</code> and then in <code>$HOME/tmp</code> in the host <code>&quot;/tmp&quot;</code>
(which is <code>localhost</code> with <code>/tmp</code> as playground).</p>
<h3 id="WithaCondition">With a Condition</h3>

<p>This function creates a 2-nodes workflow that fails because of the condition
if the first target is not ensured by the build-process it runs.</p>
<ul><li>the function <code>make_node</code> is partial application of
 <code>EDSL.workflow_node</code> with an additional argument <code>~cmd</code>.</li><li><code>target_with_condition</code> is a target that is supposed to ensure that
<code>impossible_file</code> exists (which <code>ls /tmp</code> won&#39;t do).<ul><li><code>impossible_file</code> is a datastructure representing a file on a given host.</li><li>The condition is specified with the <code>~done_when</code> argument.</li></ul></li><li><code>target2</code> is just a target that depends on <code>target_with_condition</code>.</li></ul>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">fail_because_of_condition</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">make_node</span><span class="text"> </span><span class="kw4">~cmd</span><span class="text"> =
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~host</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_condition</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">impossible_file</span><span class="text"> = </span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;/some-inexistent-file&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text"> 
    </span><span class="id">make_node</span><span class="text"> </span><span class="id">impossible_file</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Failing-target&quot;</span><span class="text">
      </span><span class="kw4">~cmd</span><span class="text">:</span><span class="string">&quot;ls /tmp&quot;</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">target2</span><span class="text"> =
    </span><span class="id">make_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Won't-run because of failed dependency&quot;</span><span class="text">
      </span><span class="kw4">~cmd</span><span class="text">:</span><span class="string">&quot;ls /tmp&quot;</span><span class="text">
      </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">target_with_condition</span><span class="text"> ]
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> </span><span class="id">target2</span><span class="text">
</span></pre>


<p>The Explorer™ will show the failed targets:</p>
<pre><code>* [1]: Won&#39;t-run because of failed dependency
ketrew_2014-09-23-21h55m01s460ms-UTC_994326685
Failed: Dependencies died:
ketrew_2014-09-23-21h55m01s460ms-UTC_089809344 died
* [2]: Failing-target
ketrew_2014-09-23-21h55m01s460ms-UTC_089809344
Failed: Process Failure: the target did not ensure (Volume
{([Host /tmp?shell=sh%2C-c]) (Root: /) (Tree: Single path:
&quot;some-inexistent-file&quot;)} exists)</code></pre>



<h3 id="ExampleBackupWorkflow">Example “Backup” Workflow</h3>

<p>This an example of a “backup” workflow.</p>
<p>Take a directory, make a tar.gz, save its MD5 sum, and if <code>gpg</code> is <code>true</code>,
call <code>gpg -c</code> and delete the tar.gz.</p>
<p>The passphrase for GPG must be in a file <code>~/.backup_passphrase</code> as</p>
<pre class='shell'><code class='shell'>  export BACKUP_PASSPHRASE=&quot;some passsphraaase&quot;
  </code></pre>


<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">make_targz_on_host</span><span class="text"> ?(</span><span class="id">gpg</span><span class="text">=</span><span class="constant">true</span><span class="text">) ?</span><span class="id">dest_prefix</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~dir</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">run_program</span><span class="text">: </span><span class="kw2">Program</span><span class="text">.</span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">Build_process</span><span class="text">.</span><span class="id">t</span><span class="text"> =
    </span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> -&gt; </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">dest_base</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">dest_prefix</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text">  </span><span class="string">&quot;/tmp/backup_from_ketrew_cli&quot;</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">destination_product</span><span class="text"> </span><span class="id">ext</span><span class="text"> =
    </span><span class="comment">(* `destination` creates “volume-artifacts” for a given file
       extension. *)</span><span class="text">
    </span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s.%s&quot;</span><span class="text"> </span><span class="id">dest_base</span><span class="text"> </span><span class="id">ext</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">make_targz</span><span class="text"> : </span><span class="id">single_file</span><span class="text"> </span><span class="id">workflow_node</span><span class="text"> = 
    </span><span class="kw">let</span><span class="text"> </span><span class="id">product</span><span class="text"> = (</span><span class="id">destination_product</span><span class="text"> </span><span class="string">&quot;tar.gz&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">product</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;make-tar.gz&quot;</span><span class="text">
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">run_program</span><span class="text">
               </span><span class="kw2">Program</span><span class="text">.(
                 </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;cd %s/../&quot;</span><span class="text"> </span><span class="id">dir</span><span class="text">
                 &amp;&amp;
                 </span><span class="id">shf</span><span class="text">  </span><span class="string">&quot;tar cfz '%s' '%s'&quot;</span><span class="text"> </span><span class="id">product</span><span class="kw1">#</span><span class="id">path</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">dir</span><span class="text">)))
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">md5_targz</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">md5_product</span><span class="text"> = </span><span class="id">destination_product</span><span class="text"> </span><span class="string">&quot;md5&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">  
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">md5_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;make-md5-of-tar.gz&quot;</span><span class="text">
      </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text">  </span><span class="id">make_targz</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">run_program</span><span class="text">
               </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;md5sum '%s' &gt; '%s'&quot;</span><span class="text">
                          </span><span class="id">make_targz</span><span class="kw1">#</span><span class="id">product</span><span class="kw1">#</span><span class="id">path</span><span class="text"> </span><span class="id">md5_product</span><span class="kw1">#</span><span class="id">path</span><span class="text">))
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">gpg_targets</span><span class="text"> () =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">delete_the_targz</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;rm-tar.gz&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">run_program</span><span class="text"> (</span><span class="kw2">Program</span><span class="text">.</span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;rm -f '%s'&quot;</span><span class="text"> </span><span class="id">make_targz</span><span class="kw1">#</span><span class="id">product</span><span class="kw1">#</span><span class="id">path</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">gpg_file</span><span class="text"> = </span><span class="id">destination_product</span><span class="text"> </span><span class="string">&quot;tar.gz.gpg&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">make_it</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">gpg_file</span><span class="text">
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;make-gpg-of-tar.gz&quot;</span><span class="text">
        </span><span class="kw4">~edges</span><span class="text">:[
          </span><span class="id">depends_on</span><span class="text"> </span><span class="id">make_targz</span><span class="text">;
          </span><span class="id">depends_on</span><span class="text"> </span><span class="id">md5_targz</span><span class="text">;
          </span><span class="id">on_success_activate</span><span class="text"> </span><span class="id">delete_the_targz</span><span class="text">;
        ]
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">run_program</span><span class="text">
                 </span><span class="kw2">Program</span><span class="text">.(
                   </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;. ~/.backup_passphrase&quot;</span><span class="text">
                   &amp;&amp; </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;gpg -c --passphrase $BACKUP_PASSPHRASE -o '%s' '%s'&quot;</span><span class="text">
                     </span><span class="id">gpg_file</span><span class="kw1">#</span><span class="id">path</span><span class="text"> </span><span class="id">make_targz</span><span class="kw1">#</span><span class="id">product</span><span class="kw1">#</span><span class="id">path</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="id">make_it</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">common_ancestor</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">edges</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">gpg</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="constant">false</span><span class="text"> -&gt; [ </span><span class="id">depends_on</span><span class="text"> </span><span class="id">md5_targz</span><span class="text">]
      | </span><span class="constant">true</span><span class="text"> -&gt;  [ </span><span class="id">depends_on</span><span class="text"> (</span><span class="id">gpg_targets</span><span class="text"> ())]
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Backup workflow common ancestor&quot;</span><span class="text"> </span><span class="kw4">~edges</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="comment">(* By running the common-ancestor we pull and activate all the targets to do. *)</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> </span><span class="id">common_ancestor</span><span class="text">

</span></pre>


<h3 id="BuildKetrewOnaVagrantVM">Build Ketrew On a Vagrant VM</h3>

<p>This function builds completely different workflows depedending on the input
command:</p>
<ul><li><code>prepare</code> → prepare a vagrant VM, ready to SSH to</li><li><code>go</code> → build Ketrew on the on vagrant VM</li><li><code>clean</code> → shutdown and delete the VM</li></ul>


<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">run_ketrew_on_vagrant</span><span class="text"> </span><span class="id">what_to_do</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (//) = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">tmp_dir</span><span class="text"> =  </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;HOME&quot;</span><span class="text">  // </span><span class="string">&quot;tmp/ketrew_vagrant&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">vagrant_tmp</span><span class="text"> = </span><span class="id">tmp_dir</span><span class="text"> // </span><span class="string">&quot;vagr_vm&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">vagrant_host</span><span class="text"> = </span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> (</span><span class="id">tmp_dir</span><span class="text"> // </span><span class="string">&quot;playground&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">do_on_vagrant_host</span><span class="text"> </span><span class="id">p</span><span class="text"> =
    </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_host</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ssh_config</span><span class="text"> =
    </span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_host</span><span class="text"> (</span><span class="id">tmp_dir</span><span class="text"> // </span><span class="string">&quot;ssh_config&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">match</span><span class="text"> </span><span class="id">what_to_do</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Prepare</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">init</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;init-vagrant&quot;</span><span class="text"> 
        (</span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_host</span><span class="text"> (</span><span class="id">vagrant_tmp</span><span class="text"> // </span><span class="string">&quot;Vagrantfile&quot;</span><span class="text">))
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;mkdir&quot;</span><span class="text">; </span><span class="string">&quot;-p&quot;</span><span class="text">; </span><span class="id">vagrant_tmp</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cd&quot;</span><span class="text">; </span><span class="id">vagrant_tmp</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;vagrant&quot;</span><span class="text">; </span><span class="string">&quot;init&quot;</span><span class="text">; </span><span class="string">&quot;hashicorp/precise64&quot;</span><span class="text">]
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">running</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;vagrant-up&quot;</span><span class="text">
        </span><span class="comment">(* TODO: create a product that uses `vagrant status` *)</span><span class="text">
        </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">init</span><span class="text">]
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cd&quot;</span><span class="text">; </span><span class="id">vagrant_tmp</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;vagrant&quot;</span><span class="text">; </span><span class="string">&quot;up&quot;</span><span class="text">]))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">make_ssh_config</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
        </span><span class="comment">(* not a single-file workflow-node, because we want this file
           regenerated every time *)</span><span class="text">
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;vagrant-ssh-config&quot;</span><span class="text"> </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">running</span><span class="text">]
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cd&quot;</span><span class="text">; </span><span class="id">vagrant_tmp</span><span class="text">]
            &amp;&amp; </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;vagrant ssh-config --host Vagrew &gt; %s&quot;</span><span class="text"> </span><span class="id">ssh_config</span><span class="kw1">#</span><span class="id">path</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">make_ssh_config</span><span class="text">
  | `</span><span class="kw2">Go</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">vagrant_box</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="kw4">~add_ssh_options</span><span class="text">:[</span><span class="string">&quot;-F&quot;</span><span class="text">; </span><span class="id">ssh_config</span><span class="kw1">#</span><span class="id">path</span><span class="text">]
        </span><span class="kw4">~playground</span><span class="text">:</span><span class="string">&quot;/tmp/KT/&quot;</span><span class="text"> </span><span class="string">&quot;Vagrew&quot;</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">do_on_vagrant_box</span><span class="text"> </span><span class="id">p</span><span class="text"> =
      </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Nohup_setsid</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_box</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">get_c_dependencies</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;apt-get-c-deps&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_box</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;echo GO&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get update&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get install -y m4 build-essential libgdbm-dev&quot;</span><span class="text">
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">get_opam</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> (</span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_box</span><span class="text"> </span><span class="string">&quot;/usr/bin/opam&quot;</span><span class="text">)
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;apt-get-opam&quot;</span><span class="text">
        </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">get_c_dependencies</span><span class="text">]
        </span><span class="comment">(* `get_opam` does not really depend on `get_c_dependencies` but
           `apt-get` does not work in parallel, so we need to make things
           sequential. *)</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_box</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;echo GO&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get update&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get install -y python-software-properties&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo add-apt-repository -y ppa:avsm/ocaml41+opam11&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get update -qq&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get install -qq ocaml ocaml-native-compilers camlp4-extra aspcud opam&quot;</span><span class="text">
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">init_opam</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text">
        (</span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_box</span><span class="text"> </span><span class="string">&quot;/home/vagrant/.opam/opam-init/init.sh&quot;</span><span class="text">)
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;init-opam&quot;</span><span class="text">
        </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">get_opam</span><span class="text">]
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_box</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.( </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;opam init&quot;</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">install_ketrew</span><span class="text"> </span><span class="id">compiler</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text">
        (</span><span class="id">single_file</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:</span><span class="id">vagrant_box</span><span class="text"> 
           (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;/home/vagrant/.opam/%s/bin/ketrew&quot;</span><span class="text"> </span><span class="id">compiler</span><span class="text">))
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;opam-install-ketrew&quot;</span><span class="text">
        </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">init_opam</span><span class="text">; </span><span class="id">depends_on</span><span class="text"> </span><span class="id">get_c_dependencies</span><span class="text">]

        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_box</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;opam switch %s&quot;</span><span class="text"> </span><span class="id">compiler</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;opam remote add smondet https://github.com/smondet/dev-opam-repo.git || echo smondet_remote_already_there&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;opam remove ocamlfind || echo ocamlfind_not_installed&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;opam pin ketrew https://github.com/smondet/ketrew/ || echo ketrew_already_pinned&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;opam install -y ketrew&quot;</span><span class="text">
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="comment">(* We forget the product so that all branches of the `match..with`
       have the same type *)</span><span class="text">
    </span><span class="id">install_ketrew</span><span class="text"> </span><span class="string">&quot;system&quot;</span><span class="text"> |&gt; </span><span class="id">forget_product</span><span class="text">
  | `</span><span class="kw2">Clean</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">kill</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;kill-vagrant&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cd&quot;</span><span class="text">; </span><span class="id">vagrant_tmp</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;vagrant&quot;</span><span class="text">; </span><span class="string">&quot;destroy&quot;</span><span class="text">; </span><span class="string">&quot;-f&quot;</span><span class="text">]
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">rm_temp</span><span class="text"> =
      </span><span class="id">workflow_node</span><span class="text"> </span><span class="id">without_product</span><span class="text">
        </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;rm-temp&quot;</span><span class="text">
        </span><span class="kw4">~edges</span><span class="text">:[</span><span class="id">depends_on</span><span class="text"> </span><span class="id">kill</span><span class="text">]
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on_vagrant_host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;rm&quot;</span><span class="text">; </span><span class="string">&quot;-fr&quot;</span><span class="text">; </span><span class="id">vagrant_tmp</span><span class="text">]))
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">rm_temp</span><span class="text">


</span></pre>


<h2 id="MainOftheModule">“Main” Of the Module</h2>

<p>Command line parsing for this multi-workflow script.</p>
<p>Here it is kept very basic but one may use usual OCaml tools
(<code>Arg</code> module, or <code>Cmdliner</code> -- which is already linked-in with Ketrew).</p>

<pre><span class="text">
</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">argl</span><span class="text"> = </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">tl_exn</span><span class="text"> </span><span class="id">argl</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | </span><span class="string">&quot;tgz&quot;</span><span class="text"> :: </span><span class="id">more_args</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more_args</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">host_uri</span><span class="text"> :: </span><span class="id">dir</span><span class="text"> :: [] -&gt;
      </span><span class="id">make_targz_on_host</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:(</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host_uri</span><span class="text">) </span><span class="kw4">~dir</span><span class="text"> ()
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">dir</span><span class="text"> :: </span><span class="id">dest_prefix</span><span class="text"> :: [] -&gt;
      </span><span class="id">make_targz_on_host</span><span class="text"> </span><span class="kw4">~dest_prefix</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:(</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text">) </span><span class="kw4">~dir</span><span class="text"> ()
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">dir</span><span class="text"> :: </span><span class="id">dest_prefix</span><span class="text"> :: </span><span class="string">&quot;with-gpg&quot;</span><span class="text"> :: []  -&gt;
      </span><span class="id">make_targz_on_host</span><span class="text"> </span><span class="kw4">~gpg</span><span class="text">:</span><span class="constant">true</span><span class="text"> </span><span class="kw4">~dest_prefix</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:(</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">host</span><span class="text">) </span><span class="kw4">~dir</span><span class="text"> ()
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s tgz &lt;host&gt; &lt;dir&gt; [dest-prefix] [\&quot;with-gpg\&quot;]&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  | </span><span class="string">&quot;lsf&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">queue</span><span class="text"> :: </span><span class="id">cmd</span><span class="text"> :: [] -&gt;
      </span><span class="id">run_command_with_lsf</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~queue</span><span class="text"> </span><span class="id">cmd</span><span class="text">
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s lsf &lt;host&gt; &lt;queue&gt; &lt;cmd&gt;&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  | </span><span class="string">&quot;nohup-setsid&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text">
  | </span><span class="string">&quot;nhss&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">cmd</span><span class="text"> :: [] -&gt; </span><span class="id">run_command_with_nohup</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd</span><span class="text">
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s nhss &lt;host&gt; &lt;cmd&gt;&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  | </span><span class="string">&quot;python-daemon&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text">
  | </span><span class="string">&quot;pyd&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">cmd</span><span class="text"> :: [] -&gt; </span><span class="id">run_command_with_python_method</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd</span><span class="text">
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s pyd &lt;host&gt; &lt;cmd&gt;&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text"> </span><span class="kw1">end</span><span class="text">
  | </span><span class="string">&quot;yarn&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">cmd</span><span class="text"> :: [] -&gt; </span><span class="id">run_command_with_yarn</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd</span><span class="text">
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s yarn &lt;host&gt; &lt;cmd&gt;&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  | </span><span class="string">&quot;two-py&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="id">host</span><span class="text"> :: </span><span class="id">cmd1</span><span class="text"> :: </span><span class="id">cmd2</span><span class="text"> :: [] -&gt; 
      </span><span class="id">run_2_commands_with_python_method</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">cmd1</span><span class="text"> </span><span class="id">cmd2</span><span class="text">
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s two-py &lt;host&gt; &lt;cmd1&gt; &lt;cmd2&gt;&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  | </span><span class="string">&quot;failing-product&quot;</span><span class="text"> :: </span><span class="id">host</span><span class="text"> :: [] -&gt;
    </span><span class="id">fail_because_of_condition</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
  | </span><span class="string">&quot;CI&quot;</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">add_tags</span><span class="text"> = [</span><span class="string">&quot;ketrew-on-vagrant&quot;</span><span class="text">; </span><span class="string">&quot;workflow-examples&quot;</span><span class="text"> ] @ </span><span class="id">more</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="string">&quot;prepare&quot;</span><span class="text"> :: [] -&gt;
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (</span><span class="id">run_ketrew_on_vagrant</span><span class="text"> `</span><span class="kw2">Prepare</span><span class="text">)
        </span><span class="kw4">~add_tags</span><span class="text">
    | </span><span class="string">&quot;go&quot;</span><span class="text"> :: [] -&gt;
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (</span><span class="id">run_ketrew_on_vagrant</span><span class="text"> `</span><span class="kw2">Go</span><span class="text">)
        </span><span class="kw4">~add_tags</span><span class="text">
    | </span><span class="string">&quot;clean&quot;</span><span class="text"> :: [] -&gt;
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> (</span><span class="id">run_ketrew_on_vagrant</span><span class="text"> `</span><span class="kw2">Clean</span><span class="text">)
        </span><span class="kw4">~add_tags</span><span class="text">
    | </span><span class="id">other</span><span class="text"> -&gt;
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s CI {prepare,go,clean}&quot;</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
      </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  | </span><span class="id">args</span><span class="text"> -&gt;
    </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;usage: %s [website|tgz|lsf|nhss|pyd|two-py|failing-product|CI|pythological] ...&quot;</span><span class="text">
      </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">);
    </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Don't know what to do with %s&quot;</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text"> </span><span class="id">args</span><span class="text">);
    </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Wrong command line&quot;</span><span class="text">

</span></pre></div></div></div></body><html>