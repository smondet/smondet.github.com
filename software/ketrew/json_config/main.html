 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: Main Test</title></head><body><div class="container"><h1>Ketrew: Main Test</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li><li><a href='Developer_Documentation.html'>Developer Documentation</a></li><li><a href='Glossary.html'>Glossary</a></li><li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li><li><a href='Server_Commands.html'>Server Commands</a></li><li><a href='The_Configuration_File.html'>The Configuration File</a></li><li><a href='The_HTTP_API.html'>The HTTP API</a></li><li><a href='Workflow_Examples.html'>Workflow Examples</a></li><li><a href='dummy_plugin.html'>Plugin Example</a></li><li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li><li><a href='integration.html'>Integration Test</a></li><li><a href='main.html'>Main Test</a></li><li><a href='preconfigured_main.html'>Preconfigured Main Example</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for the <a href='../index.html'><code>master</code></a> branch</li><li>Documentation for <a href='../doc.0.0.0/index.html'>version 0.0.0</a></li><li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li><li>Up: <a href='../../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="comment">(**************************************************************************)</span><span class="text">
</span><span class="comment">(*  Copyright 2014, Sebastien Mondet &lt;seb@mondet.org&gt;                     *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);       *)</span><span class="text">
</span><span class="comment">(*  you may not use this file except in compliance with the License.      *)</span><span class="text">
</span><span class="comment">(*  You may obtain a copy of the License at                               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*      http://www.apache.org/licenses/LICENSE-2.0                        *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Unless required by applicable law or agreed to in writing, software   *)</span><span class="text">
</span><span class="comment">(*  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,     *)</span><span class="text">
</span><span class="comment">(*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or       *)</span><span class="text">
</span><span class="comment">(*  implied.  See the License for the specific language governing         *)</span><span class="text">
</span><span class="comment">(*  permissions and limitations under the License.                        *)</span><span class="text">
</span><span class="comment">(**************************************************************************)</span><span class="text">

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_pervasives</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_unix_io</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Test</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Tests_failed</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">max_failures</span><span class="text"> = 
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;MAX_FAILURES&quot;</span><span class="text"> |&gt; </span><span class="id">int_of_string</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">2_000_000</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">failed_tests</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> []
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="id">failed_tests</span><span class="text"> := </span><span class="id">s</span><span class="text"> :: !</span><span class="id">failed_tests</span><span class="text">;
    </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> !</span><span class="id">failed_tests</span><span class="text"> &gt; </span><span class="id">max_failures</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
      </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Some tests failed: &quot;</span><span class="text"> %</span><span class="id">n</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> </span><span class="id">s</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">failed_tests</span><span class="text">)
           @ </span><span class="id">error</span><span class="text">);
      </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Tests_failed</span><span class="text"> 
    ) </span><span class="kw1">else</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">over_verbose</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;KETREW_TEST_VERBOSE&quot;</span><span class="text"> = </span><span class="string">&quot;true&quot;</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">checkf</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">function</span><span class="text">
      | </span><span class="id">name</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">not</span><span class="text"> </span><span class="id">b</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">name</span><span class="text">
      | </span><span class="id">name</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">over_verbose</span><span class="text"> -&gt;
        </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Testing &quot;</span><span class="text"> % </span><span class="id">quote</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;: SUCCESS&quot;</span><span class="text"> @ </span><span class="id">warning</span><span class="text">);
      | </span><span class="numeric">_</span><span class="text"> -&gt; ()) </span><span class="id">fmt</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_ssh_host</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="kw4">~playground</span><span class="text">:</span><span class="kw2">Path</span><span class="text">.(</span><span class="id">absolute_directory_exn</span><span class="text"> </span><span class="string">&quot;/tmp&quot;</span><span class="text">)
        (</span><span class="kw2">Unix</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;ketrew_test_ssh&quot;</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> -&gt; </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="string">&quot;localhost&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">wrong_ssh_host</span><span class="text"> =
    </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="string">&quot;ssh://SomelongNameThatIHopeDoesNotExist:42/tmp/bouh&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_targets</span><span class="text"> ?</span><span class="id">wait_between_steps</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="id">targets</span><span class="text"> </span><span class="id">checks</span><span class="text"> =
    </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">
      </span><span class="comment">(*
    let open Ketrew in
    Ketrew_engine.add_targets engine targets
    &gt;&gt;= fun () -&gt;
    Deferred_list.while_sequential checks ~f:(fun check -&gt;
        Option.value_map ~default:(return ()) ~f:System.sleep wait_between_steps
        &gt;&gt;&lt; fun _ -&gt;
        match check with
        | `Dont_care -&gt; Ketrew_engine.Run_automaton.step engine &gt;&gt;= fun _ -&gt; return ()
        | `Happens check -&gt;
          Ketrew_engine.Run_automaton.step engine &gt;&gt;= fun happening -&gt;
          begin match check happening with
          | true -&gt; return ()
          | false -&gt;
            fail (fmt &quot;T: %S: wrong happening: %s&quot; name
                    (List.map ~f:Ketrew_engine.what_happened_to_string happening
                     |&gt; String.concat ~sep:&quot;,\n  &quot;));
            return ()
          end
        | `Status (id, check) -&gt;
          Ketrew_engine.Run_automaton.step engine &gt;&gt;= fun _ -&gt;
          begin Ketrew_engine.get_status engine id
            &gt;&gt;= function
            | s when check s -&gt; return ()
            | other -&gt; fail (fmt &quot;T: %S: wrong status&quot; name); return ()
          end
        | `Kill_and (id, check) -&gt;
          Ketrew_engine.kill engine id
          &gt;&gt;= fun happening -&gt;
          begin match check happening with
          | true -&gt; return ()
          | false -&gt;
            fail (fmt &quot;T: %S: wrong kill happening: %s&quot; name
                    (List.map ~f:Ketrew_engine.what_happened_to_string happening
                     |&gt; String.concat ~sep:&quot;,\n  &quot;));
            return ()
          end)
    &gt;&gt;= fun (_: unit list) -&gt;
    return ()
  *)</span><span class="text">

  </span><span class="comment">(*
    let test_target_one_step ?condition ~engine ~make name check =
      let open Ketrew in
      let target = Target.active ~name ?condition  ~make () in
      test_targets ~name ~engine [target] [check ~id:(Target.id target)]
    let target_succeeds ~id =
      `Status (id, function `Successful _ -&gt; true | _ -&gt; false)
    let target_fails ~id =
      `Status (id, function `Dead _ -&gt; true | _ -&gt; false)
    let check_one_step ~id check = `Happens (check ~id)
    let nothing_happens = `Happens (function [] -&gt; true | _ -&gt; false)
  *)</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">new_db_file</span><span class="text"> () =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">db_file</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> (</span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getcwd</span><span class="text"> ()) </span><span class="string">&quot;_kdb_test&quot;</span><span class="text">  </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">System</span><span class="text">.</span><span class="kw2">Shell</span><span class="text">.</span><span class="id">do_or_fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;rm -rf %s&quot;</span><span class="text"> </span><span class="id">db_file</span><span class="text">)
        </span><span class="kw10">&gt;&gt;</span><span class="text">&lt; </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      </span><span class="kw1">end</span><span class="text">
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="id">db_file</span><span class="text">

    </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Target</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">check_history</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~matches</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
        </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">msg</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="id">state</span><span class="text"> = </span><span class="kw2">Ketrew_target</span><span class="text">.(</span><span class="id">state</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">b</span><span class="text"> = </span><span class="id">state</span><span class="text"> |&gt; </span><span class="id">matches</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">not</span><span class="text"> </span><span class="id">b</span><span class="text"> &amp;&amp; </span><span class="id">over_verbose</span><span class="text"> </span><span class="kw1">then</span><span class="text">
              </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Test: &quot;</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">msg</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;: unexpected history: &quot;</span><span class="text">
                   % </span><span class="id">n</span><span class="text"> % </span><span class="id">indent</span><span class="text"> (</span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="kw2">State</span><span class="text">.</span><span class="id">log</span><span class="text"> </span><span class="id">state</span><span class="text">) @ </span><span class="id">warning</span><span class="text">);
            </span><span class="id">checkf</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="string">&quot;%s&quot;</span><span class="text"> </span><span class="id">msg</span><span class="text">
          ) </span><span class="id">fmt</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_0</span><span class="text"> () =
  </span><span class="kw2">Lwt_main</span><span class="text">.</span><span class="id">run</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">new_db_file</span><span class="text"> ()
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">db_file</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = 
      </span><span class="kw2">Ketrew_configuration</span><span class="text">.</span><span class="id">engine</span><span class="text"> </span><span class="kw4">~database_parameters</span><span class="text">:</span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">with_engine</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> -&gt;
        </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="kw2">Run_automaton</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text">
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt;
        </span><span class="kw2">Test</span><span class="text">.</span><span class="id">checkf</span><span class="text"> (</span><span class="id">not</span><span class="text"> </span><span class="id">v</span><span class="text">) </span><span class="string">&quot;1st step, nothing to do&quot;</span><span class="text">;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">test_steps</span><span class="text"> </span><span class="kw4">~checks</span><span class="text"> </span><span class="id">msg</span><span class="text"> =
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">foldi</span><span class="text"> </span><span class="id">checks</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> ()) </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">check_step</span><span class="text"> -&gt;
            </span><span class="id">prev</span><span class="text"> </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="kw2">Run_automaton</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text">
            </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">do_checks</span><span class="text"> = 
              </span><span class="kw">function</span><span class="text">
              | `</span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
              | `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="id">ret</span><span class="text"> -&gt;
                </span><span class="kw2">Test</span><span class="text">.</span><span class="id">checkf</span><span class="text"> (</span><span class="id">ret</span><span class="text"> = </span><span class="id">v</span><span class="text">) </span><span class="string">&quot;step %d of %s step-returned: %b&quot;</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">msg</span><span class="text"> </span><span class="id">v</span><span class="text">;
                </span><span class="id">return</span><span class="text"> ()
              | `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">id</span><span class="text">, </span><span class="id">matches</span><span class="text">) -&gt;
                </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">get_target</span><span class="text"> </span><span class="id">engine</span><span class="text"> </span><span class="id">id</span><span class="text">
                </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">re_re_target_01</span><span class="text"> -&gt;
                </span><span class="kw2">Test</span><span class="text">.</span><span class="kw2">Target</span><span class="text">.</span><span class="id">check_history</span><span class="text"> </span><span class="id">re_re_target_01</span><span class="text"> </span><span class="kw4">~matches</span><span class="text">
                  </span><span class="string">&quot;step %d of %s target-matching %s&quot;</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">msg</span><span class="text"> </span><span class="id">id</span><span class="text">;
                </span><span class="id">return</span><span class="text"> ()
              | `</span><span class="kw2">And</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
                </span><span class="kw2">Deferred_list</span><span class="text">.</span><span class="id">while_sequential</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">do_checks</span><span class="text">
                </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text"> : </span><span class="kw3">unit</span><span class="text"> </span><span class="kw3">list</span><span class="text">) -&gt;
                </span><span class="id">return</span><span class="text"> ()
            </span><span class="kw">in</span><span class="text">
            </span><span class="id">do_checks</span><span class="text"> </span><span class="id">check_step</span><span class="text">
          </span><span class="kw1">end</span><span class="text"> 
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">target_01</span><span class="text"> = </span><span class="kw2">Ketrew_edsl</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;01&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">target_01</span><span class="kw1">#</span><span class="id">activate</span><span class="text">;
        </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">add_targets</span><span class="text"> </span><span class="id">engine</span><span class="text"> [</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">render</span><span class="text">]
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="kw2">State</span><span class="text">.</span><span class="kw2">Is</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_steps</span><span class="text"> </span><span class="string">&quot;almost empty target&quot;</span><span class="text"> </span><span class="kw4">~checks</span><span class="text">:[
          `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="constant">true</span><span class="text">;
          `</span><span class="kw2">And</span><span class="text"> [
            `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="constant">true</span><span class="text">;
            `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">building</span><span class="text">);
          ];
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">starting</span><span class="text">);
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">successfully_did_nothing</span><span class="text">);
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">verified_success</span><span class="text">);
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">finished</span><span class="text">);
          `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="constant">false</span><span class="text">;
          `</span><span class="kw2">None</span><span class="text">;
        ]
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">return</span><span class="text"> ())
    </span><span class="comment">(*
    Ketrew_engine.with_engine ~configuration begin fun ~engine -&gt;
      Ketrew_engine.add_targets engine
        [Target.(create ~name:&quot;First target&quot; ())]
      &gt;&gt;= fun () -&gt;
      begin Ketrew_engine.current_targets engine
        &gt;&gt;= function
        | [one] when one.Target.name = &quot;First target&quot; -&gt; return ()
        | other -&gt;
          Test.fail (fmt &quot;too many targets: %d&quot; (List.length other)); return ()
      end
      &gt;&gt;= fun () -&gt;


      Test.test_target_one_step ~engine &quot;ls /&quot; Test.target_succeeds
        ~make:(`Direct_command Target.Command.(shell &quot;ls /&quot;))
      &gt;&gt;= fun () -&gt;

      Test.test_target_one_step ~engine &quot;ls /crazypath&quot; Test.target_fails
        ~make:(`Direct_command Target.Command.(shell &quot;ls /crazypath&quot;))
      &gt;&gt;= fun () -&gt;

      let host = Test.test_ssh_host in
      Test.test_target_one_step ~engine &quot;ls / over ssh&quot; Test.target_succeeds
        ~make:(`Direct_command Target.Command.(shell ~host &quot;ls /&quot;))
      &gt;&gt;= fun () -&gt;

      let root = Path.absolute_directory_exn &quot;/tmp&quot; in
      Test.test_target_one_step ~engine &quot;ls / &gt; &lt;file&gt; over ssh&quot; Test.target_succeeds
        ~make:(`Direct_command
                 Target.Command.(shell ~host &quot;ls / &gt; /tmp/ketrew_test&quot;))
        ~condition:(`Volume_exists
                      Artifact.Volume.(create ~host ~root (file &quot;ketrew_test&quot;)))
      &gt;&gt;= fun () -&gt;

      (* A target that creates a more complex file structure *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(
          </span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
            </span><span class="string">&quot;mkdir -p /tmp/ketrew_test2/somedir &amp;&amp; \
             mkdir -p /tmp/ketrew_test2/somedir_empty &amp;&amp; \
             ls / &gt; /tmp/ketrew_test2/ls &amp;&amp; \
             ps aux &gt; /tmp/ketrew_test2/somedir/psaux &quot;</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">vol</span><span class="text"> =
        </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text">
                           (</span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;ketrew_test2&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">; </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_empty&quot;</span><span class="text"> [];
                                                </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;psaux&quot;</span><span class="text">]]))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_succeeds</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* doing it again should succeed for a good reason *)</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh, AGAIN&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
        (</span><span class="kw2">Test</span><span class="text">.</span><span class="id">check_one_step</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id</span><span class="text"> -&gt; </span><span class="kw">function</span><span class="text">
           | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Artifact_ready</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
           | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">))
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* A target that fails to create a more complex file structure; typo on file  *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">vol</span><span class="text"> =
        </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text">
                           (</span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;ketrew_test2&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">; </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_empty&quot;</span><span class="text"> [];
                                                </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_typo&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;psaux&quot;</span><span class="text">]]))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh + file typo&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_fails</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* A target that fails to create a more complex file structure; typo on dir  *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">vol</span><span class="text"> =
        </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text">
                           (</span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;ketrew_test2&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">; </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_empty_2&quot;</span><span class="text"> [];
                                                </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;psaux&quot;</span><span class="text">]]))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh + dir typo&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_fails</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

    </span><span class="comment">(*

      This tests 3 cases, for target1 depending on target2:

      - both may succeed consecutively
      - target 1 may fail and make target2 fail because of dependency
      - target 1 may succeed and target2 fail by itself

    *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">two_targets</span><span class="text"> (</span><span class="id">succeed1</span><span class="text">, </span><span class="id">succeed2</span><span class="text">) </span><span class="id">check</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">tmpfile</span><span class="text"> = </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;ketrew_test_%s&quot;</span><span class="text"> (</span><span class="kw2">Unique_id</span><span class="text">.</span><span class="id">create</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">target1</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">shell_command</span><span class="text"> =
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">succeed1</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;ls -l / &gt; /tmp/%s&quot;</span><span class="text"> </span><span class="id">tmpfile</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;echo bouh&quot;</span><span class="text">
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;ls / &gt; some tmp&quot;</span><span class="text">
            </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">shell_command</span><span class="text">))
            </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text"> (</span><span class="id">file</span><span class="text"> </span><span class="id">tmpfile</span><span class="text">)))
            ()
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">target2</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">shell_command</span><span class="text"> =
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">succeed2</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;wc -l /tmp/%s&quot;</span><span class="text"> </span><span class="id">tmpfile</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;exit 42&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;count lines of dependency&quot;</span><span class="text">
            </span><span class="kw4">~dependencies</span><span class="text">:[ </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target1</span><span class="text"> ]
            </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">shell_command</span><span class="text">))
            ()
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">id1</span><span class="text"> = </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">id2</span><span class="text"> = </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">expected_status</span><span class="text"> </span><span class="id">b</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="string">&quot;succeeds&quot;</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;fails&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> =
          </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;%s (%s) depends on %s (%s)&quot;</span><span class="text">
            </span><span class="id">id1</span><span class="text"> (</span><span class="id">expected_status</span><span class="text"> </span><span class="id">succeed1</span><span class="text">)
            </span><span class="id">id2</span><span class="text"> (</span><span class="id">expected_status</span><span class="text"> </span><span class="id">succeed2</span><span class="text">)
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> [</span><span class="id">target1</span><span class="text">; </span><span class="id">target2</span><span class="text">] (</span><span class="id">check</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">two_targets</span><span class="text"> (</span><span class="constant">true</span><span class="text">, </span><span class="constant">true</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text"> -&gt;
          [
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependency</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_success</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_success</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id2</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">
          ])
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">two_targets</span><span class="text"> (</span><span class="constant">false</span><span class="text">, </span><span class="constant">true</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text"> -&gt;
          [
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependency</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_failure</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependencies_died</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id2</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">
          ])
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">two_targets</span><span class="text"> (</span><span class="constant">true</span><span class="text">, </span><span class="constant">false</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text"> -&gt;
          [
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependency</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_success</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_failure</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id2</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">
          ])
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_missing_dep</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_missing_dep&quot;</span><span class="text">
          </span><span class="kw4">~dependencies</span><span class="text">:[ </span><span class="string">&quot;hope this one is not in the database&quot;</span><span class="text"> ]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_missing_dep&quot;</span><span class="text"> [</span><span class="id">target_with_missing_dep</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(
            </span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Dependencies_died</span><span class="text">;
            ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

    
      </span><span class="comment">(* A target with 2 fallback targets: *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fallback1</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Fallback 1&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fallback2</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Fallback 2&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_fallbacks</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallbacks&quot;</span><span class="text">
          </span><span class="kw4">~if_fails_activate</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback1</span><span class="text">; </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback2</span><span class="text"> ]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /somelong_STUPID-path&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallbacks&quot;</span><span class="text">
        [</span><span class="id">target_with_fallbacks</span><span class="text">; </span><span class="id">fallback1</span><span class="text">; </span><span class="id">fallback2</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(
            </span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Process_failure</span><span class="text">;
              </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Fallback</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback1</span><span class="text">);
              </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Fallback</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback2</span><span class="text">);
            ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* Two targets with the same fallback *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fallback</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Fallback&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_fallback_1</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallback_1&quot;</span><span class="text">
          </span><span class="kw4">~if_fails_activate</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback</span><span class="text">]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /somelong_STUPID-path&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_fallback_2</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallback_2&quot;</span><span class="text">
          </span><span class="kw4">~if_fails_activate</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback</span><span class="text">]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /somelong_STUPID-path&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;targets_with_same_fallback&quot;</span><span class="text">
        [</span><span class="id">target_with_fallback_1</span><span class="text">; </span><span class="id">target_with_fallback_2</span><span class="text">; </span><span class="id">fallback</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(
            </span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Process_failure</span><span class="text">;
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Process_failure</span><span class="text">;
              </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Fallback</span><span class="text">;
            ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
      </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw">let</span><span class="text"> </span><span class="id">triggered</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Triggered&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text">))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_that_triggers</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target-with-trigger&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text">))
          </span><span class="kw4">~success_triggers</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">triggered</span><span class="text">]
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target-with-trigger&quot;</span><span class="text">
        [</span><span class="id">target_that_triggers</span><span class="text">; </span><span class="id">triggered</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(</span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
            </span><span class="id">success</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target_that_triggers</span><span class="text">); 
            </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Success_trigger</span><span class="text">;
          ]);
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(</span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
            </span><span class="id">success</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">triggered</span><span class="text">); 
          ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
    </span><span class="kw1">end</span><span class="text">


*)
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">return</span><span class="text"> ()
  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_0: Ketrew ERROR:  &quot;</span><span class="text"> %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_0 ends with error&quot;</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_ssh_failure_vs_target_failure</span><span class="text"> () =
  </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">
    </span><span class="comment">(*
  let open Ketrew in
  Lwt_main.run begin
    let test_wrong_host turn_unix_ssh_failure_into_target_failure expect =
      Test.new_db_file ()
      &gt;&gt;= fun database_parameters -&gt;
      let configuration =
        Configuration.engine
          ~turn_unix_ssh_failure_into_target_failure ~database_parameters () in
      Ketrew_engine.with_engine ~configuration (fun ~engine -&gt;
          let target_with_wrong_host =
            let host = Test.wrong_ssh_host in
            Target.active ~name:&quot;target_with_missing_dep&quot;
              ~make:(`Direct_command Target.Command.(shell ~host &quot;ls&quot;)) ()
          in
          Test.test_targets
            ~engine ~name:&quot;target_with_wrong_host&quot; [target_with_wrong_host]
            expect)
    in
    (* `false` is the default:
       The target won't be killed (so Ketrew will try to run it again at each
       `step`)
    *)</span><span class="text">
    </span><span class="id">test_wrong_host</span><span class="text"> </span><span class="constant">false</span><span class="text"> [
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* Nothing happens. *)</span><span class="text">
        | []  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
        | []  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Dont_care</span><span class="text">;
    ]
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="comment">(* The target will be kill at the first attempt: *)</span><span class="text">
    </span><span class="id">test_wrong_host</span><span class="text"> </span><span class="constant">true</span><span class="text"> [
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* Nothing happens. *)</span><span class="text">
        | [`</span><span class="kw2">Target_died</span><span class="text"> </span><span class="numeric">_</span><span class="text">]  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
        | []  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Dont_care</span><span class="text">;
    ]

  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_ssh_failure_vs_target_failure: Ketrew ERROR:  &quot;</span><span class="text"> %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_ssh_failure_vs_target_failure ends with error&quot;</span><span class="text">
*)



</span><span class="kw">let</span><span class="text"> </span><span class="id">test_long_running_nohup</span><span class="text"> () =
  </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">
    </span><span class="comment">(*
  let open Ketrew in
  Lwt_main.run begin
    Test.new_db_file ()
    &gt;&gt;= fun db_file -&gt;
    let configuration = Configuration.engine ~database_parameters:db_file () in
    Ketrew_engine.with_engine ~configuration (fun ~engine -&gt;

        Test.test_targets  ~engine ~name:(&quot;one bad plugin&quot;)
          [Target.active ~name:&quot;one&quot;
             ~make:(`Long_running (&quot;bad_plugin&quot;, &quot;useless string&quot;)) ()
          ]
          [`Happens (function
             | [`Target_died (_, `Plugin_not_found &quot;bad_plugin&quot;)] -&gt; true
             | _ -&gt; false);
           `Dont_care;
           Test.nothing_happens;
          ]
        &gt;&gt;= fun () -&gt;

        let root = Path.absolute_directory_exn &quot;/tmp&quot; in
        Deferred_list.while_sequential [Test.test_ssh_host] ~f:(fun host -&gt;
            let name n = fmt &quot;%s on %s&quot; n Host.(to_string_hum host) in
            let new_name = Unique_id.create () in
            Test.test_targets  ~engine ~name:(name &quot;good ls&quot;)
              ~wait_between_steps:1.
              [Target.active ~name:&quot;one&quot; ()
                 ~make:(Daemonize.create ~host
                          (`Shell_command (fmt &quot;ls &gt; /tmp/%s&quot; new_name)))
                 ~condition:(`Volume_exists
                               Artifact.Volume.(create ~host ~root (file new_name)))
              ]
              [`Happens (function
                 | [`Target_started (_, _)] -&gt; true
                 | _ -&gt; false);
               `Happens (function (* We hope that 1 second intervals are enough
                                     but there is no good synchronization *)</span><span class="text">
                 | [`</span><span class="kw2">Target_succeeded</span><span class="text"> </span><span class="numeric">_</span><span class="text">] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">;
              ]
            </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

            </span><span class="comment">(* Test the `kill` function: *)</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">id</span><span class="text"> = </span><span class="kw2">Unique_id</span><span class="text">.</span><span class="id">create</span><span class="text"> () </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text">  </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">name</span><span class="text"> </span><span class="string">&quot;sleep 42&quot;</span><span class="text">)
              </span><span class="kw4">~wait_between_steps</span><span class="text">:</span><span class="numeric">1</span><span class="text">.
              [</span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;one&quot;</span><span class="text"> </span><span class="kw4">~id</span><span class="text">
                 </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Daemonize</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
                          (`</span><span class="kw2">Shell_command</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;echo %S &amp;&amp; sleep 42&quot;</span><span class="text"> </span><span class="kw2">String</span><span class="text">.(</span><span class="id">make</span><span class="text"> </span><span class="numeric">60</span><span class="text"> </span><span class="string">'='</span><span class="text">))))
                 ()
              ]
              [`</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                 | [`</span><span class="kw2">Target_started</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* We hope that 1 second intervals are enough *)</span><span class="text">
                 | [] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               `</span><span class="kw2">Dont_care</span><span class="text">;
               `</span><span class="kw2">Dont_care</span><span class="text">;
               `</span><span class="kw2">Dont_care</span><span class="text">;
               `</span><span class="kw2">Kill_and</span><span class="text"> (</span><span class="id">id</span><span class="text">, (</span><span class="kw">function</span><span class="text">
                 | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, `</span><span class="kw2">Killed</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">));
               </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">;
              ]
            </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

            </span><span class="comment">(* Test that a target fails when the process succeeds but does not
               create the right target: *)</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> =
              </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.(
                </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;some name&quot;</span><span class="text">
                  </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;ls &gt; /tmp/some_temp_file&quot;</span><span class="text">))
                  </span><span class="kw4">~done_when</span><span class="text">:(</span><span class="id">file</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;/tmp/some_temp_file_with_error&quot;</span><span class="text">)</span><span class="kw1">#</span><span class="id">exists</span><span class="text">
              )
            </span><span class="kw">in</span><span class="text">
            </span><span class="id">t</span><span class="kw1">#</span><span class="id">activate</span><span class="text">;
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">name</span><span class="text"> </span><span class="string">&quot;wrong 'returns'&quot;</span><span class="text">)
              </span><span class="kw4">~wait_between_steps</span><span class="text">:</span><span class="numeric">0.3</span><span class="text"> [</span><span class="id">t</span><span class="kw1">#</span><span class="id">render</span><span class="text">] [
              `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                | [`</span><span class="kw2">Target_started</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
              `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, `</span><span class="kw2">Process_failure</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
              `</span><span class="kw2">Dont_care</span><span class="text">;
            ]
            </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;

            </span><span class="id">return</span><span class="text"> ())
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text"> : </span><span class="kw3">unit</span><span class="text"> </span><span class="kw3">list</span><span class="text">) -&gt;

        </span><span class="id">return</span><span class="text"> ())
  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_long_running_nohup: Ketrew ERROR:  &quot;</span><span class="text">
         %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_long_running_nohup ends with error&quot;</span><span class="text">
*)

</span><span class="kw">type</span><span class="text"> </span><span class="id">state</span><span class="text"> = { </span><span class="id">name</span><span class="text"> : </span><span class="kw3">string</span><span class="text"> }
</span><span class="kw">type</span><span class="text"> </span><span class="id">action</span><span class="text"> = </span><span class="kw3">string</span><span class="text">
</span><span class="kw">type</span><span class="text"> </span><span class="id">tree</span><span class="text"> = [
  | `</span><span class="kw2">Leaf</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">state</span><span class="text">
  | `</span><span class="kw2">Node</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">state</span><span class="text"> * </span><span class="id">action</span><span class="text"> * (</span><span class="kw3">string</span><span class="text"> * </span><span class="id">tree</span><span class="text">) </span><span class="kw3">list</span><span class="text">
]
</span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">tree_to_log</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Log</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Leaf</span><span class="text"> {</span><span class="id">name</span><span class="text">} -&gt; </span><span class="id">braces</span><span class="text"> (</span><span class="id">s</span><span class="text"> </span><span class="id">name</span><span class="text">)
  | `</span><span class="kw2">Node</span><span class="text"> ({</span><span class="id">name</span><span class="text">}, </span><span class="id">action</span><span class="text">, </span><span class="id">trees</span><span class="text">) -&gt;
    </span><span class="id">parens</span><span class="text"> (</span><span class="id">braces</span><span class="text"> (</span><span class="id">s</span><span class="text"> </span><span class="id">name</span><span class="text">) % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot; → &quot;</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">action</span><span class="text"> 
            % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">response</span><span class="text">, </span><span class="id">tree</span><span class="text">) -&gt;
                </span><span class="id">s</span><span class="text"> </span><span class="id">response</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;: &quot;</span><span class="text"> % </span><span class="id">tree_to_log</span><span class="text"> </span><span class="id">tree</span><span class="text">)
              </span><span class="id">trees</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">action</span><span class="text"> =
  </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Leaf</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
  | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">a</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">a</span><span class="text"> = </span><span class="id">action</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
  | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">a</span><span class="text">, </span><span class="id">l</span><span class="text">) -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">t</span><span class="text">) -&gt; </span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">action</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="id">tree_to_dot</span><span class="text"> ?(</span><span class="id">style</span><span class="text">=`</span><span class="kw2">Action_boxes</span><span class="text">) </span><span class="id">t</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Log</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">arrow</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="string">&quot; -&gt; &quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">semicolon</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">transition</span><span class="text"> </span><span class="id">state1</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">response</span><span class="text"> </span><span class="id">state2</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">style</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    </span><span class="comment">(* | `Arrow_labels -&gt; *)</span><span class="text">
    </span><span class="comment">(*   (s state1 % arrow % s state2 *)</span><span class="text">
    </span><span class="comment">(*    % sp % brakets (s &quot;label=&quot; % sf &quot;%S&quot; action) *)</span><span class="text">
    </span><span class="comment">(*    % s &quot;;&quot; % n) *)</span><span class="text">
    | `</span><span class="kw2">Action_boxes</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">action_name</span><span class="text">, </span><span class="id">action_attributes</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">state2</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="string">&quot;Killing&quot;</span><span class="text"> -&gt;
          </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">state2</span><span class="text">,
          </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,shape=doubleoctagon, label=%S&quot;</span><span class="text"> </span><span class="string">&quot;MURDER&quot;</span><span class="text">
        | </span><span class="string">&quot;Active&quot;</span><span class="text"> -&gt;
    
      </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">action</span><span class="text"> ^ </span><span class="id">state2</span><span class="text">,
          </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,shape=doubleoctagon, label=%S&quot;</span><span class="text"> </span><span class="string">&quot;ACTIVATION&quot;</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt;
          </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">action</span><span class="text">, </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,shape=box label=\&quot;%s\&quot;&quot;</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">response_name</span><span class="text">, </span><span class="id">response_attributes</span><span class="text"> =
        </span><span class="string">&quot;response&quot;</span><span class="text"> ^ </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">action</span><span class="text"> ^ </span><span class="id">state2</span><span class="text">,
        </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;shape=diamond,fontsize=9,fontname=\&quot;monospace\&quot;,label=%S&quot;</span><span class="text"> </span><span class="id">response</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="comment">(* s state1 % sp % brakets (s &quot;shape=oval&quot;) % s &quot;;&quot; % n *)</span><span class="text">
      </span><span class="comment">(* % s state2 % sp % brakets (s &quot;shape=oval&quot;) % s &quot;;&quot; % n *)</span><span class="text">
      </span><span class="comment">(* % s action_name % sp % brakets action_attributes % s &quot;;&quot; % n *)</span><span class="text">
      </span><span class="comment">(* % s state1 % arrow % s action_name % arrow % s state2 % semicolon % n *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">state_attributes</span><span class="text"> =
        </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,fontsize=18,shape=oval&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">state_action_arrow</span><span class="text"> =
        </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;arrowhead=\&quot;open\&quot;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">action_respoonse_arrow</span><span class="text"> =
        </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;dir=\&quot;none\&quot;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [
        </span><span class="id">s</span><span class="text"> </span><span class="id">state1</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">state_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">state2</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">state_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">action_name</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">action_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">response_name</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">response_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">state1</span><span class="text"> % </span><span class="id">arrow</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">action_name</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">state_action_arrow</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">action_name</span><span class="text"> % </span><span class="id">arrow</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">response_name</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">action_respoonse_arrow</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">response_name</span><span class="text"> % </span><span class="id">arrow</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">state2</span><span class="text">;
      ]
  </span><span class="kw">in</span><span class="text">
  </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;digraph target_graph&quot;</span><span class="text">
  % </span><span class="id">braces</span><span class="text"> (
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">go</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">continue</span><span class="text"> = </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">t</span><span class="text">) -&gt; </span><span class="id">go</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">state</span><span class="text">) -&gt; []
      | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state</span><span class="text">, </span><span class="string">&quot;NONE&quot;</span><span class="text">, </span><span class="id">trees</span><span class="text">) -&gt;
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">continue</span><span class="text"> </span><span class="id">trees</span><span class="text">
      | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state</span><span class="text">, </span><span class="id">action</span><span class="text">, </span><span class="id">trees</span><span class="text">) -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">arrows</span><span class="text"> =
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">trees</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
            | </span><span class="id">response</span><span class="text">, `</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">statei</span><span class="text">)
            | </span><span class="id">response</span><span class="text">, `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">statei</span><span class="text">, </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
              </span><span class="id">transition</span><span class="text"> </span><span class="id">state</span><span class="text">.</span><span class="id">name</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">response</span><span class="text"> </span><span class="id">statei</span><span class="text">.</span><span class="id">name</span><span class="text">)
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">append</span><span class="text"> </span><span class="id">arrows</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">continue</span><span class="text"> </span><span class="id">trees</span><span class="text">) |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    (</span><span class="id">go</span><span class="text"> </span><span class="id">t</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">dedup</span><span class="text"> |&gt; </span><span class="id">separate</span><span class="text"> (</span><span class="id">semicolon</span><span class="text"> % </span><span class="id">n</span><span class="text">))
  )

</span><span class="comment">(* &quot;{&quot; ^ action ^ &quot; -&gt; &quot; ^ state ^ &quot;\n&quot; *)</span><span class="text">
</span><span class="comment">(* ^ String.concat ~sep:&quot; --- &quot; (List.map ~f:tree_to_string trees) ^ &quot;}&quot; *)</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">make_automaton_graph</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">T</span><span class="text"> = </span><span class="kw2">Ketrew_target</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">state_name</span><span class="text"> </span><span class="id">t</span><span class="text"> = {</span><span class="id">name</span><span class="text"> = </span><span class="kw2">Ketrew_target</span><span class="text">.(</span><span class="kw2">State</span><span class="text">.</span><span class="id">name</span><span class="text"> (</span><span class="id">state</span><span class="text"> </span><span class="id">t</span><span class="text">)) } </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text"> ?(</span><span class="id">stop_afterwards</span><span class="text">=</span><span class="constant">false</span><span class="text">) </span><span class="id">target</span><span class="text"> =
    </span><span class="comment">(* Log.(s &quot;status: &quot; % Ketrew_target.(State.log ~depth:1 (state target)) @ normal); *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">node</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">l</span><span class="text"> : </span><span class="id">tree</span><span class="text"> =
      `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state_name</span><span class="text"> </span><span class="id">target</span><span class="text">, </span><span class="id">action</span><span class="text">, </span><span class="id">l</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">additional</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">T</span><span class="text">.</span><span class="id">state</span><span class="text"> </span><span class="id">target</span><span class="text"> |&gt; </span><span class="kw2">T</span><span class="text">.</span><span class="kw2">State</span><span class="text">.</span><span class="kw2">Is</span><span class="text">.</span><span class="id">killable</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="constant">true</span><span class="text"> -&gt;
        [</span><span class="string">&quot;OK&quot;</span><span class="text">, (</span><span class="kw2">T</span><span class="text">.</span><span class="id">kill</span><span class="text"> </span><span class="id">target</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">&quot;Killing TOKILL&quot;</span><span class="text">,
                `</span><span class="kw2">Changed_state</span><span class="text">)]
      | </span><span class="constant">false</span><span class="text"> -&gt; [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">protect_rec_call</span><span class="text"> </span><span class="id">log</span><span class="text"> </span><span class="id">f</span><span class="text"> =
      </span><span class="comment">(* If a change in the state-machine makes this happen, it
         usually means that the author forgot to pass the `No-change`
         information in `Target.Automaton.transition`. *)</span><span class="text">
      </span><span class="kw1">try</span><span class="text"> </span><span class="id">f</span><span class="text"> ()
      </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Stack_overflow</span><span class="text"> -&gt;
        </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">eprintf</span><span class="text"> </span><span class="string">&quot;Test error! Stack_overflow: %d, %s\n%!&quot;</span><span class="text"> </span><span class="id">depth</span><span class="text"> </span><span class="id">log</span><span class="text">;
        </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Stack_overflow</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">node_map</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">l</span><span class="text"> : </span><span class="id">tree</span><span class="text"> =
      </span><span class="id">node</span><span class="text"> </span><span class="id">action</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> (</span><span class="id">additional</span><span class="text"> @ </span><span class="id">l</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
        | </span><span class="id">response</span><span class="text">, (</span><span class="id">t</span><span class="text">, `</span><span class="kw2">No_change</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">stop_afterwards</span><span class="text"> -&gt;
          </span><span class="id">response</span><span class="text">, `</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">state_name</span><span class="text"> </span><span class="id">t</span><span class="text">)
        | </span><span class="id">response</span><span class="text">, (</span><span class="id">t</span><span class="text">, `</span><span class="kw2">No_change</span><span class="text">) -&gt;
          </span><span class="id">response</span><span class="text">,
          </span><span class="id">protect_rec_call</span><span class="text"> </span><span class="string">&quot;no-change&quot;</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text">:(</span><span class="id">depth</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~stop_afterwards</span><span class="text">:</span><span class="constant">true</span><span class="text"> </span><span class="id">t</span><span class="text">)
        | </span><span class="id">response</span><span class="text">, (</span><span class="id">t</span><span class="text">, `</span><span class="kw2">Changed_state</span><span class="text">) -&gt;
          </span><span class="id">response</span><span class="text">,
          </span><span class="id">protect_rec_call</span><span class="text"> </span><span class="string">&quot;changed-state&quot;</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text">:(</span><span class="id">depth</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">t</span><span class="text">))) </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="kw2">Automaton</span><span class="text">.</span><span class="id">transition</span><span class="text"> </span><span class="id">target</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Kill</span><span class="text"> (</span><span class="id">b</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;kill&quot;</span><span class="text">
        [</span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">b</span><span class="text">);
         </span><span class="string">&quot;Try-Again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">b</span><span class="text">));
         </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">b</span><span class="text">));]
    | `</span><span class="kw2">Do_nothing</span><span class="text"> </span><span class="id">mkt</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">action</span><span class="text"> = </span><span class="string">&quot;do_nothing&quot;</span><span class="text">  </span><span class="kw">in</span><span class="text">
      </span><span class="id">node_map</span><span class="text"> </span><span class="id">action</span><span class="text"> [</span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> ()]
    | `</span><span class="kw2">Check_and_activate_dependencies</span><span class="text"> </span><span class="id">mkt</span><span class="text"> -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;check_and_activate_dependencies&quot;</span><span class="text"> [
        </span><span class="string">&quot;All-succeeded&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> `</span><span class="kw2">All_succeeded</span><span class="text">;
        </span><span class="string">&quot;At-least-one-failed&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">At_least_one_failed</span><span class="text"> []);
        </span><span class="string">&quot;Still-processing&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> `</span><span class="kw2">Still_processing</span><span class="text">;
      ]
    | `</span><span class="kw2">Start_running</span><span class="text"> (</span><span class="id">book</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;start_running&quot;</span><span class="text"> [
        </span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">book</span><span class="text">);
        </span><span class="string">&quot;Try-again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
      ]
    | `</span><span class="kw2">Activate</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;activate_targets&quot;</span><span class="text"> [</span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> ()]
    | `</span><span class="kw2">Eval_condition</span><span class="text"> (</span><span class="id">condition</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;eval_condition&quot;</span><span class="text"> [
        </span><span class="string">&quot;true&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="constant">true</span><span class="text">);
        </span><span class="string">&quot;false&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="constant">false</span><span class="text">);
        </span><span class="string">&quot;Try-again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">));
        </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">));
      ]
    | `</span><span class="kw2">Check_process</span><span class="text"> (</span><span class="id">book</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;check_process&quot;</span><span class="text"> [
        </span><span class="string">&quot;Success&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">Successful</span><span class="text"> </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Still-running&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">Still_running</span><span class="text"> </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Try-again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
      ]
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">activate_and_render</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">t</span><span class="kw1">#</span><span class="id">activate</span><span class="text">; </span><span class="id">t</span><span class="kw1">#</span><span class="id">render</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">dep</span><span class="text"> =(</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;01&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">targets</span><span class="text"> = [
    </span><span class="id">dep</span><span class="text"> </span><span class="kw1">#</span><span class="id">render</span><span class="text">;
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;02&quot;</span><span class="text"> |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;03&quot;</span><span class="text"> </span><span class="kw4">~dependencies</span><span class="text">:[</span><span class="id">dep</span><span class="text">] |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;03&quot;</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="string">&quot;&quot;</span><span class="text">)) |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;03&quot;</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="string">&quot;&quot;</span><span class="text">))
       </span><span class="kw4">~done_when</span><span class="text">:`</span><span class="kw2">Never</span><span class="text"> |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;04&quot;</span><span class="text"> </span><span class="kw4">~done_when</span><span class="text">:(`</span><span class="kw2">Satisfied</span><span class="text">) |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;04&quot;</span><span class="text"> |&gt; </span><span class="id">activate_and_render</span><span class="text">
     |&gt; </span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="id">kill</span><span class="text"> ?</span><span class="id">log</span><span class="text">:</span><span class="kw2">None</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">&quot;not killable?&quot;</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;TOKILL&quot;</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="string">&quot;&quot;</span><span class="text">))
     |&gt; </span><span class="id">activate_and_render</span><span class="text">);
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">result_tree</span><span class="text"> =
    (`</span><span class="kw2">Node</span><span class="text"> ({</span><span class="id">name</span><span class="text">= </span><span class="string">&quot;ROOT&quot;</span><span class="text">}, </span><span class="string">&quot;NONE&quot;</span><span class="text">,
            (</span><span class="string">&quot;OK&quot;</span><span class="text">, `</span><span class="kw2">Node</span><span class="text"> ({</span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;Passive&quot;</span><span class="text">}, </span><span class="string">&quot;Activation&quot;</span><span class="text">, [</span><span class="string">&quot;OK&quot;</span><span class="text">, `</span><span class="kw2">Leaf</span><span class="text"> {</span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;Active&quot;</span><span class="text">}]))
            :: </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">targets</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt;
                (</span><span class="string">&quot;&quot;</span><span class="text">, `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state_name</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="string">&quot;NONE&quot;</span><span class="text">, [</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="id">t</span><span class="text">]))))) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">all_actions</span><span class="text"> = [
    </span><span class="string">&quot;kill&quot;</span><span class="text">; </span><span class="string">&quot;do_nothing&quot;</span><span class="text">; </span><span class="string">&quot;check_and_activate_dependencies&quot;</span><span class="text">;
    </span><span class="string">&quot;start_running&quot;</span><span class="text">; </span><span class="string">&quot;activate_targets&quot;</span><span class="text">; </span><span class="string">&quot;eval_condition&quot;</span><span class="text">; </span><span class="string">&quot;check_process&quot;</span><span class="text">
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Test</span><span class="text">.</span><span class="id">checkf</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">all_actions</span><span class="text"> (</span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">result_tree</span><span class="text">))
    </span><span class="string">&quot;tree having all actions: missing: %s&quot;</span><span class="text">
    (</span><span class="kw2">List</span><span class="text">.</span><span class="id">filter</span><span class="text"> </span><span class="id">all_actions</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">a</span><span class="text"> -&gt; </span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">result_tree</span><span class="text"> </span><span class="id">a</span><span class="text"> |&gt; </span><span class="id">not</span><span class="text">)
     |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text">) ;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">o</span><span class="text"> = </span><span class="id">open_out</span><span class="text"> </span><span class="string">&quot;target_graph.dot&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">output_string</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw2">Log</span><span class="text">.</span><span class="id">to_long_string</span><span class="text">
                     (</span><span class="id">tree_to_dot</span><span class="text"> </span><span class="id">result_tree</span><span class="text">));
  </span><span class="id">close_out</span><span class="text"> </span><span class="id">o</span><span class="text">;
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">over_verbose</span><span class="text"> </span><span class="kw1">then</span><span class="text">
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Trrreeees: &quot;</span><span class="text"> % </span><span class="id">n</span><span class="text"> % </span><span class="id">tree_to_log</span><span class="text"> </span><span class="id">result_tree</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
  ()

</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">argl</span><span class="text"> = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">global_with_color</span><span class="text"> := </span><span class="id">not</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;-no-color&quot;</span><span class="text">);
  </span><span class="id">global_debug_level</span><span class="text"> := </span><span class="numeric">3</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">all</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;ALL&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;basic-test&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_0</span><span class="text"> ();
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;nohup-test&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_long_running_nohup</span><span class="text"> ();
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;ssh-failure&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_ssh_failure_vs_target_failure</span><span class="text"> ();
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;automaton-graph&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">make_automaton_graph</span><span class="text"> ();
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> !</span><span class="kw2">Test</span><span class="text">.</span><span class="id">failed_tests</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [] -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;No tests failed \\o/ (arg-list: &quot;</span><span class="text">
         % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> (</span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text">) </span><span class="id">argl</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;)&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">0</span><span class="text">
  | </span><span class="id">some</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Some tests failed: &quot;</span><span class="text"> %</span><span class="id">n</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> </span><span class="kw3">string</span><span class="text"> </span><span class="id">some</span><span class="text"> @ </span><span class="id">error</span><span class="text">);
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">3</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>