 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: Home</title></head><body><div class="container"><h1>Ketrew: Home</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul><li><a href='#BuildampInstall'>Build &amp; Install</a>
<ul><li><a href='#FromOpam'>From Opam</a>
</li><li><a href='#WithoutOpam'>Without Opam</a>
</li></ul>
</li><li><a href='#GettingStarted'>Getting Started</a>
</li><li><a href='#TheEDSLDefiningWorkflows'>The EDSL: Defining Workflows</a>
<ul><li><a href='#Overview'>Overview</a>
</li><li><a href='#Example'>Example</a>
</li></ul>
</li><li><a href='#Troubleshooting'>Troubleshooting</a>
</li><li><a href='#WheretoGoNext'>Where to Go Next</a>
</li><li><a href='#License'>License</a>
</li><li><a href='#Badges'>Badges</a>
</li></ul><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li><li><a href='Database_Backends.html'>Database Backends</a></li><li><a href='Developer_Documentation.html'>Developer Documentation</a></li><li><a href='FAQ.html'>FAQ</a></li><li><a href='Glossary.html'>Glossary</a></li><li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li><li><a href='Server_Commands.html'>Server Commands</a></li><li><a href='Standalone_Mode.html'>Standalone Mode</a></li><li><a href='The_Configuration_File.html'>The Configuration File</a></li><li><a href='The_HTTP_API.html'>The HTTP API</a></li><li><a href='Workflow_Examples.html'>Workflow Examples</a></li><li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li><li><a href='dummy_plugin.html'>Plugin Example</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for <a href='./doc.0.0.0/index.html'>version 0.0.0</a></li><li>Documentation for <a href='./doc.1.0.0/index.html'>version 1.0.0</a></li><li>Documentation for <a href='./doc.1.1.0/index.html'>version 1.1.0</a></li><li>Documentation for <a href='./doc.1.1.1/index.html'>version 1.1.1</a></li><li>Documentation for <a href='./doc.2.0.0/index.html'>version 2.0.0</a></li><li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><h1 id="KetrewKeepTrackofExperimentalWorkflows">Ketrew: Keep Track of Experimental Workflows</h1>

<p><strong>Ketrew</strong> is:</p>
<ol><li>An OCaml library providing an EDSL API to define complex and convoluted
workflows (interdependent steps/programs using a lot of data, with many
parameter variations, running on different hosts with various schedulers).</li><li>A client-server application to interact with these workflows.
The engine at heart of the server takes care of orchestrating workflows,
and keeps track of everything that succeeds, fails, or gets lost.</li></ol>

<p>This is the master branch of Ketrew.
See also the documentation for the latest release:
<a href='http://seb.mondet.org/software/ketrew/doc.2.0.0/index.html'>2.0.0</a>.</p>
<p>If you have any questions, you may submit an
<a href='https://github.com/hammerlab/ketrew/issues'>issue</a>, or join
the authors on the public “Slack” channel of the Hammer Lab:
<a href='http://publicslack.hammerlab.org'><img src='http://publicslack.hammerlab.org/badge.svg' alt='Slack Status' /></a></p>
<h2 id="BuildampInstall">Build &amp; Install</h2>

<p>Ketrew requires at least OCaml <strong>4.02.2</strong> and should be able to build &amp; work on
any Unix platform.</p>
<h3 id="FromOpam">From Opam</h3>

<p>If you have <a href='http://opam.ocaml.org/'>opam</a> up and running, just install Ketrew
while choose a database backend (you may pick both and choose later in the
config-file):</p>
<pre><code>opam install  (sqlite | postgresql) [ssl | tls]  ketrew</code></pre><ul><li>you need to choose a database backend <code>sqlite</code> or <code>postgresql</code>
 (you may install both and choose later in the config-file),</li><li>if you want Ketrew to use HTTPS you need to get it linked
 with OpenSSL (package <code>ssl</code>) or <a href='https://nqsb.io/'>nqsb-TLS</a> (package
 <code>tls</code>, <em>experimental</em>).</li></ul>

<p>This gets you</p>
<ul><li>a <code>ketrew</code> executable that can be used to schedule and run workflows,</li><li>an OCaml library also called <code>ketrew</code> that handles the messy orchestration of
 those tasks and exports the <a href='api/Ketrew.EDSL.html' title='Ketrew.EDSL'><code>Ketrew.EDSL</code></a> module used to write workflows.</li></ul>

<p>Remember that at runtime you&#39;ll need <code>ssh</code> in your <code>$PATH</code> to execute commands on
foreign hosts.</p>
<p><em>Optional</em>: Ketrew, like any <a href='http://ocsigen.org/lwt/'>Lwt</a>-based piece of
software, will be much faster and scalable when <code>libev</code> is detected and used
as a backend. Use <code>opam install conf-libev</code> to tell opam that <code>libev</code> is
<a href='http://opam.ocaml.org/packages/conf-libev/conf-libev.4-11/'>installed</a>, which
you can ensure with</p>
<ul><li><code>brew install libev</code> on MacOSX</li><li><code>apt-get install libev-dev</code>on Debian/Ubuntu,</li><li><code>yum install libev-devel</code> on CentOS (which requires
 <code>export C_INCLUDE_PATH=/usr/include/libev/</code> and <code>export LIBRARY_PATH=/usr/lib64/</code></li></ul>

<p>before <code>opam install conf-libev</code>.</p>
<h3 id="WithoutOpam">Without Opam</h3>

<p>See the <a href='./Developer_Documentation.html'>development documentation</a> to find
out how to build Ketrew (and its dependencies) from source.</p>
<h2 id="GettingStarted">Getting Started</h2>

<p>Ketrew is very flexible and hence may seem difficult to understand at first. 
Let&#39;s get a minimal workflow running.</p>
<p>Before you can use Ketrew, you need to configure it:</p>
<pre><code>$ ketrew init</code></pre><p>By default this will write a configuration file &amp; list of authorized tokens
for the Ketrew server in</p>
<pre><code>$ ls $HOME/.ketrew/
authorized_tokens    configuration.ml</code></pre><p>You can check that the client or the server are configured (the client is
returned by default) by using the <code>print-configuration</code> subcommand:</p>
<pre><code>$ ketrew print-configuration
[ketrew]
    Mode: Client
    Connection: &quot;http://127.0.0.1:8756&quot;
    Auth-token: &quot;755nRor8Q5z5nx7W22C6C078HF3YoY5PS29sEgNXxP4=&quot;
    UI:
        Colors: with colors
        Get-key: uses `cbreak`
        Explorer:
            Default request: Targets younger than 1.5 days
            Targets-per-page: 6
            Targets-to-prefectch: 6
    Misc:
        Debug-level: 0
        Plugins: None</code></pre><p>For the server (using <code>pc</code>, a command alias for <code>print-configuration</code>):</p>
<pre><code>$ ketrew pc server
[ketrew]
Mode: Server
Engine:
    Database: &quot;/Users/leonidrozenberg/.ketrew/database&quot;
    Unix-failure: does not turn into target failure
    Host-timeout-upper-bound:
    Maximum-successive-attempts: 10
    Concurrent-automaton-steps: 4
UI:
    Colors: with colors
    Get-key: uses `cbreak`
    Explorer:
        Default request: Targets younger than 1.5 days
        Targets-per-page: 6
        Targets-to-prefectch: 6
HTTP-server:
    Authorized tokens:
        Inline (Name: 755nRor8Q5z5nx7W22C6C078HF3YoY5PS29sEgNXxP4=,
        Value: &quot;755nRor8Q5z5nx7W22C6C078HF3YoY5PS29sEgNXxP4=&quot;)
        Path: &quot;/Users/leonidrozenberg/.ketrew/authorized_tokens&quot;
    Daemonize: false
    Command Pipe: Some &quot;/Users/leonidrozenberg/.ketrew/command.pipe&quot;
    Log-path: Some &quot;/Users/leonidrozenberg/.ketrew/server-log&quot;
    Return-error-messages: true
    Max-blocking-time: 300.
    Block-step-time: 3.
    Listen: HTTP: 8756
Misc:
    Debug-level: 0
    Plugins: None</code></pre><p>Furthermore, <code>daemon</code> is a shortcut for starting the <code>server</code> in
<a href='https://en.wikipedia.org/wiki/Daemon_%28computing%29'>daemon</a> mode. You may
now start a server:</p>
<pre><code>$ ketrew start-server --configuration-profile daemon</code></pre><p>Let&#39;s open the GUI:</p>
<pre><code>$ ketrew gui</code></pre><p>Which should open your browser.</p>
<div>
<img  width="100%"
src="https://cloud.githubusercontent.com/assets/617111/11070327/07e7f63e-87a9-11e5-9a55-1e5f1baedb29.png"
>
</div>

<p>Back at the command line you can always check the server&#39;s status (using the
shorter command line argument <code>-P</code>, instead of <code>--configuration-profile</code>):</p>
<pre><code>$ ketrew status -P daemon
[ketrew] The server appears to be doing well.</code></pre><p>The <code>ketrew submit</code> sub-command can create tiny workflows:</p>
<pre><code>ketrew submit --wet-run --tag 1st-workflow --tag command-line --daemonize /tmp/KT,&quot;du -sh $HOME&quot;</code></pre><p>The job will appear on the WebUI and you can inspect/restart/kill it.</p>
<div>
<img width="100%"
  src="https://cloud.githubusercontent.com/assets/617111/9421006/17bceb36-483a-11e5-8845-bb2234697a14.gif">
</div>

<p>If you don&#39;t like Web UI&#39;s you can use the text-based UI:</p>
<pre><code>$ ketrew interact
[ketrew]
    Main menu
    Press a single key:
    * [q]: Quit
    * [v]: Toggle verbose
    * [s]: Display current status
    * [l]: Loop displaying the status
    * [k]: Kill targets
    * [e]: The Target Explorer™</code></pre><p>Finally to stop the server:</p>
<pre><code>$ ketrew stop -P daemon
[ketrew] Server killed.</code></pre><p>As you can see, just from the command line, you can use <code>ketrew submit</code> to
launch tasks. But to go further we need to use an EDSL.</p>
<h2 id="TheEDSLDefiningWorkflows">The EDSL: Defining Workflows</h2>

<h3 id="Overview">Overview</h3>

<p>The EDSL is an OCaml library where functions are used to build a workflow
data-structure. <a href='api/Ketrew.Client.html#VALsubmit_workflow' title='Ketrew.Client.submit_workflow'><code>Ketrew.Client.submit_workflow</code></a> is used to submit that
datastructure to the engine.</p>
<p>A workflow is a graph of “workflow-nodes” (sometimes called “targets”).</p>
<p>There are three kinds of links (edges) between nodes:</p>
<ul><li><code>depends_on</code>: nodes that need to be ensured or satisfied before a node
 can start,</li><li><code>on_failure_activate</code>: nodes that will be activated if the node fails, and</li><li><code>on_success_activate</code>: nodes that will be activated only <em>after</em> a node
 succeeds.</li></ul>

<p>See the <a href='api/Ketrew.EDSL.html#VALworkflow_node' title='Ketrew.EDSL.workflow_node'><code>Ketrew.EDSL.workflow_node</code></a> function documentation for details. Any
OCaml program can use the EDSL (script, compiled, or even inside the
toplevel). See the documentation of the EDSL API (<a href='api/Ketrew.EDSL.html' title='Ketrew.EDSL'><code>Ketrew.EDSL</code></a>).</p>
<h3 id="Example">Example</h3>

<p>The following script extends the previous shell-based example with the
capability to send emails upon the success or failure of your command.</p>
<pre><span class="directive">#use</span><span class="text"> </span><span class="string">"topfind"</span><span class="directive">
#thread</span><span class="directive">
#require</span><span class="text"> </span><span class="string">"ketrew"</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">run_command_with_daemonize</span><span class="text"> </span><span class="kw4">~cmd</span><span class="text"> </span><span class="kw4">~email</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">KEDSL</span><span class="text"> = </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="comment">(* Where to run stuff *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">tmp_on_localhost</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="comment">(* A “program” is a datastructure representing an “extended shell script”. *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">program</span><span class="text"> = </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="kw2">Program</span><span class="text">.</span><span class="id">sh</span><span class="text"> </span><span class="id">cmd</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="comment">(* A “build process” is a method for making things.

     In this case, `daemonize` creates a datastructure that represents a job
     running our program on the host. *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">build_process</span><span class="text"> = </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">program</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="comment">(* On Mac OSX
  let build_process = KEDSL.daemonize ~using:`Python_daemon ~host program in
  *)</span><span class="text">

  </span><span class="comment">(* A node that Ketrew will activate after cmd completes *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">email_target</span><span class="text"> </span><span class="kw4">~success</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sstring</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">success</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="string">"succeeded"</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="string">"failed"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">e_program</span><span class="text"> =
      </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="kw2">Program</span><span class="text">.</span><span class="id">shf</span><span class="text"> </span><span class="string">"echo \"'%s' %s\" | mail -s \"Status update\" %s"</span><span class="text">
        </span><span class="id">cmd</span><span class="text"> </span><span class="id">sstring</span><span class="text">
        </span><span class="id">email</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">e_process</span><span class="text"> =
      </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">e_program</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">workflow_node</span><span class="text"> </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">without_product</span><span class="text">
      </span><span class="kw4">~name</span><span class="text">:(</span><span class="string">"email result "</span><span class="text"> ^ </span><span class="id">sstring</span><span class="text">)
      </span><span class="kw4">~make</span><span class="text">:</span><span class="id">e_process</span><span class="text">
  </span><span class="kw">in</span><span class="text">

  </span><span class="comment">(* The function `KEDSL.workflow_node` creates a node in the workflow graph.
     The value `KEDSL.without_product` means this node does not
     “produce” anything, it is like a `.PHONY` target in `make`. *)</span><span class="text">
  </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">workflow_node</span><span class="text"> </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">without_product</span><span class="text">
    </span><span class="kw4">~name</span><span class="text">:</span><span class="string">"daemonize command"</span><span class="text">
    </span><span class="kw4">~make</span><span class="text">:</span><span class="id">build_process</span><span class="text">
    </span><span class="kw4">~edges</span><span class="text">:[
      </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">on_success_activate</span><span class="text"> (</span><span class="id">email_target</span><span class="text"> </span><span class="constant">true</span><span class="text">);
      </span><span class="kw2">KEDSL</span><span class="text">.</span><span class="id">on_failure_activate</span><span class="text"> (</span><span class="id">email_target</span><span class="text"> </span><span class="constant">false</span><span class="text">);
    ]

</span><span class="kw">let</span><span class="text"> () =
  </span><span class="comment">(* Grab the command line arguments. *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">cmd</span><span class="text">   = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">1</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">email</span><span class="text"> = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">2</span><span class="text">) </span><span class="kw">in</span><span class="text">

  </span><span class="comment">(* Create the  workflow with the first argument of the command line: *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">workflow</span><span class="text"> = </span><span class="id">run_command_with_daemonize</span><span class="text"> </span><span class="kw4">~cmd</span><span class="text"> </span><span class="kw4">~email</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="comment">(* Then, `Client.submit_workflow` is the only function that “does”
     something, it submits the workflow to the engine: *)</span><span class="text">
  </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Client</span><span class="text">.</span><span class="id">submit_workflow</span><span class="text"> </span><span class="id">workflow</span></pre>

<p>You can run this <a href='daemonize_workflow.html'>script</a> from the
shell with</p>
<pre><code>ocaml daemonize_workflow.ml &#39;du -sh $HOME&#39; myaddress@email.com
</code></pre><p>Checking in with the gui, we&#39;ll have a couple of new targets:</p>
<div>
<img width="100%"
src="https://cloud.githubusercontent.com/assets/617111/11070354/32521fb2-87a9-11e5-993e-550db476cbd7.png"
</div>

<p>To learn more about the EDSL, you can also explore <a href='Workflow_Examples.html'>examples of more and more
complicated workflows</a> (<em>work-in-progress</em>).</p>
<h2 id="Troubleshooting">Troubleshooting</h2>

<ul><li><p>Trying to use use Sqlite3 on MacOSX, and <code>opam</code> fail? These
 <a href='https://github.com/smondet/trakeva#sqlite3-on-macosx'>instructions</a>
 should be helpful.</p>
</li><li><p><code>opam</code> and <code>ssl</code> errors when install <code>ketrew</code>? Please see this
 <a href='https://github.com/hammerlab/ketrew/issues/214'>issue</a>.</p>
</li><li><p>When reconfiguring <code>Ketrew</code> between versions it may be helpful to delete old
 configurations:</p>
<pre><code>$ rm -fr $HOME/.ketrew/</code></pre></li><li><p>During configuration it is recommended that you pass an authentication token,
 as opposed to having Ketrew generate one for you:</p>
<pre><code>$ ketrew init --with-token my-secret-token</code></pre></li><li><p>If you are trying the example workflow on a system that does not have Python
 installed you can use another deamonization method (we use <code>`Python_daemon</code>
 by default above because
 <a href='http://man7.org/linux/man-pages/man1/setsid.1.html'>setsid</a> is missing on
 MacOSX):</p>
<pre><code>let build_process = KEDSL.daemonize ~using:`Nohup_setsid ~host program in</code></pre></li></ul>

<h2 id="WheretoGoNext">Where to Go Next</h2>

<p>From here:</p>
<ul><li>To write workflows for Ketrew,
see <a href='Workflow_Examples.html'><code>src/test/Workflow_Examples.ml</code></a> for
examples and the <a href='api/Ketrew_edsl.html'>documentation of the EDSL API</a>.</li><li>To configure Ketrew use the configuration file
<a href='./The_Configuration_File.html'>documentation</a>.</li><li>If you don&#39;t want a server running and listening on HTTP(S), Ketrew can run a
 <em>degraded</em> mode called <a href='./Standalone_Mode.html'>“standalone.”</a></li><li>You may want to “extend” Ketrew with new ways of running “long-running&quot;
computations:  see the documentation on
<a href='./Long-Running_Plugins.html'>plugins</a>,
and the examples in the library:
like <a href='api/Lsf.html'><a href='api/Ketrew.Lsf.html' title='Ketrew.Lsf'><code>Ketrew.Lsf</code></a></a> or in the tests:
<a href='dummy_plugin.html'><code>src/test/dummy_plugin.ml</code></a>.</li><li>You may want to extend Ketrew, or preconfigure it, <em>without</em> configuration
files or dynamically loaded libraries: just
<a href='./Alternative_CLI_Application.html'>create</a> your own comand-line app.</li><li>If you are using Ketrew in server mode, you may want to know about the
<a href='./Server_Commands.html'>commands</a> that the server can understand as it
listens on a Unix-pipe.</li><li>You may want to call out directly to the <a href='./The_HTTP_API.html'>HTTP API</a>
(i.e. without <code>ketrew</code> as a client).</li><li>If you want to help or simply to understand Ketrew
see the <a href='./Developer_Documentation.html'>development</a>
documentation, and have a look at the modules
like <a href='api/Engine.html'><a href='api/Ketrew.Engine.html' title='Ketrew.Engine'><code>Ketrew.Engine</code></a></a>.</li></ul>

<h2 id="License">License</h2>

<p>It&#39;s <a href='http://www.apache.org/licenses/LICENSE-2.0'>Apache 2.0</a>.</p>
<h2 id="Badges">Badges</h2>

<p><a href='https://travis-ci.org/hammerlab/ketrew'><img src='https://travis-ci.org/hammerlab/ketrew.svg?branch=master' alt='master Branch Build Status' /></a>
<a href='http://dx.doi.org/10.5281/zenodo.45295'><img src='https://zenodo.org/badge/doi/10.5281/zenodo.45295.svg' alt='DOI' /></a></p>
</div></div></div></body><html>