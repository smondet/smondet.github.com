<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Client" rel="Chapter" href="Client.html">
<link title="Command_line" rel="Chapter" href="Command_line.html">
<link title="Configuration" rel="Chapter" href="Configuration.html">
<link title="Daemonize" rel="Chapter" href="Daemonize.html">
<link title="Document" rel="Chapter" href="Document.html">
<link title="EDSL" rel="Chapter" href="EDSL.html">
<link title="Engine" rel="Chapter" href="Engine.html">
<link title="Error" rel="Chapter" href="Error.html">
<link title="Eval_condition" rel="Chapter" href="Eval_condition.html">
<link title="Explorer" rel="Chapter" href="Explorer.html">
<link title="Host" rel="Chapter" href="Host.html">
<link title="Host_io" rel="Chapter" href="Host_io.html">
<link title="Interaction" rel="Chapter" href="Interaction.html">
<link title="Internal_pervasives" rel="Chapter" href="Internal_pervasives.html">
<link title="Long_running" rel="Chapter" href="Long_running.html">
<link title="Long_running_utilities" rel="Chapter" href="Long_running_utilities.html">
<link title="Lsf" rel="Chapter" href="Lsf.html">
<link title="Monitored_script" rel="Chapter" href="Monitored_script.html">
<link title="Path" rel="Chapter" href="Path.html">
<link title="Pbs" rel="Chapter" href="Pbs.html">
<link title="Persistent_data" rel="Chapter" href="Persistent_data.html">
<link title="Plugin" rel="Chapter" href="Plugin.html">
<link title="Program" rel="Chapter" href="Program.html">
<link title="Protocol" rel="Chapter" href="Protocol.html">
<link title="Server" rel="Chapter" href="Server.html">
<link title="Target" rel="Chapter" href="Target.html">
<link title="Unix_io" rel="Chapter" href="Unix_io.html">
<link title="Unix_process" rel="Chapter" href="Unix_process.html">
<link title="Yarn" rel="Chapter" href="Yarn.html"><title>Ketrew API : EDSL</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;2015:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Leonid&nbsp;Rozenberg&nbsp;&lt;leonidr@gmail.com&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Arun&nbsp;Ahuja&nbsp;&lt;aahuja11@gmail.com&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Jeff&nbsp;Hammerbacher&nbsp;&lt;jeff.hammerbacher@gmail.com&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_pure</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Internal_pervasives</span><br>
<br>
&nbsp;<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Host</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Host</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ssh<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?add_ssh_options<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?playground<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?port&nbsp;?user&nbsp;?name&nbsp;str&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;playground&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.map&nbsp;~f:<span class="constructor">Path</span>.absolute_directory_exn&nbsp;playground&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;ssh&nbsp;?default_shell:<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?execution_timeout:<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?add_ssh_options<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?playground<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?port&nbsp;?user&nbsp;?name&nbsp;str<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;parse&nbsp;=&nbsp;of_string<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cmdliner_term&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(doc=<span class="string">"URI&nbsp;of&nbsp;the&nbsp;host&nbsp;(e.g.&nbsp;ssh://user@example.com:42/tmp/ketrewplayground)."</span>)&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Cmdliner</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Term</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pure&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;parse&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Flag</span>&nbsp;(flags)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Arg</span>.(value&nbsp;<span class="keywordsign">&amp;</span>&nbsp;opt&nbsp;string&nbsp;<span class="string">"/tmp/"</span>&nbsp;<span class="keywordsign">&amp;</span>&nbsp;info&nbsp;flags&nbsp;~doc&nbsp;~docv:<span class="string">"URI"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Required</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Arg</span>.(required&nbsp;<span class="keywordsign">&amp;</span>&nbsp;pos&nbsp;p&nbsp;(some&nbsp;string)&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">&amp;</span>&nbsp;info&nbsp;[]&nbsp;~doc&nbsp;~docv:<span class="string">"URI"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">class</span>&nbsp;<span class="keyword">type</span>&nbsp;user_artifact&nbsp;=&nbsp;<span class="keyword">object</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;:&nbsp;string<br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;exists:&nbsp;<span class="constructor">Target</span>.<span class="constructor">Condition</span>.t<br>
<br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_bigger_than:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Target</span>.<span class="constructor">Condition</span>.t<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;unit&nbsp;=&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;=&nbsp;failwith&nbsp;<span class="string">"Unit&nbsp;has&nbsp;no&nbsp;path"</span><br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;exists&nbsp;=&nbsp;failwith&nbsp;<span class="string">"Unit&nbsp;does&nbsp;not&nbsp;“exist”"</span><br>
&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_bigger_than&nbsp;_&nbsp;=&nbsp;failwith&nbsp;<span class="string">"Unit&nbsp;has&nbsp;no&nbsp;size"</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;file&nbsp;?(host=&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Host</span>.tmp_on_localhost)&nbsp;path&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;basename&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;vol&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Target</span>.<span class="constructor">Volume</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~root:(<span class="constructor">Path</span>.absolute_directory_exn&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(file&nbsp;basename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;=&nbsp;path<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;exists&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Volume_exists</span>&nbsp;vol<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_bigger_than&nbsp;n&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Volume_size_bigger_than</span>&nbsp;(vol,&nbsp;n)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">class</span>&nbsp;<span class="keyword">type</span>&nbsp;user_target&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;activate&nbsp;:&nbsp;unit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;:&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_active:&nbsp;bool<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;id:&nbsp;<span class="constructor">Unique_id</span>.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;render:&nbsp;<span class="constructor">Target</span>.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;depends_on:&nbsp;user_target&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_failure_activate:&nbsp;user_target&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_success_activate:&nbsp;user_target&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;metadata:&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]&nbsp;option<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;product:&nbsp;user_artifact<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;add_tags:&nbsp;string&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;user_target_internal<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(active&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(depends_on&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(on_failure_activate&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(on_success_activate&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(name:&nbsp;string&nbsp;option)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(make:&nbsp;<span class="constructor">Target</span>.<span class="constructor">Build_process</span>.t&nbsp;=&nbsp;<span class="constructor">Target</span>.<span class="constructor">Build_process</span>.nop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?done_when<br>
&nbsp;&nbsp;&nbsp;&nbsp;?metadata<br>
&nbsp;&nbsp;&nbsp;&nbsp;?product<br>
&nbsp;&nbsp;&nbsp;&nbsp;?equivalence<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(tags&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=&nbsp;<span class="constructor">Unique_id</span>.create&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span>&nbsp;(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;active&nbsp;=&nbsp;active<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;additional_tags&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;id&nbsp;=&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;depends_on&nbsp;=&nbsp;depends_on<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_failure_activate&nbsp;=&nbsp;on_failure_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_success_activate&nbsp;=&nbsp;on_success_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;activate&nbsp;=&nbsp;active&nbsp;&lt;-&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_active&nbsp;=&nbsp;active<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;metadata&nbsp;=&nbsp;metadata<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;add_tags&nbsp;tags&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;additional_tags&nbsp;&lt;-&nbsp;additional_tags&nbsp;@&nbsp;tags&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.dedup<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;render&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Target</span>.create&nbsp;?metadata<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~id:self<span class="keywordsign">#</span>id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~depends_on:(<span class="constructor">List</span>.map&nbsp;depends_on&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">#</span>id))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~on_failure_activate:(<span class="constructor">List</span>.map&nbsp;on_failure_activate&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">#</span>id))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~on_success_activate:(<span class="constructor">List</span>.map&nbsp;on_success_activate&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">#</span>id))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:self<span class="keywordsign">#</span>name&nbsp;?condition:done_when<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?equivalence&nbsp;~tags:(tags&nbsp;@&nbsp;additional_tags)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;active&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Target</span>.activate_exn&nbsp;~reason:<span class="keywordsign">`</span><span class="constructor">User</span>&nbsp;x&nbsp;<span class="keyword">else</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;product&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;product&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~msg:(fmt&nbsp;<span class="string">"Target&nbsp;%s&nbsp;has&nbsp;no&nbsp;known&nbsp;product"</span>&nbsp;self<span class="keywordsign">#</span>name)<br>
<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;target&nbsp;?active&nbsp;?depends_on&nbsp;?make&nbsp;?done_when&nbsp;?metadata&nbsp;?product<br>
&nbsp;&nbsp;&nbsp;&nbsp;?equivalence&nbsp;?on_failure_activate&nbsp;?on_success_activate&nbsp;?tags&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;user_target_internal<br>
&nbsp;&nbsp;&nbsp;&nbsp;?equivalence&nbsp;?on_failure_activate&nbsp;?tags&nbsp;?on_success_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;?active&nbsp;?depends_on&nbsp;~name&nbsp;?make&nbsp;?metadata&nbsp;?done_when&nbsp;?product&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;file_target&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;?depends_on&nbsp;?make&nbsp;?metadata&nbsp;?name&nbsp;?host&nbsp;?equivalence&nbsp;?on_failure_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;?on_success_activate&nbsp;?tags&nbsp;path&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=&nbsp;file&nbsp;?host&nbsp;path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;name&nbsp;~default:(<span class="string">"Make:"</span>&nbsp;^&nbsp;path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;target&nbsp;~product&nbsp;?equivalence&nbsp;?on_failure_activate&nbsp;?tags&nbsp;?on_success_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;~done_when:product<span class="keywordsign">#</span>exists&nbsp;?depends_on&nbsp;?make&nbsp;?metadata&nbsp;name<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Program</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Program</span>.t<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(<span class="keywordsign">&amp;&amp;</span>)&nbsp;a&nbsp;b&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;[a;&nbsp;b]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sh&nbsp;c&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Shell_command</span>&nbsp;c<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;shf&nbsp;fmt&nbsp;=&nbsp;<span class="constructor">Printf</span>.ksprintf&nbsp;sh&nbsp;fmt<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;exec&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Exec</span>&nbsp;l<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;chain&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;l<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Condition</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Target</span>.<span class="constructor">Condition</span>.t<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(<span class="keywordsign">&amp;&amp;</span>)&nbsp;a&nbsp;b&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;[a;&nbsp;b]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;chain_and&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;l<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;never&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Never</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;?(returns=0)&nbsp;?host&nbsp;p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Command_returns</span>&nbsp;(<span class="constructor">Target</span>.<span class="constructor">Command</span>.program&nbsp;?host&nbsp;p,&nbsp;returns)<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;daemonize&nbsp;&nbsp;=&nbsp;<span class="constructor">Daemonize</span>.create<br>
<br>
<span class="keyword">let</span>&nbsp;lsf&nbsp;=&nbsp;<span class="constructor">Lsf</span>.create<br>
<span class="keyword">let</span>&nbsp;pbs&nbsp;=&nbsp;<span class="constructor">Pbs</span>.create<br>
<br>
<span class="keyword">let</span>&nbsp;yarn_application&nbsp;?host&nbsp;?daemonize_using&nbsp;?daemon_start_timeout&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Yarn</span>.create<br>
&nbsp;&nbsp;&nbsp;&nbsp;?host&nbsp;?daemonize_using&nbsp;?daemon_start_timeout&nbsp;(<span class="keywordsign">`</span><span class="constructor">Yarn_application</span>&nbsp;program)<br>
<br>
<span class="keyword">let</span>&nbsp;yarn_distributed_shell<br>
&nbsp;&nbsp;&nbsp;&nbsp;?host&nbsp;?daemonize_using&nbsp;?daemon_start_timeout&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;?hadoop_bin&nbsp;?distributed_shell_shell_jar<br>
&nbsp;&nbsp;&nbsp;&nbsp;~container_memory&nbsp;~timeout&nbsp;~application_name&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Yarn</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?host&nbsp;?daemonize_using&nbsp;?daemon_start_timeout<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(distributed_shell_program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?hadoop_bin&nbsp;?distributed_shell_shell_jar<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~container_memory&nbsp;~timeout&nbsp;~application_name&nbsp;program))<br>
<br>
<span class="keyword">let</span>&nbsp;to_display_string&nbsp;?(ansi_colors=<span class="keyword">false</span>)&nbsp;?(indentation=2)&nbsp;ut&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;escape&nbsp;c&nbsp;=&nbsp;fmt&nbsp;<span class="string">"\027[%sm"</span>&nbsp;c&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;color&nbsp;c&nbsp;t&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;ansi_colors&nbsp;<span class="keyword">then</span>&nbsp;escape&nbsp;c&nbsp;^&nbsp;t&nbsp;^&nbsp;escape&nbsp;<span class="string">"0"</span>&nbsp;<span class="keyword">else</span>&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bold_red&nbsp;t&nbsp;=&nbsp;&nbsp;color&nbsp;<span class="string">"1;31"</span>&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bold_yellow&nbsp;t&nbsp;=&nbsp;&nbsp;color&nbsp;<span class="string">"1;33"</span>&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bold_green&nbsp;t&nbsp;=&nbsp;&nbsp;color&nbsp;<span class="string">"1;32"</span>&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;let&nbsp;greyish&nbsp;t&nbsp;=&nbsp;color&nbsp;"37"&nbsp;t&nbsp;in&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;dump_workflow&nbsp;?(kind=<span class="keywordsign">`</span><span class="constructor">Dep</span>)&nbsp;?(depth=0)&nbsp;ut&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sublist&nbsp;~kind&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;l&nbsp;~f:(dump_workflow&nbsp;~kind&nbsp;~depth:(depth&nbsp;+&nbsp;1)))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;line&nbsp;content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;kind&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Dep</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bold_green&nbsp;(fmt&nbsp;<span class="string">"*&nbsp;%s"</span>&nbsp;content)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">OFA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bold_red&nbsp;(fmt&nbsp;<span class="string">"×&nbsp;%s"</span>&nbsp;content)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">OSA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bold_yellow&nbsp;(fmt&nbsp;<span class="string">"→&nbsp;%s"</span>&nbsp;content)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;<span class="string">"%s%s\n%s%s%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.make&nbsp;(depth&nbsp;*&nbsp;indentation)&nbsp;<span class="string">'&nbsp;'</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(line&nbsp;ut<span class="keywordsign">#</span>name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sublist&nbsp;ut<span class="keywordsign">#</span>depends_on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~kind:<span class="keywordsign">`</span><span class="constructor">Dep</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sublist&nbsp;ut<span class="keywordsign">#</span>on_failure_activate&nbsp;~kind:<span class="keywordsign">`</span><span class="constructor">OFA</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sublist&nbsp;ut<span class="keywordsign">#</span>on_success_activate&nbsp;~kind:<span class="keywordsign">`</span><span class="constructor">OSA</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;dump_workflow&nbsp;ut<br>
<br>
</code></body></html>