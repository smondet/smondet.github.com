<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Client" rel="Chapter" href="Client.html">
<link title="Command_line" rel="Chapter" href="Command_line.html">
<link title="Configuration" rel="Chapter" href="Configuration.html">
<link title="Daemonize" rel="Chapter" href="Daemonize.html">
<link title="Document" rel="Chapter" href="Document.html">
<link title="EDSL" rel="Chapter" href="EDSL.html">
<link title="Engine" rel="Chapter" href="Engine.html">
<link title="Error" rel="Chapter" href="Error.html">
<link title="Eval_condition" rel="Chapter" href="Eval_condition.html">
<link title="Explorer" rel="Chapter" href="Explorer.html">
<link title="Host" rel="Chapter" href="Host.html">
<link title="Host_io" rel="Chapter" href="Host_io.html">
<link title="Interaction" rel="Chapter" href="Interaction.html">
<link title="Internal_pervasives" rel="Chapter" href="Internal_pervasives.html">
<link title="Long_running" rel="Chapter" href="Long_running.html">
<link title="Long_running_utilities" rel="Chapter" href="Long_running_utilities.html">
<link title="Lsf" rel="Chapter" href="Lsf.html">
<link title="Monitored_script" rel="Chapter" href="Monitored_script.html">
<link title="Path" rel="Chapter" href="Path.html">
<link title="Pbs" rel="Chapter" href="Pbs.html">
<link title="Persistent_data" rel="Chapter" href="Persistent_data.html">
<link title="Plugin" rel="Chapter" href="Plugin.html">
<link title="Program" rel="Chapter" href="Program.html">
<link title="Protocol" rel="Chapter" href="Protocol.html">
<link title="Server" rel="Chapter" href="Server.html">
<link title="Target" rel="Chapter" href="Target.html">
<link title="Unix_io" rel="Chapter" href="Unix_io.html">
<link title="Unix_process" rel="Chapter" href="Unix_process.html">
<link title="Yarn" rel="Chapter" href="Yarn.html"><title>Ketrew API : Explorer</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;2015:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Leonid&nbsp;Rozenberg&nbsp;&lt;leonidr@gmail.com&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Arun&nbsp;Ahuja&nbsp;&lt;aahuja11@gmail.com&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Jeff&nbsp;Hammerbacher&nbsp;&lt;jeff.hammerbacher@gmail.com&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_pure</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Internal_pervasives</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Unix_io</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Target_cache</span>&nbsp;&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(**
     For now we implement the cache with a <code class="code"><span class="constructor">Hashtbl</span>.t</code> but in the
     future this maybe using a proper DB or cache. Hence the I/O types
     (<code class="code"><span class="constructor">Deferred_result</span>.t</code>) given to the functions. *)</span></td></tr></table><code class="code"><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;targets:&nbsp;(<span class="constructor">Target</span>.id,&nbsp;<span class="constructor">Target</span>.t)&nbsp;<span class="constructor">Hashtbl</span>.t;<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create&nbsp;()&nbsp;=&nbsp;{targets&nbsp;=&nbsp;<span class="constructor">Hashtbl</span>.create&nbsp;42}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get&nbsp;{targets}&nbsp;~id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;return&nbsp;(<span class="constructor">Some</span>&nbsp;(<span class="constructor">Hashtbl</span>.find&nbsp;targets&nbsp;id))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Target-cache:&nbsp;miss&nbsp;on&nbsp;"</span>&nbsp;%&nbsp;s&nbsp;id&nbsp;@&nbsp;verbose);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add&nbsp;{targets}&nbsp;~id&nbsp;~value&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.replace&nbsp;targets&nbsp;id&nbsp;value;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;()<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;clear&nbsp;{targets}&nbsp;=&nbsp;<span class="constructor">Hashtbl</span>.clear&nbsp;targets<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;exploration_state&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;build_process_details:&nbsp;bool;<br>
&nbsp;&nbsp;target_filter:&nbsp;(<span class="constructor">Target</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bool)&nbsp;*&nbsp;<span class="constructor">Log</span>.t;<br>
&nbsp;&nbsp;condition_details:&nbsp;bool;<br>
&nbsp;&nbsp;metadata_details:&nbsp;bool;<br>
&nbsp;&nbsp;currently_seeing:&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Target</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">Target</span>.id<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Target_menu</span>&nbsp;<span class="keyword">of</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;<span class="keyword">of</span>&nbsp;int]<br>
&nbsp;&nbsp;];<br>
}<br>
<br>
<span class="keyword">let</span>&nbsp;create_state&nbsp;()&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;build_process_details&nbsp;=&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;condition_details&nbsp;=&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;metadata_details&nbsp;=&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;target_filter&nbsp;=&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>),&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"No-filter,&nbsp;see&nbsp;them&nbsp;all"</span>);<br>
&nbsp;&nbsp;currently_seeing&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Target_menu</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;0);<br>
}<br>
<br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;ketrew_client:&nbsp;<span class="constructor">Client</span>.t;<br>
&nbsp;&nbsp;<span class="keyword">mutable</span>&nbsp;target_ids:&nbsp;string&nbsp;list;<br>
&nbsp;&nbsp;target_cache:&nbsp;<span class="constructor">Target_cache</span>.t;<br>
&nbsp;&nbsp;<span class="keyword">mutable</span>&nbsp;state_stack:&nbsp;exploration_state&nbsp;list;<br>
&nbsp;&nbsp;<span class="keyword">mutable</span>&nbsp;request_targets_ids:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;<span class="keyword">of</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;<span class="keyword">of</span>&nbsp;float&nbsp;]];<br>
&nbsp;&nbsp;<span class="keyword">mutable</span>&nbsp;targets_per_page:&nbsp;int;<br>
&nbsp;&nbsp;<span class="keyword">mutable</span>&nbsp;targets_to_prefetch:&nbsp;int;<br>
}<br>
<span class="keyword">let</span>&nbsp;create&nbsp;~client&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;conf&nbsp;=&nbsp;<span class="constructor">Client</span>.configuration&nbsp;client&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;{<br>
&nbsp;&nbsp;ketrew_client&nbsp;=&nbsp;client;<br>
&nbsp;&nbsp;target_ids&nbsp;=&nbsp;[];<br>
&nbsp;&nbsp;target_cache&nbsp;=&nbsp;<span class="constructor">Target_cache</span>.create&nbsp;();<br>
&nbsp;&nbsp;state_stack&nbsp;=&nbsp;[];<br>
&nbsp;&nbsp;request_targets_ids&nbsp;=&nbsp;<span class="constructor">Configuration</span>.request_targets_ids&nbsp;conf;<br>
&nbsp;&nbsp;targets_per_page&nbsp;=&nbsp;<span class="constructor">Configuration</span>.targets_per_page&nbsp;conf;<br>
&nbsp;&nbsp;targets_to_prefetch&nbsp;=&nbsp;<span class="constructor">Configuration</span>.targets_to_prefetch&nbsp;conf;<br>
}<br>
<br>
<span class="keyword">let</span>&nbsp;reload_list_of_ids&nbsp;explorer&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;query&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;time_constraint&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;explorer.request_targets_ids&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;days)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;now_in_seconds&nbsp;=&nbsp;<span class="constructor">Time</span>.now&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;limit_in_seconds&nbsp;=&nbsp;60.&nbsp;*.&nbsp;60.&nbsp;*.&nbsp;24.&nbsp;*.&nbsp;days&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Created_after</span>&nbsp;(now_in_seconds&nbsp;-.&nbsp;limit_in_seconds)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Protocol</span>.<span class="constructor">Up_message</span>.&nbsp;time_constraint;&nbsp;filter&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">True</span>}<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Client</span>.get_list_of_target_ids&nbsp;explorer.ketrew_client&nbsp;query&nbsp;<br>
&nbsp;&nbsp;&gt;&gt;|&nbsp;<span class="constructor">List</span>.sort&nbsp;&nbsp;~cmp:(<span class="keyword">fun</span>&nbsp;a&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">String</span>.compare&nbsp;b&nbsp;a)&nbsp;<span class="comment">(*&nbsp;reverse&nbsp;order&nbsp;*)</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;id_list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Explorer.reload&nbsp;got&nbsp;"</span>&nbsp;%&nbsp;i&nbsp;(<span class="constructor">List</span>.length&nbsp;id_list)&nbsp;%&nbsp;s&nbsp;<span class="string">"&nbsp;ids"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;verbose);<br>
&nbsp;&nbsp;explorer.target_ids&nbsp;&lt;-&nbsp;id_list;<br>
&nbsp;&nbsp;<span class="constructor">Target_cache</span>.clear&nbsp;explorer.target_cache;<br>
&nbsp;&nbsp;return&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;get_target&nbsp;?(force_reload=<span class="keyword">false</span>)&nbsp;?prefetching&nbsp;explorer&nbsp;~id&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;force_reload&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Target_cache</span>.get&nbsp;explorer.target_cache&nbsp;~id<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;e<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;prefetching&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Explorer&nbsp;getting&nbsp;target&nbsp;"</span>&nbsp;%&nbsp;s&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;(<span class="keyword">if</span>&nbsp;force_reload&nbsp;<span class="keyword">then</span>&nbsp;s&nbsp;<span class="string">"&nbsp;(forced)"</span>&nbsp;<span class="keyword">else</span>&nbsp;s&nbsp;<span class="string">"&nbsp;(cache&nbsp;miss)"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;verbose);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Client</span>.get_target&nbsp;explorer.ketrew_client&nbsp;~id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;value&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Target_cache</span>.add&nbsp;explorer.target_cache&nbsp;~id&nbsp;~value<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;value<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Take_from</span>&nbsp;(nb,&nbsp;ids))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;find_cache_misses&nbsp;cache_misses&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(zero,&nbsp;_)&nbsp;<span class="keyword">when</span>&nbsp;zero&nbsp;&lt;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;cache_misses<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(_,&nbsp;[])&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;cache_misses<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(more,&nbsp;next&nbsp;::&nbsp;ids)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Target_cache</span>.get&nbsp;explorer.target_cache&nbsp;~id:next<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;opt&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;find_cache_misses&nbsp;(next&nbsp;::&nbsp;cache_misses)&nbsp;(more&nbsp;-&nbsp;1,&nbsp;ids)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;find_cache_misses&nbsp;cache_misses&nbsp;(more,&nbsp;ids)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;find_cache_misses&nbsp;[]&nbsp;(nb,&nbsp;id&nbsp;::&nbsp;ids)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;id_list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Explorer&nbsp;getting&nbsp;targets&nbsp;"</span>&nbsp;%&nbsp;<span class="constructor">OCaml</span>.list&nbsp;s&nbsp;id_list&nbsp;@&nbsp;verbose);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Client</span>.get_targets&nbsp;explorer.ketrew_client&nbsp;~id_list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;targets&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Deferred_list</span>.while_sequential&nbsp;targets&nbsp;~f:(<span class="keyword">fun</span>&nbsp;value&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=&nbsp;<span class="constructor">Target</span>.id&nbsp;value&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Target_cache</span>.add&nbsp;explorer.target_cache&nbsp;~id&nbsp;~value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(_&nbsp;:&nbsp;unit&nbsp;list)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_target&nbsp;~force_reload:<span class="keyword">false</span>&nbsp;?prefetching:<span class="constructor">None</span>&nbsp;explorer&nbsp;~id<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;Items&nbsp;that&nbsp;would&nbsp;be&nbsp;in&nbsp;every&nbsp;menu<br>
*)</span><br>
<span class="keyword">let</span>&nbsp;common_menu_items&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'Q'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Quit&nbsp;explorer"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'q'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Cancel/Go-back"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'R'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Reload"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Reload</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'S'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Settings"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Settings</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;])<br>
<br>
<span class="keyword">let</span>&nbsp;filter&nbsp;~log&nbsp;~char&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;(char,&nbsp;log,&nbsp;<span class="keywordsign">`</span><span class="constructor">Set</span>&nbsp;(f,&nbsp;log))<br>
<br>
<span class="keyword">let</span>&nbsp;simple_filter&nbsp;~log&nbsp;~char&nbsp;simple&nbsp;=<br>
&nbsp;&nbsp;filter&nbsp;~log&nbsp;~char&nbsp;(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Target</span>.state&nbsp;t&nbsp;|&gt;&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.simplify&nbsp;=&nbsp;simple)<br>
<br>
<span class="keyword">let</span>&nbsp;finished&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;simple&nbsp;=&nbsp;<span class="constructor">Target</span>.state&nbsp;t&nbsp;|&gt;&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.simplify&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;simple&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Failed</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Successful</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">In_progress</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Activable</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span><br>
<br>
<span class="keyword">let</span>&nbsp;failed_but_not_because_of_dependencies&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;state&nbsp;=&nbsp;<span class="constructor">Target</span>.state&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.simplify&nbsp;state&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Failed</span><br>
&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;not&nbsp;(<span class="constructor">Target</span>.<span class="constructor">State</span>.<span class="constructor">Is</span>.finished_because_dependencies_died&nbsp;state)<br>
<br>
<span class="keyword">let</span>&nbsp;really_running&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;state&nbsp;=&nbsp;<span class="constructor">Target</span>.state&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Is</span>.started_running&nbsp;state&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Is</span>.still_running&nbsp;state<br>
&nbsp;&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Is</span>.ran_successfully&nbsp;state<br>
<br>
<span class="keyword">let</span>&nbsp;waiting_on_dependencies&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;state&nbsp;=&nbsp;<span class="constructor">Target</span>.state&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Is</span>.building&nbsp;state&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Is</span>.still_building&nbsp;state<br>
<br>
<span class="keyword">let</span>&nbsp;filters&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;filter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>)&nbsp;~char:<span class="string">'n'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"No-filter,&nbsp;see&nbsp;them&nbsp;all"</span>);<br>
&nbsp;&nbsp;simple_filter&nbsp;<span class="keywordsign">`</span><span class="constructor">Activable</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~char:<span class="string">'p'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Passive/Activable"</span>);<br>
&nbsp;&nbsp;simple_filter&nbsp;<span class="keywordsign">`</span><span class="constructor">In_progress</span>&nbsp;&nbsp;&nbsp;&nbsp;~char:<span class="string">'r'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Running/In-progress"</span>);<br>
&nbsp;&nbsp;filter&nbsp;really_running&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~char:<span class="string">'R'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Really&nbsp;running,&nbsp;not&nbsp;waiting"</span>);<br>
&nbsp;&nbsp;filter&nbsp;waiting_on_dependencies&nbsp;~char:<span class="string">'d'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Waiting&nbsp;on&nbsp;dependencies"</span>);<br>
&nbsp;&nbsp;simple_filter&nbsp;<span class="keywordsign">`</span><span class="constructor">Successful</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~char:<span class="string">'s'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Successful"</span>);<br>
&nbsp;&nbsp;simple_filter&nbsp;<span class="keywordsign">`</span><span class="constructor">Failed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~char:<span class="string">'f'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Failed"</span>);<br>
&nbsp;&nbsp;filter&nbsp;finished&nbsp;~char:<span class="string">'n'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Finished&nbsp;(success&nbsp;or&nbsp;failure)"</span>);<br>
&nbsp;&nbsp;filter&nbsp;failed_but_not_because_of_dependencies<br>
&nbsp;&nbsp;&nbsp;&nbsp;~char:<span class="string">'D'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Failed&nbsp;but&nbsp;not&nbsp;because&nbsp;of&nbsp;its&nbsp;depedencies"</span>);<br>
]<br>
<br>
<span class="keyword">let</span>&nbsp;initial_ask_tags_content&nbsp;=<br>
&nbsp;&nbsp;<span class="string">"#&nbsp;Enter&nbsp;regular&nbsp;expressions&nbsp;on&nbsp;`tags`&nbsp;of&nbsp;the&nbsp;targets\n#&nbsp;Lines&nbsp;beginning&nbsp;with&nbsp;'#'&nbsp;are&nbsp;thrown&nbsp;aways\n#&nbsp;The&nbsp;syntax&nbsp;of&nbsp;the&nbsp;regular&nbsp;expressions&nbsp;is&nbsp;“POSIX”\n"</span><br>
<br>
<span class="keyword">let</span>&nbsp;get_filter&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;menu&nbsp;~sentence:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Pick&nbsp;a&nbsp;filter"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;filters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(char,&nbsp;log,&nbsp;tag)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char&nbsp;~log&nbsp;tag)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[menu_item&nbsp;~char:<span class="string">'T'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Enter&nbsp;tag&nbsp;regular-expression(s)"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Ask_tags</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ask_tags</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Interaction</span>.ask_for_edition&nbsp;initial_ask_tags_content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;content&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tag_regs&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'\n'</span>)&nbsp;content<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.filter_map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;line&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stripped&nbsp;=&nbsp;<span class="constructor">String</span>.strip&nbsp;line&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.get&nbsp;~index:0&nbsp;stripped&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">'#'</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(stripped,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Re_posix</span>.compile_pat&nbsp;stripped)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;trgt&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.for_all&nbsp;tag_regs&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(_,&nbsp;reg)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.exists&nbsp;<span class="constructor">Target</span>.(tags&nbsp;trgt)&nbsp;~f:(<span class="keyword">fun</span>&nbsp;tag&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Re</span>.execp&nbsp;reg&nbsp;tag))),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Tags&nbsp;matching&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;<span class="constructor">OCaml</span>.list&nbsp;(<span class="keyword">fun</span>&nbsp;(s,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;quote&nbsp;s)&nbsp;tag_regs))<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Set</span>&nbsp;f&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;f<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;settings_menu&nbsp;explorer&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;menu&nbsp;~sentence:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Pick&nbsp;an&nbsp;action"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~always_there:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'q'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Quit"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'d'</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Edit</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Edit&nbsp;settings&nbsp;with&nbsp;a&nbsp;DSL"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Edit</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Interaction</span>.ask_for_edition<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fmt<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#&nbsp;Edit/Uncomment&nbsp;the&nbsp;lines&nbsp;you're&nbsp;interested\n#&nbsp;(lines&nbsp;starting&nbsp;with&nbsp;'#'&nbsp;are&nbsp;ignored)\n\n#&nbsp;Set&nbsp;the&nbsp;“listing&nbsp;query”:\n#&nbsp;type&nbsp;(or&nbsp;uncomment):\n#&nbsp;&nbsp;&nbsp;listing-query&nbsp;=&nbsp;all\n#&nbsp;to&nbsp;see&nbsp;ALL&nbsp;targets&nbsp;since&nbsp;the&nbsp;beginning&nbsp;of&nbsp;time,&nbsp;or&nbsp;limit&nbsp;with:\n#&nbsp;&nbsp;&nbsp;listing-query&nbsp;=&nbsp;younger&nbsp;than&nbsp;&lt;some-float&gt;&nbsp;days\n#&nbsp;Current&nbsp;value:&nbsp;%s\n\n#&nbsp;Set&nbsp;the&nbsp;number&nbsp;of&nbsp;targets&nbsp;per&nbsp;page:\n#&nbsp;&nbsp;&nbsp;targets-per-page&nbsp;=&nbsp;%d\n\n#&nbsp;Set&nbsp;the&nbsp;number&nbsp;of&nbsp;targets&nbsp;that&nbsp;the&nbsp;client&nbsp;requests&nbsp;at&nbsp;once&nbsp;(for&nbsp;prefetching/speed)):\n#&nbsp;&nbsp;&nbsp;prefetch-targets&nbsp;=&nbsp;%d\n"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;explorer.request_targets_ids&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"all"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;days)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fmt&nbsp;<span class="string">"younger&nbsp;than&nbsp;%F&nbsp;days"</span>&nbsp;days)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;explorer.targets_per_page<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;explorer.targets_to_prefetch)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;|&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'\n'</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;lines&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;lines&nbsp;~f:(<span class="keyword">fun</span>&nbsp;line&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stripped&nbsp;=&nbsp;<span class="constructor">String</span>.strip&nbsp;line&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.get&nbsp;~index:0&nbsp;stripped&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">'#'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'&nbsp;'</span>)&nbsp;stripped<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:<span class="constructor">String</span>.strip<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.filter&nbsp;~f:((&lt;&gt;)&nbsp;<span class="string">""</span>)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"listing-query"</span>&nbsp;::&nbsp;<span class="string">"="</span>&nbsp;::&nbsp;listing_query&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;listing_query&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[<span class="string">"all"</span>]&nbsp;<span class="keywordsign">|</span>&nbsp;[<span class="string">"All"</span>]&nbsp;<span class="keywordsign">|</span>&nbsp;[<span class="string">"ALL"</span>]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;explorer.request_targets_ids&nbsp;&lt;-&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"younger"</span>&nbsp;::&nbsp;<span class="string">"than"</span>&nbsp;::&nbsp;v&nbsp;::&nbsp;<span class="string">"days"</span>&nbsp;::&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Float</span>.of_string&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Can't&nbsp;parse&nbsp;float:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;v&nbsp;@&nbsp;error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;days&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;explorer.request_targets_ids&nbsp;&lt;-&nbsp;(<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;days))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Can't&nbsp;parse&nbsp;listing&nbsp;query:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;line&nbsp;@&nbsp;error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"targets-per-page"</span>&nbsp;::&nbsp;<span class="string">"="</span>&nbsp;::&nbsp;v&nbsp;::&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Int</span>.of_string&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Can't&nbsp;parse&nbsp;int:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;v&nbsp;@&nbsp;error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;nb&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;explorer.targets_per_page&nbsp;&lt;-&nbsp;nb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"prefetch-targets"</span>&nbsp;::&nbsp;<span class="string">"="</span>&nbsp;::&nbsp;v&nbsp;::&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Int</span>.of_string&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Can't&nbsp;parse&nbsp;int:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;v&nbsp;@&nbsp;error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;nb&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;explorer.targets_to_prefetch&nbsp;&lt;-&nbsp;nb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Can't&nbsp;parse&nbsp;line:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;line&nbsp;@&nbsp;error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;reload_list_of_ids&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;settings_menu&nbsp;explorer<br>
<br>
<span class="keyword">let</span>&nbsp;pick_a_target_from_list&nbsp;explorer&nbsp;target_ids&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Deferred_list</span>.while_sequential&nbsp;target_ids&nbsp;(<span class="keyword">fun</span>&nbsp;id&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;get_target&nbsp;explorer&nbsp;~id)<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;targets&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;menu&nbsp;~sentence:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Pick&nbsp;a&nbsp;target"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~always_there:common_menu_items<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(make_target_menu&nbsp;~targets&nbsp;()))<br>
<br>
<span class="keyword">let</span>&nbsp;pick_a_target&nbsp;explorer&nbsp;(es&nbsp;:&nbsp;exploration_state)&nbsp;~how&nbsp;=<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Client.current_targets&nbsp;explorer.ketrew_client&nbsp;&gt;&gt;=&nbsp;fun&nbsp;targets&nbsp;-&gt;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;targets_to_display&nbsp;=&nbsp;explorer.targets_per_page&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;max_per_page&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;targets_to_display&nbsp;+&nbsp;<span class="constructor">List</span>.length&nbsp;common_menu_items<br>
&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;1&nbsp;<span class="comment">(*&nbsp;=&nbsp;filter&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;3&nbsp;<span class="comment">(*&nbsp;prev,&nbsp;next,&nbsp;and&nbsp;home&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;from&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;find_targets&nbsp;in_list&nbsp;acc&nbsp;found_count&nbsp;passed_count&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;in_list&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;(<span class="constructor">List</span>.rev&nbsp;acc,&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;&nbsp;<span class="keyword">when</span>&nbsp;found_count&nbsp;=&nbsp;targets_to_display&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(<span class="constructor">List</span>.rev&nbsp;acc,&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Pick</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;passed_count)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;one&nbsp;::&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prefetching&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Take_from</span>&nbsp;(explorer.targets_to_prefetch,&nbsp;more)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_target&nbsp;explorer&nbsp;~id:one&nbsp;~prefetching<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;target&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;(fst&nbsp;es.target_filter)&nbsp;target&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;find_targets&nbsp;more&nbsp;(target&nbsp;::&nbsp;acc)&nbsp;(found_count&nbsp;+&nbsp;1)&nbsp;(passed_count&nbsp;+&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;find_targets&nbsp;more&nbsp;acc&nbsp;found_count&nbsp;(passed_count&nbsp;+&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;init&nbsp;=&nbsp;<span class="constructor">List</span>.drop&nbsp;explorer.target_ids&nbsp;from&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"pick_a_target&nbsp;from&nbsp;"</span>&nbsp;%&nbsp;i&nbsp;from&nbsp;%&nbsp;s&nbsp;<span class="string">"&nbsp;among&nbsp;"</span>&nbsp;%&nbsp;i&nbsp;(<span class="constructor">List</span>.length&nbsp;init)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;verbose);<br>
&nbsp;&nbsp;&nbsp;&nbsp;find_targets&nbsp;init&nbsp;[]&nbsp;0&nbsp;from<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;(sub_list,&nbsp;next_menu_option)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;menu&nbsp;~sentence:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Pick&nbsp;a&nbsp;target"</span>)&nbsp;~max_per_page<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~always_there:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;common_menu_items<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'f'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Change&nbsp;filter&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;parens&nbsp;(s&nbsp;<span class="string">"current:&nbsp;"</span>&nbsp;%&nbsp;snd&nbsp;es.target_filter))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Filter</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">match</span>&nbsp;next_menu_option&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;next&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[menu_item&nbsp;~char:<span class="string">'n'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Next&nbsp;targets"</span>)&nbsp;next])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[menu_item&nbsp;~char:<span class="string">'p'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Previous&nbsp;view"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~char:<span class="string">'h'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Back&nbsp;to&nbsp;top/home"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Pick</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">From</span>&nbsp;0))])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;sub_list&nbsp;~f:(<span class="keyword">fun</span>&nbsp;target&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item&nbsp;~log:<span class="constructor">Log</span>.(<span class="constructor">Document</span>.target_for_menu&nbsp;target)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Go</span>&nbsp;(<span class="constructor">Target</span>.id&nbsp;target)))))<br>
<br>
<span class="keyword">let</span>&nbsp;explore_single_target&nbsp;~client&nbsp;(es:&nbsp;exploration_state)&nbsp;target&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sentence&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;build_process_details&nbsp;=&nbsp;es.build_process_details&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;condition_details&nbsp;=&nbsp;es.condition_details&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;metadata_details&nbsp;=&nbsp;es.metadata_details&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Exploring&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;<span class="constructor">Document</span>.target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~build_process_details&nbsp;~condition_details&nbsp;~metadata_details&nbsp;target)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kill_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Target</span>.state&nbsp;target&nbsp;|&gt;&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.<span class="constructor">Is</span>.killable<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;[menu_item&nbsp;~char:<span class="string">'k'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Kill"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Kill</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;boolean_item&nbsp;~value&nbsp;~char&nbsp;~to_false&nbsp;~to_true&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;value&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[menu_item&nbsp;~char&nbsp;~log:(fst&nbsp;to_false)&nbsp;(snd&nbsp;to_false)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[menu_item&nbsp;~char&nbsp;~log:(fst&nbsp;to_true)&nbsp;(snd&nbsp;to_true)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;build_process_details_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean_item&nbsp;~value:es.build_process_details&nbsp;~char:<span class="string">'b'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~to_false:(<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Hide&nbsp;build&nbsp;process&nbsp;details"</span>),&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_make</span>&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~to_true:(<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Show&nbsp;build&nbsp;process&nbsp;details"</span>),&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_make</span>&nbsp;<span class="keyword">true</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;condition_details_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean_item&nbsp;~value:es.condition_details&nbsp;~char:<span class="string">'c'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~to_false:(<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Hide&nbsp;condition&nbsp;details"</span>),&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_condition</span>&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~to_true:(<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Show&nbsp;condition&nbsp;details"</span>),&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_condition</span>&nbsp;<span class="keyword">true</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;metadata_details_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Target</span>.metadata&nbsp;target&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean_item&nbsp;~value:es.metadata_details&nbsp;~char:<span class="string">'m'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~to_false:(<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Hide&nbsp;metadata&nbsp;details"</span>),&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_metadata</span>&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~to_true:(<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Show&nbsp;metadata&nbsp;details"</span>),&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_metadata</span>&nbsp;<span class="keyword">true</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[menu_item&nbsp;~char:<span class="string">'M'</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"View&nbsp;Metadata&nbsp;in&nbsp;$EDITOR"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">View_metadata</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;menu_item_of_id_list&nbsp;~char&nbsp;~log&nbsp;~result&nbsp;ids&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;ids&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;some&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[menu_item&nbsp;~char&nbsp;~log&nbsp;result]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;follow_deps_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item_of_id_list&nbsp;~char:<span class="string">'d'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Follow&nbsp;a&nbsp;dependency"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result:<span class="keywordsign">`</span><span class="constructor">Follow_dependencies</span>&nbsp;(<span class="constructor">Target</span>.depends_on&nbsp;target)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;follow_failed_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item_of_id_list&nbsp;~char:<span class="string">'f'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Follow&nbsp;a&nbsp;failure"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result:<span class="keywordsign">`</span><span class="constructor">Follow_failures</span>&nbsp;(<span class="constructor">Target</span>.on_failure_activate&nbsp;target)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;follow_successful_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menu_item_of_id_list&nbsp;~char:<span class="string">'t'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Follow&nbsp;a&nbsp;success"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result:<span class="keywordsign">`</span><span class="constructor">Follow_successes</span>&nbsp;(<span class="constructor">Target</span>.on_success_activate&nbsp;target)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;restart_item&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Target</span>.state&nbsp;target&nbsp;|&gt;&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.<span class="constructor">Is</span>.finished<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;[menu_item&nbsp;~char:<span class="string">'r'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Restart&nbsp;(clone&nbsp;&amp;&nbsp;activate)"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Restart</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;menu&nbsp;~sentence&nbsp;~always_there:common_menu_items&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[menu_item&nbsp;~char:<span class="string">'s'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Show&nbsp;status"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">Status</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;build_process_details_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;condition_details_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;metadata_details_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;follow_deps_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;follow_failed_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;follow_successful_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;kill_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;restart_item<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[menu_item&nbsp;~char:<span class="string">'O'</span>&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"See&nbsp;JSON&nbsp;in&nbsp;$EDITOR"</span>)&nbsp;<span class="keywordsign">`</span><span class="constructor">View_json</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;view_json&nbsp;~client&nbsp;target&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;content&nbsp;=&nbsp;<span class="constructor">Target</span>.<span class="constructor">Stored_target</span>.(of_target&nbsp;target&nbsp;|&gt;&nbsp;serialize)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.view_in_dollar_editor&nbsp;~extension:<span class="string">"json"</span>&nbsp;content<br>
<br>
<span class="keyword">let</span>&nbsp;view_metadata&nbsp;~client&nbsp;target&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Target</span>.metadata&nbsp;target&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Interaction</span>.view_in_dollar_editor&nbsp;~extension:<span class="string">"json"</span>&nbsp;content<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;target_status<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(viewer=<span class="keywordsign">`</span><span class="constructor">Inline</span>)&nbsp;?(add_info=<span class="constructor">Log</span>.empty)&nbsp;explorer&nbsp;exploration_state&nbsp;target&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sentence&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Log</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;log_of_status&nbsp;(status:&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.t)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Target</span>.<span class="constructor">State</span>.log&nbsp;~depth:4&nbsp;status&nbsp;%&nbsp;n&nbsp;%&nbsp;s&nbsp;<span class="string">"..."</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Document</span>.target&nbsp;target<br>
&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;s&nbsp;<span class="string">"Status:"</span>&nbsp;%&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;indent&nbsp;(log_of_status&nbsp;(<span class="constructor">Target</span>.state&nbsp;target))<br>
&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;n&nbsp;%&nbsp;add_info<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Interaction</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;additional&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Plugin</span>.additional_queries&nbsp;target<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(key,&nbsp;log)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;menu_item&nbsp;~log&nbsp;(<span class="keywordsign">`</span><span class="constructor">Call</span>&nbsp;(key,&nbsp;log)))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;always_there&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;viewer_items&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;char&nbsp;=&nbsp;<span class="string">'v'</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;additional,&nbsp;viewer&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[],&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]&nbsp;<span class="comment">(*&nbsp;No&nbsp;additional&nbsp;→&nbsp;no&nbsp;need&nbsp;for&nbsp;this&nbsp;menu-item.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;<span class="keywordsign">`</span><span class="constructor">Inline</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[menu_item&nbsp;~char&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Use&nbsp;$EDITOR&nbsp;as&nbsp;viewer"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Set_viewer</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Dollar_editor</span>)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;<span class="keywordsign">`</span><span class="constructor">Dollar_editor</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[menu_item&nbsp;~char&nbsp;~log:<span class="constructor">Log</span>.(s&nbsp;<span class="string">"View&nbsp;stuff&nbsp;inline"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Set_viewer</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Inline</span>)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;common_menu_items&nbsp;@&nbsp;&nbsp;viewer_items&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;menu&nbsp;~sentence&nbsp;~always_there&nbsp;additional<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Set_viewer</span>&nbsp;viewer&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;target_status&nbsp;~viewer&nbsp;explorer&nbsp;exploration_state&nbsp;target<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Call</span>&nbsp;(key,&nbsp;log)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Calling&nbsp;query&nbsp;"</span>&nbsp;%&nbsp;sf&nbsp;<span class="string">"%S"</span>&nbsp;key&nbsp;%&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;s&nbsp;<span class="string">"Press&nbsp;"</span>&nbsp;%&nbsp;bold_red&nbsp;(s&nbsp;<span class="string">"'K'"</span>)&nbsp;%&nbsp;s&nbsp;<span class="string">"&nbsp;for&nbsp;cancelling"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;warning);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="constructor">Deferred_list</span>.pick_and_cancel&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Client</span>.call_query&nbsp;explorer.ketrew_client&nbsp;~target&nbsp;key;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_key&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Failure</span>&nbsp;failure)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Interface&nbsp;fails:&nbsp;"</span>&nbsp;%&nbsp;s&nbsp;failure)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;<span class="string">'K'</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Cancelled&nbsp;by&nbsp;user"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;loop&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&lt;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;qlog&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;viewer&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Inline</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;formatted&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;line&nbsp;=&nbsp;<span class="constructor">String</span>.make&nbsp;80&nbsp;<span class="string">'`'</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"\n"</span>&nbsp;[line;&nbsp;qlog;&nbsp;line]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="constructor">Log</span>.(log&nbsp;%&nbsp;s&nbsp;<span class="string">":"</span>&nbsp;%&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;verbatim&nbsp;(<span class="string">"\n"</span>&nbsp;^&nbsp;formatted&nbsp;^&nbsp;<span class="string">"\n"</span>)&nbsp;%&nbsp;n))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Dollar_editor</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Interaction</span>.view_in_dollar_editor&nbsp;qlog<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="constructor">Log</span>.(log&nbsp;%&nbsp;s&nbsp;<span class="string">":&nbsp;ERROR&nbsp;-&gt;&nbsp;"</span>&nbsp;%&nbsp;n&nbsp;%&nbsp;e&nbsp;%&nbsp;n))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;add_info&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;target_status&nbsp;explorer&nbsp;~viewer&nbsp;?add_info&nbsp;exploration_state&nbsp;target<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Reload</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;get_target&nbsp;explorer&nbsp;~force_reload:<span class="keyword">true</span>&nbsp;~id:(<span class="constructor">Target</span>.id&nbsp;target)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;chosen&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;target_status&nbsp;explorer&nbsp;~viewer&nbsp;exploration_state&nbsp;chosen<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Settings</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;settings_menu&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;target_status&nbsp;explorer&nbsp;~viewer&nbsp;exploration_state&nbsp;target<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keyword">as</span>&nbsp;up&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;up<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;exploration_loop&nbsp;explorer&nbsp;state&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;go_back&nbsp;explorer&nbsp;state&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;state&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;some&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;exploration_loop&nbsp;explorer&nbsp;some&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;state&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;exploration_loop&nbsp;explorer&nbsp;[create_state&nbsp;()]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(current&nbsp;::&nbsp;previous)&nbsp;<span class="keyword">as</span>&nbsp;history&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;current.currently_seeing&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Target_menu</span>&nbsp;how&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;pick_a_target&nbsp;explorer&nbsp;current&nbsp;~how<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;go_back&nbsp;explorer&nbsp;previous<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Reload</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reload_list_of_ids&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Settings</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings_menu&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Filter</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_filter&nbsp;()&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;({current&nbsp;<span class="keyword">with</span>&nbsp;target_filter&nbsp;=&nbsp;f&nbsp;}&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Go</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;({current&nbsp;<span class="keyword">with</span>&nbsp;currently_seeing&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Target</span>&nbsp;t&nbsp;}&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Pick</span>&nbsp;how&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;({current&nbsp;<span class="keyword">with</span>&nbsp;currently_seeing&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Target_menu</span>&nbsp;how&nbsp;}&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Target</span>&nbsp;chosen_id&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_target&nbsp;explorer&nbsp;~id:chosen_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;chosen&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;explore_single_target&nbsp;~client:explorer.ketrew_client&nbsp;current&nbsp;chosen<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;go_back&nbsp;explorer&nbsp;previous<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Reload</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_target&nbsp;explorer&nbsp;~id:chosen_id&nbsp;~force_reload:<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;reloaded&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Settings</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings_menu&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_make</span>&nbsp;build_process_details&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;({&nbsp;current&nbsp;<span class="keyword">with</span>&nbsp;build_process_details&nbsp;}&nbsp;&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_condition</span>&nbsp;condition_details&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;({&nbsp;current&nbsp;<span class="keyword">with</span>&nbsp;condition_details&nbsp;}&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Show_metadata</span>&nbsp;metadata_details&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;({&nbsp;current&nbsp;<span class="keyword">with</span>&nbsp;metadata_details&nbsp;}&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Status</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;target_status&nbsp;explorer&nbsp;current&nbsp;chosen<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;go_back&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Kill</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Killing&nbsp;target …"</span>&nbsp;@&nbsp;warning);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Client</span>.kill&nbsp;explorer.ketrew_client&nbsp;[<span class="constructor">Target</span>.id&nbsp;chosen]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Restart</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Client</span>.restart&nbsp;explorer.ketrew_client&nbsp;[<span class="constructor">Target</span>.id&nbsp;chosen]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">View_json</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view_json&nbsp;explorer.ketrew_client&nbsp;chosen&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">View_metadata</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view_metadata&nbsp;~client:explorer.ketrew_client&nbsp;chosen&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Follow_dependencies</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Follow_failures</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Follow_successes</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">as</span>&nbsp;follow&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target_ids&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;follow&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Follow_failures</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="constructor">Target</span>.on_failure_activate&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Follow_successes</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="constructor">Target</span>.on_success_activate&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Follow_dependencies</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="constructor">Target</span>.depends_on&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;next_target&nbsp;ids&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;pick_a_target_from_list&nbsp;explorer&nbsp;ids<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Reload</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_target&nbsp;explorer&nbsp;~id:chosen_id&nbsp;~force_reload:<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;chosen&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_target&nbsp;(target_ids&nbsp;chosen)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Settings</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings_menu&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_target&nbsp;ids<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Go</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;(<span class="keywordsign">`</span><span class="constructor">Go</span>&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;next_target&nbsp;(target_ids&nbsp;chosen)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Cancel</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;go_back&nbsp;explorer&nbsp;history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;return&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Go</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploration_loop&nbsp;explorer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;({current&nbsp;<span class="keyword">with</span>&nbsp;currently_seeing&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Target</span>&nbsp;t}&nbsp;::&nbsp;history)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="comment">(*&nbsp;The&nbsp;exported&nbsp;function&nbsp;just&nbsp;“starts”&nbsp;the&nbsp;exploration&nbsp;with&nbsp;`[]`:&nbsp;*)</span><br>
<span class="keyword">let</span>&nbsp;explore&nbsp;state&nbsp;=<br>
&nbsp;&nbsp;reload_list_of_ids&nbsp;state<br>
&nbsp;&nbsp;&gt;&gt;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;exploration_loop&nbsp;state&nbsp;[]<br>
</code></body></html>