<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Ketrew" rel="Chapter" href="Ketrew.html">
<link title="Ketrew_client" rel="Chapter" href="Ketrew_client.html">
<link title="Ketrew_command_line" rel="Chapter" href="Ketrew_command_line.html">
<link title="Ketrew_configuration" rel="Chapter" href="Ketrew_configuration.html">
<link title="Ketrew_daemonize" rel="Chapter" href="Ketrew_daemonize.html">
<link title="Ketrew_document" rel="Chapter" href="Ketrew_document.html">
<link title="Ketrew_edsl" rel="Chapter" href="Ketrew_edsl.html">
<link title="Ketrew_engine" rel="Chapter" href="Ketrew_engine.html">
<link title="Ketrew_error" rel="Chapter" href="Ketrew_error.html">
<link title="Ketrew_eval_condition" rel="Chapter" href="Ketrew_eval_condition.html">
<link title="Ketrew_explorer" rel="Chapter" href="Ketrew_explorer.html">
<link title="Ketrew_host" rel="Chapter" href="Ketrew_host.html">
<link title="Ketrew_host_io" rel="Chapter" href="Ketrew_host_io.html">
<link title="Ketrew_interaction" rel="Chapter" href="Ketrew_interaction.html">
<link title="Ketrew_long_running" rel="Chapter" href="Ketrew_long_running.html">
<link title="Ketrew_long_running_utilities" rel="Chapter" href="Ketrew_long_running_utilities.html">
<link title="Ketrew_lsf" rel="Chapter" href="Ketrew_lsf.html">
<link title="Ketrew_measurement" rel="Chapter" href="Ketrew_measurement.html">
<link title="Ketrew_monitored_script" rel="Chapter" href="Ketrew_monitored_script.html">
<link title="Ketrew_path" rel="Chapter" href="Ketrew_path.html">
<link title="Ketrew_pbs" rel="Chapter" href="Ketrew_pbs.html">
<link title="Ketrew_pervasives" rel="Chapter" href="Ketrew_pervasives.html">
<link title="Ketrew_plugin" rel="Chapter" href="Ketrew_plugin.html">
<link title="Ketrew_program" rel="Chapter" href="Ketrew_program.html">
<link title="Ketrew_protocol" rel="Chapter" href="Ketrew_protocol.html">
<link title="Ketrew_server" rel="Chapter" href="Ketrew_server.html">
<link title="Ketrew_target" rel="Chapter" href="Ketrew_target.html">
<link title="Ketrew_unix_io" rel="Chapter" href="Ketrew_unix_io.html">
<link title="Ketrew_unix_process" rel="Chapter" href="Ketrew_unix_process.html">
<link title="Ketrew_yarn" rel="Chapter" href="Ketrew_yarn.html"><title>Ketrew API : Ketrew_configuration</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;2015:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Leonid&nbsp;Rozenberg&nbsp;&lt;leonidr@gmail.com&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Arun&nbsp;Ahuja&nbsp;&lt;aahuja11@gmail.com&gt;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Jeff&nbsp;Hammerbacher&nbsp;&lt;jeff.hammerbacher@gmail.com&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_pervasives</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_unix_io</span><br>
<br>
<br>
<span class="keyword">type</span>&nbsp;plugin&nbsp;=&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Compiled</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">OCamlfind</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[@@deriving&nbsp;yojson]<br>
<br>
<br>
<span class="keyword">type</span>&nbsp;engine&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;database_parameters:&nbsp;string;<br>
&nbsp;&nbsp;turn_unix_ssh_failure_into_target_failure:&nbsp;bool&nbsp;[@default&nbsp;<span class="keyword">false</span>];<br>
&nbsp;&nbsp;host_timeout_upper_bound:&nbsp;float&nbsp;option&nbsp;[@default&nbsp;<span class="constructor">None</span>];<br>
&nbsp;&nbsp;maximum_successive_attempts:&nbsp;int&nbsp;[@default&nbsp;10];<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;explorer_defaults&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;request_targets_ids:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;<span class="keyword">of</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;<span class="keyword">of</span>&nbsp;float&nbsp;]];<br>
&nbsp;&nbsp;targets_per_page:&nbsp;int;<br>
&nbsp;&nbsp;targets_to_prefetch:&nbsp;int;<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;ui&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;with_color:&nbsp;bool;<br>
&nbsp;&nbsp;explorer:&nbsp;explorer_defaults;<br>
&nbsp;&nbsp;with_cbreak:&nbsp;bool;<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;authorized_tokens&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Path</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Inline</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;string<br>
]&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;server&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;authorized_tokens:&nbsp;authorized_tokens&nbsp;list;<br>
&nbsp;&nbsp;listen_to:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Tls</span>&nbsp;<span class="keyword">of</span>&nbsp;(string&nbsp;*&nbsp;string&nbsp;*&nbsp;int)&nbsp;];<br>
&nbsp;&nbsp;return_error_messages:&nbsp;bool;<br>
&nbsp;&nbsp;command_pipe:&nbsp;string&nbsp;option;<br>
&nbsp;&nbsp;daemon:&nbsp;bool;<br>
&nbsp;&nbsp;log_path:&nbsp;string&nbsp;option;<br>
&nbsp;&nbsp;server_engine:&nbsp;engine;<br>
&nbsp;&nbsp;server_ui:&nbsp;ui;<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;client&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;connection:&nbsp;string;<br>
&nbsp;&nbsp;token:&nbsp;string;<br>
&nbsp;&nbsp;client_ui&nbsp;[@key&nbsp;<span class="string">"ui"</span>]:&nbsp;ui;<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;standalone&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;standalone_engine&nbsp;[@key&nbsp;<span class="string">"engine"</span>]:&nbsp;engine;<br>
&nbsp;&nbsp;standalone_ui&nbsp;[@key&nbsp;<span class="string">"ui"</span>]:&nbsp;ui;<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<span class="keyword">type</span>&nbsp;mode&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Standalone</span>&nbsp;<span class="keyword">of</span>&nbsp;standalone<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Client</span>&nbsp;<span class="keyword">of</span>&nbsp;client<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Server</span>&nbsp;<span class="keyword">of</span>&nbsp;server<br>
]&nbsp;[@@deriving&nbsp;yojson]<br>
<br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;debug_level:&nbsp;int;<br>
&nbsp;&nbsp;plugins:&nbsp;plugin&nbsp;list&nbsp;[@default&nbsp;[]];<br>
&nbsp;&nbsp;mode:&nbsp;mode;<br>
}&nbsp;[@@deriving&nbsp;yojson]<br>
<br>
<span class="keyword">let</span>&nbsp;log&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Log</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;item&nbsp;name&nbsp;l&nbsp;=&nbsp;s&nbsp;name&nbsp;%&nbsp;s&nbsp;<span class="string">":&nbsp;"</span>&nbsp;%&nbsp;l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;toplevel&nbsp;l&nbsp;=&nbsp;separate&nbsp;n&nbsp;l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sublist&nbsp;l&nbsp;=&nbsp;n&nbsp;%&nbsp;indent&nbsp;(separate&nbsp;n&nbsp;l)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;common&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sublist&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Debug-level"</span>&nbsp;(i&nbsp;t.debug_level);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Plugins"</span>&nbsp;(<span class="keyword">match</span>&nbsp;t.plugins&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;<span class="string">"None"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sublist&nbsp;(<span class="constructor">List</span>.map&nbsp;more&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Compiled</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;item&nbsp;<span class="string">"Compiled"</span>&nbsp;&nbsp;(quote&nbsp;path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">OCamlfind</span>&nbsp;pack&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;item&nbsp;<span class="string">"OCamlfind&nbsp;package"</span>&nbsp;(quote&nbsp;pack))))<br>
&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ui&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sublist&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Colors"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;t.with_color&nbsp;<span class="keyword">then</span>&nbsp;s&nbsp;<span class="string">"with&nbsp;colors"</span>&nbsp;<span class="keyword">else</span>&nbsp;s&nbsp;<span class="string">"without&nbsp;colors"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Get-key"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;t.with_cbreak&nbsp;<span class="keyword">then</span>&nbsp;s&nbsp;<span class="string">"uses&nbsp;`cbreak`"</span>&nbsp;<span class="keyword">else</span>&nbsp;s&nbsp;<span class="string">"classic&nbsp;readline"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Explorer"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">let</span>&nbsp;{&nbsp;request_targets_ids;&nbsp;targets_per_page;&nbsp;targets_to_prefetch&nbsp;}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.explorer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sublist&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Default&nbsp;request"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;request_targets_ids&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;days)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;<span class="string">"Targets&nbsp;younger&nbsp;than&nbsp;"</span>&nbsp;%&nbsp;f&nbsp;days&nbsp;%&nbsp;s&nbsp;<span class="string">"&nbsp;days"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">All</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;<span class="string">"All&nbsp;targets"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Targets-per-page"</span>&nbsp;(i&nbsp;targets_per_page);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Targets-to-prefectch"</span>&nbsp;(i&nbsp;targets_to_prefetch);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;engine&nbsp;{&nbsp;database_parameters;&nbsp;turn_unix_ssh_failure_into_target_failure;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host_timeout_upper_bound;&nbsp;maximum_successive_attempts&nbsp;}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sublist&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Database"</span>&nbsp;(quote&nbsp;database_parameters);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Unix-failure"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="keyword">if</span>&nbsp;turn_unix_ssh_failure_into_target_failure<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;s&nbsp;<span class="string">"turns"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;s&nbsp;<span class="string">"does&nbsp;not&nbsp;turn"</span>)&nbsp;%&nbsp;s&nbsp;<span class="string">"&nbsp;into&nbsp;target&nbsp;failure"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Host-timeout-upper-bound"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(option&nbsp;f&nbsp;host_timeout_upper_bound);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Maximum-successive-attempts"</span>&nbsp;(i&nbsp;maximum_successive_attempts);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;authorized_tokens&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Path</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;<span class="string">"Path:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;path<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Inline</span>&nbsp;(name,&nbsp;value)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;<span class="string">"Inline&nbsp;"</span>&nbsp;%&nbsp;parens&nbsp;(s&nbsp;<span class="string">"Name:&nbsp;"</span>&nbsp;%&nbsp;s&nbsp;name&nbsp;%&nbsp;s&nbsp;<span class="string">",&nbsp;Value:&nbsp;"</span>&nbsp;%&nbsp;quote&nbsp;value)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Standalone</span>&nbsp;{standalone_engine;&nbsp;standalone_ui}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;toplevel&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Mode"</span>&nbsp;(s&nbsp;<span class="string">"Standalone"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Engine"</span>&nbsp;(engine&nbsp;standalone_engine);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"UI"</span>&nbsp;(ui&nbsp;standalone_ui);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Misc"</span>&nbsp;common;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Client</span>&nbsp;client&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;toplevel&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Mode"</span>&nbsp;(s&nbsp;<span class="string">"Client"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Connection"</span>&nbsp;(quote&nbsp;client.connection);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Auth-token"</span>&nbsp;(quote&nbsp;client.token);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"UI"</span>&nbsp;(ui&nbsp;client.client_ui);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Misc"</span>&nbsp;common;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Server</span>&nbsp;srv&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;toplevel&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Mode"</span>&nbsp;(s&nbsp;<span class="string">"Server"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Engine"</span>&nbsp;(engine&nbsp;srv.server_engine);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"UI"</span>&nbsp;(ui&nbsp;srv.server_ui);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"HTTP-server"</span>&nbsp;(sublist&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Authorized&nbsp;tokens"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sublist&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:authorized_tokens&nbsp;srv.authorized_tokens));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Daemonize"</span>&nbsp;(<span class="constructor">OCaml</span>.bool&nbsp;srv.daemon);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Command&nbsp;Pipe"</span>&nbsp;(<span class="constructor">OCaml</span>.option&nbsp;quote&nbsp;srv.command_pipe);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Log-path"</span>&nbsp;(<span class="constructor">OCaml</span>.option&nbsp;quote&nbsp;srv.log_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Return-error-messages"</span>&nbsp;(<span class="constructor">OCaml</span>.bool&nbsp;srv.return_error_messages);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Listen"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">let</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Tls</span>&nbsp;(cert,&nbsp;key,&nbsp;port)&nbsp;=&nbsp;srv.listen_to&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sublist&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Port"</span>&nbsp;(i&nbsp;port);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Certificate"</span>&nbsp;(quote&nbsp;cert);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Key"</span>&nbsp;(quote&nbsp;key);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item&nbsp;<span class="string">"Misc"</span>&nbsp;common;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;default_database_path&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"HOME"</span>&nbsp;^&nbsp;<span class="string">"/.ketrew/database"</span><br>
<br>
<span class="keyword">let</span>&nbsp;create&nbsp;?(debug_level=0)&nbsp;?(plugins=[])&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;{debug_level;&nbsp;plugins;&nbsp;mode;}<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;explorer<br>
&nbsp;&nbsp;?(request_targets_ids&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Younger_than</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Days</span>&nbsp;1.5))<br>
&nbsp;&nbsp;?(targets_per_page&nbsp;=&nbsp;6)<br>
&nbsp;&nbsp;?(targets_to_prefetch&nbsp;=&nbsp;6)&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;{request_targets_ids;&nbsp;targets_to_prefetch;&nbsp;targets_per_page&nbsp;}<br>
<br>
<span class="keyword">let</span>&nbsp;default_explorer_defaults&nbsp;:&nbsp;explorer_defaults&nbsp;=&nbsp;explorer&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;ui<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(with_color=<span class="keyword">true</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(explorer=default_explorer_defaults)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(with_cbreak=<span class="keyword">true</span>)&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;{with_color;&nbsp;explorer;&nbsp;with_cbreak}<br>
<span class="keyword">let</span>&nbsp;default_ui&nbsp;=&nbsp;ui&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;engine<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(database_parameters=default_database_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(turn_unix_ssh_failure_into_target_failure=<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?host_timeout_upper_bound<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(maximum_successive_attempts=10)<br>
&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;database_parameters;<br>
&nbsp;&nbsp;turn_unix_ssh_failure_into_target_failure;<br>
&nbsp;&nbsp;host_timeout_upper_bound;<br>
&nbsp;&nbsp;maximum_successive_attempts;<br>
}<br>
<span class="keyword">let</span>&nbsp;default_engine&nbsp;=&nbsp;engine&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;standalone&nbsp;?(ui=default_ui)&nbsp;?engine&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;standalone_engine&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;engine&nbsp;~default:default_engine&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Standalone</span>&nbsp;{standalone_engine;&nbsp;standalone_ui&nbsp;=&nbsp;ui})<br>
<br>
<span class="keyword">let</span>&nbsp;client&nbsp;?(ui=default_ui)&nbsp;~token&nbsp;connection&nbsp;=<br>
&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Client</span>&nbsp;{client_ui&nbsp;=&nbsp;ui;&nbsp;connection;&nbsp;token})<br>
<br>
<span class="keyword">let</span>&nbsp;authorized_token&nbsp;~name&nbsp;value&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Inline</span>&nbsp;(name,&nbsp;value)<br>
<span class="keyword">let</span>&nbsp;authorized_tokens_path&nbsp;p&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Path</span>&nbsp;p<br>
<br>
<span class="keyword">let</span>&nbsp;server<br>
&nbsp;&nbsp;&nbsp;&nbsp;?ui&nbsp;?engine<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(authorized_tokens=[])&nbsp;?(return_error_messages=<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?command_pipe&nbsp;?(daemon=<span class="keyword">false</span>)&nbsp;?log_path&nbsp;listen_to&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;server_engine&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;engine&nbsp;~default:default_engine&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;server_ui&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;ui&nbsp;~default:default_ui&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Server</span>&nbsp;{server_engine;&nbsp;authorized_tokens;&nbsp;listen_to;&nbsp;server_ui;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return_error_messages;&nbsp;command_pipe;&nbsp;daemon;&nbsp;log_path;&nbsp;})<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;plugins&nbsp;t&nbsp;=&nbsp;t.plugins<br>
<br>
<span class="keyword">let</span>&nbsp;server_configuration&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Server</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;s<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<span class="keyword">let</span>&nbsp;listen_to&nbsp;s&nbsp;=&nbsp;s.listen_to<br>
<span class="keyword">let</span>&nbsp;return_error_messages&nbsp;s&nbsp;=&nbsp;s.return_error_messages<br>
<span class="keyword">let</span>&nbsp;authorized_tokens&nbsp;s&nbsp;=&nbsp;s.authorized_tokens<br>
<span class="keyword">let</span>&nbsp;command_pipe&nbsp;s&nbsp;=&nbsp;s.command_pipe<br>
<span class="keyword">let</span>&nbsp;daemon&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;s.daemon<br>
<span class="keyword">let</span>&nbsp;log_path&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;s.log_path<br>
<span class="keyword">let</span>&nbsp;database_parameters&nbsp;e&nbsp;=&nbsp;e.database_parameters<br>
<span class="keyword">let</span>&nbsp;is_unix_ssh_failure_fatal&nbsp;e&nbsp;=&nbsp;e.turn_unix_ssh_failure_into_target_failure<br>
<span class="keyword">let</span>&nbsp;maximum_successive_attempts&nbsp;e&nbsp;=&nbsp;e.maximum_successive_attempts<br>
<span class="keyword">let</span>&nbsp;mode&nbsp;t&nbsp;=&nbsp;t.mode<br>
<span class="keyword">let</span>&nbsp;standalone_engine&nbsp;st&nbsp;=&nbsp;st.standalone_engine<br>
<span class="keyword">let</span>&nbsp;server_engine&nbsp;s&nbsp;=&nbsp;s.server_engine<br>
<span class="keyword">let</span>&nbsp;connection&nbsp;c&nbsp;=&nbsp;c.connection<br>
<span class="keyword">let</span>&nbsp;token&nbsp;c&nbsp;=&nbsp;c.token<br>
<br>
<span class="keyword">let</span>&nbsp;standalone_of_server&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;{standalone_ui&nbsp;=&nbsp;s.server_ui;<br>
&nbsp;&nbsp;&nbsp;standalone_engine&nbsp;=&nbsp;s.server_engine;}<br>
<br>
<span class="keyword">let</span>&nbsp;get_ui&nbsp;(t:&nbsp;t)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Server</span>&nbsp;{&nbsp;server_ui;&nbsp;_&nbsp;}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;server_ui<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Standalone</span>&nbsp;{&nbsp;standalone_ui;&nbsp;_&nbsp;}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;standalone_ui<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Client</span>&nbsp;{&nbsp;client_ui;&nbsp;_&nbsp;}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;client_ui<br>
<br>
<span class="keyword">let</span>&nbsp;with_color&nbsp;t&nbsp;=&nbsp;get_ui&nbsp;t&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;ui&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ui.with_color<br>
<span class="keyword">let</span>&nbsp;request_targets_ids&nbsp;t&nbsp;=&nbsp;get_ui&nbsp;t&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;ui&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ui.explorer.request_targets_ids<br>
<span class="keyword">let</span>&nbsp;targets_per_page&nbsp;t&nbsp;=&nbsp;get_ui&nbsp;t&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;ui&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ui.explorer.targets_per_page<br>
<span class="keyword">let</span>&nbsp;targets_to_prefetch&nbsp;t&nbsp;=&nbsp;get_ui&nbsp;t&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;ui&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ui.explorer.targets_to_prefetch<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">File</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;configuration&nbsp;=&nbsp;t<br>
&nbsp;&nbsp;&nbsp;[@@deriving&nbsp;yojson]<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;profile&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration:&nbsp;configuration;<br>
&nbsp;&nbsp;}&nbsp;[@@deriving&nbsp;yojson]<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ketrew_configuration</span>&nbsp;[@name&nbsp;<span class="string">"Ketrew"</span>]&nbsp;<span class="keyword">of</span>&nbsp;profile&nbsp;list<br>
&nbsp;&nbsp;]&nbsp;[@@deriving&nbsp;yojson]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;parse_string_exn&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Safe</span>.from_string&nbsp;s&nbsp;|&gt;&nbsp;of_yojson&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ok</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;o<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Error</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;(fmt&nbsp;<span class="string">"Configuration&nbsp;parsing&nbsp;error:&nbsp;%s"</span>&nbsp;e)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_string&nbsp;s&nbsp;=&nbsp;to_yojson&nbsp;s&nbsp;|&gt;&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Safe</span>.pretty_to_string&nbsp;~std:<span class="keyword">true</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_profile&nbsp;t&nbsp;the_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Ketrew_configuration</span>&nbsp;profiles&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;profiles&nbsp;~f:(<span class="keyword">fun</span>&nbsp;{name;&nbsp;configuration}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;name&nbsp;=&nbsp;the_name&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;configuration&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">None</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pick_profile_exn&nbsp;?name&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"KETREW_PROFILE"</span>&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"default"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;get_profile&nbsp;t&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:(fmt&nbsp;<span class="string">"profile&nbsp;%S&nbsp;not&nbsp;found"</span>&nbsp;name)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_ketrew_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"HOME"</span>&nbsp;^&nbsp;<span class="string">"/.ketrew/"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_configuration_filenames&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration.json"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration.ml"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration.sh"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration.url"</span>;<br>
&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_path&nbsp;?root&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;env&nbsp;n&nbsp;()&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Sys</span>.getenv&nbsp;n)&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;try_options&nbsp;l&nbsp;~and_then&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">List</span>.find_map&nbsp;l&nbsp;~f:(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;())&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;and_then&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;findout_path&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try_options&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;root);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"KETREW_ROOT"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~and_then:(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;default_ketrew_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;find_in_path&nbsp;ketrew_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try_options<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;default_configuration_filenames<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;path&nbsp;=&nbsp;<span class="constructor">Filename</span>.concat&nbsp;ketrew_path&nbsp;name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Sys</span>.file_exists&nbsp;path&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;path&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">None</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~and_then:(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.concat&nbsp;ketrew_path&nbsp;<span class="string">"configuration.json"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;try_options&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"KETREW_CONFIGURATION"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env&nbsp;<span class="string">"KETREW_CONFIG"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~and_then:(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ketrew_path&nbsp;=&nbsp;findout_path&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;find_in_path&nbsp;ketrew_path)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;read_file_no_lwt&nbsp;path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;open_in&nbsp;path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;content&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buf&nbsp;=&nbsp;<span class="constructor">Buffer</span>.create&nbsp;1023&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;get_all&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;line&nbsp;=&nbsp;input_line&nbsp;i&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Buffer</span>.add_string&nbsp;buf&nbsp;(line&nbsp;^&nbsp;<span class="string">"\n"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_all&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_all&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Buffer</span>.contents&nbsp;buf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;close_in&nbsp;i;<br>
&nbsp;&nbsp;&nbsp;&nbsp;content<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;read_command_output_no_lwt_exn&nbsp;cmd&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ic&nbsp;=&nbsp;<span class="constructor">Unix</span>.open_process_in&nbsp;cmd&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buf&nbsp;=&nbsp;<span class="constructor">Buffer</span>.create&nbsp;24&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Buffer</span>.add_char&nbsp;buf&nbsp;(input_char&nbsp;ic)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">End_of_file</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Unix</span>.close_process_in&nbsp;ic&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unix</span>.<span class="constructor">WEXITED</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Buffer</span>.contents&nbsp;buf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;(fmt&nbsp;<span class="string">"failed&nbsp;command:&nbsp;%S"</span>&nbsp;cmd)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;load_exn&nbsp;path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;(<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'.'</span>)&nbsp;path&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.last)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"json"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_file_no_lwt&nbsp;path&nbsp;|&gt;&nbsp;parse_string_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"ml"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_command_output_no_lwt_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fmt&nbsp;<span class="string">"ocaml&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;parse_string_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"sh"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_command_output_no_lwt_exn&nbsp;path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;parse_string_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"url"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Getting&nbsp;config&nbsp;from&nbsp;URL:&nbsp;not&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Config&nbsp;file&nbsp;should&nbsp;a&nbsp;discriminatory&nbsp;extension,&nbsp;not&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;quote&nbsp;other&nbsp;%&nbsp;s&nbsp;<span class="string">"&nbsp;pretending&nbsp;it&nbsp;is&nbsp;`.json`"</span>&nbsp;@&nbsp;warning);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_file_no_lwt&nbsp;path&nbsp;|&gt;&nbsp;parse_string_exn<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;using_cbreak&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span><br>
<span class="keyword">let</span>&nbsp;use_cbreak&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;!using_cbreak<br>
<span class="keyword">let</span>&nbsp;set_using_cbreak&nbsp;from_config&nbsp;=<br>
&nbsp;&nbsp;using_cbreak&nbsp;:=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"WITH_CBREAK"</span>&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"no"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"false"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"yes"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"true"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;from_config<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;from_config)<br>
<br>
<span class="keyword">let</span>&nbsp;apply_globals&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;global_debug_level&nbsp;:=&nbsp;t.debug_level;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;color,&nbsp;host_timeout,&nbsp;cbreak&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Client</span>&nbsp;{client_ui;&nbsp;connection}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(client_ui.with_color,&nbsp;<span class="constructor">None</span>,&nbsp;client_ui.with_cbreak)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Standalone</span>&nbsp;{standalone_ui;&nbsp;standalone_engine}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(standalone_ui.with_color,&nbsp;standalone_engine.host_timeout_upper_bound,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;standalone_ui.with_cbreak)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Server</span>&nbsp;{server_engine;&nbsp;server_ui;&nbsp;_}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(server_ui.with_color,&nbsp;server_engine.host_timeout_upper_bound,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_ui.with_cbreak)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;global_with_color&nbsp;:=&nbsp;color;<br>
&nbsp;&nbsp;set_using_cbreak&nbsp;cbreak;<br>
&nbsp;&nbsp;<span class="constructor">Log</span>.(s&nbsp;<span class="string">"Configuration:&nbsp;setting&nbsp;globals:&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;indent&nbsp;(n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;s&nbsp;<span class="string">"debug_level:&nbsp;"</span>&nbsp;%&nbsp;i&nbsp;!global_debug_level&nbsp;%&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;s&nbsp;<span class="string">"with_color:&nbsp;"</span>&nbsp;%&nbsp;<span class="constructor">OCaml</span>.bool&nbsp;!global_with_color&nbsp;%&nbsp;n<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;s&nbsp;<span class="string">"timeout&nbsp;upper&nbsp;bound:&nbsp;"</span>&nbsp;%&nbsp;<span class="constructor">OCaml</span>.(option&nbsp;float&nbsp;host_timeout)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;@&nbsp;very_verbose);<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;host_timeout&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;ht&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ketrew_host_io</span>.default_timeout_upper_bound&nbsp;:=&nbsp;ht<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;load_exn&nbsp;?(and_apply=<span class="keyword">true</span>)&nbsp;?profile&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;conf&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Override</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">From_path</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">File</span>.(load_exn&nbsp;path&nbsp;|&gt;&nbsp;pick_profile_exn&nbsp;?name:profile)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">In_directory</span>&nbsp;root&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">File</span>.(get_path&nbsp;~root&nbsp;()&nbsp;|&gt;&nbsp;load_exn&nbsp;|&gt;&nbsp;pick_profile_exn&nbsp;?name:profile)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Guess</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">File</span>.(get_path&nbsp;()&nbsp;|&gt;&nbsp;load_exn&nbsp;|&gt;&nbsp;pick_profile_exn&nbsp;?name:profile)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;and_apply&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;apply_globals&nbsp;conf;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ketrew_plugin</span>.load_plugins_no_lwt_exn&nbsp;conf.plugins<br>
&nbsp;&nbsp;);<br>
&nbsp;&nbsp;conf<br>
<br>
<br>
<span class="keyword">type</span>&nbsp;profile&nbsp;=&nbsp;<span class="constructor">File</span>.profile<br>
<br>
<span class="keyword">let</span>&nbsp;profile&nbsp;name&nbsp;configuration&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">File</span>.({name;&nbsp;configuration})<br>
<br>
<span class="keyword">let</span>&nbsp;output&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">File</span>.(<span class="keywordsign">`</span><span class="constructor">Ketrew_configuration</span>&nbsp;l&nbsp;|&gt;&nbsp;to_string&nbsp;|&gt;&nbsp;print_string)<br>
<br>
<span class="keyword">let</span>&nbsp;to_json&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">File</span>.(<span class="keywordsign">`</span><span class="constructor">Ketrew_configuration</span>&nbsp;l&nbsp;|&gt;&nbsp;to_string)<br>
</code></body></html>