 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: Integration Test</title></head><body><div class="container"><h1>Ketrew: Integration Test</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul><li><a href='#BigIntegrationTest'>Big Integration Test</a>
</li></ul><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li><li><a href='Developer_Documentation.html'>Developer Documentation</a></li><li><a href='Glossary.html'>Glossary</a></li><li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li><li><a href='Server_Commands.html'>Server Commands</a></li><li><a href='The_Configuration_File.html'>The Configuration File</a></li><li><a href='The_HTTP_API.html'>The HTTP API</a></li><li><a href='Workflow_Examples.html'>Workflow Examples</a></li><li><a href='dummy_plugin.html'>Plugin Example</a></li><li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li><li><a href='integration.html'>Integration Test</a></li><li><a href='main.html'>Main Test</a></li><li><a href='preconfigured_main.html'>Preconfigured Main Example</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for <a href='./doc.0.0.0/index.html'>version 0.0.0</a></li><li>Documentation for <a href='./doc.1.0.0/index.html'>version 1.0.0</a></li><li>Documentation for <a href='./doc.1.1.0/index.html'>version 1.1.0</a></li><li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="comment">(**************************************************************************)</span><span class="text">
</span><span class="comment">(*    Copyright 2014, 2015:                                               *)</span><span class="text">
</span><span class="comment">(*          Sebastien Mondet &lt;seb@mondet.org&gt;,                            *)</span><span class="text">
</span><span class="comment">(*          Leonid Rozenberg &lt;leonidr@gmail.com&gt;,                         *)</span><span class="text">
</span><span class="comment">(*          Arun Ahuja &lt;aahuja11@gmail.com&gt;,                              *)</span><span class="text">
</span><span class="comment">(*          Jeff Hammerbacher &lt;jeff.hammerbacher@gmail.com&gt;               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);       *)</span><span class="text">
</span><span class="comment">(*  you may not use this file except in compliance with the License.      *)</span><span class="text">
</span><span class="comment">(*  You may obtain a copy of the License at                               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*      http://www.apache.org/licenses/LICENSE-2.0                        *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Unless required by applicable law or agreed to in writing, software   *)</span><span class="text">
</span><span class="comment">(*  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,     *)</span><span class="text">
</span><span class="comment">(*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or       *)</span><span class="text">
</span><span class="comment">(*  implied.  See the License for the specific language governing         *)</span><span class="text">
</span><span class="comment">(*  permissions and limitations under the License.                        *)</span><span class="text">
</span><span class="comment">(**************************************************************************)</span><span class="text">

</span></pre>


<h2 id="BigIntegrationTest">Big Integration Test</h2>
<pre><span class="text">

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">Sosa</span><span class="text">.</span><span class="kw2">Native_string</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">printf</span><span class="text"> </span><span class="string">&quot;%s\n%!&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text">
</span><span class="kw">let</span><span class="text"> (//) = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">failwithf</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="id">fmt</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">shellf</span><span class="text"> ?(</span><span class="id">returns</span><span class="text">=</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="id">fmt</span><span class="text"> =
  </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">command</span><span class="text"> </span><span class="id">s</span><span class="text">, </span><span class="id">returns</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="id">n</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">m</span><span class="text"> -&gt; ()
      | </span><span class="numeric">_</span><span class="text">, </span><span class="kw2">None</span><span class="text"> -&gt; ()
      | </span><span class="id">other</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
        </span><span class="id">failwith</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Command %S returned %d instead of %d&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">other</span><span class="text"> </span><span class="id">m</span><span class="text">)
    ) </span><span class="id">fmt</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_dir</span><span class="text"> =
  </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;PWD&quot;</span><span class="text"> // </span><span class="string">&quot;_integration_test&quot;</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Test_host</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">as_host</span><span class="text"> () = </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="string">&quot;/tmp/ketrew-integration-test&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">do_on</span><span class="text"> </span><span class="kw4">~program</span><span class="text"> = 
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">as_host</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">program</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">write_file</span><span class="text"> </span><span class="id">path</span><span class="text"> </span><span class="kw4">~content</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">as_host</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Python_daemon</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
        </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;mkdir -p %s&quot;</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> (</span><span class="id">dirname</span><span class="text"> </span><span class="id">path</span><span class="text">))
        &amp;&amp; </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;echo %s &gt; %s&quot;</span><span class="text">
          </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> </span><span class="id">content</span><span class="text">)
          </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> </span><span class="id">path</span><span class="text">)
      )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">tmp</span><span class="text"> </span><span class="id">file</span><span class="text"> = </span><span class="id">test_dir</span><span class="text"> // </span><span class="id">file</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_kill_file</span><span class="text"> = </span><span class="id">test_dir</span><span class="text"> // </span><span class="string">&quot;targets-to-kill&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_target</span><span class="text"> ?</span><span class="id">depends_on</span><span class="text"> ?(</span><span class="id">and_then</span><span class="text"> = []) </span><span class="kw4">~name</span><span class="text"> </span><span class="kw4">~make</span><span class="text"> </span><span class="id">should</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">result_file</span><span class="text"> = </span><span class="id">tmp</span><span class="text"> (</span><span class="id">name</span><span class="text"> ^ </span><span class="string">&quot;-result&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">expectations_file</span><span class="text"> = </span><span class="id">tmp</span><span class="text"> (</span><span class="id">name</span><span class="text"> ^ </span><span class="string">&quot;-expectation&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_success_activate</span><span class="text"> =
      </span><span class="id">target</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;register-success-of-%s&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">)
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">write_file</span><span class="text"> </span><span class="kw4">~content</span><span class="text">:</span><span class="string">&quot;OK&quot;</span><span class="text"> </span><span class="id">result_file</span><span class="text">)
      :: </span><span class="id">and_then</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_failure_activate</span><span class="text"> =
      </span><span class="id">target</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;register-failure-of-%s&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">)
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">write_file</span><span class="text"> </span><span class="kw4">~content</span><span class="text">:</span><span class="string">&quot;KO&quot;</span><span class="text"> </span><span class="id">result_file</span><span class="text">)
      :: </span><span class="id">and_then</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> =
      </span><span class="id">target</span><span class="text"> </span><span class="id">name</span><span class="text">
        </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;to-kill&quot;</span><span class="text">] ?</span><span class="id">depends_on</span><span class="text"> </span><span class="kw4">~make</span><span class="text">
        </span><span class="kw4">~on_success_activate</span><span class="text"> </span><span class="kw4">~on_failure_activate</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">should</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Should_succeed</span><span class="text"> -&gt; </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;echo OK &gt; %s&quot;</span><span class="text"> </span><span class="id">expectations_file</span><span class="text">
    | `</span><span class="kw2">Should_fail</span><span class="text"> -&gt; </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;echo KO &gt; %s&quot;</span><span class="text"> </span><span class="id">expectations_file</span><span class="text">
    | `</span><span class="kw2">Should_be_killed</span><span class="text"> -&gt;
      </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;echo KO &gt; %s&quot;</span><span class="text"> </span><span class="id">expectations_file</span><span class="text">;
      </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;echo %s &gt;&gt; %s&quot;</span><span class="text"> </span><span class="id">t</span><span class="kw1">#</span><span class="id">id</span><span class="text"> </span><span class="id">to_kill_file</span><span class="text">;
    </span><span class="kw1">end</span><span class="text">;
    </span><span class="id">t</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">should_to_3rd_person_verb</span><span class="text"> = </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Should_fail</span><span class="text"> -&gt; </span><span class="string">&quot;fails&quot;</span><span class="text">
  | `</span><span class="kw2">Should_succeed</span><span class="text"> -&gt; </span><span class="string">&quot;succeeds&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">check_test_targets</span><span class="text"> () =
    </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;for exp in %s/*-expectation ; do echo $exp ; \
            diff $exp ${exp%%-expectation}-result ; done&quot;</span><span class="text">
      </span><span class="id">test_dir</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Vagrant_box</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="comment">(* 
  About Torque:
  https://github.com/audy/vagrant-torque
  https://redditjs.com/r/bioinformatics/comments/29xz66/vagranttorque_run_a_single_machine_torque_cluster/

https://github.com/vangj/vagrant-hadoop-2.4.1-spark-1.0.1

  *)</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">initialization</span><span class="text"> = [
    | `</span><span class="kw2">Precise64</span><span class="text">
    | `</span><span class="kw2">Audy_torque</span><span class="text">
    | `</span><span class="kw2">Hadoop_spark_cluster</span><span class="text">
  ]

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = {
    </span><span class="id">dir</span><span class="text">: </span><span class="kw3">string</span><span class="text">;
    </span><span class="id">ssh_config</span><span class="text">: </span><span class="kw3">string</span><span class="text">;
    </span><span class="id">hostname</span><span class="text">: </span><span class="kw3">string</span><span class="text">;
    </span><span class="id">initialization</span><span class="text">: </span><span class="id">initialization</span><span class="text">;
  }

  </span><span class="kw">let</span><span class="text"> </span><span class="id">tmp_dir</span><span class="text"> = </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">tmp</span><span class="text"> </span><span class="string">&quot;vagrant-boxes&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">create</span><span class="text"> </span><span class="id">initialization</span><span class="text"> </span><span class="id">hostname</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">dir</span><span class="text"> = </span><span class="id">tmp_dir</span><span class="text"> // </span><span class="id">hostname</span><span class="text"> </span><span class="kw">in</span><span class="text">
    {</span><span class="id">dir</span><span class="text">; </span><span class="id">ssh_config</span><span class="text"> = </span><span class="id">dir</span><span class="text"> // </span><span class="string">&quot;ssh_config&quot;</span><span class="text">; </span><span class="id">hostname</span><span class="text">; </span><span class="id">initialization</span><span class="text">;}

  </span><span class="kw">let</span><span class="text"> </span><span class="id">in_dir</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Program</span><span class="text">.(
      </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;mkdir&quot;</span><span class="text">; </span><span class="string">&quot;-p&quot;</span><span class="text">; </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">]
      &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cd&quot;</span><span class="text">; </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">]
    )
  </span><span class="kw">let</span><span class="text"> </span><span class="id">as_host</span><span class="text"> </span><span class="id">t</span><span class="text"> = 
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="kw4">~add_ssh_options</span><span class="text">:[</span><span class="string">&quot;-F&quot;</span><span class="text">; </span><span class="id">t</span><span class="text">.</span><span class="id">ssh_config</span><span class="text">]
      </span><span class="kw4">~playground</span><span class="text">:</span><span class="string">&quot;/tmp/KT/&quot;</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">hostname</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">do_on</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~program</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">as_host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Nohup_setsid</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">program</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">internal_hostname</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">initialization</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Precise64</span><span class="text"> -&gt; </span><span class="string">&quot;precise64&quot;</span><span class="text">
    | `</span><span class="kw2">Audy_torque</span><span class="text"> -&gt; </span><span class="string">&quot;master&quot;</span><span class="text">
    | `</span><span class="kw2">Hadoop_spark_cluster</span><span class="text"> -&gt; </span><span class="string">&quot;TODO&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">internal_username</span><span class="text"> </span><span class="numeric">_</span><span class="text"> = </span><span class="string">&quot;vagrant&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">sub</span><span class="text"> =
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s: %s&quot;</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">hostname</span><span class="text"> </span><span class="id">sub</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">prepare</span><span class="text"> ?(</span><span class="id">force_hostname</span><span class="text">=</span><span class="constant">true</span><span class="text">)
      ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">as_host</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">init</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">from_git</span><span class="text"> </span><span class="id">url</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Program</span><span class="text"> </span><span class="kw">in</span><span class="text">
        [</span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;if [ -d %s ] ; then echo 'Already cloned' ; else \
              mkdir -p %s &amp;&amp; cd %s &amp;&amp; \
              git clone %s.git &amp;&amp; \
              mv %s %s ; fi&quot;</span><span class="text">
           (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">)
           (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">tmp_dir</span><span class="text">) (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">tmp_dir</span><span class="text">)
           </span><span class="id">url</span><span class="text">
           (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">basename</span><span class="text"> </span><span class="id">url</span><span class="text">) (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">);
        ]
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">file_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;init-vagrant&quot;</span><span class="text">)
        (</span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text"> // </span><span class="string">&quot;Vagrantfile&quot;</span><span class="text">)
        </span><span class="kw4">~host</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">chain</span><span class="text"> (
              </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">initialization</span><span class="text"> </span><span class="kw1">with</span><span class="text">
              | `</span><span class="kw2">Precise64</span><span class="text"> -&gt; [
                  </span><span class="id">in_dir</span><span class="text"> </span><span class="id">t</span><span class="text">;
                  </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;vagrant&quot;</span><span class="text">; </span><span class="string">&quot;init&quot;</span><span class="text">; </span><span class="string">&quot;hashicorp/precise64&quot;</span><span class="text">];
                ]
              | `</span><span class="kw2">Audy_torque</span><span class="text"> -&gt;
                </span><span class="id">from_git</span><span class="text"> </span><span class="string">&quot;https://github.com/audy/vagrant-torque&quot;</span><span class="text">
                  </span><span class="comment">(*
                [shf &quot;if [ -d %s ] ; then echo 'Already cloned' ; else \
  mkdir -p %s &amp;&amp; cd %s &amp;&amp; \
  git clone git@github.com:audy/vagrant-torque &amp;&amp; \
                           mv vagrant-torque %s ; fi&quot;
                   (Filename.quote t.dir)
                   (Filename.quote tmp_dir) (Filename.quote tmp_dir)
                   (Filename.quote t.dir);
                ] *)</span><span class="text">
              | `</span><span class="kw2">Hadoop_spark_cluster</span><span class="text"> -&gt; 
                </span><span class="comment">(*
                sh &quot;vagrant box add \
                 centos65 \
                 https://github.com/2creatives/vagrant-centos/releases/download/v6.5.1/centos65-x86_64-20131205.box&quot;
                :: *)</span><span class="text">
                </span><span class="id">from_git</span><span class="text"> </span><span class="string">&quot;https://github.com/smondet/vagrant-hadoop-2.4.1-spark-1.0.1&quot;</span><span class="text">
            )
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">running</span><span class="text"> =
      </span><span class="comment">(* re-running `vagrant up` on a running machine does not fail. *)</span><span class="text">
      </span><span class="id">target</span><span class="text"> (</span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;vagrant-up&quot;</span><span class="text">)
        </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">init</span><span class="text">]
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">in_dir</span><span class="text"> </span><span class="id">t</span><span class="text"> &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;vagrant&quot;</span><span class="text">; </span><span class="string">&quot;up&quot;</span><span class="text">]))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">make_ssh_config</span><span class="text"> =
      </span><span class="id">target</span><span class="text"> </span><span class="comment">(* not a `file_target`, because we want this file regenerated 
                every time. We set the `product` but not the “condition”. *)</span><span class="text">
        (</span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;vagrant-ssh-config&quot;</span><span class="text">)
        </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">running</span><span class="text">] ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text">
        </span><span class="kw4">~product</span><span class="text">:(</span><span class="id">file</span><span class="text"> </span><span class="kw4">~host</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">as_host</span><span class="text"> ()) </span><span class="id">t</span><span class="text">.</span><span class="id">ssh_config</span><span class="text">)
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">in_dir</span><span class="text"> </span><span class="id">t</span><span class="text">
            &amp;&amp; </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;vagrant ssh-config %s &gt; %s&quot;</span><span class="text">
              (</span><span class="kw1">match</span><span class="text"> </span><span class="id">force_hostname</span><span class="text"> </span><span class="kw1">with</span><span class="text">
              | </span><span class="constant">false</span><span class="text">  -&gt; </span><span class="string">&quot;&quot;</span><span class="text">
              | </span><span class="constant">true</span><span class="text">  -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;--host %s&quot;</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">hostname</span><span class="text">)
              </span><span class="id">t</span><span class="text">.</span><span class="id">ssh_config</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">make_ssh_config</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">destroy</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">rm_temp</span><span class="text"> =
      </span><span class="id">target</span><span class="text"> (</span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;rm-temp&quot;</span><span class="text">)
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;rm&quot;</span><span class="text">; </span><span class="string">&quot;-fr&quot;</span><span class="text">; </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">]))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">signal_failure</span><span class="text"> =
      </span><span class="id">target</span><span class="text"> (</span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;rm-temp&quot;</span><span class="text">)
        </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.(
            </span><span class="id">write_file</span><span class="text"> (</span><span class="id">tmp</span><span class="text">
                        @@ </span><span class="string">&quot;results&quot;</span><span class="text"> // </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s-destroy-failure&quot;</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">hostname</span><span class="text">)
              </span><span class="kw4">~content</span><span class="text">:</span><span class="id">t</span><span class="text">.</span><span class="id">ssh_config</span><span class="text">
          ))
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> (</span><span class="id">namify</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;kill-vagrant&quot;</span><span class="text">)
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
          </span><span class="id">in_dir</span><span class="text"> </span><span class="id">t</span><span class="text"> &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;vagrant&quot;</span><span class="text">; </span><span class="string">&quot;destroy&quot;</span><span class="text">; </span><span class="string">&quot;-f&quot;</span><span class="text">]
        ))
      </span><span class="kw4">~on_success_activate</span><span class="text">:[</span><span class="id">rm_temp</span><span class="text">]
      </span><span class="kw4">~on_failure_activate</span><span class="text">:[</span><span class="id">rm_temp</span><span class="text">; </span><span class="id">signal_failure</span><span class="text">]

  </span><span class="kw">let</span><span class="text"> </span><span class="id">ssh</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;cd %s &amp;&amp; vagrant ssh&quot;</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">is_running</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text">
      </span><span class="id">shellf</span><span class="text"> </span><span class="kw4">~returns</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="string">&quot;cd %s &amp;&amp; vagrant status | grep running&quot;</span><span class="text"> </span><span class="id">t</span><span class="text">.</span><span class="id">dir</span><span class="text">;
      </span><span class="constant">true</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">exec_is_installed</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~exec</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">as_host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">shell_cmd</span><span class="text"> = </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;which %s&quot;</span><span class="text"> </span><span class="id">exec</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Condition</span><span class="text">.</span><span class="id">program</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">sh</span><span class="text"> </span><span class="id">shell_cmd</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">do_on</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~program</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">as_host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Nohup_setsid</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">program</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">sudo</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Program</span><span class="text">.( </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;sudo su -c %s&quot;</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">cmd</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">with_installed</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~packages</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;apt-getting-%s&quot;</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;-&quot;</span><span class="text"> </span><span class="id">packages</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> </span><span class="id">name</span><span class="text">
      </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;integration&quot;</span><span class="text">; </span><span class="string">&quot;apt-get&quot;</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">do_on</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
          </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;echo GO&quot;</span><span class="text">
          &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sudo apt-get update&quot;</span><span class="text">
          &amp;&amp; </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;sudo apt-get install -y %s&quot;</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot; &quot;</span><span class="text"> </span><span class="id">packages</span><span class="text">)
        ))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">file</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~path</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">as_host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">file</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">path</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = {
    </span><span class="id">box</span><span class="text">: </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">t</span><span class="text">;
  }
  </span><span class="kw">let</span><span class="text"> </span><span class="id">create</span><span class="text"> () =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">box</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">create</span><span class="text"> `</span><span class="kw2">Hadoop_spark_cluster</span><span class="text"> </span><span class="string">&quot;HadoopSpark&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    {</span><span class="id">box</span><span class="text">}
  </span><span class="kw">let</span><span class="text"> </span><span class="id">prepare</span><span class="text"> {</span><span class="id">box</span><span class="text">} =
    </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="kw4">~force_hostname</span><span class="text">:</span><span class="constant">false</span><span class="text"> </span><span class="id">box</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">destroy</span><span class="text"> {</span><span class="id">box</span><span class="text">} =
    </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">destroy</span><span class="text"> </span><span class="id">box</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ssh</span><span class="text"> {</span><span class="id">box</span><span class="text">} </span><span class="id">node</span><span class="text"> =
    </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;cd %s &amp;&amp; vagrant ssh %s&quot;</span><span class="text"> </span><span class="id">box</span><span class="text">.</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">dir</span><span class="text"> </span><span class="id">node</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">is_running</span><span class="text"> {</span><span class="id">box</span><span class="text">} = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">is_running</span><span class="text"> </span><span class="id">box</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> {</span><span class="id">box</span><span class="text">} </span><span class="id">name</span><span class="text"> = 
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="kw4">~add_ssh_options</span><span class="text">:[</span><span class="string">&quot;-F&quot;</span><span class="text">; </span><span class="id">box</span><span class="text">.</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">ssh_config</span><span class="text">]
      </span><span class="kw4">~playground</span><span class="text">:</span><span class="string">&quot;/tmp/KT/&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">finish_setup</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="comment">(* From https://github.com/vangj/vagrant-hadoop-2.4.1-spark-1.0.1/blob/master/README.md *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">namenode_setup</span><span class="text"> = [
      </span><span class="string">&quot;$HADOOP_PREFIX/bin/hdfs namenode -format myhadoop -force -nonInteractive&quot;</span><span class="text">;
      </span><span class="comment">(* We add `-force -nonInteractive` because the commad asks `Y/N`
         questions by default *)</span><span class="text">
    ] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">hdfs_setup</span><span class="text"> = [
      </span><span class="string">&quot;$HADOOP_PREFIX/sbin/hadoop-daemon.sh \
       --config $HADOOP_CONF_DIR --script hdfs start namenode&quot;</span><span class="text">;
      </span><span class="string">&quot;$HADOOP_PREFIX/sbin/hadoop-daemons.sh --config $HADOOP_CONF_DIR  \
       --script hdfs start datanode&quot;</span><span class="text">;
    ] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">yarn_setup</span><span class="text"> = [
      </span><span class="string">&quot;$HADOOP_YARN_HOME/sbin/yarn-daemon.sh --config $HADOOP_CONF_DIR start resourcemanager&quot;</span><span class="text">;
      </span><span class="string">&quot;$HADOOP_YARN_HOME/sbin/yarn-daemons.sh --config $HADOOP_CONF_DIR start nodemanager&quot;</span><span class="text">;
      </span><span class="string">&quot;$HADOOP_YARN_HOME/sbin/yarn-daemon.sh start proxyserver --config $HADOOP_CONF_DIR&quot;</span><span class="text">;
      </span><span class="string">&quot;$HADOOP_PREFIX/sbin/mr-jobhistory-daemon.sh start historyserver --config $HADOOP_CONF_DIR&quot;</span><span class="text">;
    ] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">make</span><span class="text"> = </span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~using</span><span class="text">:`</span><span class="kw2">Nohup_setsid</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_node1</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;node1&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Namenode + HDFS Setup&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:</span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">make</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
              (</span><span class="id">chain</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;sudo %s&quot;</span><span class="text">) (</span><span class="id">namenode_setup</span><span class="text"> @ </span><span class="id">hdfs_setup</span><span class="text">)))
          )
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_node2</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;node2&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Yarn Setup&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:</span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">make</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
              (</span><span class="id">chain</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;sudo %s&quot;</span><span class="text">) </span><span class="id">yarn_setup</span><span class="text">))
          )
        </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">on_node1</span><span class="text">]
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_yarn_setup</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;node2&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">witness</span><span class="text"> = </span><span class="string">&quot;/home/vagrant/pi-2-100&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">file_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Test Yarn Setup&quot;</span><span class="text">
        </span><span class="id">witness</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:</span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">make</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> (
              </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;yarn jar \
                  /usr/local/hadoop/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.4.1.jar \
                   pi 2 100 &gt; %s&quot;</span><span class="text"> </span><span class="id">witness</span><span class="text">
            )
          )
        </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">on_node2</span><span class="text">]
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test_yarn_setup</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">yarn_du_minus_sh</span><span class="text"> ({</span><span class="id">box</span><span class="text">} </span><span class="kw1">as</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="id">should</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;node2&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">application_name</span><span class="text"> =
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;yarn-du-sh-%s&quot;</span><span class="text">
        (</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">should_to_3rd_person_verb</span><span class="text"> </span><span class="id">should</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">test_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="id">application_name</span><span class="text"> </span><span class="id">should</span><span class="text">
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">yarn_distributed_shell</span><span class="text"> 
               </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~container_memory</span><span class="text">:(`</span><span class="kw2">MB</span><span class="text"> </span><span class="numeric">120</span><span class="text">)
               </span><span class="kw4">~timeout</span><span class="text">:(`</span><span class="kw2">Seconds</span><span class="text"> </span><span class="numeric">1800</span><span class="text">)
               </span><span class="kw4">~distributed_shell_shell_jar</span><span class="text">:</span><span class="string">&quot;/usr/local/hadoop-2.4.1/share/hadoop/yarn/hadoop-yarn-applications-distributedshell-2.4.1.jar&quot;</span><span class="text">
               </span><span class="kw4">~application_name</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
                   </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;hostname&quot;</span><span class="text">
                   &amp;&amp; (</span><span class="kw1">match</span><span class="text"> </span><span class="id">should</span><span class="text"> </span><span class="kw1">with</span><span class="text">
                       | `</span><span class="kw2">Should_succeed</span><span class="text"> -&gt; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;du -sh /usr/local/&quot;</span><span class="text">
                       | `</span><span class="kw2">Should_fail</span><span class="text"> -&gt; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;du -sh /doesnotexist/&quot;</span><span class="text">)
                 ))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">yarn_job_to_kill</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="id">host</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="string">&quot;node2&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">application_name</span><span class="text"> = </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;yarn-job-to-kill&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">test_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="id">application_name</span><span class="text"> `</span><span class="kw2">Should_be_killed</span><span class="text">
      </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">yarn_distributed_shell</span><span class="text"> 
               </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~container_memory</span><span class="text">:(`</span><span class="kw2">Raw</span><span class="text"> </span><span class="string">&quot;110&quot;</span><span class="text">)
               </span><span class="kw4">~timeout</span><span class="text">:(`</span><span class="kw2">Raw</span><span class="text"> </span><span class="string">&quot;1800000&quot;</span><span class="text">)
               </span><span class="kw4">~distributed_shell_shell_jar</span><span class="text">:</span><span class="string">&quot;/usr/local/hadoop-2.4.1/share/hadoop/yarn/hadoop-yarn-applications-distributedshell-2.4.1.jar&quot;</span><span class="text">
               </span><span class="kw4">~application_name</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
                   </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;hostname&quot;</span><span class="text"> &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sleep 400&quot;</span><span class="text">
                 ))


  </span><span class="kw">let</span><span class="text"> </span><span class="id">run_all_tests</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Hadoop-tests coordinator&quot;</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[
        </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;HadoopSpark-cluster post-install setup&quot;</span><span class="text">
          </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">finish_setup</span><span class="text"> </span><span class="id">t</span><span class="text">]
          </span><span class="kw4">~on_success_activate</span><span class="text">:[
            </span><span class="id">yarn_du_minus_sh</span><span class="text"> </span><span class="id">t</span><span class="text"> `</span><span class="kw2">Should_succeed</span><span class="text">;
            </span><span class="id">yarn_du_minus_sh</span><span class="text"> </span><span class="id">t</span><span class="text"> `</span><span class="kw2">Should_fail</span><span class="text">;
          ];
      ]

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_to_kill</span><span class="text"> </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Hadoop-to-kill-tests common ancestor&quot;</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[
        </span><span class="id">yarn_job_to_kill</span><span class="text"> </span><span class="id">t</span><span class="text">;
      ]
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Lsf</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
</span></pre>


<p>See <a href='http://www.openlava.org/home.html'>openlava.org</a>.</p>

<pre><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">config_files</span><span class="text"> </span><span class="kw4">~hostname</span><span class="text"> </span><span class="kw4">~usernames</span><span class="text"> () = [
    </span><span class="string">&quot;lsb.hosts&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> </span><span class="string">&quot;
Begin Host
HOST_NAME     MXJ JL/U   r1m    pg    ls     tmp  DISPATCH_WINDOW  # Keywords
#host0        1    1   3.5/4.5  15/   12/15  0      ()		   # Example
#host1       ()   2     3.5  15/18   12/    0/  (5:19:00-1:8:30 20:00-8:30)
#host2        ()   ()   3.5/5   18    15     ()     ()		   # Example
default       2   ()     ()    ()    ()     ()     ()		   # Example
End Host
    &quot;</span><span class="text">;
    </span><span class="string">&quot;lsb.params&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> </span><span class="string">&quot;
Begin Parameters
DEFAULT_QUEUE  = normal   #default job queue name
MBD_SLEEP_TIME = 10       #mbatchd scheduling interval (60 secs is default)
SBD_SLEEP_TIME = 7        #sbatchd scheduling interval (30 secs is default)
JOB_ACCEPT_INTERVAL = 1   #interval for any host to accept a job 
                          # (default is 1 (one-fold of MBD_SLEEP_TIME))
End Parameters
&quot;</span><span class="text">;
    </span><span class="string">&quot;lsb.queues&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> </span><span class="string">&quot;
Begin Queue
QUEUE_NAME   = normal
PRIORITY     = 30
NICE         = 20
DESCRIPTION  = For normal low priority jobs, running only if hosts are \
lightly loaded.
End Queue
&quot;</span><span class="text">;
    </span><span class="string">&quot;lsb.users&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;
Begin UserGroup
GROUP_NAME       GROUP_MEMBER              
#develop         (jwang long david ming)  
#system          (all)                    
#eng_users       (develop zhang ahmedk pangj) 
End UserGroup
Begin User
USER_NAME	MAX_JOBS	JL/P
#develop@        20              8
#support         50              -
%s
End User
  &quot;</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">usernames</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s 50 -&quot;</span><span class="text">)
       |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;\n&quot;</span><span class="text">)
                         );
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;lsf.cluster.%s&quot;</span><span class="text"> </span><span class="id">hostname</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;
Begin   ClusterAdmins
Administrators = (root %s)
End    ClusterAdmins

Begin   Host
HOSTNAME          model          type  server  r1m  RESOURCES
%s               !              !     1       -       -
End     Host
                                                  
Begin ResourceMap
RESOURCENAME  LOCATION
# tmp2          [default]
# nio           [all]
# console       [default]
End ResourceMap
  &quot;</span><span class="text"> 
    (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">usernames</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s&quot;</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot; &quot;</span><span class="text">)
    </span><span class="id">hostname</span><span class="text">
);

    </span><span class="string">&quot;lsf.shared&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;
Begin Cluster
ClusterName			# Keyword
%s
End Cluster
Begin HostType
TYPENAME                        # Keyword
linux
End HostType
Begin HostModel
MODELNAME  CPUFACTOR   ARCHITECTURE # keyword
# CPU factors are only comparisons.
IntelI5      100        (x86_64)
End HostModel
Begin Resource
RESOURCENAME  TYPE    INTERVAL INCREASING  DESCRIPTION 	      # Keywords
   fs         Boolean ()       ()          (File server)
   cs         Boolean ()       ()          (Compute server)
End Resource
&quot;</span><span class="text"> </span><span class="id">hostname</span><span class="text">);
    </span><span class="string">&quot;lsf.task&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> </span><span class="string">&quot;
Begin RemoteTasks
ar
as
cc/cpu
c89/cpu
gcc/cpu
g++/cpu
CC
compress/-:cpu:mem
compressdir/cpu:mem
deroff
diff
ditroff
dvi2ps
egrep
eqn
f77/cpu
fgrep/
gcc/cpu
gprof
grap/-
grep/-
ispell
lint
latex/cpu
make/cpu
nroff/cpu
od
pic
psroff
sort
spell
split
tbl
tpc
troff/cpu
ttc
uncompress/cpu:mem
uuencode/cpu
wc
what
zcat/cpu:mem
zmore/cpu
End RemoteTasks
  &quot;</span><span class="text">;
    </span><span class="string">&quot;lsf.conf&quot;</span><span class="text">, `</span><span class="kw2">File</span><span class="text"> </span><span class="string">&quot;config/lsf.conf&quot;</span><span class="text">;
  </span><span class="comment">(*
    hack found here:
https://groups.google.com/forum/#!topic/openlava-users/ezYDlyeb1wk
  *)</span><span class="text">
    </span><span class="string">&quot;hosts&quot;</span><span class="text">, `</span><span class="kw2">Inline</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;
127.0.0.1 %s
127.0.1.1 %s
&quot;</span><span class="text"> </span><span class="id">hostname</span><span class="text"> </span><span class="id">hostname</span><span class="text">);
  ]

  </span><span class="kw">let</span><span class="text"> </span><span class="id">install_lsf</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">packages</span><span class="text"> = [</span><span class="string">&quot;build-essential&quot;</span><span class="text">; </span><span class="string">&quot;libncurses-dev&quot;</span><span class="text">; </span><span class="string">&quot;tk8.4-dev&quot;</span><span class="text">] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;install-lsf&quot;</span><span class="text">
      </span><span class="kw4">~done_when</span><span class="text">:</span><span class="kw2">Condition</span><span class="text">.( </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">exec_is_installed</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw4">~exec</span><span class="text">:</span><span class="string">&quot;bsub&quot;</span><span class="text">)
      </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;intergration&quot;</span><span class="text">]
      </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">with_installed</span><span class="text"> </span><span class="kw4">~packages</span><span class="text"> </span><span class="id">box</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:(
        </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;wget&quot;</span><span class="text">; </span><span class="string">&quot;http://www.openlava.org/tarball/openlava-2.2.tar.gz&quot;</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;sudo&quot;</span><span class="text">; </span><span class="string">&quot;sh&quot;</span><span class="text">; </span><span class="string">&quot;-c&quot;</span><span class="text">; </span><span class="string">&quot;cd /usr/include &amp;&amp; rm -fr tcl &amp;&amp; ln -s tcl8.4 tcl&quot;</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;rm&quot;</span><span class="text">; </span><span class="string">&quot;-fr&quot;</span><span class="text">; </span><span class="string">&quot;openlava-2.2&quot;</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;tar&quot;</span><span class="text">; </span><span class="string">&quot;xvfz&quot;</span><span class="text">; </span><span class="string">&quot;openlava-2.2.tar.gz&quot;</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cd&quot;</span><span class="text">; </span><span class="string">&quot;openlava-2.2&quot;</span><span class="text">]
            &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;./configure --prefix /usr&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;make&quot;</span><span class="text">]
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;sudo&quot;</span><span class="text">; </span><span class="string">&quot;make&quot;</span><span class="text">; </span><span class="string">&quot;install&quot;</span><span class="text">]
          ))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">ensure_lsf_is_running</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">installed</span><span class="text"> = </span><span class="id">install_lsf</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">hostname</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">internal_hostname</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">usernames</span><span class="text"> = [</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">internal_username</span><span class="text"> </span><span class="id">box</span><span class="text">] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">config_files</span><span class="text"> = </span><span class="id">config_files</span><span class="text"> </span><span class="kw4">~hostname</span><span class="text"> </span><span class="kw4">~usernames</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">config_directory</span><span class="text"> = </span><span class="string">&quot;/usr/etc&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">conditions</span><span class="text"> = 
      </span><span class="kw2">Condition</span><span class="text">.</span><span class="id">chain_and</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">config_files</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">name</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">file</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">file</span><span class="text"> </span><span class="id">box</span><span class="text"> (</span><span class="id">config_directory</span><span class="text"> // </span><span class="id">name</span><span class="text">) </span><span class="kw">in</span><span class="text">
          </span><span class="id">file</span><span class="kw1">#</span><span class="id">exists</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;start-lsf&quot;</span><span class="text">
      </span><span class="kw4">~done_when</span><span class="text">:</span><span class="kw2">Condition</span><span class="text">.(
          </span><span class="id">conditions</span><span class="text">
          &amp;&amp; </span><span class="id">program</span><span class="text"> </span><span class="kw4">~returns</span><span class="text">:</span><span class="numeric">0</span><span class="text">
            </span><span class="kw4">~host</span><span class="text">:(</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">as_host</span><span class="text"> </span><span class="id">box</span><span class="text">)
            </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;timeout&quot;</span><span class="text">; </span><span class="string">&quot;1&quot;</span><span class="text">; </span><span class="string">&quot;sh&quot;</span><span class="text">; </span><span class="string">&quot;-c&quot;</span><span class="text">; </span><span class="string">&quot;bjobs; exit 0&quot;</span><span class="text">]))
      </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;integration&quot;</span><span class="text">]
      </span><span class="kw4">~depends_on</span><span class="text">:[ </span><span class="id">installed</span><span class="text">; ]
      </span><span class="kw4">~make</span><span class="text">:( </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
          </span><span class="id">chain</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">config_files</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">name</span><span class="text">, </span><span class="id">content</span><span class="text">) -&gt;
              </span><span class="kw1">match</span><span class="text"> </span><span class="id">content</span><span class="text"> </span><span class="kw1">with</span><span class="text">
              | `</span><span class="kw2">Inline</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
                </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;sudo&quot;</span><span class="text">; </span><span class="string">&quot;sh&quot;</span><span class="text">; </span><span class="string">&quot;-c&quot;</span><span class="text">;
                      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;echo %s &gt; %s&quot;</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> </span><span class="id">c</span><span class="text">)
                        (</span><span class="id">config_directory</span><span class="text"> // </span><span class="id">name</span><span class="text">)]
              | `</span><span class="kw2">File</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;sudo&quot;</span><span class="text">; </span><span class="string">&quot;cp&quot;</span><span class="text">; </span><span class="string">&quot;openlava-2.2&quot;</span><span class="text"> // </span><span class="id">f</span><span class="text">; </span><span class="id">config_directory</span><span class="text"> // </span><span class="id">name</span><span class="text">]
            ))
          &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;sudo&quot;</span><span class="text">; </span><span class="string">&quot;/usr/etc/openlava&quot;</span><span class="text">; </span><span class="string">&quot;start&quot;</span><span class="text">]
        ))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">lsf_job</span><span class="text"> ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> () =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">output</span><span class="text"> = </span><span class="string">&quot;/tmp/du-sh-dollar-home&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">as_host</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;lsf-1&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">file_target</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="id">output</span><span class="text"> ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[ </span><span class="id">ensure_lsf_is_running</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> ]
      </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;integration&quot;</span><span class="text">; </span><span class="string">&quot;lsf&quot;</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:(
        </span><span class="id">lsf</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;du -sh $HOME &gt; %s&quot;</span><span class="text"> </span><span class="id">output</span><span class="text">
                                 &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cat&quot;</span><span class="text">; </span><span class="id">output</span><span class="text">])
          </span><span class="kw4">~queue</span><span class="text">:</span><span class="string">&quot;normal&quot;</span><span class="text">
      )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_lsf_job</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="id">should</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">as_host</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> =
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;lsf-test-that-%s&quot;</span><span class="text">
        (</span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">should_to_3rd_person_verb</span><span class="text"> </span><span class="id">should</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">test_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="id">should</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[
        </span><span class="id">lsf_job</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> ();
        </span><span class="id">ensure_lsf_is_running</span><span class="text"> </span><span class="kw4">~box</span><span class="text">;
      ]
      </span><span class="kw4">~make</span><span class="text">:(
        </span><span class="id">lsf</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="kw4">~queue</span><span class="text">:</span><span class="string">&quot;normal&quot;</span><span class="text">
          </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="kw1">match</span><span class="text"> </span><span class="id">should</span><span class="text"> </span><span class="kw1">with</span><span class="text">
            | `</span><span class="kw2">Should_fail</span><span class="text"> -&gt; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;ls /somewierd/path/&quot;</span><span class="text">
            | `</span><span class="kw2">Should_succeed</span><span class="text"> -&gt; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;du -sh $HOME&quot;</span><span class="text">
          )
        )

  </span><span class="kw">let</span><span class="text"> </span><span class="id">run_all_tests</span><span class="text"> </span><span class="id">box</span><span class="text"> =
    </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;LSF tests common ancestor&quot;</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[
        </span><span class="id">test_lsf_job</span><span class="text"> </span><span class="id">box</span><span class="text"> `</span><span class="kw2">Should_fail</span><span class="text">;
        </span><span class="id">test_lsf_job</span><span class="text"> </span><span class="id">box</span><span class="text"> `</span><span class="kw2">Should_succeed</span><span class="text">;
      ]
</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(* Old stuff:
   let setup_pbs ~box () =
   let packages =
    [&quot;torque-server&quot;; &quot;torque-scheduler&quot;; &quot;torque-client&quot;; &quot;torque-mom&quot;] in
   let open Ketrew.EDSL in
   let setup = [
    sprintf &quot;echo '%s' &gt; /var/spool/torque/server_name&quot;
      (Vagrant_box.internal_hostname box);
    &quot;sed -i 's/127.0.1.1/127.0.0.1/' /etc/hosts&quot;;
   ] in
   target &quot;install-pbs&quot;
    (* ~done_when:Condition.( Vagrant_box.exec_is_installed box ~exec:&quot;qsub&quot;) *)</span><span class="text">
    </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;intergration&quot;</span><span class="text">]
    </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">with_installed</span><span class="text"> </span><span class="kw4">~packages</span><span class="text"> </span><span class="id">box</span><span class="text">]
    </span><span class="kw4">~make</span><span class="text">:(
      </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw4">~program</span><span class="text">:</span><span class="kw2">Program</span><span class="text">.(
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">setup</span><span class="text"> </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">sudo</span><span class="text"> |&gt; </span><span class="id">chain</span><span class="text">
        ))
*)
</span><span class="kw">let</span><span class="text"> </span><span class="id">finish_pbs_setup</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">as_host</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">witness</span><span class="text"> = </span><span class="id">file</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;/home/vagrant/.ssh/done&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ssh_config</span><span class="text"> =
    </span><span class="string">&quot;Host master\n\
    \  StrictHostKeyChecking no\n\
    \  UserKnownHostsFile=/dev/null\n\
    &quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">setup</span><span class="text"> = [
    </span><span class="string">&quot;ssh-keygen -t dsa -P '' -f ~/.ssh/id_dsa&quot;</span><span class="text">;
    </span><span class="string">&quot;cat .ssh/id_dsa.pub &gt;&gt; .ssh/authorized_keys&quot;</span><span class="text">;
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;echo %s &gt;&gt; .ssh/config&quot;</span><span class="text"> (</span><span class="kw2">Filename</span><span class="text">.</span><span class="id">quote</span><span class="text"> </span><span class="id">ssh_config</span><span class="text">);
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;echo Done &gt; %s&quot;</span><span class="text"> </span><span class="id">witness</span><span class="kw1">#</span><span class="id">path</span><span class="text">;
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;install-pbs&quot;</span><span class="text">
    </span><span class="comment">(* ~done_when:Condition.( Vagrant_box.exec_is_installed box ~exec:&quot;qsub&quot;) *)</span><span class="text">
    </span><span class="kw4">~done_when</span><span class="text">:(</span><span class="id">witness</span><span class="kw1">#</span><span class="id">exists</span><span class="text">)
    </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;intergration&quot;</span><span class="text">]
    </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">do_on</span><span class="text"> </span><span class="id">box</span><span class="text">
             </span><span class="kw4">~program</span><span class="text">:</span><span class="kw2">Program</span><span class="text">.( </span><span class="id">chain</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">sh</span><span class="text"> </span><span class="id">setup</span><span class="text">)))

</span><span class="kw">let</span><span class="text"> </span><span class="id">pbs_job</span><span class="text"> ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> </span><span class="id">kind</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">setup</span><span class="text"> = </span><span class="id">finish_pbs_setup</span><span class="text"> </span><span class="kw4">~box</span><span class="text"> () </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">match</span><span class="text"> </span><span class="id">kind</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Always_runs</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">as_host</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;pbs-2&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">target</span><span class="text"> </span><span class="id">name</span><span class="text"> ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">setup</span><span class="text">]
      </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;integration&quot;</span><span class="text">; </span><span class="string">&quot;pbs&quot;</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:( </span><span class="id">pbs</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.( 
          </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;echo \&quot;PBS-2 Starts:\n%s\&quot;&quot;</span><span class="text">
            (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s: $%s\n&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">s</span><span class="text">)
               [</span><span class="string">&quot;PBS_O_HOST&quot;</span><span class="text">; </span><span class="string">&quot;PBS_SERVER&quot;</span><span class="text">]
            |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;&quot;</span><span class="text">)
          &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;echo PBS-2 Starts &gt;&amp;2&quot;</span><span class="text">
          &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sleep 10&quot;</span><span class="text">
          &amp;&amp; </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;echo PBS-2 Ends&quot;</span><span class="text">
        ))
  | `</span><span class="kw2">File_target</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">output</span><span class="text"> = </span><span class="string">&quot;/tmp/du-sh-slash&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">as_host</span><span class="text"> </span><span class="id">box</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;pbs-1&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">file_target</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="id">output</span><span class="text"> ?</span><span class="id">on_success_activate</span><span class="text"> ?</span><span class="id">on_failure_activate</span><span class="text">
      </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">setup</span><span class="text">]
      </span><span class="kw4">~tags</span><span class="text">:[</span><span class="string">&quot;integration&quot;</span><span class="text">; </span><span class="string">&quot;pbs&quot;</span><span class="text">]
      </span><span class="kw4">~make</span><span class="text">:(
        </span><span class="id">pbs</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(
            </span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;sleep 42&quot;</span><span class="text">
            &amp;&amp; </span><span class="id">shf</span><span class="text"> </span><span class="string">&quot;du -sh $HOME &gt; %s&quot;</span><span class="text"> </span><span class="id">output</span><span class="text">
            &amp;&amp; </span><span class="id">exec</span><span class="text"> [</span><span class="string">&quot;cat&quot;</span><span class="text">; </span><span class="id">output</span><span class="text">])
        </span><span class="comment">(* ~queue:&quot;normal&quot; *)</span><span class="text">
      )


</span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">lsf_host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">create</span><span class="text"> `</span><span class="kw2">Precise64</span><span class="text"> </span><span class="string">&quot;LsfTestHost&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">pbs_host</span><span class="text"> = </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">create</span><span class="text"> `</span><span class="kw2">Audy_torque</span><span class="text"> </span><span class="string">&quot;PbsTestHost&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text"> =
    </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">create</span><span class="text"> () </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">object</span><span class="text">  (</span><span class="id">self</span><span class="text">)
    </span><span class="kw">method</span><span class="text"> </span><span class="id">prepare</span><span class="text"> </span><span class="id">what</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="string">&quot;ALL&quot;</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">prepare_hadoop</span><span class="text"> = </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">prepare_pbs</span><span class="text"> =
          </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="id">pbs_host</span><span class="text">
            </span><span class="kw4">~on_success_activate</span><span class="text">:[</span><span class="id">prepare_hadoop</span><span class="text">]
            </span><span class="kw4">~on_failure_activate</span><span class="text">:[</span><span class="id">prepare_hadoop</span><span class="text">]
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">prepare_lsf</span><span class="text"> = 
          </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="id">lsf_host</span><span class="text">
            </span><span class="kw4">~on_success_activate</span><span class="text">:[</span><span class="id">prepare_pbs</span><span class="text">]
            </span><span class="kw4">~on_failure_activate</span><span class="text">:[</span><span class="id">prepare_pbs</span><span class="text">]
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Trigger VM preparation&quot;</span><span class="text"> </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">prepare_lsf</span><span class="text">]
      | </span><span class="string">&quot;LSF&quot;</span><span class="text"> -&gt; </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="id">lsf_host</span><span class="text">
      | </span><span class="string">&quot;PBS&quot;</span><span class="text"> -&gt; </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="id">pbs_host</span><span class="text">
      | </span><span class="string">&quot;Hadoop&quot;</span><span class="text"> -&gt; </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">prepare</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text">
      | </span><span class="id">other</span><span class="text"> -&gt;
        </span><span class="id">failwithf</span><span class="text"> </span><span class="string">&quot;Don't know how to “prepare” %S&quot;</span><span class="text"> </span><span class="id">other</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">go</span><span class="text"> =
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Run Tests&quot;</span><span class="text">
        </span><span class="kw4">~depends_on</span><span class="text">:[
          </span><span class="kw2">Lsf</span><span class="text">.</span><span class="id">run_all_tests</span><span class="text"> </span><span class="id">lsf_host</span><span class="text">;
          </span><span class="id">pbs_job</span><span class="text"> </span><span class="kw4">~box</span><span class="text">:</span><span class="id">pbs_host</span><span class="text"> `</span><span class="kw2">Always_runs</span><span class="text">;
          </span><span class="id">pbs_job</span><span class="text"> </span><span class="kw4">~box</span><span class="text">:</span><span class="id">pbs_host</span><span class="text"> `</span><span class="kw2">File_target</span><span class="text">;
          </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">run_all_tests</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text">;        
        ]
    </span><span class="kw">method</span><span class="text"> </span><span class="id">start_jobs_to_kill</span><span class="text"> =
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Jobs to kill&quot;</span><span class="text">
        </span><span class="kw4">~depends_on</span><span class="text">:[
          </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">test_to_kill</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text">;        
        ]
    </span><span class="kw">method</span><span class="text"> </span><span class="id">clean_up</span><span class="text"> =
      </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;Destroy VMs&quot;</span><span class="text">
        </span><span class="kw4">~depends_on</span><span class="text">:[
          </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">destroy</span><span class="text"> </span><span class="id">lsf_host</span><span class="text">;
          </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">destroy</span><span class="text"> </span><span class="id">pbs_host</span><span class="text">;
          </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">destroy</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text">;
        ]
    </span><span class="kw">method</span><span class="text"> </span><span class="id">box_names</span><span class="text"> = [</span><span class="string">&quot;LSF&quot;</span><span class="text">; </span><span class="string">&quot;PBS&quot;</span><span class="text">; </span><span class="string">&quot;Hadoop&quot;</span><span class="text">]
    </span><span class="kw">method</span><span class="text"> </span><span class="id">ssh</span><span class="text"> </span><span class="id">spec</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="id">spec</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">':'</span><span class="text">) </span><span class="kw1">with</span><span class="text">
      | </span><span class="string">&quot;LSF&quot;</span><span class="text"> :: [] -&gt; </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="id">lsf_host</span><span class="text">
      | </span><span class="string">&quot;PBS&quot;</span><span class="text"> :: [] -&gt; </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="id">pbs_host</span><span class="text">
      | </span><span class="string">&quot;Hadoop&quot;</span><span class="text"> :: </span><span class="id">node</span><span class="text"> :: [] -&gt; </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text"> </span><span class="id">node</span><span class="text">
      | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="id">failwithf</span><span class="text"> </span><span class="string">&quot;Unkown “Box”: %S&quot;</span><span class="text"> </span><span class="id">spec</span><span class="text">
    </span><span class="kw">method</span><span class="text"> </span><span class="id">is_running</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | </span><span class="string">&quot;LSF&quot;</span><span class="text"> -&gt; </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">is_running</span><span class="text"> </span><span class="id">lsf_host</span><span class="text">
    | </span><span class="string">&quot;PBS&quot;</span><span class="text"> -&gt; </span><span class="kw2">Vagrant_box</span><span class="text">.</span><span class="id">is_running</span><span class="text"> </span><span class="id">pbs_host</span><span class="text">
    | </span><span class="string">&quot;Hadoop&quot;</span><span class="text"> -&gt; </span><span class="kw2">Vagrant_hadoop_cluster</span><span class="text">.</span><span class="id">is_running</span><span class="text"> </span><span class="id">hadoop_host</span><span class="text">;
    | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="id">failwithf</span><span class="text"> </span><span class="string">&quot;Unkown “Box”: %S&quot;</span><span class="text"> </span><span class="id">other</span><span class="text">

  </span><span class="kw1">end</span><span class="text">

</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Cmdliner</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">version</span><span class="text"> = </span><span class="kw2">Lazy</span><span class="text">.</span><span class="id">force</span><span class="text"> </span><span class="kw2">Ketrew_metadata</span><span class="text">.</span><span class="id">version</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_command</span><span class="text"> </span><span class="kw4">~info</span><span class="text"> </span><span class="kw4">~term</span><span class="text"> = (</span><span class="id">term</span><span class="text">, </span><span class="id">info</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_command_of_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="kw4">~doc</span><span class="text"> </span><span class="id">make_target</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">the_name</span><span class="text"> = </span><span class="id">name</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">sub_command</span><span class="text">
      </span><span class="kw4">~info</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(</span><span class="id">info</span><span class="text"> </span><span class="id">the_name</span><span class="text"> </span><span class="kw4">~version</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">)
      </span><span class="kw4">~term</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(
          </span><span class="id">pure</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="kw2">Ketrew_client</span><span class="text">.</span><span class="id">submit</span><span class="text"> (
                </span><span class="id">make_target</span><span class="text"> ()
              ))
          $ </span><span class="id">pure</span><span class="text"> ()
        )
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">prepare</span><span class="text"> =
    </span><span class="id">sub_command_of_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;prepare&quot;</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Setup the VM(s)&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">test</span><span class="kw1">#</span><span class="id">prepare</span><span class="text"> </span><span class="string">&quot;ALL&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">hadoop_prepare</span><span class="text"> =
    </span><span class="id">sub_command_of_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;hadoop-prepare&quot;</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Setup the VM(s)&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">test</span><span class="kw1">#</span><span class="id">prepare</span><span class="text"> </span><span class="string">&quot;Hadoop&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">go</span><span class="text"> =
    </span><span class="id">sub_command_of_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;go&quot;</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Do the test&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">test</span><span class="kw1">#</span><span class="id">go</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">start_jobs_to_kill</span><span class="text"> =
    </span><span class="id">sub_command_of_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;start-jobs-to-kill&quot;</span><span class="text">
      </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Start jobs that should be killed&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">test</span><span class="kw1">#</span><span class="id">start_jobs_to_kill</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">clean_up</span><span class="text"> =
    </span><span class="id">sub_command_of_target</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;clean-up&quot;</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Destroy the VM(s)&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">test</span><span class="kw1">#</span><span class="id">clean_up</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ssh</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> =
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;SSH into a VM (%s)&quot;</span><span class="text">
        (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text">) </span><span class="id">test</span><span class="kw1">#</span><span class="id">box_names</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="id">sub_command</span><span class="text"> </span><span class="kw4">~info</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(</span><span class="id">info</span><span class="text"> </span><span class="string">&quot;ssh&quot;</span><span class="text"> </span><span class="kw4">~version</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">)
      </span><span class="kw4">~term</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(
          </span><span class="id">pure</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">name</span><span class="text"> -&gt; </span><span class="id">test</span><span class="kw1">#</span><span class="id">ssh</span><span class="text"> </span><span class="id">name</span><span class="text">)
          $ </span><span class="kw2">Arg</span><span class="text">.(</span><span class="id">required</span><span class="text"> @@ </span><span class="id">pos</span><span class="text"> </span><span class="numeric">0</span><span class="text"> (</span><span class="id">some</span><span class="text"> </span><span class="kw3">string</span><span class="text">) </span><span class="kw2">None</span><span class="text">
                 @@ </span><span class="id">info</span><span class="text"> [] </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Name of the VM&quot;</span><span class="text">))
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">is_running</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> =
      </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Check if a VM is running (%s)&quot;</span><span class="text">
        (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text">) </span><span class="id">test</span><span class="kw1">#</span><span class="id">box_names</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="id">sub_command</span><span class="text"> </span><span class="kw4">~info</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(</span><span class="id">info</span><span class="text"> </span><span class="string">&quot;is-running&quot;</span><span class="text"> </span><span class="kw4">~version</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">)
      </span><span class="kw4">~term</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(
          </span><span class="id">pure</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">name</span><span class="text"> -&gt;
              </span><span class="kw1">if</span><span class="text"> </span><span class="id">test</span><span class="kw1">#</span><span class="id">is_running</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">exit</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">exit</span><span class="text"> </span><span class="numeric">3</span><span class="text">)
          $ </span><span class="kw2">Arg</span><span class="text">.(</span><span class="id">required</span><span class="text"> @@ </span><span class="id">pos</span><span class="text"> </span><span class="numeric">0</span><span class="text"> (</span><span class="id">some</span><span class="text"> </span><span class="kw3">string</span><span class="text">) </span><span class="kw2">None</span><span class="text">
                 @@ </span><span class="id">info</span><span class="text"> [] </span><span class="kw4">~doc</span><span class="text">:</span><span class="string">&quot;Name of the VM&quot;</span><span class="text">))
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">check_tests</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> = </span><span class="string">&quot;Check that tests succeeded or failed appropriately&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">sub_command</span><span class="text"> </span><span class="kw4">~info</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(</span><span class="id">info</span><span class="text"> </span><span class="string">&quot;check-tests&quot;</span><span class="text"> </span><span class="kw4">~version</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">)
      </span><span class="kw4">~term</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(
          </span><span class="id">pure</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">check_test_targets</span><span class="text"> ())
          $ </span><span class="id">pure</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_kill_list</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> = </span><span class="string">&quot;Display list of IDs to kill externally&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">sub_command</span><span class="text"> </span><span class="kw4">~info</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(</span><span class="id">info</span><span class="text"> </span><span class="string">&quot;to-kill&quot;</span><span class="text"> </span><span class="kw4">~version</span><span class="text"> </span><span class="kw4">~doc</span><span class="text">)
      </span><span class="kw4">~term</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(
          </span><span class="id">pure</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="id">shellf</span><span class="text"> </span><span class="string">&quot;cat %s&quot;</span><span class="text"> </span><span class="kw2">Test_host</span><span class="text">.</span><span class="id">to_kill_file</span><span class="text">)
          $ </span><span class="id">pure</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
  </span><span class="comment">(* $ Arg.(unit)) in *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">default_cmd</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> = </span><span class="string">&quot;Integration Test for Ketrew&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">man</span><span class="text"> = [] </span><span class="kw">in</span><span class="text">
    </span><span class="id">sub_command</span><span class="text">
      </span><span class="kw4">~term</span><span class="text">:</span><span class="kw2">Term</span><span class="text">.(</span><span class="id">ret</span><span class="text"> (</span><span class="id">pure</span><span class="text"> (`</span><span class="kw2">Help</span><span class="text"> (`</span><span class="kw2">Plain</span><span class="text">, </span><span class="kw2">None</span><span class="text">))))
      </span><span class="kw4">~info</span><span class="text">:(</span><span class="kw2">Term</span><span class="text">.</span><span class="id">info</span><span class="text"> </span><span class="string">&quot;ketrew-integration-test&quot;</span><span class="text"> </span><span class="kw4">~version</span><span class="text"> </span><span class="kw4">~doc</span><span class="text"> </span><span class="kw4">~man</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">cmds</span><span class="text"> = [
    </span><span class="id">prepare</span><span class="text">;
    </span><span class="id">hadoop_prepare</span><span class="text">;
    </span><span class="id">go</span><span class="text">;
    </span><span class="id">start_jobs_to_kill</span><span class="text">;
    </span><span class="id">clean_up</span><span class="text">;
    </span><span class="id">ssh</span><span class="text">;
    </span><span class="id">is_running</span><span class="text">;
    </span><span class="id">check_tests</span><span class="text">;
    </span><span class="id">to_kill_list</span><span class="text">;
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Term</span><span class="text">.</span><span class="id">eval_choice</span><span class="text">  </span><span class="id">default_cmd</span><span class="text"> </span><span class="id">cmds</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">exit</span><span class="text"> </span><span class="numeric">1</span><span class="text">
  | `</span><span class="kw2">Version</span><span class="text"> | `</span><span class="kw2">Help</span><span class="text"> -&gt; </span><span class="id">exit</span><span class="text"> </span><span class="numeric">0</span><span class="text">

</span></pre></div></div></div></body><html>