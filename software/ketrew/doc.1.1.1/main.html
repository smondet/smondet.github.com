 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: Main Test</title></head><body><div class="container"><h1>Ketrew: Main Test</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li><li><a href='Developer_Documentation.html'>Developer Documentation</a></li><li><a href='Glossary.html'>Glossary</a></li><li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li><li><a href='Server_Commands.html'>Server Commands</a></li><li><a href='The_Configuration_File.html'>The Configuration File</a></li><li><a href='The_HTTP_API.html'>The HTTP API</a></li><li><a href='Workflow_Examples.html'>Workflow Examples</a></li><li><a href='dummy_plugin.html'>Plugin Example</a></li><li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li><li><a href='integration.html'>Integration Test</a></li><li><a href='main.html'>Main Test</a></li><li><a href='preconfigured_main.html'>Preconfigured Main Example</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for the <a href='../index.html'><code>master</code></a> branch</li><li>Documentation for <a href='../doc.0.0.0/index.html'>version 0.0.0</a></li><li>Documentation for <a href='../doc.1.0.0/index.html'>version 1.0.0</a></li><li>Documentation for <a href='../doc.1.1.0/index.html'>version 1.1.0</a></li><li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li><li>Up: <a href='../../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="comment">(**************************************************************************)</span><span class="text">
</span><span class="comment">(*    Copyright 2014, 2015:                                               *)</span><span class="text">
</span><span class="comment">(*          Sebastien Mondet &lt;seb@mondet.org&gt;,                            *)</span><span class="text">
</span><span class="comment">(*          Leonid Rozenberg &lt;leonidr@gmail.com&gt;,                         *)</span><span class="text">
</span><span class="comment">(*          Arun Ahuja &lt;aahuja11@gmail.com&gt;,                              *)</span><span class="text">
</span><span class="comment">(*          Jeff Hammerbacher &lt;jeff.hammerbacher@gmail.com&gt;               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);       *)</span><span class="text">
</span><span class="comment">(*  you may not use this file except in compliance with the License.      *)</span><span class="text">
</span><span class="comment">(*  You may obtain a copy of the License at                               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*      http://www.apache.org/licenses/LICENSE-2.0                        *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Unless required by applicable law or agreed to in writing, software   *)</span><span class="text">
</span><span class="comment">(*  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,     *)</span><span class="text">
</span><span class="comment">(*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or       *)</span><span class="text">
</span><span class="comment">(*  implied.  See the License for the specific language governing         *)</span><span class="text">
</span><span class="comment">(*  permissions and limitations under the License.                        *)</span><span class="text">
</span><span class="comment">(**************************************************************************)</span><span class="text">

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_pervasives</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_unix_io</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Test</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Tests_failed</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">max_failures</span><span class="text"> = 
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;MAX_FAILURES&quot;</span><span class="text"> |&gt; </span><span class="id">int_of_string</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">2_000_000</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">failed_tests</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> []
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="id">failed_tests</span><span class="text"> := </span><span class="id">s</span><span class="text"> :: !</span><span class="id">failed_tests</span><span class="text">;
    </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> !</span><span class="id">failed_tests</span><span class="text"> &gt; </span><span class="id">max_failures</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
      </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Some tests failed: &quot;</span><span class="text"> %</span><span class="id">n</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> </span><span class="id">s</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">failed_tests</span><span class="text">)
           @ </span><span class="id">error</span><span class="text">);
      </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Tests_failed</span><span class="text"> 
    ) </span><span class="kw1">else</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">over_verbose</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;KETREW_TEST_VERBOSE&quot;</span><span class="text"> = </span><span class="string">&quot;true&quot;</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">checkf</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">function</span><span class="text">
      | </span><span class="id">name</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">not</span><span class="text"> </span><span class="id">b</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">name</span><span class="text">
      | </span><span class="id">name</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">over_verbose</span><span class="text"> -&gt;
        </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Testing &quot;</span><span class="text"> % </span><span class="id">quote</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;: SUCCESS&quot;</span><span class="text"> @ </span><span class="id">warning</span><span class="text">);
      | </span><span class="numeric">_</span><span class="text"> -&gt; ()) </span><span class="id">fmt</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">new_db_file</span><span class="text"> () =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">db_file</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> (</span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getcwd</span><span class="text"> ()) </span><span class="string">&quot;_kdb_test&quot;</span><span class="text">  </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">System</span><span class="text">.</span><span class="kw2">Shell</span><span class="text">.</span><span class="id">do_or_fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;rm -rf %s&quot;</span><span class="text"> </span><span class="id">db_file</span><span class="text">)
      </span><span class="kw10">&gt;&gt;</span><span class="text">&lt; </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">return</span><span class="text"> </span><span class="id">db_file</span><span class="text">

  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Target</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">check_history</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~matches</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">msg</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">state</span><span class="text"> = </span><span class="kw2">Ketrew_target</span><span class="text">.(</span><span class="id">state</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">b</span><span class="text"> = </span><span class="id">state</span><span class="text"> |&gt; </span><span class="id">matches</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">not</span><span class="text"> </span><span class="id">b</span><span class="text"> &amp;&amp; </span><span class="id">over_verbose</span><span class="text"> </span><span class="kw1">then</span><span class="text">
            </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Test: &quot;</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">msg</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;: unexpected history: &quot;</span><span class="text">
                 % </span><span class="id">n</span><span class="text"> % </span><span class="id">indent</span><span class="text"> (</span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="kw2">State</span><span class="text">.</span><span class="id">log</span><span class="text"> </span><span class="id">state</span><span class="text">) @ </span><span class="id">warning</span><span class="text">);
          </span><span class="id">checkf</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="string">&quot;%s&quot;</span><span class="text"> </span><span class="id">msg</span><span class="text">
        ) </span><span class="id">fmt</span><span class="text">
  </span><span class="kw1">end</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_0</span><span class="text"> () =
  </span><span class="kw2">Lwt_main</span><span class="text">.</span><span class="id">run</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">new_db_file</span><span class="text"> ()
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">db_file</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = 
      </span><span class="kw2">Ketrew_configuration</span><span class="text">.</span><span class="id">engine</span><span class="text"> </span><span class="kw4">~database_parameters</span><span class="text">:</span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">with_engine</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> -&gt;
        </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="kw2">Run_automaton</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text">
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt;
        </span><span class="kw2">Test</span><span class="text">.</span><span class="id">checkf</span><span class="text"> (</span><span class="id">not</span><span class="text"> </span><span class="id">v</span><span class="text">) </span><span class="string">&quot;1st step, nothing to do&quot;</span><span class="text">;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">test_steps</span><span class="text"> </span><span class="kw4">~checks</span><span class="text"> </span><span class="id">msg</span><span class="text"> =
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">foldi</span><span class="text"> </span><span class="id">checks</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">return</span><span class="text"> ()) </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">check_step</span><span class="text"> -&gt;
            </span><span class="id">prev</span><span class="text"> </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="kw2">Run_automaton</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text">
            </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">do_checks</span><span class="text"> = 
              </span><span class="kw">function</span><span class="text">
              | `</span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
              | `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="id">ret</span><span class="text"> -&gt;
                </span><span class="kw2">Test</span><span class="text">.</span><span class="id">checkf</span><span class="text"> (</span><span class="id">ret</span><span class="text"> = </span><span class="id">v</span><span class="text">) </span><span class="string">&quot;step %d of %s step-returned: %b&quot;</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">msg</span><span class="text"> </span><span class="id">v</span><span class="text">;
                </span><span class="id">return</span><span class="text"> ()
              | `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">id</span><span class="text">, </span><span class="id">matches</span><span class="text">) -&gt;
                </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">get_target</span><span class="text"> </span><span class="id">engine</span><span class="text"> </span><span class="id">id</span><span class="text">
                </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">re_re_target_01</span><span class="text"> -&gt;
                </span><span class="kw2">Test</span><span class="text">.</span><span class="kw2">Target</span><span class="text">.</span><span class="id">check_history</span><span class="text"> </span><span class="id">re_re_target_01</span><span class="text"> </span><span class="kw4">~matches</span><span class="text">
                  </span><span class="string">&quot;step %d of %s target-matching %s&quot;</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">msg</span><span class="text"> </span><span class="id">id</span><span class="text">;
                </span><span class="id">return</span><span class="text"> ()
              | `</span><span class="kw2">And</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
                </span><span class="kw2">Deferred_list</span><span class="text">.</span><span class="id">while_sequential</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">do_checks</span><span class="text">
                </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text"> : </span><span class="kw3">unit</span><span class="text"> </span><span class="kw3">list</span><span class="text">) -&gt;
                </span><span class="id">return</span><span class="text"> ()
            </span><span class="kw">in</span><span class="text">
            </span><span class="id">do_checks</span><span class="text"> </span><span class="id">check_step</span><span class="text">
          </span><span class="kw1">end</span><span class="text"> 
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">target_01</span><span class="text"> = </span><span class="kw2">Ketrew_edsl</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;01&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">target_01</span><span class="kw1">#</span><span class="id">activate</span><span class="text">;
        </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">add_targets</span><span class="text"> </span><span class="id">engine</span><span class="text"> [</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">render</span><span class="text">]
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="kw2">State</span><span class="text">.</span><span class="kw2">Is</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_steps</span><span class="text"> </span><span class="string">&quot;almost empty target&quot;</span><span class="text"> </span><span class="kw4">~checks</span><span class="text">:[
          `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="constant">true</span><span class="text">;
          `</span><span class="kw2">And</span><span class="text"> [
            `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="constant">true</span><span class="text">;
            `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">building</span><span class="text">);
          ];
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">starting</span><span class="text">);
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">successfully_did_nothing</span><span class="text">);
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">verified_success</span><span class="text">);
          `</span><span class="kw2">Target_is</span><span class="text"> (</span><span class="id">target_01</span><span class="kw1">#</span><span class="id">id</span><span class="text">, </span><span class="id">finished</span><span class="text">);
          `</span><span class="kw2">Step_returns</span><span class="text"> </span><span class="constant">false</span><span class="text">;
          `</span><span class="kw2">None</span><span class="text">;
        ]
        </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="id">return</span><span class="text"> ())
    </span><span class="kw10">&gt;&gt;=</span><span class="text"> </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">return</span><span class="text"> ()
  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_0: Ketrew ERROR:  &quot;</span><span class="text"> %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_0 ends with error&quot;</span><span class="text">


</span><span class="kw">type</span><span class="text"> </span><span class="id">state</span><span class="text"> = { </span><span class="id">name</span><span class="text"> : </span><span class="kw3">string</span><span class="text"> }
</span><span class="kw">type</span><span class="text"> </span><span class="id">action</span><span class="text"> = </span><span class="kw3">string</span><span class="text">
</span><span class="kw">type</span><span class="text"> </span><span class="id">tree</span><span class="text"> = [
  | `</span><span class="kw2">Leaf</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">state</span><span class="text">
  | `</span><span class="kw2">Node</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">state</span><span class="text"> * </span><span class="id">action</span><span class="text"> * (</span><span class="kw3">string</span><span class="text"> * </span><span class="id">tree</span><span class="text">) </span><span class="kw3">list</span><span class="text">
]
</span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">tree_to_log</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Log</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Leaf</span><span class="text"> {</span><span class="id">name</span><span class="text">} -&gt; </span><span class="id">braces</span><span class="text"> (</span><span class="id">s</span><span class="text"> </span><span class="id">name</span><span class="text">)
  | `</span><span class="kw2">Node</span><span class="text"> ({</span><span class="id">name</span><span class="text">}, </span><span class="id">action</span><span class="text">, </span><span class="id">trees</span><span class="text">) -&gt;
    </span><span class="id">parens</span><span class="text"> (</span><span class="id">braces</span><span class="text"> (</span><span class="id">s</span><span class="text"> </span><span class="id">name</span><span class="text">) % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot; â†’ &quot;</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">action</span><span class="text"> 
            % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">response</span><span class="text">, </span><span class="id">tree</span><span class="text">) -&gt;
                </span><span class="id">s</span><span class="text"> </span><span class="id">response</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;: &quot;</span><span class="text"> % </span><span class="id">tree_to_log</span><span class="text"> </span><span class="id">tree</span><span class="text">)
              </span><span class="id">trees</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">action</span><span class="text"> =
  </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Leaf</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
  | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">a</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">a</span><span class="text"> = </span><span class="id">action</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
  | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">a</span><span class="text">, </span><span class="id">l</span><span class="text">) -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">t</span><span class="text">) -&gt; </span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">action</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="id">tree_to_dot</span><span class="text"> ?(</span><span class="id">style</span><span class="text">=`</span><span class="kw2">Action_boxes</span><span class="text">) </span><span class="id">t</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Log</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">arrow</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="string">&quot; -&gt; &quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">semicolon</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">transition</span><span class="text"> </span><span class="id">state1</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">response</span><span class="text"> </span><span class="id">state2</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">style</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    </span><span class="comment">(* | `Arrow_labels -&gt; *)</span><span class="text">
    </span><span class="comment">(*   (s state1 % arrow % s state2 *)</span><span class="text">
    </span><span class="comment">(*    % sp % brakets (s &quot;label=&quot; % sf &quot;%S&quot; action) *)</span><span class="text">
    </span><span class="comment">(*    % s &quot;;&quot; % n) *)</span><span class="text">
    | `</span><span class="kw2">Action_boxes</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">action_name</span><span class="text">, </span><span class="id">action_attributes</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">state2</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="string">&quot;Killing&quot;</span><span class="text"> -&gt;
          </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">state2</span><span class="text">,
          </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,shape=doubleoctagon, label=%S&quot;</span><span class="text"> </span><span class="string">&quot;MURDER&quot;</span><span class="text">
        | </span><span class="string">&quot;Active&quot;</span><span class="text"> -&gt;
    
      </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">action</span><span class="text"> ^ </span><span class="id">state2</span><span class="text">,
          </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,shape=doubleoctagon, label=%S&quot;</span><span class="text"> </span><span class="string">&quot;ACTIVATION&quot;</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt;
          </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">action</span><span class="text">, </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,shape=box label=\&quot;%s\&quot;&quot;</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">response_name</span><span class="text">, </span><span class="id">response_attributes</span><span class="text"> =
        </span><span class="string">&quot;response&quot;</span><span class="text"> ^ </span><span class="id">state1</span><span class="text"> ^ </span><span class="id">action</span><span class="text"> ^ </span><span class="id">state2</span><span class="text">,
        </span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;shape=diamond,fontsize=9,fontname=\&quot;monospace\&quot;,label=%S&quot;</span><span class="text"> </span><span class="id">response</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="comment">(* s state1 % sp % brakets (s &quot;shape=oval&quot;) % s &quot;;&quot; % n *)</span><span class="text">
      </span><span class="comment">(* % s state2 % sp % brakets (s &quot;shape=oval&quot;) % s &quot;;&quot; % n *)</span><span class="text">
      </span><span class="comment">(* % s action_name % sp % brakets action_attributes % s &quot;;&quot; % n *)</span><span class="text">
      </span><span class="comment">(* % s state1 % arrow % s action_name % arrow % s state2 % semicolon % n *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">state_attributes</span><span class="text"> =
        </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;fontname=\&quot;monospace\&quot;,fontsize=18,shape=oval&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">state_action_arrow</span><span class="text"> =
        </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;arrowhead=\&quot;open\&quot;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">action_respoonse_arrow</span><span class="text"> =
        </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;dir=\&quot;none\&quot;&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      [
        </span><span class="id">s</span><span class="text"> </span><span class="id">state1</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">state_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">state2</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">state_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">action_name</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">action_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">response_name</span><span class="text"> % </span><span class="id">sp</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">response_attributes</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">state1</span><span class="text"> % </span><span class="id">arrow</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">action_name</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">state_action_arrow</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">action_name</span><span class="text"> % </span><span class="id">arrow</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">response_name</span><span class="text"> % </span><span class="id">brakets</span><span class="text"> </span><span class="id">action_respoonse_arrow</span><span class="text">;
        </span><span class="id">s</span><span class="text"> </span><span class="id">response_name</span><span class="text"> % </span><span class="id">arrow</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="id">state2</span><span class="text">;
      ]
  </span><span class="kw">in</span><span class="text">
  </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;digraph target_graph&quot;</span><span class="text">
  % </span><span class="id">braces</span><span class="text"> (
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">go</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">continue</span><span class="text"> = </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">t</span><span class="text">) -&gt; </span><span class="id">go</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">state</span><span class="text">) -&gt; []
      | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state</span><span class="text">, </span><span class="string">&quot;NONE&quot;</span><span class="text">, </span><span class="id">trees</span><span class="text">) -&gt;
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">continue</span><span class="text"> </span><span class="id">trees</span><span class="text">
      | `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state</span><span class="text">, </span><span class="id">action</span><span class="text">, </span><span class="id">trees</span><span class="text">) -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">arrows</span><span class="text"> =
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">trees</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
            | </span><span class="id">response</span><span class="text">, `</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">statei</span><span class="text">)
            | </span><span class="id">response</span><span class="text">, `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">statei</span><span class="text">, </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
              </span><span class="id">transition</span><span class="text"> </span><span class="id">state</span><span class="text">.</span><span class="id">name</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">response</span><span class="text"> </span><span class="id">statei</span><span class="text">.</span><span class="id">name</span><span class="text">)
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">append</span><span class="text"> </span><span class="id">arrows</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">continue</span><span class="text"> </span><span class="id">trees</span><span class="text">) |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    (</span><span class="id">go</span><span class="text"> </span><span class="id">t</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">dedup</span><span class="text"> |&gt; </span><span class="id">separate</span><span class="text"> (</span><span class="id">semicolon</span><span class="text"> % </span><span class="id">n</span><span class="text">))
  )

</span><span class="comment">(* &quot;{&quot; ^ action ^ &quot; -&gt; &quot; ^ state ^ &quot;\n&quot; *)</span><span class="text">
</span><span class="comment">(* ^ String.concat ~sep:&quot; --- &quot; (List.map ~f:tree_to_string trees) ^ &quot;}&quot; *)</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">make_automaton_graph</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">T</span><span class="text"> = </span><span class="kw2">Ketrew_target</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">state_name</span><span class="text"> </span><span class="id">t</span><span class="text"> = {</span><span class="id">name</span><span class="text"> = </span><span class="kw2">Ketrew_target</span><span class="text">.(</span><span class="kw2">State</span><span class="text">.</span><span class="id">name</span><span class="text"> (</span><span class="id">state</span><span class="text"> </span><span class="id">t</span><span class="text">)) } </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text"> ?(</span><span class="id">stop_afterwards</span><span class="text">=</span><span class="constant">false</span><span class="text">) </span><span class="id">target</span><span class="text"> =
    </span><span class="comment">(* Log.(s &quot;status: &quot; % Ketrew_target.(State.log ~depth:1 (state target)) @ normal); *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">node</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">l</span><span class="text"> : </span><span class="id">tree</span><span class="text"> =
      `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state_name</span><span class="text"> </span><span class="id">target</span><span class="text">, </span><span class="id">action</span><span class="text">, </span><span class="id">l</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">additional</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">T</span><span class="text">.</span><span class="id">state</span><span class="text"> </span><span class="id">target</span><span class="text"> |&gt; </span><span class="kw2">T</span><span class="text">.</span><span class="kw2">State</span><span class="text">.</span><span class="kw2">Is</span><span class="text">.</span><span class="id">killable</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="constant">true</span><span class="text"> -&gt;
        [</span><span class="string">&quot;OK&quot;</span><span class="text">, (</span><span class="kw2">T</span><span class="text">.</span><span class="id">kill</span><span class="text"> </span><span class="id">target</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">&quot;Killing TOKILL&quot;</span><span class="text">,
                `</span><span class="kw2">Changed_state</span><span class="text">)]
      | </span><span class="constant">false</span><span class="text"> -&gt; [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">protect_rec_call</span><span class="text"> </span><span class="id">log</span><span class="text"> </span><span class="id">f</span><span class="text"> =
      </span><span class="comment">(* If a change in the state-machine makes this happen, it
         usually means that the author forgot to pass the `No-change`
         information in `Target.Automaton.transition`. *)</span><span class="text">
      </span><span class="kw1">try</span><span class="text"> </span><span class="id">f</span><span class="text"> ()
      </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Stack_overflow</span><span class="text"> -&gt;
        </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">eprintf</span><span class="text"> </span><span class="string">&quot;Test error! Stack_overflow: %d, %s\n%!&quot;</span><span class="text"> </span><span class="id">depth</span><span class="text"> </span><span class="id">log</span><span class="text">;
        </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Stack_overflow</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">node_map</span><span class="text"> </span><span class="id">action</span><span class="text"> </span><span class="id">l</span><span class="text"> : </span><span class="id">tree</span><span class="text"> =
      </span><span class="id">node</span><span class="text"> </span><span class="id">action</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> (</span><span class="id">additional</span><span class="text"> @ </span><span class="id">l</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
        | </span><span class="id">response</span><span class="text">, (</span><span class="id">t</span><span class="text">, `</span><span class="kw2">No_change</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">stop_afterwards</span><span class="text"> -&gt;
          </span><span class="id">response</span><span class="text">, `</span><span class="kw2">Leaf</span><span class="text"> (</span><span class="id">state_name</span><span class="text"> </span><span class="id">t</span><span class="text">)
        | </span><span class="id">response</span><span class="text">, (</span><span class="id">t</span><span class="text">, `</span><span class="kw2">No_change</span><span class="text">) -&gt;
          </span><span class="id">response</span><span class="text">,
          </span><span class="id">protect_rec_call</span><span class="text"> </span><span class="string">&quot;no-change&quot;</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text">:(</span><span class="id">depth</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~stop_afterwards</span><span class="text">:</span><span class="constant">true</span><span class="text"> </span><span class="id">t</span><span class="text">)
        | </span><span class="id">response</span><span class="text">, (</span><span class="id">t</span><span class="text">, `</span><span class="kw2">Changed_state</span><span class="text">) -&gt;
          </span><span class="id">response</span><span class="text">,
          </span><span class="id">protect_rec_call</span><span class="text"> </span><span class="string">&quot;changed-state&quot;</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
              </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text">:(</span><span class="id">depth</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">t</span><span class="text">))) </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="kw2">Automaton</span><span class="text">.</span><span class="id">transition</span><span class="text"> </span><span class="id">target</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Kill</span><span class="text"> (</span><span class="id">b</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;kill&quot;</span><span class="text">
        [</span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">b</span><span class="text">);
         </span><span class="string">&quot;Try-Again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">b</span><span class="text">));
         </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">b</span><span class="text">));]
    | `</span><span class="kw2">Do_nothing</span><span class="text"> </span><span class="id">mkt</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">action</span><span class="text"> = </span><span class="string">&quot;do_nothing&quot;</span><span class="text">  </span><span class="kw">in</span><span class="text">
      </span><span class="id">node_map</span><span class="text"> </span><span class="id">action</span><span class="text"> [</span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> ()]
    | `</span><span class="kw2">Check_and_activate_dependencies</span><span class="text"> </span><span class="id">mkt</span><span class="text"> -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;check_and_activate_dependencies&quot;</span><span class="text"> [
        </span><span class="string">&quot;All-succeeded&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> `</span><span class="kw2">All_succeeded</span><span class="text">;
        </span><span class="string">&quot;At-least-one-failed&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">At_least_one_failed</span><span class="text"> []);
        </span><span class="string">&quot;Still-processing&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> `</span><span class="kw2">Still_processing</span><span class="text">;
      ]
    | `</span><span class="kw2">Start_running</span><span class="text"> (</span><span class="id">book</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;start_running&quot;</span><span class="text"> [
        </span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">book</span><span class="text">);
        </span><span class="string">&quot;Try-again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
      ]
    | `</span><span class="kw2">Activate</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;activate_targets&quot;</span><span class="text"> [</span><span class="string">&quot;OK&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> ()]
    | `</span><span class="kw2">Eval_condition</span><span class="text"> (</span><span class="id">condition</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;eval_condition&quot;</span><span class="text"> [
        </span><span class="string">&quot;true&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="constant">true</span><span class="text">);
        </span><span class="string">&quot;false&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> </span><span class="constant">false</span><span class="text">);
        </span><span class="string">&quot;Try-again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">));
        </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">));
      ]
    | `</span><span class="kw2">Check_process</span><span class="text"> (</span><span class="id">book</span><span class="text">, </span><span class="id">mkt</span><span class="text">) -&gt;
      </span><span class="id">node_map</span><span class="text"> </span><span class="string">&quot;check_process&quot;</span><span class="text"> [
        </span><span class="string">&quot;Success&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">Successful</span><span class="text"> </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Still-running&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">Still_running</span><span class="text"> </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Try-again&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Try_again</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
        </span><span class="string">&quot;Fatal&quot;</span><span class="text">, </span><span class="id">mkt</span><span class="text"> (`</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Fatal</span><span class="text">,  </span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">book</span><span class="text">));
      ]
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">activate_and_render</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">t</span><span class="kw1">#</span><span class="id">activate</span><span class="text">; </span><span class="id">t</span><span class="kw1">#</span><span class="id">render</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">dep</span><span class="text"> =(</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;01&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">targets</span><span class="text"> = [
    </span><span class="id">dep</span><span class="text"> </span><span class="kw1">#</span><span class="id">render</span><span class="text">;
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;02&quot;</span><span class="text"> |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;03&quot;</span><span class="text"> </span><span class="kw4">~depends_on</span><span class="text">:[</span><span class="id">dep</span><span class="text">] |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;03&quot;</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="string">&quot;&quot;</span><span class="text">)) |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;03&quot;</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="string">&quot;&quot;</span><span class="text">))
       </span><span class="kw4">~done_when</span><span class="text">:`</span><span class="kw2">Never</span><span class="text"> |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;04&quot;</span><span class="text"> </span><span class="kw4">~done_when</span><span class="text">:(`</span><span class="kw2">Satisfied</span><span class="text">) |&gt; </span><span class="id">activate_and_render</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;04&quot;</span><span class="text"> |&gt; </span><span class="id">activate_and_render</span><span class="text">
     |&gt; </span><span class="kw2">Ketrew_target</span><span class="text">.</span><span class="id">kill</span><span class="text"> ?</span><span class="id">log</span><span class="text">:</span><span class="kw2">None</span><span class="text"> |&gt; </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">&quot;not killable?&quot;</span><span class="text">);
    (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="id">target</span><span class="text"> </span><span class="string">&quot;TOKILL&quot;</span><span class="text"> </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="string">&quot;&quot;</span><span class="text">))
     |&gt; </span><span class="id">activate_and_render</span><span class="text">);
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">result_tree</span><span class="text"> =
    (`</span><span class="kw2">Node</span><span class="text"> ({</span><span class="id">name</span><span class="text">= </span><span class="string">&quot;ROOT&quot;</span><span class="text">}, </span><span class="string">&quot;NONE&quot;</span><span class="text">,
            (</span><span class="string">&quot;OK&quot;</span><span class="text">, `</span><span class="kw2">Node</span><span class="text"> ({</span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;Passive&quot;</span><span class="text">}, </span><span class="string">&quot;Activation&quot;</span><span class="text">, [</span><span class="string">&quot;OK&quot;</span><span class="text">, `</span><span class="kw2">Leaf</span><span class="text"> {</span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;Active&quot;</span><span class="text">}]))
            :: </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">targets</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">t</span><span class="text"> -&gt;
                (</span><span class="string">&quot;&quot;</span><span class="text">, `</span><span class="kw2">Node</span><span class="text"> (</span><span class="id">state_name</span><span class="text"> </span><span class="id">t</span><span class="text">, </span><span class="string">&quot;NONE&quot;</span><span class="text">, [</span><span class="string">&quot;&quot;</span><span class="text">, </span><span class="id">loop</span><span class="text"> </span><span class="kw4">~depth</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="id">t</span><span class="text">]))))) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">all_actions</span><span class="text"> = [
    </span><span class="string">&quot;kill&quot;</span><span class="text">; </span><span class="string">&quot;do_nothing&quot;</span><span class="text">; </span><span class="string">&quot;check_and_activate_dependencies&quot;</span><span class="text">;
    </span><span class="string">&quot;start_running&quot;</span><span class="text">; </span><span class="string">&quot;activate_targets&quot;</span><span class="text">; </span><span class="string">&quot;eval_condition&quot;</span><span class="text">; </span><span class="string">&quot;check_process&quot;</span><span class="text">
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Test</span><span class="text">.</span><span class="id">checkf</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">all_actions</span><span class="text"> (</span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">result_tree</span><span class="text">))
    </span><span class="string">&quot;tree having all actions: missing: %s&quot;</span><span class="text">
    (</span><span class="kw2">List</span><span class="text">.</span><span class="id">filter</span><span class="text"> </span><span class="id">all_actions</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">a</span><span class="text"> -&gt; </span><span class="id">tree_has_action</span><span class="text"> </span><span class="id">result_tree</span><span class="text"> </span><span class="id">a</span><span class="text"> |&gt; </span><span class="id">not</span><span class="text">)
     |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text">) ;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">o</span><span class="text"> = </span><span class="id">open_out</span><span class="text"> </span><span class="string">&quot;target_graph.dot&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">output_string</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw2">Log</span><span class="text">.</span><span class="id">to_long_string</span><span class="text">
                     (</span><span class="id">tree_to_dot</span><span class="text"> </span><span class="id">result_tree</span><span class="text">));
  </span><span class="id">close_out</span><span class="text"> </span><span class="id">o</span><span class="text">;
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">over_verbose</span><span class="text"> </span><span class="kw1">then</span><span class="text">
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Trrreeees: &quot;</span><span class="text"> % </span><span class="id">n</span><span class="text"> % </span><span class="id">tree_to_log</span><span class="text"> </span><span class="id">result_tree</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
  ()

</span><span class="kw">let</span><span class="text"> </span><span class="id">integration_meta_test</span><span class="text"> </span><span class="id">options</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
        </span><span class="id">printf</span><span class="text"> </span><span class="string">&quot;=&gt; %s\n%!&quot;</span><span class="text">
          (</span><span class="kw2">String</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">Character</span><span class="text"> </span><span class="string">'\n'</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;\n   &quot;</span><span class="text">)
      ) </span><span class="id">fmt</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">phase</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sep</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="string">'#'</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">printf</span><span class="text"> </span><span class="string">&quot;###%s###\n## %s ##\n###%s###\n%!&quot;</span><span class="text"> </span><span class="id">sep</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">sep</span><span class="text">
      ) </span><span class="id">fmt</span><span class="text">)
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">tmpdir</span><span class="text"> = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;PWD&quot;</span><span class="text"> // </span><span class="string">&quot;_integration_testing&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">tmp</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">tmpdir</span><span class="text"> // </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">with_server</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">options</span><span class="text"> </span><span class="string">&quot;with-server&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">verbose_commands</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">options</span><span class="text"> </span><span class="string">&quot;quiet-cmd&quot;</span><span class="text"> |&gt; </span><span class="id">not</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">with_clean_up</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">options</span><span class="text"> </span><span class="string">&quot;no-clean-up&quot;</span><span class="text"> |&gt; </span><span class="id">not</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="comment">(*
  let write_file f ~content =
    let o = open_out f in
    output_string o content;
    close_out o in
     *)</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">cmdf</span><span class="text"> ?(</span><span class="id">returns</span><span class="text">=</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">verbose_commands</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">printf</span><span class="text"> </span><span class="string">&quot; $ %s\n%!&quot;</span><span class="text"> </span><span class="id">s</span><span class="text">;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">command</span><span class="text"> </span><span class="id">s</span><span class="text">, </span><span class="id">returns</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="id">n</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">m</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">m</span><span class="text"> -&gt; ()
        | </span><span class="numeric">_</span><span class="text">, </span><span class="kw2">None</span><span class="text"> -&gt; ()
        | </span><span class="id">other</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">m</span><span class="text"> -&gt;
          </span><span class="id">failwith</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;Command %S returned %d instead of %d&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">other</span><span class="text"> </span><span class="id">m</span><span class="text">)
      ) </span><span class="id">fmt</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ketrew_configuration_prefix</span><span class="text"> </span><span class="id">profile</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">config_file</span><span class="text"> = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;PWD&quot;</span><span class="text"> // </span><span class="string">&quot;_test_env&quot;</span><span class="text"> // </span><span class="string">&quot;configuration.ml&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;KETREW_CONFIGURATION=%s KETREW_PROFILE=%s&quot;</span><span class="text">
          </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> </span><span class="id">config_file</span><span class="text">) </span><span class="id">profile</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ketrew</span><span class="text"> ?(</span><span class="id">bin</span><span class="text">=</span><span class="string">&quot;./ketrew&quot;</span><span class="text">) </span><span class="id">profile</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
        </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;%s %s %s&quot;</span><span class="text"> (</span><span class="id">ketrew_configuration_prefix</span><span class="text"> </span><span class="id">profile</span><span class="text">) </span><span class="id">bin</span><span class="text"> </span><span class="id">s</span><span class="text">
      ) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Preparing Integration Meta-Test&quot;</span><span class="text">;
  </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;mkdir -p %s&quot;</span><span class="text"> </span><span class="id">tmpdir</span><span class="text">;

  </span><span class="kw">let</span><span class="text"> </span><span class="id">server_out</span><span class="text"> = </span><span class="id">tmp</span><span class="text"> </span><span class="string">&quot;server-out.txt&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">server_output</span><span class="text"> </span><span class="id">lines</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">with_server</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
      </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Server output (%d lines)&quot;</span><span class="text"> </span><span class="id">lines</span><span class="text">;
      </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;tail -n %d %s | sed 's/^/   /'&quot;</span><span class="text"> </span><span class="id">lines</span><span class="text"> </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> </span><span class="id">server_out</span><span class="text">)
    );
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">with_server</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
      </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Starting Server&quot;</span><span class="text">;
      </span><span class="id">ketrew</span><span class="text"> </span><span class="string">&quot;server&quot;</span><span class="text"> </span><span class="string">&quot;start 2&gt;&amp;1 &gt; %s &amp;&quot;</span><span class="text">
        </span><span class="kw2">Filename</span><span class="text">.(</span><span class="id">quote</span><span class="text"> </span><span class="id">server_out</span><span class="text">);
      </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;sleep 3&quot;</span><span class="text">;
    ) </span><span class="kw1">end</span><span class="text">;
  </span><span class="id">server_output</span><span class="text"> </span><span class="numeric">10</span><span class="text">;

  </span><span class="kw">let</span><span class="text"> </span><span class="id">wait_for_targets_to_complete</span><span class="text"> () =
    </span><span class="id">ketrew</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;status --loop&quot;</span><span class="text">;
    </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;sleep 2&quot;</span><span class="text">; </span><span class="comment">(* we â€œavoidâ€ some kinds of race-conditionsÂ â€¦ *)</span><span class="text">
    </span><span class="id">ketrew</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;status --loop&quot;</span><span class="text">;
  </span><span class="kw">in</span><span class="text">
  </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Submit integration preparation&quot;</span><span class="text">;
  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;prepare&quot;</span><span class="text">;
  </span><span class="id">wait_for_targets_to_complete</span><span class="text"> ();

  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;is-running LSF&quot;</span><span class="text">;
  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;is-running PBS&quot;</span><span class="text">;
  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;is-running Hadoop&quot;</span><span class="text">;

  </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Submit integration tests&quot;</span><span class="text">;
  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;go&quot;</span><span class="text">;
  </span><span class="id">wait_for_targets_to_complete</span><span class="text"> ();

  
  </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Start the targets-to-kill&quot;</span><span class="text">;
  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;start-jobs-to-kill&quot;</span><span class="text">;
  </span><span class="comment">(* We need to kill the targets-to-kill. *)</span><span class="text">
  </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Kill the targets-to-kill&quot;</span><span class="text">;
  </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;sleep 300&quot;</span><span class="text">;
  </span><span class="comment">(* We hope it is enough for them to actually start; an observed
     low-bound is 120 seconds (between application start and obtention of
     an application ID from YARN!) *)</span><span class="text">
  </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;for id in `./ketrew-integration-test to-kill` ; do \n\
        echo \&quot;Kill $i\&quot;\n\
        %s ./ketrew kill $id\n\
        done&quot;</span><span class="text"> (</span><span class="id">ketrew_configuration_prefix</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text">);

  </span><span class="id">wait_for_targets_to_complete</span><span class="text"> ();

  </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;check&quot;</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">with_clean_up</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | </span><span class="constant">true</span><span class="text">  -&gt;
    </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Submit integration clean-up&quot;</span><span class="text">;
    </span><span class="id">ketrew</span><span class="text"> </span><span class="kw4">~bin</span><span class="text">:</span><span class="string">&quot;./ketrew-integration-test&quot;</span><span class="text"> </span><span class="string">&quot;client&quot;</span><span class="text"> </span><span class="string">&quot;clean&quot;</span><span class="text">;
    </span><span class="id">wait_for_targets_to_complete</span><span class="text"> ();
  | </span><span class="constant">false</span><span class="text"> -&gt;
    </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;NO integration clean-up&quot;</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">if</span><span class="text"> </span><span class="id">with_server</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="id">phase</span><span class="text"> </span><span class="string">&quot;Stopping server&quot;</span><span class="text">;
    </span><span class="id">ketrew</span><span class="text"> </span><span class="string">&quot;server&quot;</span><span class="text"> </span><span class="string">&quot;stop&quot;</span><span class="text">;
    </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;sleep 3&quot;</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="id">cmdf</span><span class="text"> </span><span class="string">&quot;ps aux | grep ketrew&quot;</span><span class="text">;
  ()

</span><span class="kw">let</span><span class="text"> </span><span class="id">run_all_tests</span><span class="text"> () =
  </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Starting ALL Tests&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
  </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Basic test:&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
  </span><span class="id">test_0</span><span class="text"> ();
  </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Automaton graph test:&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
  </span><span class="id">make_automaton_graph</span><span class="text"> ();
  </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;End of ALL Tests&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
  ()

</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">argl</span><span class="text"> = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">global_with_color</span><span class="text"> := </span><span class="id">not</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;-no-color&quot;</span><span class="text">);
  </span><span class="id">global_debug_level</span><span class="text"> := </span><span class="numeric">3</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">all</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;ALL&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">all</span><span class="text">
    </span><span class="kw1">then</span><span class="text"> </span><span class="id">run_all_tests</span><span class="text"> ()
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;basic-test&quot;</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_0</span><span class="text"> ();
      </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;automaton-graph&quot;</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">make_automaton_graph</span><span class="text"> ();
      </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;integration&quot;</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">integration_meta_test</span><span class="text"> </span><span class="id">argl</span><span class="text">;
    </span><span class="kw1">end</span><span class="text">
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> !</span><span class="kw2">Test</span><span class="text">.</span><span class="id">failed_tests</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [] -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;No tests failed \\o/ (arg-list: &quot;</span><span class="text">
         % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> (</span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text">) </span><span class="id">argl</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;)&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">0</span><span class="text">
  | </span><span class="id">some</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Some tests failed: &quot;</span><span class="text"> %</span><span class="id">n</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> </span><span class="kw3">string</span><span class="text"> </span><span class="id">some</span><span class="text"> @ </span><span class="id">error</span><span class="text">);
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">3</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>