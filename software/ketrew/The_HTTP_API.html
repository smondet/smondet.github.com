 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: The HTTP API</title></head><body><div class="container"><h1>Ketrew: The HTTP API</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul><li><a href='#Examples'>Examples</a>
</li></ul><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='The_HTTP_API.html'>The HTTP API</a></li><li><a href='The_Configuration_File.html'>The Configuration File</a></li><li><a href='Developer_Documentation.html'>Developer Documentation</a></li><li><a href='Server_Commands.html'>Server Commands</a></li><li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li><li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li><li><a href='integration.html'>Integration Test</a></li><li><a href='Workflow_Examples.html'>Workflow Examples</a></li><li><a href='main.html'>Main Test</a></li><li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li><li><a href='dummy_plugin.html'>Plugin Example</a></li><li><a href='preconfigured_main.html'>Preconfigured Main Example</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Branch/Tag: <a href='./dev/index.html'><code>dev</code></a></li><li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><h1 id="WhenKetrewRepliesonHTTP">When Ketrew Replies on HTTP</h1>

<h2 id="Examples">Examples</h2>

<p>Let&#39;s create a test environment, and source the resulting shell environment:</p><pre><code>./please.sh test-env
. _obuild/test.env</code></pre><p>Let&#39;s start the server:</p><pre><code>kdserver start</code></pre><p>You should be able to stop it with</p><pre><code>kdserver stop</code></pre><p>Let&#39;s add some targets to the database (c.f. <code>src/test/Workflow_Examples.ml</code>):</p><pre><code>kdtest website some_branch</code></pre><p>You can always browse with the client working like in standalone mode:</p><pre><code>kdclient interact</code></pre><p>Let&#39;s see the API itself, we use <code>curl</code>, here on the <code>/targets</code> service:</p><pre><code>curl -k &quot;$ktest_url/targets&quot;</code></pre><p>The option <code>return-error-messages</code> is set to true, so the server is nice and
says what went wrong:</p><pre class='badresult'><code class='badresult'>Error: Wrong HTTP Request: Authentication → Insufficient credentials</code></pre>

<p>In <code>_obuild/test-authorized-tokens</code> there is an “easy token” <code>&quot;nekot&quot;</code>:</p><pre><code>curl -k &quot;$ktest_url/targets?token=nekot&quot;</code></pre><pre class='badresult'><code class='badresult'>Error: Wrong HTTP Request: format-mandatory-parameter → Missing mandatory parameter: &quot;format&quot;</code></pre>

<p>Let&#39;s try again:</p><pre><code>curl -k &quot;$ktest_url/targets?token=nekot&amp;format=json&quot;</code></pre><p>Yay we get some Json \o/ i.e. a list of target JSON representations:</p><pre class='goodresult'><code class='goodresult'>[[
  &quot;V0&quot;,
  {
    &quot;history&quot;: [
      &quot;Successful&quot;,
      [
        1410886910.433017,
        [
          &quot;Running&quot;,
          [
            {
              &quot;run_history&quot;: [
  ...
]</code></pre>

<p>We can use <code>id</code> parameters to limit the request to one or more
targets:</p><pre><code>one_of_them=&quot;ketrew_2014-09-16-18h02m29s828ms-UTC_290180182&quot;
curl -k &quot;$ktest_url/targets?token=nekot&amp;format=json&amp;id=$one_of_them&quot;</code></pre><p>or with a pretty-printer:</p><pre><code>curl -k &quot;$ktest_url/targets?token=nekot&amp;format=json&amp;id=$one_of_them&quot; | json_pp</code></pre><pre class='goodresult'><code class='goodresult'>[
   [
      &quot;V0&quot;,
      {
         &quot;history&quot; : [
            &quot;Created&quot;,
            1408654128.82403
         ],
         &quot;make&quot; : [
            &quot;Direct_command&quot;,
            {
               &quot;action&quot; : [
                  &quot;Shell_command&quot;,
                  &quot;git add api &amp;&amp; git ci -a -m &#39;update website&#39; &quot;
               ],
               &quot;host&quot; : {
                  &quot;playground&quot; : [
                     &quot;Some&quot;,
                     {
                        &quot;kind&quot; : &quot;Directory&quot;,
                        &quot;path&quot; : &quot;/tmp&quot;
                     }
                  ],
                  &quot;connection&quot; : &quot;Localhost&quot;,
                  &quot;execution_timeout&quot; : &quot;None&quot;,
                  &quot;default_shell&quot; : {
                     &quot;command_option&quot; : &quot;-c&quot;,
                     &quot;options&quot; : [],
                     &quot;binary&quot; : &quot;None&quot;,
                     &quot;command_name&quot; : &quot;sh&quot;
                  },
                  &quot;name&quot; : &quot;file://tmp&quot;
               }
            }
         ],
         &quot;dependencies&quot; : [
            &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_332180439&quot;
         ],
         &quot;persistence&quot; : &quot;Input_data&quot;,
         &quot;name&quot; : &quot;Commit&quot;,
         &quot;if_fails_activate&quot; : [
            &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_641907500&quot;
         ],
         &quot;id&quot; : &quot;ketrew_2014-08-21-21h49m48s823ms-UTC_781944104&quot;,
         &quot;metadata&quot; : &quot;Unit&quot;,
         &quot;equivalence&quot; : &quot;Same_active_condition&quot;,
         &quot;condition&quot; : &quot;None&quot;
      }
   ]
]</code></pre>

<p>By the way, the <code>/targets</code> service is
<a href='http://en.wiktionary.org/wiki/nullipotent'>nullipotent</a>, and <code>GET</code>-only:</p><pre><code>curl -k --data &quot;something to post&quot; &quot;$ktest_url/targets?token=nekot&amp;format=json&quot;</code></pre><pre class='badresult'><code class='badresult'>Error: Wrong HTTP Request: wrong method → POST</code></pre>

<p>What additional queries can we get on the targets?</p><pre><code>curl -k &quot;$ktest_url/target-available-queries?token=nekot&amp;format=json&amp;id=$one_of_them&quot;</code></pre><p>we get a list of <code>(&quot;name&quot;, &quot;description&quot;)</code> pairs; the queries that are
available for this particular target:</p><pre class='goodresult'><code class='goodresult'>[
  [ &quot;stdout&quot;, &quot;Stardard output&quot; ],
  [ &quot;stderr&quot;, &quot;Stardard error&quot; ],
  [ &quot;log&quot;, &quot;Monitored-script `log` file&quot; ],
  [ &quot;script&quot;, &quot;Monitored-script used&quot; ]
]</code></pre>

<pre><code>curl -k &quot;$ktest_url/target-call-query?token=nekot&amp;format=json&amp;id=$one_of_them&amp;query=log&quot; | json_pp</code></pre><pre class='goodresult'><code class='goodresult'>[
  &quot;start\t2014-09-05 19:09:01\t\nbefore-cmd\t2014-09-05 19:09:01\tCMD0000\tcd /tmp/deploy_website_ketrew_2014-09-05-20h06m11s022ms-UTC_089809344/ketrew\nafter-cmd\t2014-09-05 19:09:01\tCMD0000\treturned 0\nbefore-cmd\t2014-09-05 19:09:01\tCMD0001\tbash _/please_sh clean build doc\nafter-cmd\t2014-09-05 19:09:14\tCMD0001\treturned 0\nsuccess\t2014-09-05 19:09:14\t\n&quot;
]</code></pre></div></div></div></body><html>