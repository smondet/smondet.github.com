 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Ketrew: Main Test</title></head><body><div class="container"><h1>Ketrew: Main Test</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul>
 <li><a href='index.html'>Home</a></li>
 <li><a href='Alternative_CLI_Application.html'>Alternative CLI Application</a></li>
 <li><a href='Developer_Documentation.html'>Developer Documentation</a></li>
 <li><a href='Long-Running_Plugins.html'>Long-Running Plugins</a></li>
 <li><a href='Server_Commands.html'>Server Commands</a></li>
 <li><a href='The_Configuration_File.html'>The Configuration File</a></li>
 <li><a href='The_HTTP_API.html'>The HTTP API</a></li>
 <li><a href='Workflow_Examples.html'>Workflow Examples</a></li>
 <li><a href='dummy_plugin.html'>Plugin Example</a></li>
 <li><a href='dummy_plugin_user.html'>Plugin-Usage Example</a></li>
 <li><a href='integration.html'>Integration Test</a></li>
 <li><a href='main.html'>Main Test</a></li>
 <li><a href='preconfigured_main.html'>Preconfigured Main Example</a></li>
 <li><a href='./api/index.html'>API Documentation</a></li>
 <li><a href='../index.html'><code>master</code></a> branch</li>
 <li>Branch/Tag: <a href='./long_running_factorization/index.html'><code>long_running_factorization</code></a></li>
 <li>Repository <a href='https://github.com/hammerlab/ketrew'>at Github</a></li>
 <li>Up: <a href='../../index.html'>Software Projects</a></li>
</ul>
</div><div class="col-md-9"><pre><span class="comment">(**************************************************************************)</span><span class="text">
</span><span class="comment">(*  Copyright 2014, Sebastien Mondet &lt;seb@mondet.org&gt;                     *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);       *)</span><span class="text">
</span><span class="comment">(*  you may not use this file except in compliance with the License.      *)</span><span class="text">
</span><span class="comment">(*  You may obtain a copy of the License at                               *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*      http://www.apache.org/licenses/LICENSE-2.0                        *)</span><span class="text">
</span><span class="comment">(*                                                                        *)</span><span class="text">
</span><span class="comment">(*  Unless required by applicable law or agreed to in writing, software   *)</span><span class="text">
</span><span class="comment">(*  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,     *)</span><span class="text">
</span><span class="comment">(*  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or       *)</span><span class="text">
</span><span class="comment">(*  implied.  See the License for the specific language governing         *)</span><span class="text">
</span><span class="comment">(*  permissions and limitations under the License.                        *)</span><span class="text">
</span><span class="comment">(**************************************************************************)</span><span class="text">

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew_pervasives</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Test</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Tests_failed</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">max_failures</span><span class="text"> = 
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;MAX_FAILURES&quot;</span><span class="text"> |&gt; </span><span class="id">int_of_string</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">2_000_000</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">failed_tests</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> []
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="id">failed_tests</span><span class="text"> := </span><span class="id">s</span><span class="text"> :: !</span><span class="id">failed_tests</span><span class="text">;
    </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> !</span><span class="id">failed_tests</span><span class="text"> &gt; </span><span class="id">max_failures</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
      </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Some tests failed: &quot;</span><span class="text"> %</span><span class="id">n</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> </span><span class="id">s</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">failed_tests</span><span class="text">)
           @ </span><span class="id">error</span><span class="text">);
      </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Tests_failed</span><span class="text"> 
    ) </span><span class="kw1">else</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_ssh_host</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="kw4">~playground</span><span class="text">:</span><span class="kw2">Path</span><span class="text">.(</span><span class="id">absolute_directory_exn</span><span class="text"> </span><span class="string">&quot;/tmp&quot;</span><span class="text">)
        (</span><span class="kw2">Unix</span><span class="text">.</span><span class="id">getenv</span><span class="text"> </span><span class="string">&quot;ketrew_test_ssh&quot;</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> -&gt; </span><span class="kw2">Host</span><span class="text">.</span><span class="id">ssh</span><span class="text"> </span><span class="string">&quot;localhost&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">wrong_ssh_host</span><span class="text"> =
    </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.</span><span class="kw2">Host</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="string">&quot;ssh://SomelongNameThatIHopeDoesNotExist:42/tmp/bouh&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">test_targets</span><span class="text"> ?</span><span class="id">wait_between_steps</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="id">targets</span><span class="text"> </span><span class="id">checks</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">add_targets</span><span class="text"> </span><span class="id">engine</span><span class="text"> </span><span class="id">targets</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw2">Deferred_list</span><span class="text">.</span><span class="id">while_sequential</span><span class="text"> </span><span class="id">checks</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">check</span><span class="text"> -&gt;
        </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:(</span><span class="id">return</span><span class="text"> ()) </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">System</span><span class="text">.</span><span class="id">sleep</span><span class="text"> </span><span class="id">wait_between_steps</span><span class="text">
        &gt;&gt;&lt; </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">check</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Dont_care</span><span class="text"> -&gt; </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
        | `</span><span class="kw2">Happens</span><span class="text"> </span><span class="id">check</span><span class="text"> -&gt;
          </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">happening</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check</span><span class="text"> </span><span class="id">happening</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="constant">true</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
          | </span><span class="constant">false</span><span class="text"> -&gt;
            </span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;T: %S: wrong happening: %s&quot;</span><span class="text"> </span><span class="id">name</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">what_happened_to_string</span><span class="text"> </span><span class="id">happening</span><span class="text">
                     |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;,\n  &quot;</span><span class="text">));
            </span><span class="id">return</span><span class="text"> ()
          </span><span class="kw1">end</span><span class="text">
        | `</span><span class="kw2">Status</span><span class="text"> (</span><span class="id">id</span><span class="text">, </span><span class="id">check</span><span class="text">) -&gt;
          </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">step</span><span class="text"> </span><span class="id">engine</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">get_status</span><span class="text"> </span><span class="id">engine</span><span class="text"> </span><span class="id">id</span><span class="text">
            &gt;&gt;= </span><span class="kw">function</span><span class="text">
            | </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">check</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
            | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;T: %S: wrong status&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">); </span><span class="id">return</span><span class="text"> ()
          </span><span class="kw1">end</span><span class="text">
        | `</span><span class="kw2">Kill_and</span><span class="text"> (</span><span class="id">id</span><span class="text">, </span><span class="id">check</span><span class="text">) -&gt;
          </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">kill</span><span class="text"> </span><span class="id">engine</span><span class="text"> </span><span class="id">id</span><span class="text">
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">happening</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">check</span><span class="text"> </span><span class="id">happening</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="constant">true</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
          | </span><span class="constant">false</span><span class="text"> -&gt;
            </span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;T: %S: wrong kill happening: %s&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">
                    (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">what_happened_to_string</span><span class="text"> </span><span class="id">happening</span><span class="text">
                     |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;,\n  &quot;</span><span class="text">));
            </span><span class="id">return</span><span class="text"> ()
          </span><span class="kw1">end</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">: </span><span class="kw3">unit</span><span class="text"> </span><span class="kw3">list</span><span class="text">) -&gt;
    </span><span class="id">return</span><span class="text"> ()

    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_target_one_step</span><span class="text"> ?</span><span class="id">condition</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~make</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">check</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target</span><span class="text"> = </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> ?</span><span class="id">condition</span><span class="text">  </span><span class="kw4">~make</span><span class="text"> () </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> [</span><span class="id">target</span><span class="text">] [</span><span class="id">check</span><span class="text"> </span><span class="kw4">~id</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target</span><span class="text">)]
    </span><span class="kw">let</span><span class="text"> </span><span class="id">target_succeeds</span><span class="text"> </span><span class="kw4">~id</span><span class="text"> =
      `</span><span class="kw2">Status</span><span class="text"> (</span><span class="id">id</span><span class="text">, </span><span class="kw">function</span><span class="text"> `</span><span class="kw2">Successful</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">)
    </span><span class="kw">let</span><span class="text"> </span><span class="id">target_fails</span><span class="text"> </span><span class="kw4">~id</span><span class="text"> =
      `</span><span class="kw2">Status</span><span class="text"> (</span><span class="id">id</span><span class="text">, </span><span class="kw">function</span><span class="text"> `</span><span class="kw2">Dead</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">)
    </span><span class="kw">let</span><span class="text"> </span><span class="id">check_one_step</span><span class="text"> </span><span class="kw4">~id</span><span class="text"> </span><span class="id">check</span><span class="text"> = `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="id">check</span><span class="text"> </span><span class="kw4">~id</span><span class="text">)
    </span><span class="kw">let</span><span class="text"> </span><span class="id">nothing_happens</span><span class="text"> = `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> [] -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">)

    </span><span class="kw">let</span><span class="text"> </span><span class="id">new_db_file</span><span class="text"> () =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">db_file</span><span class="text"> = </span><span class="kw2">Filename</span><span class="text">.</span><span class="id">concat</span><span class="text"> (</span><span class="kw2">Sys</span><span class="text">.</span><span class="id">getcwd</span><span class="text"> ()) </span><span class="string">&quot;_kdb_test&quot;</span><span class="text">  </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">System</span><span class="text">.</span><span class="kw2">Shell</span><span class="text">.</span><span class="id">do_or_fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;rm -rf %s&quot;</span><span class="text"> </span><span class="id">db_file</span><span class="text">)
        &gt;&gt;&lt; </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      </span><span class="kw1">end</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">return</span><span class="text"> </span><span class="id">db_file</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">contains</span><span class="text"> </span><span class="id">h1</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">yes</span><span class="text">, </span><span class="id">no</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">partition</span><span class="text"> </span><span class="id">h1</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">yes</span><span class="text">, </span><span class="id">no</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [], </span><span class="id">all</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="id">one</span><span class="text"> :: </span><span class="id">more</span><span class="text">, </span><span class="id">rest</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">one</span><span class="text">, </span><span class="id">more</span><span class="text"> @ </span><span class="id">rest</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">look</span><span class="text"> ?(</span><span class="id">and_nothing_more</span><span class="text">=</span><span class="constant">true</span><span class="text">) </span><span class="kw4">~like</span><span class="text"> () </span><span class="id">haps</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">go</span><span class="text"> </span><span class="id">prev</span><span class="text"> = 
      </span><span class="kw">function</span><span class="text">
      | [] -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">and_nothing_more</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">prev</span><span class="text"> = [] </span><span class="kw1">else</span><span class="text"> </span><span class="constant">true</span><span class="text">
      | </span><span class="id">f</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">contains</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">rest</span><span class="text">) -&gt; </span><span class="id">go</span><span class="text"> </span><span class="id">rest</span><span class="text"> </span><span class="id">more</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">go</span><span class="text"> </span><span class="id">haps</span><span class="text"> </span><span class="id">like</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">check_option</span><span class="text"> </span><span class="id">opt</span><span class="text"> </span><span class="id">v</span><span class="text"> =
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">opt</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">h</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">h</span><span class="text"> = </span><span class="id">v</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">success</span><span class="text"> ?</span><span class="id">how</span><span class="text"> ?</span><span class="id">what</span><span class="text"> </span><span class="id">hap</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">hap</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">trgt</span><span class="text">, </span><span class="id">meth</span><span class="text">) -&gt;
      </span><span class="id">check_option</span><span class="text"> </span><span class="id">how</span><span class="text"> </span><span class="id">meth</span><span class="text">
      &amp;&amp; </span><span class="id">check_option</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="id">trgt</span><span class="text"> 
    | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">activation</span><span class="text"> ?</span><span class="id">how</span><span class="text"> ?</span><span class="id">what</span><span class="text"> </span><span class="id">hap</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">hap</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">trgt</span><span class="text">, </span><span class="id">meth</span><span class="text">) -&gt;
      </span><span class="id">check_option</span><span class="text"> </span><span class="id">how</span><span class="text"> </span><span class="id">meth</span><span class="text">
      &amp;&amp; </span><span class="id">check_option</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="id">trgt</span><span class="text"> 
    | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">death</span><span class="text"> ?</span><span class="id">how</span><span class="text"> ?</span><span class="id">what</span><span class="text"> </span><span class="id">hap</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">hap</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">trgt</span><span class="text">, </span><span class="id">meth</span><span class="text">) -&gt;
      </span><span class="id">check_option</span><span class="text"> </span><span class="id">how</span><span class="text"> </span><span class="id">meth</span><span class="text">
      &amp;&amp; </span><span class="id">check_option</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="id">trgt</span><span class="text"> 
    | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">mini_db_test</span><span class="text"> () =
  </span><span class="kw2">Lwt_main</span><span class="text">.</span><span class="id">run</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">DB</span><span class="text"> = </span><span class="kw2">Ketrew_database</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">new_db_file</span><span class="text"> ()
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">db_file</span><span class="text"> -&gt;
    </span><span class="kw2">DB</span><span class="text">.</span><span class="id">load</span><span class="text"> </span><span class="id">db_file</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">db</span><span class="text"> -&gt;
    </span><span class="kw2">DB</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">db</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k&quot;</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">res</span><span class="text"> -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;key k got %S&quot;</span><span class="text"> </span><span class="id">v</span><span class="text">); </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [ </span><span class="id">is_not_set</span><span class="text"> </span><span class="string">&quot;k&quot;</span><span class="text">; </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k&quot;</span><span class="text"> </span><span class="string">&quot;V&quot;</span><span class="text"> ])
      &gt;&gt;= </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Done</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Not_done</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;seq 1 not done&quot;</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">check_k</span><span class="text"> </span><span class="id">current_db</span><span class="text"> =
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">current_db</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k&quot;</span><span class="text"> &gt;&gt;= </span><span class="kw">function</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">v</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">v</span><span class="text"> = </span><span class="string">&quot;V&quot;</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;get k got None&quot;</span><span class="text">); </span><span class="id">return</span><span class="text"> ()
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;get k got %S&quot;</span><span class="text"> </span><span class="id">v</span><span class="text">); </span><span class="id">return</span><span class="text"> ()
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">check_k</span><span class="text"> </span><span class="id">db</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw2">DB</span><span class="text">.</span><span class="id">close</span><span class="text"> </span><span class="id">db</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw2">DB</span><span class="text">.</span><span class="id">load</span><span class="text"> </span><span class="id">db_file</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">db2</span><span class="text"> -&gt;
    </span><span class="id">check_k</span><span class="text"> </span><span class="id">db2</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [</span><span class="id">contains</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k&quot;</span><span class="text"> </span><span class="string">&quot;V&quot;</span><span class="text">])
      &gt;&gt;= </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Done</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Not_done</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;seq 2 not done&quot;</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="comment">(* Transation that fails: *)</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [
        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;vvv&quot;</span><span class="text">;
        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~collection</span><span class="text">:</span><span class="string">&quot;c3&quot;</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k3&quot;</span><span class="text"> </span><span class="string">&quot;vvv&quot;</span><span class="text">;
        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;uuu&quot;</span><span class="text">;
        </span><span class="id">contains</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k&quot;</span><span class="text"> </span><span class="string">&quot;u&quot;</span><span class="text">])
      &gt;&gt;= </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Not_done</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Done</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;seq 3 done&quot;</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="comment">(* Transation that succeeds: *)</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [
        </span><span class="id">is_not_set</span><span class="text"> </span><span class="string">&quot;k2&quot;</span><span class="text">;
        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;vvv&quot;</span><span class="text">;
        </span><span class="id">contains</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;vvv&quot;</span><span class="text">;
        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;uuu&quot;</span><span class="text">;
        </span><span class="id">contains</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k&quot;</span><span class="text"> </span><span class="string">&quot;V&quot;</span><span class="text">;
        </span><span class="id">contains</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;uuu&quot;</span><span class="text">;
        </span><span class="id">unset</span><span class="text"> </span><span class="string">&quot;k2&quot;</span><span class="text">;
        </span><span class="id">is_not_set</span><span class="text"> </span><span class="string">&quot;k2&quot;</span><span class="text">;
      ])
      &gt;&gt;= </span><span class="kw">function</span><span class="text">
      | `</span><span class="kw2">Done</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | `</span><span class="kw2">Not_done</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;seq 4 not done&quot;</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="comment">(* Transations that fail hard: *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_with_debug_artificial_failure</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">f</span><span class="text"> =
      </span><span class="kw2">DB</span><span class="text">.</span><span class="kw2">Debug</span><span class="text">.(</span><span class="id">global_debug</span><span class="text"> := </span><span class="id">f</span><span class="text"> </span><span class="string">&quot;k2&quot;</span><span class="text">);
      </span><span class="kw1">begin</span><span class="text">
        </span><span class="kw2">Lwt</span><span class="text">.</span><span class="id">catch</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> () -&gt;
            </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [
                </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;rrr&quot;</span><span class="text">;
                </span><span class="id">set</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;uuu&quot;</span><span class="text">;
                </span><span class="id">unset</span><span class="text"> </span><span class="string">&quot;k2&quot;</span><span class="text">;
              ])
            &gt;&gt;&lt; </span><span class="kw">function</span><span class="text">
            | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;seq %s not exn&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">); </span><span class="id">return</span><span class="text"> ())
          (</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ())
      </span><span class="kw1">end</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="kw2">DB</span><span class="text">.</span><span class="kw2">Debug</span><span class="text">.(</span><span class="id">global_debug</span><span class="text"> := </span><span class="kw2">No</span><span class="text">);
      </span><span class="comment">(* We should be like end of seq 6 *)</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [
          </span><span class="id">is_not_set</span><span class="text"> </span><span class="string">&quot;k2&quot;</span><span class="text">;
          </span><span class="id">set</span><span class="text"> </span><span class="kw4">~collection</span><span class="text">:</span><span class="string">&quot;c3&quot;</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k3&quot;</span><span class="text"> </span><span class="string">&quot;uuu&quot;</span><span class="text">;
          </span><span class="id">unset</span><span class="text"> </span><span class="kw4">~collection</span><span class="text">:</span><span class="string">&quot;c3&quot;</span><span class="text"> </span><span class="string">&quot;k3&quot;</span><span class="text">;
          </span><span class="id">unset</span><span class="text"> </span><span class="kw4">~collection</span><span class="text">:</span><span class="string">&quot;c3&quot;</span><span class="text"> </span><span class="string">&quot;k3&quot;</span><span class="text">;
        ])
        &gt;&gt;= </span><span class="kw">function</span><span class="text">
        | `</span><span class="kw2">Done</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
        | `</span><span class="kw2">Not_done</span><span class="text"> -&gt; </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;seq %s+1 not done&quot;</span><span class="text"> </span><span class="id">name</span><span class="text">); </span><span class="id">return</span><span class="text"> ()
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test_with_debug_artificial_failure</span><span class="text"> </span><span class="string">&quot;After_write&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> </span><span class="id">k</span><span class="text"> -&gt; </span><span class="kw2">DB</span><span class="text">.</span><span class="kw2">Debug</span><span class="text">.</span><span class="kw2">After_write</span><span class="text"> </span><span class="id">k</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

    </span><span class="id">test_with_debug_artificial_failure</span><span class="text"> </span><span class="string">&quot;After_git_add&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> </span><span class="id">k</span><span class="text"> -&gt; </span><span class="kw2">DB</span><span class="text">.</span><span class="kw2">Debug</span><span class="text">.</span><span class="kw2">After_git_add</span><span class="text"> </span><span class="id">k</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">test_with_debug_artificial_failure</span><span class="text"> </span><span class="string">&quot;After_git_rm&quot;</span><span class="text">
      (</span><span class="kw">fun</span><span class="text"> </span><span class="id">k</span><span class="text"> -&gt; </span><span class="kw2">DB</span><span class="text">.</span><span class="kw2">Debug</span><span class="text">.</span><span class="kw2">After_git_rm</span><span class="text"> </span><span class="id">k</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">check_collection</span><span class="text"> </span><span class="id">collection</span><span class="text"> </span><span class="id">result</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">check</span><span class="text"> </span><span class="id">r</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sort</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">sort</span><span class="text"> </span><span class="kw4">~cmp</span><span class="text">:</span><span class="kw2">String</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">sort</span><span class="text"> </span><span class="id">r</span><span class="text"> = </span><span class="id">sort</span><span class="text"> </span><span class="id">result</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">DB</span><span class="text">.</span><span class="id">get_all</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw4">~collection</span><span class="text">
      &gt;&gt;= </span><span class="kw">function</span><span class="text">
      | </span><span class="id">r</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">check</span><span class="text"> </span><span class="id">r</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
      | </span><span class="id">other</span><span class="text"> -&gt;
        </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;Collection test: in %S  \nexpecting [%s]  \ngot [%s]&quot;</span><span class="text">
                     </span><span class="id">collection</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text"> </span><span class="id">result</span><span class="text">)
                     (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">&quot;, &quot;</span><span class="text"> </span><span class="id">other</span><span class="text">));
        </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">check_collection</span><span class="text"> </span><span class="string">&quot;&quot;</span><span class="text"> [] &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">check_collection</span><span class="text"> </span><span class="string">&quot;aslkdj&quot;</span><span class="text"> [] &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">check_collection</span><span class="text"> </span><span class="string">&quot;c3&quot;</span><span class="text"> [] &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">collection</span><span class="text"> = </span><span class="string">&quot;c3&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [</span><span class="id">set</span><span class="text"> </span><span class="kw4">~collection</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k1&quot;</span><span class="text"> </span><span class="string">&quot;v1&quot;</span><span class="text">;
                        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~collection</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;v2&quot;</span><span class="text">])
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
    </span><span class="id">check_collection</span><span class="text"> </span><span class="id">collection</span><span class="text"> [</span><span class="string">&quot;v1&quot;</span><span class="text">; </span><span class="string">&quot;v2&quot;</span><span class="text">] &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">collection</span><span class="text"> = </span><span class="string">&quot;c4&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">DB</span><span class="text">.</span><span class="id">act</span><span class="text"> </span><span class="id">db2</span><span class="text"> </span><span class="kw2">DB</span><span class="text">.(</span><span class="id">seq</span><span class="text"> [</span><span class="id">set</span><span class="text"> </span><span class="kw4">~collection</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k1&quot;</span><span class="text"> </span><span class="string">&quot;v1&quot;</span><span class="text">;
                        </span><span class="id">set</span><span class="text"> </span><span class="kw4">~collection</span><span class="text"> </span><span class="kw4">~key</span><span class="text">:</span><span class="string">&quot;k2&quot;</span><span class="text"> </span><span class="string">&quot;v2&quot;</span><span class="text">])
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
    </span><span class="id">check_collection</span><span class="text"> </span><span class="id">collection</span><span class="text"> [</span><span class="string">&quot;v1&quot;</span><span class="text">; </span><span class="string">&quot;v2&quot;</span><span class="text">] &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="comment">(* check_collection &quot;c3&quot; [&quot;sld&quot;] &gt;&gt;= fun () -&gt; *)</span><span class="text">

    </span><span class="id">return</span><span class="text"> ()
  </span><span class="kw1">end</span><span class="text">
  |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;mini_db_test: ERROR:  &quot;</span><span class="text"> % </span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew_error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;mini_db_test ends with error&quot;</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_0</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Lwt_main</span><span class="text">.</span><span class="id">run</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">new_db_file</span><span class="text"> ()
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">db_file</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = 
      </span><span class="kw2">Configuration</span><span class="text">.</span><span class="id">engine</span><span class="text"> </span><span class="kw4">~database_parameters</span><span class="text">:</span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">with_engine</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> -&gt;
      </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">add_targets</span><span class="text"> </span><span class="id">engine</span><span class="text">
        [</span><span class="kw2">Target</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;First target&quot;</span><span class="text"> ())]
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">current_targets</span><span class="text"> </span><span class="id">engine</span><span class="text">
        &gt;&gt;= </span><span class="kw">function</span><span class="text">
        | [</span><span class="id">one</span><span class="text">] </span><span class="kw1">when</span><span class="text"> </span><span class="id">one</span><span class="text">.</span><span class="kw2">Target</span><span class="text">.</span><span class="id">name</span><span class="text"> = </span><span class="string">&quot;First target&quot;</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> ()
        | </span><span class="id">other</span><span class="text"> -&gt;
          </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;too many targets: %d&quot;</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">other</span><span class="text">)); </span><span class="id">return</span><span class="text"> ()
      </span><span class="kw1">end</span><span class="text">
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;


      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_succeeds</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text">))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;ls /crazypath&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_fails</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /crazypath&quot;</span><span class="text">))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_ssh_host</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;ls / over ssh&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_succeeds</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text">))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw">let</span><span class="text"> </span><span class="id">root</span><span class="text"> = </span><span class="kw2">Path</span><span class="text">.</span><span class="id">absolute_directory_exn</span><span class="text"> </span><span class="string">&quot;/tmp&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;ls / &gt; &lt;file&gt; over ssh&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_succeeds</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text">
                 </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;ls / &gt; /tmp/ketrew_test&quot;</span><span class="text">))
        </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text">
                      </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text"> (</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ketrew_test&quot;</span><span class="text">)))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* A target that creates a more complex file structure *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">cmd</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(
          </span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
            </span><span class="string">&quot;mkdir -p /tmp/ketrew_test2/somedir &amp;&amp; \
             mkdir -p /tmp/ketrew_test2/somedir_empty &amp;&amp; \
             ls / &gt; /tmp/ketrew_test2/ls &amp;&amp; \
             ps aux &gt; /tmp/ketrew_test2/somedir/psaux &quot;</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">vol</span><span class="text"> =
        </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text">
                           (</span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;ketrew_test2&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">; </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_empty&quot;</span><span class="text"> [];
                                                </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;psaux&quot;</span><span class="text">]]))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_succeeds</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* doing it again should succeed for a good reason *)</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh, AGAIN&quot;</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
        (</span><span class="kw2">Test</span><span class="text">.</span><span class="id">check_one_step</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id</span><span class="text"> -&gt; </span><span class="kw">function</span><span class="text">
           | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Artifact_ready</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
           | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">))
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* A target that fails to create a more complex file structure; typo on file  *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">vol</span><span class="text"> =
        </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text">
                           (</span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;ketrew_test2&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">; </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_empty&quot;</span><span class="text"> [];
                                                </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_typo&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;psaux&quot;</span><span class="text">]]))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh + file typo&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_fails</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* A target that fails to create a more complex file structure; typo on dir  *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">vol</span><span class="text"> =
        </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text">
                           (</span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;ketrew_test2&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">; </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir_empty_2&quot;</span><span class="text"> [];
                                                </span><span class="id">dir</span><span class="text"> </span><span class="string">&quot;somedir&quot;</span><span class="text"> [</span><span class="id">file</span><span class="text"> </span><span class="string">&quot;psaux&quot;</span><span class="text">]]))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_target_one_step</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="string">&quot;2 files, 2 dirs over ssh + dir typo&quot;</span><span class="text"> </span><span class="kw2">Test</span><span class="text">.</span><span class="id">target_fails</span><span class="text">
        </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="id">cmd</span><span class="text">) </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="id">vol</span><span class="text">)
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

    </span><span class="comment">(*

      This tests 3 cases, for target1 depending on target2:

      - both may succeed consecutively
      - target 1 may fail and make target2 fail because of dependency
      - target 1 may succeed and target2 fail by itself

    *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">two_targets</span><span class="text"> (</span><span class="id">succeed1</span><span class="text">, </span><span class="id">succeed2</span><span class="text">) </span><span class="id">check</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">tmpfile</span><span class="text"> = </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;ketrew_test_%s&quot;</span><span class="text"> (</span><span class="kw2">Unique_id</span><span class="text">.</span><span class="id">create</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">target1</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">shell_command</span><span class="text"> =
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">succeed1</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;ls -l / &gt; /tmp/%s&quot;</span><span class="text"> </span><span class="id">tmpfile</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;echo bouh&quot;</span><span class="text">
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;ls / &gt; some tmp&quot;</span><span class="text">
            </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">shell_command</span><span class="text">))
            </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text"> </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text"> (</span><span class="id">file</span><span class="text"> </span><span class="id">tmpfile</span><span class="text">)))
            ()
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">target2</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">shell_command</span><span class="text"> =
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">succeed2</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;wc -l /tmp/%s&quot;</span><span class="text"> </span><span class="id">tmpfile</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;exit 42&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;count lines of dependency&quot;</span><span class="text">
            </span><span class="kw4">~dependencies</span><span class="text">:[ </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target1</span><span class="text"> ]
            </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="id">shell_command</span><span class="text">))
            ()
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">id1</span><span class="text"> = </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">id2</span><span class="text"> = </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">expected_status</span><span class="text"> </span><span class="id">b</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="string">&quot;succeeds&quot;</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="string">&quot;fails&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> =
          </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;%s (%s) depends on %s (%s)&quot;</span><span class="text">
            </span><span class="id">id1</span><span class="text"> (</span><span class="id">expected_status</span><span class="text"> </span><span class="id">succeed1</span><span class="text">)
            </span><span class="id">id2</span><span class="text"> (</span><span class="id">expected_status</span><span class="text"> </span><span class="id">succeed2</span><span class="text">)
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text"> [</span><span class="id">target1</span><span class="text">; </span><span class="id">target2</span><span class="text">] (</span><span class="id">check</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">two_targets</span><span class="text"> (</span><span class="constant">true</span><span class="text">, </span><span class="constant">true</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text"> -&gt;
          [
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependency</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_success</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_success</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id2</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">
          ])
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">two_targets</span><span class="text"> (</span><span class="constant">false</span><span class="text">, </span><span class="constant">true</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text"> -&gt;
          [
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependency</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_failure</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependencies_died</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id2</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">
          ])
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
      </span><span class="id">two_targets</span><span class="text"> (</span><span class="constant">true</span><span class="text">, </span><span class="constant">false</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~id1</span><span class="text"> </span><span class="kw4">~id2</span><span class="text"> -&gt;
          [
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_activated</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Dependency</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_succeeded</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_success</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id1</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
              | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="id">i</span><span class="text">, `</span><span class="kw2">Process_failure</span><span class="text">)] </span><span class="kw1">when</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">id2</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
              | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">
          ])
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_missing_dep</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_missing_dep&quot;</span><span class="text">
          </span><span class="kw4">~dependencies</span><span class="text">:[ </span><span class="string">&quot;hope this one is not in the database&quot;</span><span class="text"> ]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_missing_dep&quot;</span><span class="text"> [</span><span class="id">target_with_missing_dep</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(
            </span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Dependencies_died</span><span class="text">;
            ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

    
      </span><span class="comment">(* A target with 2 fallback targets: *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fallback1</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Fallback 1&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fallback2</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Fallback 2&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_fallbacks</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallbacks&quot;</span><span class="text">
          </span><span class="kw4">~if_fails_activate</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback1</span><span class="text">; </span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback2</span><span class="text"> ]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /somelong_STUPID-path&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallbacks&quot;</span><span class="text">
        [</span><span class="id">target_with_fallbacks</span><span class="text">; </span><span class="id">fallback1</span><span class="text">; </span><span class="id">fallback2</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(
            </span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Process_failure</span><span class="text">;
              </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Fallback</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback1</span><span class="text">);
              </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Fallback</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback2</span><span class="text">);
            ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="comment">(* Two targets with the same fallback *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fallback</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Fallback&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_fallback_1</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallback_1&quot;</span><span class="text">
          </span><span class="kw4">~if_fails_activate</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback</span><span class="text">]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /somelong_STUPID-path&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_fallback_2</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_fallback_2&quot;</span><span class="text">
          </span><span class="kw4">~if_fails_activate</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">fallback</span><span class="text">]
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /somelong_STUPID-path&quot;</span><span class="text">))
          ()
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;targets_with_same_fallback&quot;</span><span class="text">
        [</span><span class="id">target_with_fallback_1</span><span class="text">; </span><span class="id">target_with_fallback_2</span><span class="text">; </span><span class="id">fallback</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(
            </span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Process_failure</span><span class="text">;
              </span><span class="id">death</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Process_failure</span><span class="text">;
              </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Fallback</span><span class="text">;
            ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

      </span><span class="kw">let</span><span class="text"> </span><span class="id">triggered</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;Triggered&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text">))
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">target_that_triggers</span><span class="text"> =
        </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target-with-trigger&quot;</span><span class="text"> ()
          </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="string">&quot;ls /&quot;</span><span class="text">))
          </span><span class="kw4">~success_triggers</span><span class="text">:[</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">triggered</span><span class="text">]
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target-with-trigger&quot;</span><span class="text">
        [</span><span class="id">target_that_triggers</span><span class="text">; </span><span class="id">triggered</span><span class="text">] [
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(</span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
            </span><span class="id">success</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">target_that_triggers</span><span class="text">); 
            </span><span class="id">activation</span><span class="text"> </span><span class="kw4">~how</span><span class="text">:`</span><span class="kw2">Success_trigger</span><span class="text">;
          ]);
        `</span><span class="kw2">Happens</span><span class="text"> </span><span class="kw2">Happenings</span><span class="text">.(</span><span class="id">look</span><span class="text"> () </span><span class="kw4">~like</span><span class="text">:[
            </span><span class="id">success</span><span class="text"> </span><span class="kw4">~what</span><span class="text">:(</span><span class="kw2">Target</span><span class="text">.</span><span class="id">id</span><span class="text"> </span><span class="id">triggered</span><span class="text">); 
          ]);
        `</span><span class="kw2">Dont_care</span><span class="text">;
        `</span><span class="kw2">Dont_care</span><span class="text">;
      ]
    </span><span class="kw1">end</span><span class="text">


    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="id">return</span><span class="text"> ()
  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_0: Ketrew ERROR:  &quot;</span><span class="text"> %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_0 ends with error&quot;</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_ssh_failure_vs_target_failure</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Lwt_main</span><span class="text">.</span><span class="id">run</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_wrong_host</span><span class="text"> </span><span class="id">turn_unix_ssh_failure_into_target_failure</span><span class="text"> </span><span class="id">expect</span><span class="text"> =
      </span><span class="kw2">Test</span><span class="text">.</span><span class="id">new_db_file</span><span class="text"> ()
      &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">database_parameters</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> =
        </span><span class="kw2">Configuration</span><span class="text">.</span><span class="id">engine</span><span class="text">
          </span><span class="kw4">~turn_unix_ssh_failure_into_target_failure</span><span class="text"> </span><span class="kw4">~database_parameters</span><span class="text"> () </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">with_engine</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">target_with_wrong_host</span><span class="text"> =
            </span><span class="kw">let</span><span class="text"> </span><span class="id">host</span><span class="text"> = </span><span class="kw2">Test</span><span class="text">.</span><span class="id">wrong_ssh_host</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_missing_dep&quot;</span><span class="text">
              </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Direct_command</span><span class="text"> </span><span class="kw2">Target</span><span class="text">.</span><span class="kw2">Command</span><span class="text">.(</span><span class="id">shell</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;ls&quot;</span><span class="text">)) ()
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text">
            </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;target_with_wrong_host&quot;</span><span class="text"> [</span><span class="id">target_with_wrong_host</span><span class="text">]
            </span><span class="id">expect</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="comment">(* `false` is the default:
       The target won't be killed (so Ketrew will try to run it again at each
       `step`)
    *)</span><span class="text">
    </span><span class="id">test_wrong_host</span><span class="text"> </span><span class="constant">false</span><span class="text"> [
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* Nothing happens. *)</span><span class="text">
        | []  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
        | []  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Dont_care</span><span class="text">;
    ]
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
    </span><span class="comment">(* The target will be kill at the first attempt: *)</span><span class="text">
    </span><span class="id">test_wrong_host</span><span class="text"> </span><span class="constant">true</span><span class="text"> [
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* Nothing happens. *)</span><span class="text">
        | [`</span><span class="kw2">Target_died</span><span class="text"> </span><span class="numeric">_</span><span class="text">]  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
        | []  -&gt; </span><span class="constant">true</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
      `</span><span class="kw2">Dont_care</span><span class="text">;
    ]

  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_ssh_failure_vs_target_failure: Ketrew ERROR:  &quot;</span><span class="text"> %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_ssh_failure_vs_target_failure ends with error&quot;</span><span class="text">



</span><span class="kw">let</span><span class="text"> </span><span class="id">test_long_running_nohup</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Ketrew</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Lwt_main</span><span class="text">.</span><span class="id">run</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">new_db_file</span><span class="text"> ()
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="id">db_file</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">configuration</span><span class="text"> = </span><span class="kw2">Configuration</span><span class="text">.</span><span class="id">engine</span><span class="text"> </span><span class="kw4">~database_parameters</span><span class="text">:</span><span class="id">db_file</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">Ketrew_engine</span><span class="text">.</span><span class="id">with_engine</span><span class="text"> </span><span class="kw4">~configuration</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> -&gt;

        </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text">  </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="string">&quot;one bad plugin&quot;</span><span class="text">)
          [</span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;one&quot;</span><span class="text">
             </span><span class="kw4">~make</span><span class="text">:(`</span><span class="kw2">Long_running</span><span class="text"> (</span><span class="string">&quot;bad_plugin&quot;</span><span class="text">, </span><span class="string">&quot;useless string&quot;</span><span class="text">)) ()
          ]
          [`</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
             | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, `</span><span class="kw2">Plugin_not_found</span><span class="text"> </span><span class="string">&quot;bad_plugin&quot;</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
             | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
           `</span><span class="kw2">Dont_care</span><span class="text">;
           </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">;
          ]
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

        </span><span class="kw">let</span><span class="text"> </span><span class="id">root</span><span class="text"> = </span><span class="kw2">Path</span><span class="text">.</span><span class="id">absolute_directory_exn</span><span class="text"> </span><span class="string">&quot;/tmp&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">Deferred_list</span><span class="text">.</span><span class="id">while_sequential</span><span class="text"> [</span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_ssh_host</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">host</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;%s on %s&quot;</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="kw2">Host</span><span class="text">.(</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">host</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">new_name</span><span class="text"> = </span><span class="kw2">Unique_id</span><span class="text">.</span><span class="id">create</span><span class="text"> () </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text">  </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">name</span><span class="text"> </span><span class="string">&quot;good ls&quot;</span><span class="text">)
              </span><span class="kw4">~wait_between_steps</span><span class="text">:</span><span class="numeric">1</span><span class="text">.
              [</span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;one&quot;</span><span class="text"> ()
                 </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Daemonize</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
                          (`</span><span class="kw2">Shell_command</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;ls &gt; /tmp/%s&quot;</span><span class="text"> </span><span class="id">new_name</span><span class="text">)))
                 </span><span class="kw4">~condition</span><span class="text">:(`</span><span class="kw2">Volume_exists</span><span class="text">
                               </span><span class="kw2">Artifact</span><span class="text">.</span><span class="kw2">Volume</span><span class="text">.(</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw4">~root</span><span class="text"> (</span><span class="id">file</span><span class="text"> </span><span class="id">new_name</span><span class="text">)))
              ]
              [`</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                 | [`</span><span class="kw2">Target_started</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* We hope that 1 second intervals are enough
                                     but there is no good synchronization *)</span><span class="text">
                 | [`</span><span class="kw2">Target_succeeded</span><span class="text"> </span><span class="numeric">_</span><span class="text">] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">;
              ]
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

            </span><span class="comment">(* Test the `kill` function: *)</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">id</span><span class="text"> = </span><span class="kw2">Unique_id</span><span class="text">.</span><span class="id">create</span><span class="text"> () </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text">  </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">name</span><span class="text"> </span><span class="string">&quot;sleep 42&quot;</span><span class="text">)
              </span><span class="kw4">~wait_between_steps</span><span class="text">:</span><span class="numeric">1</span><span class="text">.
              [</span><span class="kw2">Target</span><span class="text">.</span><span class="id">active</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:</span><span class="string">&quot;one&quot;</span><span class="text"> </span><span class="kw4">~id</span><span class="text">
                 </span><span class="kw4">~make</span><span class="text">:(</span><span class="kw2">Daemonize</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw4">~host</span><span class="text">
                          (`</span><span class="kw2">Shell_command</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;echo %S &amp;&amp; sleep 42&quot;</span><span class="text"> </span><span class="kw2">String</span><span class="text">.(</span><span class="id">make</span><span class="text"> </span><span class="numeric">60</span><span class="text"> </span><span class="string">'='</span><span class="text">))))
                 ()
              ]
              [`</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                 | [`</span><span class="kw2">Target_started</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text"> </span><span class="comment">(* We hope that 1 second intervals are enough *)</span><span class="text">
                 | [] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
               `</span><span class="kw2">Dont_care</span><span class="text">;
               `</span><span class="kw2">Dont_care</span><span class="text">;
               `</span><span class="kw2">Dont_care</span><span class="text">;
               `</span><span class="kw2">Kill_and</span><span class="text"> (</span><span class="id">id</span><span class="text">, (</span><span class="kw">function</span><span class="text">
                 | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, `</span><span class="kw2">Killed</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                 | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">));
               </span><span class="kw2">Test</span><span class="text">.</span><span class="id">nothing_happens</span><span class="text">;
              ]
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

            </span><span class="comment">(* Test that a target fails when the process succeeds but does not
               create the right target: *)</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> =
              </span><span class="kw2">Ketrew</span><span class="text">.</span><span class="kw2">EDSL</span><span class="text">.(
                </span><span class="id">target</span><span class="text"> </span><span class="string">&quot;some name&quot;</span><span class="text">
                  </span><span class="kw4">~make</span><span class="text">:(</span><span class="id">daemonize</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="kw2">Program</span><span class="text">.(</span><span class="id">sh</span><span class="text"> </span><span class="string">&quot;ls &gt; /tmp/some_temp_file&quot;</span><span class="text">))
                  </span><span class="kw4">~done_when</span><span class="text">:(</span><span class="id">file</span><span class="text"> </span><span class="kw4">~host</span><span class="text"> </span><span class="string">&quot;/tmp/some_temp_file_with_error&quot;</span><span class="text">)</span><span class="kw1">#</span><span class="id">exists</span><span class="text">
              )
            </span><span class="kw">in</span><span class="text">
            </span><span class="id">t</span><span class="kw1">#</span><span class="id">activate</span><span class="text">;
            </span><span class="kw2">Test</span><span class="text">.</span><span class="id">test_targets</span><span class="text"> </span><span class="kw4">~engine</span><span class="text"> </span><span class="kw4">~name</span><span class="text">:(</span><span class="id">name</span><span class="text"> </span><span class="string">&quot;wrong 'returns'&quot;</span><span class="text">)
              </span><span class="kw4">~wait_between_steps</span><span class="text">:</span><span class="numeric">0.3</span><span class="text"> [</span><span class="id">t</span><span class="kw1">#</span><span class="id">render</span><span class="text">] [
              `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                | [`</span><span class="kw2">Target_started</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
              `</span><span class="kw2">Happens</span><span class="text"> (</span><span class="kw">function</span><span class="text">
                | [`</span><span class="kw2">Target_died</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, `</span><span class="kw2">Process_failure</span><span class="text">)] -&gt; </span><span class="constant">true</span><span class="text">
                | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
              `</span><span class="kw2">Dont_care</span><span class="text">;
            ]
            &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;

            </span><span class="id">return</span><span class="text"> ())
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text"> : </span><span class="kw3">unit</span><span class="text"> </span><span class="kw3">list</span><span class="text">) -&gt;

        </span><span class="id">return</span><span class="text"> ())
  </span><span class="kw1">end</span><span class="text"> |&gt; </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> () -&gt; ()
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;test_long_running_nohup: Ketrew ERROR:  &quot;</span><span class="text">
         %</span><span class="id">s</span><span class="text"> (</span><span class="kw2">Error</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">e</span><span class="text">) @ </span><span class="id">error</span><span class="text">);
    </span><span class="kw2">Test</span><span class="text">.</span><span class="id">fail</span><span class="text"> </span><span class="string">&quot;test_long_running_nohup ends with error&quot;</span><span class="text">


</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">argl</span><span class="text"> = </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">global_with_color</span><span class="text"> := </span><span class="id">not</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;-no-color&quot;</span><span class="text">);
  </span><span class="id">global_debug_level</span><span class="text"> := </span><span class="numeric">3</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">all</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;ALL&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;db-test&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">mini_db_test</span><span class="text"> ();
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;basic-test&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_0</span><span class="text"> ();
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;nohup-test&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_long_running_nohup</span><span class="text"> ();
  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">argl</span><span class="text"> </span><span class="string">&quot;ssh-failure&quot;</span><span class="text"> || </span><span class="id">all</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test_ssh_failure_vs_target_failure</span><span class="text"> ();
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> !</span><span class="kw2">Test</span><span class="text">.</span><span class="id">failed_tests</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | [] -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;No tests failed \\o/ (arg-list: &quot;</span><span class="text">
         % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> (</span><span class="id">sf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text">) </span><span class="id">argl</span><span class="text"> % </span><span class="id">s</span><span class="text"> </span><span class="string">&quot;)&quot;</span><span class="text"> @ </span><span class="id">normal</span><span class="text">);
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">0</span><span class="text">
  | </span><span class="id">some</span><span class="text"> -&gt;
    </span><span class="kw2">Log</span><span class="text">.(</span><span class="id">s</span><span class="text"> </span><span class="string">&quot;Some tests failed: &quot;</span><span class="text"> %</span><span class="id">n</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">list</span><span class="text"> </span><span class="kw3">string</span><span class="text"> </span><span class="id">some</span><span class="text"> @ </span><span class="id">error</span><span class="text">);
    </span><span class="id">exit</span><span class="text"> </span><span class="numeric">3</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>