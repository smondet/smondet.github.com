 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Sosa: Literate Implementation</title></head><body><div class="container"><h1>Sosa: Literate Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='sosa.html'>Literate Implementation</a></li><li><a href='sosa_test.html'>Tests &amp; Benchmarks (<code>sosa_test.ml</code>)</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for <a href='./doc.0.0.1/index.html'>version 0.0.1</a></li><li>Documentation for <a href='./dev/index.html'>the <code>dev</code> branch</a></li><li>Repository <a href='https://github.com/smondet/sosa'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="comment">(** Sane OCaml String API *)</span><span class="text">

</span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">) </span><span class="id">result</span><span class="text"> = [
  | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">a</span><span class="text">
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="kw">of</span><span class="text"> '</span><span class="id">b</span><span class="text">
]
</span><span class="comment">(** The type [result] is a reusable version the classical [Result.t]
    type. *)</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">OUTPUT_MODEL</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** A monadic thread model (like [Lwt], [Async]) and an [output]
  function. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">thread</span><span class="text">
  </span><span class="comment">(** The type of the threads, the type parameters are there in case
      the user needs up to 3 of them.
      
      For instance, if implement with [Lwt], we will have [type ('a, 'b, 'c)
      thread = 'a Lwt.t], but with [Pvem.DEFERRED_RESULT]: [type ('a, 'b, 'c)
      thread = ('a, 'b) Deferred_result.t]. *)</span><span class="text">


  </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">channel</span><span class="text">
  </span><span class="comment">(** The of the channels, channels can have up to 3 type-parameters
      too.  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">return</span><span class="text">: '</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">thread</span><span class="text">
  </span><span class="comment">(** The monadic [return]. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">bind</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">thread</span><span class="text"> -&gt; ('</span><span class="id">a</span><span class="text"> -&gt; ('</span><span class="id">d</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">thread</span><span class="text">) -&gt; ('</span><span class="id">d</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">thread</span><span class="text">
  </span><span class="comment">(** The monadic [bind]. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">output</span><span class="text">: ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">channel</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text"> -&gt; (</span><span class="kw3">unit</span><span class="text">, '</span><span class="id">e</span><span class="text">, '</span><span class="id">f</span><span class="text">) </span><span class="id">thread</span><span class="text">
  </span><span class="comment">(** The function to output a given native string to a channel.  *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">NATIVE_CONVERSIONS</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** API definition of conversions from native OCaml strings to a
      given string type or vice-versa. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** The string type. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_native_string</span><span class="text">: </span><span class="kw3">string</span><span class="text"> -&gt; (</span><span class="id">t</span><span class="text">, [&gt; `</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> ]) </span><span class="id">result</span><span class="text">
  </span><span class="comment">(** Convert a native string to the current representation.
      [of_native_string] returns [`Error (`wrong_char_at index)]
      when the native string contains a character not representable
      with the type [character]. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text">: </span><span class="kw3">string</span><span class="text"> -&gt; </span><span class="id">offset</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    (</span><span class="id">t</span><span class="text">, [&gt; `</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text"> | `</span><span class="id">out_of_bounds</span><span class="text"> ]) </span><span class="id">result</span><span class="text">
  </span><span class="comment">(** Convert a native string like [of_native_string] but take a
      subset of the string. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">to_native_string</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text">
  </span><span class="comment">(** Serialize the string to a native string. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">


</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">BASIC_CHARACTER</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** The minimal API implemented by characters. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** The type representing the character. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_native_char</span><span class="text">: </span><span class="kw3">char</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Import a native [char], returns [None] if the character is not
      representable. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_int</span><span class="text">: </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Import an integer, returns [None] if there is no character for
      that value. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">to_int</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="comment">(** Returns the integer representation of the character. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">size</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="comment">(** Get the size of the character, the exact semantics are
      implementation-specific (c.f. {!write_to_native_string}) *)</span><span class="text">


  </span><span class="kw">val</span><span class="text"> </span><span class="id">write_to_native_string</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">buf</span><span class="text">:</span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; (</span><span class="kw3">int</span><span class="text">, [&gt; `</span><span class="id">out_of_bounds</span><span class="text">]) </span><span class="id">result</span><span class="text">
  </span><span class="comment">(** [write_to_native_string c ~buf ~index] serializes
      the character [c] at position [index] in the native string
      [buf] (writing [size c] units). Note, as with {!size} that the
      meaning of [index] is implementation dependent (can be the {i
      index-th} byte, the {i index-th} bit, etc.). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">to_native_string</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text">
  </span><span class="comment">(** [to_native_string c] creates a string containing the
      serialization of the character [c] (if [size c] is not a
      multiple of 8, the end-padding is undefined). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">read_from_native_string</span><span class="text">: </span><span class="id">buf</span><span class="text">:</span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; (</span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text">) </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Read a character at a given [index] in a native string, returns
      [Some (c, s)], the character [c] and the number of units read [s],
      or [None] if there is no representable/valid character at that
      index. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Convert the character to a human-readable native string (in the
      spirit of [sprintf &quot;%s&quot;]). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="comment">(** Comparison function (as expected by most common functors in the
      ecosystem). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">
  </span><span class="comment">(** Tell whether a character is considered whitespace. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">BASIC_STRING</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** The minimal API implemented by string modules. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text">
  </span><span class="comment">(** A string is a string of characters. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** The type of the string. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">empty</span><span class="text">: </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** An “empty” string. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">is_empty</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">
  </span><span class="comment">(** Test whether a string is empty. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">make</span><span class="text">: </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Build a new string like [String.make]. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">length</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="comment">(** Get the length of the string (i.e. the number of characters). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_character</span><span class="text">: </span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Make a string with one character. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">of_character_list</span><span class="text">: </span><span class="id">character</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Make a string out of a list of characters. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">to_character_list</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> </span><span class="kw3">list</span><span class="text">
  </span><span class="comment">(** Explode a string into a list of characters. *)</span><span class="text">


  </span><span class="kw">val</span><span class="text"> </span><span class="id">get</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Get the n-th char, indexes are not necessarily bytes, they can
      be bits. [get] returns [None] when [index] is out of bounds. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">set</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">v</span><span class="text">:</span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** [set str ~index ~v] creates a new string equal to [t] with
      character [v] at position [index]. [set] returns [None] when
      [index] is out of bounds. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">get_exn</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text">
  </span><span class="comment">(** Like [get] but fail with an exception *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">set_exn</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">v</span><span class="text">:</span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Like [set] but fail with an exception *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">concat</span><span class="text">: ?</span><span class="id">sep</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** The classical [concat] function. *)</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">NATIVE_CONVERSIONS</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> := </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** By including {!NATIVE_CONVERSIONS}, a
      basic string provides
      {!NATIVE_CONVERSIONS.of_native_string},
      {!NATIVE_CONVERSIONS.of_native_substring}, and
      {!NATIVE_CONVERSIONS.to_native_string}.
  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text">
  </span><span class="comment">(** Convert the string to a human-readable native string (à la
      [sprintf &quot;%S&quot;]). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">fold</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">init</span><span class="text">:'</span><span class="id">a</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:('</span><span class="id">a</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; '</span><span class="id">a</span><span class="text">) -&gt; '</span><span class="id">a</span><span class="text">
  </span><span class="comment">(** The standard [fold] function, see [List.fold_left] for example. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="comment">(** Comparison function (as expected by most common functors in the
      ecosystem). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">sub</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Get the sub-string of size [length] at position [index]. If
      [length] is 0, [sub] returns [Some empty] whichever the other
      parameters are. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">sub_exn</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Do like [sub] but throw an exception instead of returning [None] *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare_substring</span><span class="text">: </span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="comment">(** Comparison function for substrings: use as [compare_substring
      (s1, index1, length1) (s2, index2, length2)].

      Note that out-of-bounds accesses will {b not} be reported: for
      performance reasons, if the result can be decided with the
      smallest sub-string then [compare_substring] won't look
      further.

      However, if {!compare_substring_strict} returns [Some c] then
      [compare_substring] {i must} return [d] such as [c] = [d] or
      [c] × [d] &gt; 0 (i.e. strictly same sign).

      In other words, is [sub a ~index:ia ~length:la] returns [Some suba] and
      [sub b ~index:ib ~length:lb] returns [Some subb], then
      [compare_substring (a, ia, la) (b, ib, lb)] will behave like
      [compare suba subb] (again, with the same sign).
  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare_substring_strict</span><span class="text">: </span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Do like {!compare_substring} but return [Some _] only when it is
      well defined (same validity criteria as {!sub}: if [length]
      is [0], [index] is irrelevant).

      Depending on the backend implementation, this function might be
      significantly slower than [compare_substring] (for example when
      calls to [length] are not {i O(1)}). *)</span><span class="text">


  </span><span class="kw">val</span><span class="text"> </span><span class="id">iter</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">) -&gt; </span><span class="kw3">unit</span><span class="text">
  </span><span class="comment">(** Apply [f] on every character successively. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">iter_reverse</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">) -&gt; </span><span class="kw3">unit</span><span class="text">
  </span><span class="comment">(** Apply [f] on every character successively in reverse order. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">map</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text">) -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Make a new string by applying [f] to all characters of the
      input. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">for_all</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="kw3">bool</span><span class="text">
  </span><span class="comment">(** Return [true] if-and-only-if [f] returns [true] on all characters. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">exists</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="kw3">bool</span><span class="text">
  </span><span class="comment">(** Return [true] if-and-only-if [f] returns [true] on at least one
      character. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">index_of_character</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Find the first occurrence of a character in the string (starting
      at position [from]).
      
      Default value for [from] is [0].
      If [from] is negative, [0] will be used.
      If [from &gt;= length t], [None] will be returned.
  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">index_of_character_reverse</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Do like [index_of_character] but start from the end of the string.

      Default value for [from] is [length t - 1] (end of the string).
      If [from] is negative, [None] will be returned.
      If [from &gt;= length t], [length t - 1] will be used.
  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">index_of_string</span><span class="text">: ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    ?</span><span class="id">sub_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">sub_length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">sub</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Find the first occurrence of the substring [(sub, sub_index,
      sub_length)] in a given string, starting at index [from].
  
      The [from] parameter behaves like for {!index_of_character}.

      The [(sub_index, sub_length)] parameters are constrained to [(0, length
      sub)], for example, if [sub] is [&quot;abc&quot;], [(-1, 4)] will be equivalent to
      [(0, 3)], [(1, 3)] will be equivalent to [(1, 2)].

      Searching for an empty string [from] a valid position always succeeds at
      that position.
  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">index_of_string_reverse</span><span class="text">: ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    ?</span><span class="id">sub_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">sub_length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">sub</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Do like [index_of_string] but start from the end of the string. 

      The [from] parameter behaves like for {!index_of_character_reverse}.

      The [(sub_index, sub_length)] parameters are constrained like in
      {!index_of_string}.  *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">find</span><span class="text">: ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Find the index of the first character [c] for which [f c] is [true]. One
      can restrict to the sub-string [(from, length)] (the
      default is to use the whole string, “out-of-bound” values are restricted
      to the bounds of the string). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">find_reverse</span><span class="text">:
    ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="comment">(** Find the index of the last character [c] for which [f c] is [true]. One
      can restrict to the reverse sub-string [(from, length)] (the
      default is to use the whole string,  “out-of-bound” values are restricted
      to the bounds of the string). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">filter_map</span><span class="text">: ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; 
    </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> </span><span class="id">option</span><span class="text">) -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Create a new string with the characters for which [f c] returned 
      [Some c]. One can restrict to the sub-string [(from, length)] (the
      default is to use the whole string, “out-of-bound” values are restricted
      to the bounds of the string). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">split</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; 
    </span><span class="id">on</span><span class="text">:[ `</span><span class="kw2">Character</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">character</span><span class="text"> | `</span><span class="kw2">String</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="id">t</span><span class="text"> ] -&gt;
    </span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text">
  </span><span class="comment">(** Split the string using [on] as separator. 
      Splitting the empty string returns  [[empty]], splitting [on] the empty
      string explodes the string into a list of one-character strings. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">strip</span><span class="text">: ?</span><span class="id">on</span><span class="text">:[`</span><span class="kw2">Both</span><span class="text"> | `</span><span class="kw2">Left</span><span class="text"> | `</span><span class="kw2">Right</span><span class="text">] -&gt;
    ?</span><span class="id">whitespace</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="comment">(** Remove any whitespace characters at the beginning and/or the end of the
      string (default [`Both]).

      The default is to call the {!BASIC_CHARACTER.is_whitespace} function of
      the implemented character.
  *)</span><span class="text">

  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_output</span><span class="text">: </span><span class="kw">functor</span><span class="text"> (</span><span class="kw2">Model</span><span class="text">: </span><span class="kw2">OUTPUT_MODEL</span><span class="text">) -&gt; </span><span class="kw1">sig</span><span class="text">

    </span><span class="kw">val</span><span class="text"> </span><span class="id">output</span><span class="text">:  ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="kw2">Model</span><span class="text">.</span><span class="id">channel</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; (</span><span class="kw3">unit</span><span class="text">, '</span><span class="id">e</span><span class="text">, '</span><span class="id">f</span><span class="text">) </span><span class="kw2">Model</span><span class="text">.</span><span class="id">thread</span><span class="text">
    </span><span class="comment">(** Output a string to a channel. *)</span><span class="text">

  </span><span class="kw1">end</span><span class="text">
  </span><span class="comment">(** [Make_output(Asynchronous_output_model)] provides a function
      {!Make_output.output} given any {!OUTPUT_MODEL}. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">UNSAFELY_MUTABLE</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="comment">(** This interface defines functions that may be implemented by
      particular string types that are actually mutable.

      They are considered “unsafe” because they break the immutability
      invariants assumed by the rest of this library; you'd better
      know what you're doing. *)</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">mutate</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; (</span><span class="kw3">unit</span><span class="text">, [&gt; `</span><span class="id">out_of_bounds</span><span class="text"> ]) </span><span class="id">result</span><span class="text">
  </span><span class="comment">(** Set the [index]-th character of the string. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">mutate_exn</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">
  </span><span class="comment">(** Set the [index]-th character of the string, but fail with a
      non-specified exception. *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">blit</span><span class="text">:
    </span><span class="id">src</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">src_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">dst</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">dst_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    (</span><span class="kw3">unit</span><span class="text">, [&gt; `</span><span class="id">out_of_bounds</span><span class="text"> ]) </span><span class="id">result</span><span class="text">
  </span><span class="comment">(** Copy [length] characters from [src] (starting at [src_index]) to
      [dst] (starting at [dst_index]). *)</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">blit_exn</span><span class="text">:
    </span><span class="id">src</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">src_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">dst</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">dst_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">
  </span><span class="comment">(** Like {!blit} but fail with a non-specified exception. *)</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Printf</span><span class="text">

</span><span class="comment">(* Internal “Pervasives” module, tu be used in all the following
   implementations. *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Internal_pervasives</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">List</span><span class="text"> = </span><span class="kw2">ListLabels</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">StringLabels</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (|&gt;) </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="id">x</span><span class="text"> : (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">result</span><span class="text"> = `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">x</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fail</span><span class="text"> </span><span class="id">x</span><span class="text"> : (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text">) </span><span class="id">result</span><span class="text"> = `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">x</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">o</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> </span><span class="id">e</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (&gt;&gt;=) = </span><span class="id">bind</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">dbg</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">printf</span><span class="text"> (</span><span class="string">&quot;DBG: &quot;</span><span class="text"> ^^ </span><span class="id">fmt</span><span class="text"> ^^ </span><span class="string">&quot;\n%!&quot;</span><span class="text">)

  </span><span class="comment">(* The function `List.map` adapted from `Core_kernel`'s way of
     unrolling the loops. *)</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Core_list_map</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">map_slow</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text">)

    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">count_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">ctr</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [] -&gt; []
      | [</span><span class="id">x1</span><span class="text">] -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        [</span><span class="id">f1</span><span class="text">]
      | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">] -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">]
      | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">] -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
        [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">]
      | [</span><span class="id">x1</span><span class="text">; </span><span class="id">x2</span><span class="text">; </span><span class="id">x3</span><span class="text">; </span><span class="id">x4</span><span class="text">] -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x4</span><span class="text"> </span><span class="kw">in</span><span class="text">
        [</span><span class="id">f1</span><span class="text">; </span><span class="id">f2</span><span class="text">; </span><span class="id">f3</span><span class="text">; </span><span class="id">f4</span><span class="text">]
      | </span><span class="id">x1</span><span class="text"> :: </span><span class="id">x2</span><span class="text"> :: </span><span class="id">x3</span><span class="text"> :: </span><span class="id">x4</span><span class="text"> :: </span><span class="id">x5</span><span class="text"> :: </span><span class="id">tl</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f1</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f2</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f3</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x3</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f4</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x4</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">f5</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x5</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">f1</span><span class="text"> :: </span><span class="id">f2</span><span class="text"> :: </span><span class="id">f3</span><span class="text"> :: </span><span class="id">f4</span><span class="text"> :: </span><span class="id">f5</span><span class="text"> ::
          (</span><span class="kw1">if</span><span class="text"> </span><span class="id">ctr</span><span class="text"> &gt; </span><span class="numeric">1000</span><span class="text">
           </span><span class="kw1">then</span><span class="text"> </span><span class="id">map_slow</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl</span><span class="text">
           </span><span class="kw1">else</span><span class="text"> </span><span class="id">count_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">tl</span><span class="text"> (</span><span class="id">ctr</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))

    </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="id">count_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="numeric">0</span><span class="text">

  </span><span class="kw1">end</span><span class="text">
</span><span class="kw1">end</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Internal_pervasives</span><span class="text">


</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">NATIVE_CHARACTER</span><span class="text"> = </span><span class="kw2">BASIC_CHARACTER</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">char</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">NATIVE_STRING</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">BASIC_STRING</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw3">char</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">UNSAFELY_MUTABLE</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> := </span><span class="kw2">String</span><span class="text">.</span><span class="id">t</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> := </span><span class="kw3">char</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Native_character</span><span class="text"> : </span><span class="kw2">NATIVE_CHARACTER</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

    </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">char</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_char</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="id">x</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">of_int</span><span class="text"> </span><span class="id">x</span><span class="text"> =
      </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">char_of_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_int</span><span class="text"> = </span><span class="id">int_of_char</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">compare</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">size</span><span class="text"> </span><span class="numeric">_</span><span class="text"> = </span><span class="numeric">1</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_print</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="string">' '</span><span class="text"> &lt;= </span><span class="id">t</span><span class="text"> &amp;&amp; </span><span class="id">t</span><span class="text"> &lt;= </span><span class="string">'~'</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="numeric">1</span><span class="text"> </span><span class="id">x</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">x</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">is_print</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="numeric">1</span><span class="text"> </span><span class="id">x</span><span class="text">
      </span><span class="kw1">else</span><span class="text"> </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;0x%2x&quot;</span><span class="text"> (</span><span class="id">int_of_char</span><span class="text"> </span><span class="id">x</span><span class="text">)

    </span><span class="kw">let</span><span class="text"> </span><span class="id">write_to_native_string</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
      </span><span class="kw1">try</span><span class="text"> </span><span class="id">buf</span><span class="text">.[</span><span class="id">index</span><span class="text">] &lt;- </span><span class="id">c</span><span class="text">; </span><span class="id">return</span><span class="text"> </span><span class="numeric">1</span><span class="text">
      </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">read_from_native_string</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
      </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">buf</span><span class="text">.[</span><span class="id">index</span><span class="text">], </span><span class="numeric">1</span><span class="text">)
      </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> = 
      </span><span class="kw">function</span><span class="text"> </span><span class="string">' '</span><span class="text"> | </span><span class="string">'\t'</span><span class="text"> | </span><span class="string">'\r'</span><span class="text"> | </span><span class="string">'\n'</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">T_LENGTH_AND_COMPSUB</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">length</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare_substring</span><span class="text">: </span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> * </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(* This functor builds a `compare_substring_strict` function out of a
   `compare_substring` function.

   It may not be the optimal algorithm (it may call `length` on both
   strings.)
 *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Compare_substring_strict_of_loose</span><span class="text"> (</span><span class="kw2">S</span><span class="text">: </span><span class="kw2">T_LENGTH_AND_COMPSUB</span><span class="text">) = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">open</span><span class="text"> </span><span class="kw2">S</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">b</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">check_a</span><span class="text"> = </span><span class="kw1">lazy</span><span class="text"> (</span><span class="id">idxa</span><span class="text"> &gt;= </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">lena</span><span class="text"> &gt;= </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">idxa</span><span class="text"> + </span><span class="id">lena</span><span class="text"> &lt;= (</span><span class="id">length</span><span class="text"> </span><span class="id">a</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">check_b</span><span class="text"> = </span><span class="kw1">lazy</span><span class="text"> (</span><span class="id">idxb</span><span class="text"> &gt;= </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">lenb</span><span class="text"> &gt;= </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">idxb</span><span class="text"> + </span><span class="id">lenb</span><span class="text"> &lt;= (</span><span class="id">length</span><span class="text"> </span><span class="id">b</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">lena</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">lenb</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">
    </span><span class="kw1">else</span><span class="text">
      (</span><span class="kw1">if</span><span class="text"> </span><span class="id">lena</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Lazy</span><span class="text">.</span><span class="id">force</span><span class="text"> </span><span class="id">check_b</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="numeric">-1</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">)
       </span><span class="kw1">else</span><span class="text">
         (</span><span class="kw1">if</span><span class="text"> </span><span class="id">lenb</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Lazy</span><span class="text">.</span><span class="id">force</span><span class="text"> </span><span class="id">check_a</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="numeric">1</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">)
          </span><span class="kw1">else</span><span class="text">
            (</span><span class="kw1">if</span><span class="text"> </span><span class="id">not</span><span class="text"> (</span><span class="kw2">Lazy</span><span class="text">.</span><span class="id">force</span><span class="text"> </span><span class="id">check_a</span><span class="text">) || </span><span class="id">not</span><span class="text"> (</span><span class="kw2">Lazy</span><span class="text">.</span><span class="id">force</span><span class="text"> </span><span class="id">check_b</span><span class="text">) </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
             </span><span class="kw1">else</span><span class="text">
               </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">b</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">)))))
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_index_of_string</span><span class="text"> (</span><span class="kw2">S</span><span class="text">: </span><span class="kw2">T_LENGTH_AND_COMPSUB</span><span class="text">) = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">open</span><span class="text"> </span><span class="kw2">S</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_string</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?(</span><span class="id">sub_index</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">sub_length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~sub</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_exn</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Found</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">

      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> () =
        </span><span class="comment">(* Readjust the arguments: *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = 
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">min</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">total_length_of_sub</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> =
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">default</span><span class="text"> = </span><span class="id">max</span><span class="text"> </span><span class="numeric">0</span><span class="text"> (</span><span class="id">total_length_of_sub</span><span class="text"> - </span><span class="id">sub_index</span><span class="text">) </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">match</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">default</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt;= </span><span class="id">default</span><span class="text"> -&gt; </span><span class="id">default</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="comment">(* dbg &quot;from: %d, length: %d sub_index: %d sub_length: %d&quot; *)</span><span class="text">
          </span><span class="comment">(* from length_of_t  sub_index sub_length; *)</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &gt;= </span><span class="id">length_of_t</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">from</span><span class="text">
        </span><span class="kw1">else</span><span class="text">
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
            </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> - </span><span class="id">from</span><span class="text"> </span><span class="kw1">do</span><span class="text">
              </span><span class="kw1">if</span><span class="text"> </span><span class="id">compare_substring</span><span class="text">
                  (</span><span class="id">t</span><span class="text">, </span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">, </span><span class="id">sub_length</span><span class="text">)
                  (</span><span class="id">sub</span><span class="text">, </span><span class="id">sub_index</span><span class="text">, </span><span class="id">sub_length</span><span class="text">) = </span><span class="numeric">0</span><span class="text">
              </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Found</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">))
            </span><span class="kw1">done</span><span class="text">;
            </span><span class="kw2">None</span><span class="text">
          </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Found</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">f</span><span class="text">
          </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">With_exn</span><span class="text">.</span><span class="id">f</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_string_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?(</span><span class="id">sub_index</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">sub_length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~sub</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_exn</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Found</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">

      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> () =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">last</span><span class="text"> = </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = 
          </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">last</span><span class="text"> 
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">f</span><span class="text"> &gt;= </span><span class="id">last</span><span class="text"> -&gt; </span><span class="id">last</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">total_length_of_sub</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> =
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">default</span><span class="text"> = </span><span class="id">max</span><span class="text"> </span><span class="numeric">0</span><span class="text"> (</span><span class="id">total_length_of_sub</span><span class="text"> - </span><span class="id">sub_index</span><span class="text">) </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">match</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">default</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt;= </span><span class="id">default</span><span class="text"> -&gt; </span><span class="id">default</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="comment">(* dbg &quot;from: %d, length: %d sub_index: %d sub_length: %d&quot; *)</span><span class="text">
          </span><span class="comment">(* from length_of_t  sub_index sub_length; *)</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">from</span><span class="text">
        </span><span class="kw1">else</span><span class="text">
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
            </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">from</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
              </span><span class="kw1">if</span><span class="text"> </span><span class="id">compare_substring</span><span class="text">
                  (</span><span class="id">t</span><span class="text">, </span><span class="id">i</span><span class="text">, </span><span class="id">sub_length</span><span class="text">)
                  (</span><span class="id">sub</span><span class="text">, </span><span class="id">sub_index</span><span class="text">, </span><span class="id">sub_length</span><span class="text">) = </span><span class="numeric">0</span><span class="text">
              </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Found</span><span class="text"> (</span><span class="id">i</span><span class="text">))
            </span><span class="kw1">done</span><span class="text">;
            </span><span class="kw2">None</span><span class="text">
          </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Found</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">f</span><span class="text">
          </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">With_exn</span><span class="text">.</span><span class="id">f</span><span class="text"> ()

</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(* This module type is a subset of `BASIC_STRING` for strings with a `length`
   function, a `sub_exn` function, and the `index_of_*` functions *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">T_LENGTH_SUB_AND_SEARCH</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">length</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">sub_exn</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">index_of_character</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">index_of_string</span><span class="text">: ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt;
    ?</span><span class="id">sub_index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">sub_length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">sub</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(* This functor implements the `BASIC_STRING.split` function out of a
   `T_LENGTH_AND_SEARCH` *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_split_function</span><span class="text"> (</span><span class="kw2">S</span><span class="text">: </span><span class="kw2">T_LENGTH_SUB_AND_SEARCH</span><span class="text">) = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">split</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~on</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">on</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Character</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">from</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">index_of_character</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">index</span><span class="text"> -&gt;
          </span><span class="id">loop</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">from</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">index</span><span class="text"> - </span><span class="id">from</span><span class="text">) :: </span><span class="id">acc</span><span class="text">) 
            (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">)
        | </span><span class="kw2">None</span><span class="text"> -&gt;
          (</span><span class="kw2">S</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">from</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length_of_t</span><span class="text"> - </span><span class="id">from</span><span class="text">) :: </span><span class="id">acc</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">loop</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">)
    | `</span><span class="kw2">String</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">from</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">index_of_string</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">index</span><span class="text"> -&gt;
          </span><span class="id">loop</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">from</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">index</span><span class="text"> - </span><span class="id">from</span><span class="text">) :: </span><span class="id">acc</span><span class="text">) 
            (</span><span class="id">index</span><span class="text"> + </span><span class="id">length_of_s</span><span class="text">)
        | </span><span class="kw2">None</span><span class="text"> -&gt;
          (</span><span class="kw2">S</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">from</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length_of_t</span><span class="text"> - </span><span class="id">from</span><span class="text">) :: </span><span class="id">acc</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text"> 
      </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">loop</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">)
      </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="numeric">0</span><span class="text">
      </span><span class="kw1">then</span><span class="text"> [ </span><span class="id">t</span><span class="text"> ]
      </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">for</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
          </span><span class="id">res</span><span class="text"> := </span><span class="kw2">S</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> :: !</span><span class="id">res</span><span class="text">
        </span><span class="kw1">done</span><span class="text">;
        !</span><span class="id">res</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_strip_function</span><span class="text"> (</span><span class="kw2">S</span><span class="text">:
   </span><span class="kw1">sig</span><span class="text">
     </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">
     </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text">
     </span><span class="kw">val</span><span class="text"> </span><span class="id">empty</span><span class="text"> : </span><span class="id">t</span><span class="text">
     </span><span class="kw">val</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text">: </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">
     </span><span class="kw">val</span><span class="text"> </span><span class="id">length</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
     </span><span class="kw">val</span><span class="text"> </span><span class="id">find</span><span class="text">:
       ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
     </span><span class="kw">val</span><span class="text"> </span><span class="id">find_reverse</span><span class="text">:
       ?</span><span class="id">from</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; ?</span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text">:(</span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">) -&gt; </span><span class="kw3">int</span><span class="text"> </span><span class="id">option</span><span class="text">
     </span><span class="kw">val</span><span class="text"> </span><span class="id">sub_exn</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">index</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">length</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
   </span><span class="kw1">end</span><span class="text">) = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">strip</span><span class="text"> ?(</span><span class="id">on</span><span class="text">=`</span><span class="kw2">Both</span><span class="text">) ?(</span><span class="id">whitespace</span><span class="text">=</span><span class="kw2">S</span><span class="text">.</span><span class="id">is_whitespace</span><span class="text">) </span><span class="id">t</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">S</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">first_non</span><span class="text"> () =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">find</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">not</span><span class="text"> (</span><span class="id">whitespace</span><span class="text"> </span><span class="id">c</span><span class="text">)) </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">last_non</span><span class="text"> () =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">not</span><span class="text"> (</span><span class="id">whitespace</span><span class="text"> </span><span class="id">c</span><span class="text">)) </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">on</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Both</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="id">first_non</span><span class="text"> () </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">last</span><span class="text"> = </span><span class="id">last_non</span><span class="text"> () </span><span class="kw">in</span><span class="text">
        </span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">last</span><span class="text"> - </span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">)
      | `</span><span class="kw2">Left</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="id">first_non</span><span class="text"> () </span><span class="kw">in</span><span class="text">
        </span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> - </span><span class="id">index</span><span class="text">)
      | `</span><span class="kw2">Right</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">last</span><span class="text"> = </span><span class="id">last_non</span><span class="text"> () </span><span class="kw">in</span><span class="text">
        </span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">last</span><span class="text"> + </span><span class="numeric">1</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> 
    | </span><span class="kw2">Not_found</span><span class="text"> -&gt; </span><span class="id">empty</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Native_string</span><span class="text"> : </span><span class="kw2">NATIVE_STRING</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">StringLabels</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw3">char</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = </span><span class="string">&quot;&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">is_empty</span><span class="text"> </span><span class="id">t</span><span class="text"> = (</span><span class="id">compare</span><span class="text"> </span><span class="string">&quot;&quot;</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="numeric">0</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_character</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="numeric">1</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_character_list</span><span class="text"> </span><span class="id">cl</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">cl</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">buf</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="id">length</span><span class="text"> '\</span><span class="id">x00</span><span class="text">' </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iteri</span><span class="text"> </span><span class="id">cl</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">buf</span><span class="text">.[</span><span class="id">i</span><span class="text">] &lt;- </span><span class="id">c</span><span class="text">);
    </span><span class="id">buf</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">res</span><span class="text"> := </span><span class="id">s</span><span class="text">.[</span><span class="id">i</span><span class="text">] :: !</span><span class="id">res</span><span class="text">
    </span><span class="kw1">done</span><span class="text">;
    !</span><span class="id">res</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">get</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">s</span><span class="text">.[</span><span class="id">index</span><span class="text">])
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">index</span><span class="text"> &gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
    </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">cop</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">copy</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">cop</span><span class="text">.[</span><span class="id">index</span><span class="text">] &lt;- </span><span class="id">v</span><span class="text">;
      </span><span class="kw2">Some</span><span class="text"> </span><span class="id">cop</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> = </span><span class="id">s</span><span class="text">.[</span><span class="id">index</span><span class="text">]
  </span><span class="kw">let</span><span class="text"> </span><span class="id">set_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;set_exn&quot;</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">b</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_exns</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Return</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Left_out</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Right_out</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> () =
        </span><span class="kw1">try</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">shortest</span><span class="text"> = </span><span class="id">min</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">shortest</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">ca</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="id">a</span><span class="text">.[</span><span class="id">idxa</span><span class="text"> + </span><span class="id">i</span><span class="text">] </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Left_out</span><span class="text"> </span><span class="id">i</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">cb</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="id">b</span><span class="text">.[</span><span class="id">idxb</span><span class="text"> + </span><span class="id">i</span><span class="text">] </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Right_out</span><span class="text"> </span><span class="id">i</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">compare</span><span class="text">  </span><span class="id">ca</span><span class="text"> </span><span class="id">cb</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">c</span><span class="text"> &lt;&gt; </span><span class="numeric">0</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Return</span><span class="text"> </span><span class="id">c</span><span class="text">)
            </span><span class="kw1">else</span><span class="text"> ()
          </span><span class="kw1">done</span><span class="text">;
          (</span><span class="kw2">Pervasives</span><span class="text">.</span><span class="id">compare</span><span class="text"> (</span><span class="id">lena</span><span class="text"> : </span><span class="kw3">int</span><span class="text">) </span><span class="id">lenb</span><span class="text">)
        </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Return</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">
        | </span><span class="kw2">Left_out</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="comment">(* a went out of bounds at 'c + idxa' *)</span><span class="text"> </span><span class="numeric">-1</span><span class="text">
        | </span><span class="kw2">Right_out</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="comment">(* b went out of bounds at 'c + idxb' *)</span><span class="text">
          </span><span class="comment">(* so, a is “longer” *)</span><span class="text"> </span><span class="numeric">1</span><span class="text">
    </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">With_exns</span><span class="text">.</span><span class="id">f</span><span class="text"> ()

  </span><span class="kw">type</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">t</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">T_length_and_compsub</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
    </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring</span><span class="text"> = </span><span class="id">compare_substring</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Compare_substring_strict_of_loose</span><span class="text">(</span><span class="kw2">T_length_and_compsub</span><span class="text">)
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_index_of_string</span><span class="text">(</span><span class="kw2">T_length_and_compsub</span><span class="text">)


  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">copy</span><span class="text"> </span><span class="id">x</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_string</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">return</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">copy</span><span class="text"> </span><span class="id">x</span><span class="text">)
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="string">&quot;&quot;</span><span class="text">
    </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">try</span><span class="text"> </span><span class="id">return</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">offset</span><span class="text"> </span><span class="id">length</span><span class="text">)
      </span><span class="kw1">with</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text"> </span><span class="id">x</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">concat</span><span class="text"> ?(</span><span class="id">sep</span><span class="text">=</span><span class="string">&quot;&quot;</span><span class="text">) </span><span class="id">sl</span><span class="text"> = </span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text"> </span><span class="id">sl</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="id">init</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">res</span><span class="text"> := </span><span class="id">f</span><span class="text"> !</span><span class="id">res</span><span class="text"> </span><span class="id">s</span><span class="text">.[</span><span class="id">i</span><span class="text">];
    </span><span class="kw1">done</span><span class="text">;
    !</span><span class="id">res</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">empty</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">empty</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text">)
      </span><span class="kw1">with</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">mutate_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">c</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">mutate</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="id">c</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">c</span><span class="text">; </span><span class="id">return</span><span class="text"> () </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">blit_exn</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~src_index</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~src_pos</span><span class="text">:</span><span class="id">src_index</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_pos</span><span class="text">:</span><span class="id">dst_index</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:</span><span class="id">length</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~src_index</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="id">blit_exn</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~src_index</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_index</span><span class="text"> </span><span class="kw4">~length</span><span class="text">; </span><span class="id">return</span><span class="text"> ()
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="numeric">-1</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text">)
    </span><span class="kw1">done</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_all</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> (</span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">not</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> </span><span class="kw1">else</span><span class="text"> ()); </span><span class="constant">true</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">exists</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> (</span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> </span><span class="kw1">else</span><span class="text"> ()); </span><span class="constant">false</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> </span><span class="id">t</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">min</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">index_from</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="id">c</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">rindex_from</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="id">c</span><span class="text">)
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">resize_from_length</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="kw4">~length_of_s</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">min</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="id">from</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">lg</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">lg</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">lg</span><span class="text"> -&gt; </span><span class="id">min</span><span class="text"> (</span><span class="id">length_of_s</span><span class="text"> - </span><span class="id">from</span><span class="text">) </span><span class="id">lg</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    (</span><span class="id">from</span><span class="text">, </span><span class="id">length</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text">, </span><span class="id">length</span><span class="text"> = </span><span class="id">resize_from_length</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="kw4">~length_of_s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">found</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">while</span><span class="text"> !</span><span class="id">found</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> &amp;&amp; !</span><span class="id">i</span><span class="text">  &lt; </span><span class="id">length</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> (!</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">))
      </span><span class="kw1">then</span><span class="text"> </span><span class="id">found</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> (!</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">)
      </span><span class="kw1">else</span><span class="text"> </span><span class="id">incr</span><span class="text"> </span><span class="id">i</span><span class="text">
    </span><span class="kw1">done</span><span class="text">;
    !</span><span class="id">found</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = 
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> 
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt;= </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">from</span><span class="text"> + </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">l</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">l</span><span class="text"> &gt;= </span><span class="id">from</span><span class="text"> + </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">from</span><span class="text"> + </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt; </span><span class="id">l</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">found</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">while</span><span class="text"> !</span><span class="id">found</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> &amp;&amp; !</span><span class="id">i</span><span class="text"> &gt;= </span><span class="id">from</span><span class="text"> - </span><span class="id">length</span><span class="text"> + </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="comment">(* dbg &quot;i: %d from: %d length: %d&quot; !i from length; *)</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> !</span><span class="id">i</span><span class="text">)
        </span><span class="kw1">then</span><span class="text"> </span><span class="id">found</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> (!</span><span class="id">i</span><span class="text">)
        </span><span class="kw1">else</span><span class="text"> </span><span class="id">decr</span><span class="text"> </span><span class="id">i</span><span class="text">
      </span><span class="kw1">done</span><span class="text">;
      !</span><span class="id">found</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">filter_map</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text">, </span><span class="id">length</span><span class="text"> = </span><span class="id">resize_from_length</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="kw4">~length_of_s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">empty</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">b</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">)) </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">add_char</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">c</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; ()
      </span><span class="kw1">done</span><span class="text">;
      </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">b</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_strip_function</span><span class="text"> (</span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">string</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw3">char</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = </span><span class="id">empty</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> = </span><span class="id">sub_exn</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> = </span><span class="id">find</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> = </span><span class="id">find_reverse</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> = </span><span class="kw2">Native_character</span><span class="text">.</span><span class="id">is_whitespace</span><span class="text">
    </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_split_function</span><span class="text">(</span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">string</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw3">char</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> = </span><span class="id">sub_exn</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_string</span><span class="text"> = </span><span class="id">index_of_string</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> = </span><span class="id">index_of_character</span><span class="text">
    </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_output</span><span class="text"> (</span><span class="kw2">Model</span><span class="text">: </span><span class="kw2">OUTPUT_MODEL</span><span class="text">) = </span><span class="kw2">Model</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="comment">(* Module to help build `{of,to}_native_[sub]string` functions.

   It is most useful while using variable sized characters. *)</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_native_conversions</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text">
      </span><span class="kw4">~empty</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~on_new_character</span><span class="text"> </span><span class="kw4">~finalize</span><span class="text">
      </span><span class="kw4">~read_character_from_native_string</span><span class="text">
      </span><span class="id">s</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="id">empty</span><span class="text">
    </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">begin</span><span class="text">
        (</span><span class="kw1">if</span><span class="text"> </span><span class="id">offset</span><span class="text"> + </span><span class="id">length</span><span class="text"> &gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">
         </span><span class="kw1">then</span><span class="text"> </span><span class="id">fail</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">
         </span><span class="kw1">else</span><span class="text"> </span><span class="id">return</span><span class="text"> ())
        &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_exn</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
          </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">WChar</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">buf</span><span class="text"> =
            </span><span class="kw">let</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">init</span><span class="text"> () </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">try</span><span class="text">
              </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">index</span><span class="text"> =
                </span><span class="kw1">if</span><span class="text"> </span><span class="id">index</span><span class="text"> &lt; </span><span class="id">offset</span><span class="text"> + </span><span class="id">length</span><span class="text">
                </span><span class="kw1">then</span><span class="text">
                  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">read_character_from_native_string</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw1">with</span><span class="text">
                  | </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">s</span><span class="text">, </span><span class="id">size</span><span class="text">) </span><span class="kw1">when</span><span class="text"> </span><span class="id">index</span><span class="text"> + </span><span class="id">size</span><span class="text"> &lt;= </span><span class="id">offset</span><span class="text"> + </span><span class="id">length</span><span class="text"> -&gt;
                    </span><span class="id">on_new_character</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">s</span><span class="text">;
                    </span><span class="id">loop</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="id">size</span><span class="text">)
                  | </span><span class="kw2">Some</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="comment">(* too big size *)</span><span class="text">)
                  | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">WChar</span><span class="text"> </span><span class="id">index</span><span class="text">)
                  </span><span class="kw1">end</span><span class="text">
                </span><span class="kw1">else</span><span class="text"> ()
              </span><span class="kw">in</span><span class="text">
              </span><span class="id">loop</span><span class="text"> </span><span class="id">offset</span><span class="text">;
              </span><span class="id">return</span><span class="text"> (</span><span class="id">finalize</span><span class="text"> </span><span class="id">x</span><span class="text">)
            </span><span class="kw1">with</span><span class="text">
            | </span><span class="kw2">WChar</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">c</span><span class="text">)
        </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw2">With_exn</span><span class="text">.</span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_string</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~offset</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">return</span><span class="text"> </span><span class="id">o</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">c</span><span class="text">) -&gt; </span><span class="id">fail</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">c</span><span class="text">)
    | `</span><span class="kw2">Error</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text"> -&gt; </span><span class="comment">(* There is a bug ! *)</span><span class="text"> </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">


  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string_knowing_size</span><span class="text">
      </span><span class="kw4">~future_size</span><span class="text"> </span><span class="kw4">~iter</span><span class="text"> </span><span class="kw4">~write_char_to_native_string</span><span class="text"> </span><span class="id">l</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">future_size</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">buf</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="string">'B'</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">iter</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">write_char_to_native_string</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:!</span><span class="id">index</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">siz</span><span class="text"> -&gt;  </span><span class="id">index</span><span class="text"> := !</span><span class="id">index</span><span class="text"> + </span><span class="id">siz</span><span class="text">
      | `</span><span class="kw2">Error</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text"> -&gt;
        </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;Bug in Make_native_conversions.to_native_string&quot;</span><span class="text">
    </span><span class="kw1">end</span><span class="text">;
    </span><span class="id">buf</span><span class="text">

</span><span class="kw1">end</span><span class="text">





</span><span class="kw">module</span><span class="text"> </span><span class="kw2">List_of</span><span class="text"> (</span><span class="kw2">Char</span><span class="text">: </span><span class="kw2">BASIC_CHARACTER</span><span class="text">) :
  </span><span class="kw2">BASIC_STRING</span><span class="text">
  </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text">
  </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text">

  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">character</span><span class="text"> </span><span class="kw3">list</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = []
  </span><span class="kw">let</span><span class="text"> </span><span class="id">is_empty</span><span class="text"> = (=) []

  </span><span class="kw">let</span><span class="text"> </span><span class="id">make</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="id">acc</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> &gt;= </span><span class="id">length</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">loop</span><span class="text"> (</span><span class="id">n</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">c</span><span class="text"> :: </span><span class="id">acc</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="numeric">0</span><span class="text"> []

  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_character</span><span class="text"> </span><span class="id">c</span><span class="text"> = [</span><span class="id">c</span><span class="text">]
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_character_list</span><span class="text"> </span><span class="id">cl</span><span class="text"> = </span><span class="id">cl</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_character_list</span><span class="text"> </span><span class="id">cl</span><span class="text"> = </span><span class="id">cl</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">get</span><span class="text"> </span><span class="id">sl</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">nth</span><span class="text"> </span><span class="id">sl</span><span class="text"> </span><span class="id">index</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="id">acc</span><span class="text"> = </span><span class="kw">function</span><span class="text">
    | [] -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="id">q</span><span class="text"> :: </span><span class="id">t</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">index</span><span class="text"> -&gt;
      </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_append</span><span class="text"> </span><span class="id">acc</span><span class="text"> (</span><span class="id">v</span><span class="text"> :: </span><span class="id">t</span><span class="text">))
    | </span><span class="id">q</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt;
      </span><span class="id">loop</span><span class="text"> (</span><span class="id">n</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">q</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">t</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">loop</span><span class="text"> </span><span class="numeric">0</span><span class="text"> [] </span><span class="id">s</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">get</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;get_exn&quot;</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">set_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;set_exn&quot;</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw4">~f</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> = </span><span class="kw2">Core_list_map</span><span class="text">.</span><span class="id">map</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_all</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">exists</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> (</span><span class="id">a</span><span class="text"> : </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text">) (</span><span class="id">b</span><span class="text">: </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text">) = </span><span class="id">compare</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw2">Make_native_conversions</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text">
      </span><span class="kw4">~empty</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw1">ref</span><span class="text"> [])
      </span><span class="kw4">~on_new_character</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> := </span><span class="id">c</span><span class="text"> :: !</span><span class="id">x</span><span class="text">)
      </span><span class="kw4">~finalize</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">x</span><span class="text">)
      </span><span class="kw4">~read_character_from_native_string</span><span class="text">:</span><span class="kw2">Char</span><span class="text">.</span><span class="id">read_from_native_string</span><span class="text">
      </span><span class="id">s</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw2">Make_native_conversions</span><span class="text">.</span><span class="id">of_native_string</span><span class="text">
      </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">s</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">l</span><span class="text"> =
    </span><span class="kw2">Make_native_conversions</span><span class="text">.</span><span class="id">to_native_string_knowing_size</span><span class="text">
      </span><span class="kw4">~future_size</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">sum</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">sum</span><span class="text"> + </span><span class="kw2">Char</span><span class="text">.</span><span class="id">size</span><span class="text"> </span><span class="id">c</span><span class="text">))
      </span><span class="kw4">~iter</span><span class="text"> </span><span class="kw4">~write_char_to_native_string</span><span class="text">:</span><span class="kw2">Char</span><span class="text">.</span><span class="id">write_to_native_string</span><span class="text">
      </span><span class="id">l</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text"> (</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">l</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">concat</span><span class="text"> ?(</span><span class="id">sep</span><span class="text">=[]) </span><span class="id">ll</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">ll</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; []
    | </span><span class="id">hh</span><span class="text"> :: </span><span class="id">tt</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">hh</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">tt</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
        </span><span class="id">x</span><span class="text"> := </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_append</span><span class="text"> </span><span class="id">sep</span><span class="text"> !</span><span class="id">x</span><span class="text">;
        </span><span class="id">x</span><span class="text"> := </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_append</span><span class="text"> </span><span class="id">l</span><span class="text"> !</span><span class="id">x</span><span class="text">;
        );
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">x</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text">



  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">r</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iteri</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">a</span><span class="text"> -&gt;
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">i</span><span class="text"> &gt;= </span><span class="id">index</span><span class="text"> + </span><span class="id">length</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">;
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">index</span><span class="text"> &lt;= </span><span class="id">i</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
            </span><span class="id">r</span><span class="text">:= </span><span class="id">a</span><span class="text"> :: !</span><span class="id">r</span><span class="text">;
            </span><span class="id">incr</span><span class="text"> </span><span class="id">c</span><span class="text">;
          );
        );
      </span><span class="kw1">if</span><span class="text"> !</span><span class="id">c</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">r</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Not_found</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">r</span><span class="text">)
    
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;sub_exn(%d,%d)&quot;</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> </span><span class="id">t</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt;
          </span><span class="kw1">if</span><span class="text"> !</span><span class="id">index</span><span class="text"> &gt;= </span><span class="id">from</span><span class="text">
          </span><span class="kw1">then</span><span class="text">
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">c</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;found&quot;</span><span class="text">
            </span><span class="kw1">else</span><span class="text"> </span><span class="id">incr</span><span class="text"> </span><span class="id">index</span><span class="text">
          </span><span class="kw1">else</span><span class="text"> </span><span class="id">incr</span><span class="text"> </span><span class="id">index</span><span class="text">);
      </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> !</span><span class="id">index</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_t</span><span class="text">, </span><span class="id">rev</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">lgth</span><span class="text"> </span><span class="id">acc</span><span class="text"> = </span><span class="kw">function</span><span class="text">
      | [] -&gt; (</span><span class="id">lgth</span><span class="text">, </span><span class="id">acc</span><span class="text">)
      | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">loop</span><span class="text"> (</span><span class="id">lgth</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">h</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">loop</span><span class="text"> </span><span class="numeric">0</span><span class="text"> [] </span><span class="id">t</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> </span><span class="id">rev</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="id">length_of_t</span><span class="text"> - </span><span class="id">from</span><span class="text"> - </span><span class="numeric">1</span><span class="text">) </span><span class="id">c</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">length_of_t</span><span class="text"> - </span><span class="id">c</span><span class="text"> - </span><span class="numeric">1</span><span class="text">)
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">b</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_exns</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Left</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Right</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">drop_until</span><span class="text"> </span><span class="kw4">~exn</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="id">l</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">idx</span><span class="text">, </span><span class="id">l</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="numeric">0</span><span class="text">, </span><span class="id">l</span><span class="text"> -&gt; </span><span class="id">l</span><span class="text">
        | </span><span class="id">more</span><span class="text">, [] -&gt; </span><span class="id">raise</span><span class="text"> </span><span class="id">exn</span><span class="text">
        | </span><span class="id">more</span><span class="text">, </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">drop_until</span><span class="text"> </span><span class="kw4">~exn</span><span class="text"> (</span><span class="id">more</span><span class="text"> - </span><span class="numeric">1</span><span class="text">) </span><span class="id">t</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> () =
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">cmp</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="id">len1</span><span class="text"> </span><span class="id">len2</span><span class="text"> =
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">len1</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Left</span><span class="text">;
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">len2</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Right</span><span class="text">;
            </span><span class="kw1">match</span><span class="text"> </span><span class="id">l1</span><span class="text">, </span><span class="id">l2</span><span class="text"> </span><span class="kw1">with</span><span class="text">
            | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">len1</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">len2</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
            | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">len1</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
            | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">len2</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">
            | [], [] </span><span class="kw1">when</span><span class="text"> </span><span class="id">len1</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> || </span><span class="id">len2</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="kw2">Pervasives</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text">
            | [], </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">len1</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Left</span><span class="text">
            | </span><span class="numeric">_</span><span class="text">, [] </span><span class="kw1">when</span><span class="text"> </span><span class="id">len2</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Right</span><span class="text">
            | </span><span class="id">h1</span><span class="text"> :: </span><span class="id">t1</span><span class="text">, </span><span class="id">h2</span><span class="text"> :: </span><span class="id">t2</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="kw2">Char</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">h1</span><span class="text"> </span><span class="id">h2</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> -&gt;
              </span><span class="id">cmp</span><span class="text"> </span><span class="id">t1</span><span class="text"> </span><span class="id">t2</span><span class="text"> (</span><span class="id">len1</span><span class="text"> - </span><span class="numeric">1</span><span class="text">) (</span><span class="id">len2</span><span class="text"> - </span><span class="numeric">1</span><span class="text">)
            | </span><span class="id">h1</span><span class="text"> :: </span><span class="numeric">_</span><span class="text">, </span><span class="id">h2</span><span class="text"> :: </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">Char</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">h1</span><span class="text"> </span><span class="id">h2</span><span class="text">
            | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="comment">(* calming down the warnings.. *)</span><span class="text">
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">lena</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> &amp;&amp; </span><span class="id">lenb</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text">
          </span><span class="kw1">else</span><span class="text"> (
            </span><span class="kw">let</span><span class="text"> </span><span class="id">aa</span><span class="text"> = </span><span class="id">drop_until</span><span class="text"> </span><span class="kw4">~exn</span><span class="text">:</span><span class="kw2">Left</span><span class="text"> </span><span class="id">idxa</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">bb</span><span class="text"> = </span><span class="id">drop_until</span><span class="text"> </span><span class="kw4">~exn</span><span class="text">:</span><span class="kw2">Right</span><span class="text"> </span><span class="id">idxb</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="kw">in</span><span class="text">
            (</span><span class="id">cmp</span><span class="text"> </span><span class="id">aa</span><span class="text"> </span><span class="id">bb</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text">)
          )
        </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Left</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
        | </span><span class="kw2">Right</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Failure</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">
          </span><span class="comment">(* dbg &quot;(%d, %d/%d) Vs (%d, %d/%d) %s&quot; idxa lena (length a) idxb lenb (length b) s; *)</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
    </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">With_exns</span><span class="text">.</span><span class="id">f</span><span class="text"> ()

  </span><span class="kw">type</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">t</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">T_length_and_compsub</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
    </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring</span><span class="text"> = </span><span class="id">compare_substring</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Compare_substring_strict_of_loose</span><span class="text">(</span><span class="kw2">T_length_and_compsub</span><span class="text">)
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_index_of_string</span><span class="text">(</span><span class="kw2">T_length_and_compsub</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="comment">(* index and virtual_length are maybe a bit redundant but I favor
       readability of the branches of the match *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">find_from</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">virtual_length</span><span class="text"> </span><span class="id">l</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text">, </span><span class="id">length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [], </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
      | </span><span class="numeric">_</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">lgth</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">lgth</span><span class="text"> &lt;= </span><span class="id">virtual_length</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
      | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">index</span><span class="text"> &lt; </span><span class="id">from</span><span class="text"> -&gt; </span><span class="id">find_from</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">virtual_length</span><span class="text"> </span><span class="id">t</span><span class="text">
      | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">index</span><span class="text"> &gt;= </span><span class="id">from</span><span class="text"> &amp;&amp; </span><span class="id">f</span><span class="text"> </span><span class="id">h</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">index</span><span class="text">
      | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">find_from</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">virtual_length</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">t</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">find_from</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="id">s</span><span class="text"> 

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = 
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">length_of_s</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> - </span><span class="id">s</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">find</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw4">~f</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> - </span><span class="id">i</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">filter_map</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">filter_map_rec</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">virtual_length</span><span class="text"> </span><span class="id">l</span><span class="text"> = 
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">l</span><span class="text">, </span><span class="id">length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | [], </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">acc</span><span class="text">
      | </span><span class="numeric">_</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">lgth</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">lgth</span><span class="text"> &lt;= </span><span class="id">virtual_length</span><span class="text"> -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">acc</span><span class="text">
      | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">index</span><span class="text"> &lt; </span><span class="id">from</span><span class="text"> -&gt;
        </span><span class="id">filter_map_rec</span><span class="text"> </span><span class="id">acc</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">virtual_length</span><span class="text"> </span><span class="id">t</span><span class="text">
      | </span><span class="id">h</span><span class="text"> :: </span><span class="id">t</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="comment">(* when index &gt;= from  *)</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">h</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">filter_map_rec</span><span class="text"> (</span><span class="id">o</span><span class="text"> :: </span><span class="id">acc</span><span class="text">) (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">virtual_length</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">t</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">filter_map_rec</span><span class="text"> </span><span class="id">acc</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">virtual_length</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">t</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">filter_map_rec</span><span class="text"> [] </span><span class="numeric">0</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="id">t</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_strip_function</span><span class="text"> (</span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = </span><span class="id">empty</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> = </span><span class="id">sub_exn</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> = </span><span class="id">find</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> = </span><span class="id">find_reverse</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">is_whitespace</span><span class="text">
    </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_split_function</span><span class="text">(</span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text"> </span><span class="kw3">list</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">t</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> = </span><span class="id">sub_exn</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_string</span><span class="text"> = </span><span class="id">index_of_string</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> = </span><span class="id">index_of_character</span><span class="text">
    </span><span class="kw1">end</span><span class="text">)


  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_output</span><span class="text"> (</span><span class="kw2">Model</span><span class="text">: </span><span class="kw2">OUTPUT_MODEL</span><span class="text">) = </span><span class="kw1">struct</span><span class="text">

    </span><span class="kw">let</span><span class="text"> (&gt;&gt;=) = </span><span class="kw2">Model</span><span class="text">.</span><span class="id">bind</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">output</span><span class="text"> </span><span class="id">chan</span><span class="text"> </span><span class="id">l</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="kw2">Model</span><span class="text">.</span><span class="id">return</span><span class="text"> ()) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev_m</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
          </span><span class="id">prev_m</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> () -&gt;
          </span><span class="kw2">Model</span><span class="text">.</span><span class="id">output</span><span class="text"> </span><span class="id">chan</span><span class="text"> (</span><span class="kw2">Char</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">c</span><span class="text">))

  </span><span class="kw1">end</span><span class="text">

</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Int_utf8_character</span><span class="text"> : </span><span class="kw2">BASIC_CHARACTER</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">int</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

    </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">int</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_char</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">int_of_char</span><span class="text"> </span><span class="id">x</span><span class="text">)

    </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> (</span><span class="id">i</span><span class="text">: </span><span class="kw3">int</span><span class="text">) (</span><span class="id">j</span><span class="text"> : </span><span class="kw3">int</span><span class="text">) = </span><span class="id">compare</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">j</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">of_int</span><span class="text"> </span><span class="id">x</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0x7FFF_FFFF</span><span class="text"> = </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_int</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="id">c</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">size</span><span class="text"> </span><span class="id">x</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> &lt;=        </span><span class="numeric">0x7f</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> &lt;=       </span><span class="numeric">0x7ff</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">2</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> &lt;=      </span><span class="numeric">0xffff</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">3</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> &lt;=   </span><span class="numeric">0x1f_ffff</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">4</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> &lt;=  </span><span class="numeric">0x3ff_ffff</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">5</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">x</span><span class="text"> &lt;= </span><span class="numeric">0x7fff_ffff</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">6</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="numeric">0</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_print</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">int_of_char</span><span class="text"> </span><span class="string">' '</span><span class="text"> &lt;= </span><span class="id">t</span><span class="text"> &amp;&amp; </span><span class="id">t</span><span class="text"> &lt;= </span><span class="id">int_of_char</span><span class="text"> </span><span class="string">'~'</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">x</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">is_print</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="numeric">1</span><span class="text"> (</span><span class="id">char_of_int</span><span class="text"> </span><span class="id">x</span><span class="text">)
      </span><span class="kw1">else</span><span class="text"> </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;&amp;#x%X;&quot;</span><span class="text"> </span><span class="id">x</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">write_to_native_string</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sz</span><span class="text"> = </span><span class="id">size</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">try</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">first_byte</span><span class="text"> =
          </span><span class="kw1">match</span><span class="text"> </span><span class="id">sz</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="numeric">1</span><span class="text"> -&gt; ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">  </span><span class="numeric">0</span><span class="text">) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0111</span><span class="numeric">_1111</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b0000</span><span class="numeric">_0000</span><span class="text">
          | </span><span class="numeric">2</span><span class="text"> -&gt; ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">  </span><span class="numeric">6</span><span class="text">) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0001</span><span class="numeric">_1111</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b1100</span><span class="numeric">_0000</span><span class="text">
          | </span><span class="numeric">3</span><span class="text"> -&gt; ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> </span><span class="numeric">12</span><span class="text">) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0000</span><span class="numeric">_1111</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b1110</span><span class="numeric">_0000</span><span class="text">
          | </span><span class="numeric">4</span><span class="text"> -&gt; ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> </span><span class="numeric">18</span><span class="text">) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0000</span><span class="numeric">_0111</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b1111</span><span class="numeric">_0000</span><span class="text">
          | </span><span class="numeric">5</span><span class="text"> -&gt; ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> </span><span class="numeric">24</span><span class="text">) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0000</span><span class="numeric">_0011</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b1111</span><span class="numeric">_1000</span><span class="text">
          | </span><span class="numeric">6</span><span class="text"> -&gt; ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> </span><span class="numeric">30</span><span class="text">) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0000</span><span class="numeric">_0001</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b1111</span><span class="numeric">_1100</span><span class="text">
          | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">buf</span><span class="text">.[</span><span class="id">index</span><span class="text">] &lt;- </span><span class="id">char_of_int</span><span class="text"> </span><span class="id">first_byte</span><span class="text">;
        </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">2</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">sz</span><span class="text">  </span><span class="kw1">do</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">ith_byte</span><span class="text"> =
            ((</span><span class="id">c</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> (</span><span class="numeric">6</span><span class="text"> * (</span><span class="id">i</span><span class="text"> - </span><span class="numeric">2</span><span class="text">))) </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0011</span><span class="numeric">_1111</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> </span><span class="numeric">0b1000</span><span class="numeric">_0000</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">buf</span><span class="text">.[</span><span class="id">index</span><span class="text"> + </span><span class="id">sz</span><span class="text"> - </span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">] &lt;- </span><span class="id">char_of_int</span><span class="text"> </span><span class="id">ith_byte</span><span class="text">;
        </span><span class="kw1">done</span><span class="text">;
        </span><span class="id">return</span><span class="text"> </span><span class="id">sz</span><span class="text">
      </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fail</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">read_from_native_string</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> =
      </span><span class="kw1">try</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">first_char</span><span class="text"> = </span><span class="id">buf</span><span class="text">.[</span><span class="id">index</span><span class="text">] |&gt; </span><span class="id">int_of_char</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">size</span><span class="text">, </span><span class="id">mask</span><span class="text"> =
          </span><span class="kw1">if</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> </span><span class="numeric">7</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0b0111</span><span class="numeric">_1111</span><span class="text">)
          </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">     </span><span class="numeric">5</span><span class="text"> =     </span><span class="numeric">0b110</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="numeric">2</span><span class="text">, </span><span class="numeric">0b0001</span><span class="numeric">_1111</span><span class="text">)
          </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">     </span><span class="numeric">4</span><span class="text"> =    </span><span class="numeric">0b1110</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="numeric">3</span><span class="text">, </span><span class="numeric">0b0000</span><span class="numeric">_1111</span><span class="text">)
          </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">     </span><span class="numeric">3</span><span class="text"> =   </span><span class="numeric">0b11110</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="numeric">4</span><span class="text">, </span><span class="numeric">0b0000</span><span class="numeric">_0111</span><span class="text">)
          </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">     </span><span class="numeric">2</span><span class="text"> =  </span><span class="numeric">0b111110</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="numeric">5</span><span class="text">, </span><span class="numeric">0b0000</span><span class="numeric">_0011</span><span class="text">)
          </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">if</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text">     </span><span class="numeric">1</span><span class="text"> = </span><span class="numeric">0b1111110</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="numeric">6</span><span class="text">, </span><span class="numeric">0b0000</span><span class="numeric">_0001</span><span class="text">)
          </span><span class="kw1">else</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">the_int</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> (</span><span class="id">first_char</span><span class="text"> </span><span class="kw1">land</span><span class="text"> </span><span class="id">mask</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">size</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">the_char</span><span class="text"> = </span><span class="id">buf</span><span class="text">.[</span><span class="id">index</span><span class="text"> + </span><span class="id">i</span><span class="text">] |&gt; </span><span class="id">int_of_char</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">if</span><span class="text"> (</span><span class="id">the_char</span><span class="text"> </span><span class="kw1">lsr</span><span class="text"> </span><span class="numeric">6</span><span class="text">) = </span><span class="numeric">0b10</span><span class="text">
          </span><span class="kw1">then</span><span class="text"> (
            </span><span class="id">the_int</span><span class="text"> := (!</span><span class="id">the_int</span><span class="text"> </span><span class="kw1">lsl</span><span class="text"> </span><span class="numeric">6</span><span class="text">) </span><span class="kw1">lor</span><span class="text"> (</span><span class="id">the_char</span><span class="text"> </span><span class="kw1">land</span><span class="text"> </span><span class="numeric">0b0011</span><span class="numeric">_1111</span><span class="text">);
          ) </span><span class="kw1">else</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">;
        </span><span class="kw1">done</span><span class="text">;
        </span><span class="kw2">Some</span><span class="text"> (!</span><span class="id">the_int</span><span class="text">, </span><span class="id">size</span><span class="text">)
      </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">x</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">buf</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> (</span><span class="id">size</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="string">'B'</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">write_to_native_string</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw4">~buf</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; ()
      | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
        </span><span class="id">dbg</span><span class="text"> </span><span class="string">&quot;buf: %S siz: %d x: %d&quot;</span><span class="text"> </span><span class="id">buf</span><span class="text"> (</span><span class="id">size</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="id">x</span><span class="text">;
        </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">
      </span><span class="kw1">end</span><span class="text">;
      </span><span class="id">buf</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> </span><span class="id">c</span><span class="text"> = 
      </span><span class="kw1">try</span><span class="text"> 
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">char_of_int</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="string">' '</span><span class="text"> | </span><span class="string">'\t'</span><span class="text"> | </span><span class="string">'\r'</span><span class="text"> | </span><span class="string">'\n'</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text"> | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
      </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

</span><span class="kw1">end</span><span class="text">


</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">MINIMALISTIC_MUTABLE_STRING</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text">
  </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">empty</span><span class="text">: </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">make</span><span class="text">: </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">length</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">compare_char</span><span class="text">: </span><span class="id">character</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">get</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">set</span><span class="text">: </span><span class="id">t</span><span class="text"> -&gt; </span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">blit</span><span class="text">: </span><span class="id">src</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">src_pos</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">dst</span><span class="text">:</span><span class="id">t</span><span class="text"> -&gt; </span><span class="id">dst_pos</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="id">len</span><span class="text">:</span><span class="kw3">int</span><span class="text"> -&gt; </span><span class="kw3">unit</span><span class="text">

  </span><span class="kw">val</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text">: </span><span class="id">character</span><span class="text"> -&gt; </span><span class="kw3">bool</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">NATIVE_CONVERSIONS</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> := </span><span class="id">t</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Of_mutable</span><span class="text">
    (</span><span class="kw2">S</span><span class="text">: </span><span class="kw2">MINIMALISTIC_MUTABLE_STRING</span><span class="text">) :
  </span><span class="kw2">BASIC_STRING</span><span class="text">
  </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">character</span><span class="text">
  </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">t</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">S</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">is_empty</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text"> </span><span class="id">ignore</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="numeric">0</span><span class="text">); </span><span class="constant">false</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">index</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text">:</span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">lgth</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">index</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> || </span><span class="id">lgth</span><span class="text"> &lt;= </span><span class="id">index</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">make</span><span class="text"> </span><span class="id">lgth</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~dst</span><span class="text">:</span><span class="id">res</span><span class="text"> </span><span class="kw4">~dst_pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~src</span><span class="text">:</span><span class="id">t</span><span class="text"> </span><span class="kw4">~src_pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:</span><span class="id">lgth</span><span class="text">;
        </span><span class="kw2">S</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">c</span><span class="text">;
        </span><span class="id">res</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">index</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">set_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~v</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;set_exn&quot;</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_character</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="id">make</span><span class="text"> </span><span class="numeric">1</span><span class="text"> </span><span class="id">c</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">of_character_list</span><span class="text"> </span><span class="id">cl</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">cl</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; </span><span class="id">empty</span><span class="text">
    | </span><span class="id">one</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">make</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">cl</span><span class="text">) </span><span class="id">one</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">iteri</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text">  </span><span class="id">i</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
          </span><span class="kw2">S</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">res</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="id">c</span><span class="text">);
      </span><span class="id">res</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">res</span><span class="text"> := </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">i</span><span class="text"> :: !</span><span class="id">res</span><span class="text">
    </span><span class="kw1">done</span><span class="text">;
    !</span><span class="id">res</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">concat</span><span class="text">  ?(</span><span class="id">sep</span><span class="text">=</span><span class="id">empty</span><span class="text">) </span><span class="id">tl</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">tl</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; </span><span class="id">empty</span><span class="text">
    | </span><span class="id">one</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">first_char</span><span class="text"> =
          </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">one</span><span class="text"> </span><span class="numeric">0</span><span class="text">
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">sep</span><span class="text"> </span><span class="numeric">0</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sep_length</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">sep</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">total_length</span><span class="text"> =
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold_left</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">one</span><span class="text">) </span><span class="id">more</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
              </span><span class="id">prev</span><span class="text"> + </span><span class="id">sep_length</span><span class="text"> + </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">dst</span><span class="text"> = </span><span class="id">make</span><span class="text"> </span><span class="id">total_length</span><span class="text"> </span><span class="id">first_char</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_pos</span><span class="text">:!</span><span class="id">index</span><span class="text"> </span><span class="kw4">~src</span><span class="text">:</span><span class="id">one</span><span class="text"> </span><span class="kw4">~src_pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">one</span><span class="text">);
        </span><span class="id">index</span><span class="text"> := !</span><span class="id">index</span><span class="text"> + (</span><span class="id">length</span><span class="text"> </span><span class="id">one</span><span class="text">);
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
            </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_pos</span><span class="text">:!</span><span class="id">index</span><span class="text"> </span><span class="kw4">~src</span><span class="text">:</span><span class="id">sep</span><span class="text"> </span><span class="kw4">~src_pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:</span><span class="id">sep_length</span><span class="text">;
            </span><span class="id">index</span><span class="text"> := !</span><span class="id">index</span><span class="text"> + </span><span class="id">sep_length</span><span class="text">;
            </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_pos</span><span class="text">:!</span><span class="id">index</span><span class="text"> </span><span class="kw4">~src</span><span class="text">:</span><span class="id">s</span><span class="text"> </span><span class="kw4">~src_pos</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~len</span><span class="text">:(</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">);
            </span><span class="id">index</span><span class="text"> := !</span><span class="id">index</span><span class="text"> + (</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">);
          );
        </span><span class="id">dst</span><span class="text">
      </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
        </span><span class="id">concat</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw4">~sep</span><span class="text"> </span><span class="comment">(* both one and sep are empty *)</span><span class="text">
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">f</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text">)
    </span><span class="kw1">done</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">iter_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="numeric">-1</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">f</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text">)
    </span><span class="kw1">done</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">fold</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="id">init</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">x</span><span class="text"> := </span><span class="id">f</span><span class="text"> !</span><span class="id">x</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text">)
    </span><span class="kw1">done</span><span class="text">;
    !</span><span class="id">x</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">map</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">lgth</span><span class="text"> = (</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">lgth</span><span class="text"> = </span><span class="numeric">0</span><span class="text">
    </span><span class="kw1">then</span><span class="text"> </span><span class="id">empty</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">make</span><span class="text"> </span><span class="id">lgth</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">lgth</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="kw2">S</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">i</span><span class="text"> (</span><span class="id">f</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text">))
      </span><span class="kw1">done</span><span class="text">;
      </span><span class="id">res</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">for_all</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text">
      </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">not</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">);
      </span><span class="constant">true</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">exists</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw1">try</span><span class="text">
      </span><span class="id">iter</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> (</span><span class="id">f</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">);
      </span><span class="constant">false</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">empty</span><span class="text"> </span><span class="kw1">else</span><span class="text">
      </span><span class="kw1">begin</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">lgth</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">lgth</span><span class="text"> = </span><span class="numeric">0</span><span class="text">
        </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="comment">(* `length &lt;&gt; 0` *)</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
          </span><span class="kw1">try</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">make</span><span class="text"> </span><span class="id">length</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">index</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
              </span><span class="kw2">S</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">i</span><span class="text"> (</span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="id">i</span><span class="text">))
            </span><span class="kw1">done</span><span class="text">;
            </span><span class="kw2">Some</span><span class="text"> </span><span class="id">res</span><span class="text">
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="string">&quot;sub_exn(%d,%d)&quot;</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">t</span><span class="text"> |&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%S&quot;</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> </span><span class="id">t</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">min</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">from</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">c</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">res</span><span class="text">:= </span><span class="kw2">Some</span><span class="text"> </span><span class="id">i</span><span class="text">; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">)
      </span><span class="kw1">done</span><span class="text">;
      </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; !</span><span class="id">res</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">c</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_t</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">length_of_t</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">from</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">c</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">res</span><span class="text">:= </span><span class="kw2">Some</span><span class="text"> </span><span class="id">i</span><span class="text">; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">)
      </span><span class="kw1">done</span><span class="text">;
      </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; !</span><span class="id">res</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">b</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">With_exns</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Return</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Left_out</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
      </span><span class="kw">exception</span><span class="text"> </span><span class="kw2">Right_out</span><span class="text"> </span><span class="kw">of</span><span class="text"> </span><span class="kw3">int</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> () =
        </span><span class="kw1">try</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">shortest</span><span class="text"> = </span><span class="id">min</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">shortest</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">ca</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">a</span><span class="text"> (</span><span class="id">idxa</span><span class="text"> + </span><span class="id">i</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Left_out</span><span class="text"> </span><span class="id">i</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">cb</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">S</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">b</span><span class="text"> (</span><span class="id">idxb</span><span class="text"> + </span><span class="id">i</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Right_out</span><span class="text"> </span><span class="id">i</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">compare_char</span><span class="text">  </span><span class="id">ca</span><span class="text"> </span><span class="id">cb</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">c</span><span class="text"> &lt;&gt; </span><span class="numeric">0</span><span class="text">
            </span><span class="kw1">then</span><span class="text"> </span><span class="id">raise</span><span class="text"> (</span><span class="kw2">Return</span><span class="text"> </span><span class="id">c</span><span class="text">)
            </span><span class="kw1">else</span><span class="text"> ()
          </span><span class="kw1">done</span><span class="text">;
          (</span><span class="kw2">Pervasives</span><span class="text">.</span><span class="id">compare</span><span class="text"> (</span><span class="id">lena</span><span class="text"> : </span><span class="kw3">int</span><span class="text">) </span><span class="id">lenb</span><span class="text">)
        </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Return</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">
        | </span><span class="kw2">Left_out</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="comment">(* a went out of bounds at 'c + idxa' *)</span><span class="text"> </span><span class="numeric">-1</span><span class="text">
        | </span><span class="kw2">Right_out</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="comment">(* b went out of bounds at 'c + idxb' *)</span><span class="text">
          </span><span class="comment">(* so, a is “longer” *)</span><span class="text"> </span><span class="numeric">1</span><span class="text">
    </span><span class="kw1">end</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">With_exns</span><span class="text">.</span><span class="id">f</span><span class="text"> ()

  </span><span class="kw">type</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">t</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">T_length_and_compsub</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
    </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">s</span><span class="text"> </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text"> </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_substring</span><span class="text"> = </span><span class="id">compare_substring</span><span class="text">
  </span><span class="kw1">end</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Compare_substring_strict_of_loose</span><span class="text">(</span><span class="kw2">T_length_and_compsub</span><span class="text">)
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_index_of_string</span><span class="text">(</span><span class="kw2">T_length_and_compsub</span><span class="text">)


  </span><span class="kw">let</span><span class="text"> </span><span class="id">resize_from_length</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="kw4">~length_of_s</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">min</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="id">from</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">lg</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">lg</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">lg</span><span class="text"> -&gt; </span><span class="id">min</span><span class="text"> (</span><span class="id">length_of_s</span><span class="text"> - </span><span class="id">from</span><span class="text">) </span><span class="id">lg</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    (</span><span class="id">from</span><span class="text">, </span><span class="id">length</span><span class="text">)

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text">, </span><span class="id">length</span><span class="text"> = </span><span class="id">resize_from_length</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="kw4">~length_of_s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">found</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">while</span><span class="text"> !</span><span class="id">found</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> &amp;&amp; !</span><span class="id">i</span><span class="text">  &lt; </span><span class="id">length</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> (!</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">))
      </span><span class="kw1">then</span><span class="text"> </span><span class="id">found</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> (!</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">)
      </span><span class="kw1">else</span><span class="text"> </span><span class="id">incr</span><span class="text"> </span><span class="id">i</span><span class="text">
    </span><span class="kw1">done</span><span class="text">;
    !</span><span class="id">found</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">None</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = 
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> 
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">-1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">s</span><span class="text"> &gt;= </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">length_of_s</span><span class="text"> - </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">from</span><span class="text"> + </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">l</span><span class="text"> &lt;= </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">l</span><span class="text"> &gt;= </span><span class="id">from</span><span class="text"> + </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="id">from</span><span class="text"> + </span><span class="numeric">1</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt; </span><span class="id">l</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">found</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="id">from</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">while</span><span class="text"> !</span><span class="id">found</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> &amp;&amp; !</span><span class="id">i</span><span class="text"> &gt;= </span><span class="id">from</span><span class="text"> - </span><span class="id">length</span><span class="text"> + </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="comment">(* dbg &quot;i: %d from: %d length: %d&quot; !i from length; *)</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> !</span><span class="id">i</span><span class="text">)
        </span><span class="kw1">then</span><span class="text"> </span><span class="id">found</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> (!</span><span class="id">i</span><span class="text">)
        </span><span class="kw1">else</span><span class="text"> </span><span class="id">decr</span><span class="text"> </span><span class="id">i</span><span class="text">
      </span><span class="kw1">done</span><span class="text">;
      !</span><span class="id">found</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">filter_map</span><span class="text"> ?(</span><span class="id">from</span><span class="text">=</span><span class="numeric">0</span><span class="text">) ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length_of_s</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text">, </span><span class="id">length</span><span class="text"> = </span><span class="id">resize_from_length</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="kw4">~length_of_s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">empty</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">length</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="id">get_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="id">from</span><span class="text">)) </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">res</span><span class="text"> := </span><span class="id">c</span><span class="text"> :: !</span><span class="id">res</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; ()
      </span><span class="kw1">done</span><span class="text">;
      </span><span class="id">of_character_list</span><span class="text"> !</span><span class="id">res</span><span class="text">
    </span><span class="kw1">end</span><span class="text">

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_strip_function</span><span class="text"> (</span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">t</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">character</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = </span><span class="id">empty</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> = </span><span class="id">sub_exn</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">find</span><span class="text"> = </span><span class="id">find</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">find_reverse</span><span class="text"> = </span><span class="id">find_reverse</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">is_whitespace</span><span class="text">
    </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">Make_split_function</span><span class="text">(</span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">t</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">S</span><span class="text">.</span><span class="id">character</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="id">length</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_exn</span><span class="text"> = </span><span class="id">sub_exn</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_string</span><span class="text"> = </span><span class="id">index_of_string</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">index_of_character</span><span class="text"> = </span><span class="id">index_of_character</span><span class="text">
    </span><span class="kw1">end</span><span class="text">)

  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Make_output</span><span class="text"> (</span><span class="kw2">Model</span><span class="text">: </span><span class="kw2">OUTPUT_MODEL</span><span class="text">) = </span><span class="kw1">struct</span><span class="text">

    </span><span class="kw">let</span><span class="text"> (&gt;&gt;=) = </span><span class="kw2">Model</span><span class="text">.</span><span class="id">bind</span><span class="text">

    </span><span class="kw">let</span><span class="text"> </span><span class="id">output</span><span class="text"> </span><span class="id">chan</span><span class="text"> </span><span class="id">t</span><span class="text"> =
      </span><span class="kw2">Model</span><span class="text">.</span><span class="id">output</span><span class="text"> </span><span class="id">chan</span><span class="text"> (</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">t</span><span class="text">)

  </span><span class="kw1">end</span><span class="text">
</span><span class="kw1">end</span><span class="text">
</span></pre></div></div></div></body><html>