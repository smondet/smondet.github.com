<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Api" rel="Chapter" href="Api.html">
<link title="Functors" rel="Chapter" href="Functors.html">
<link title="Native_character" rel="Chapter" href="Native_character.html">
<link title="Native_string" rel="Chapter" href="Native_string.html">
<link title="Native_bytes" rel="Chapter" href="Native_bytes.html">
<link title="List_of" rel="Chapter" href="List_of.html">
<link title="Of_mutable" rel="Chapter" href="Of_mutable.html">
<link title="Int_utf8_character" rel="Chapter" href="Int_utf8_character.html"><title>Functors.Make_native</title>
</head>
<body>
<code class="code">(<span class="constructor">B</span>&nbsp;:<br>
&nbsp;&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;empty&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;length&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;get&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;make&nbsp;:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;init&nbsp;:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f:(int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;compare&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;concat&nbsp;:&nbsp;sep:t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;iter&nbsp;:&nbsp;f:(char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;iteri&nbsp;:&nbsp;f:(int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<span class="keywordsign">-&gt;</span>&nbsp;unit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;map&nbsp;:&nbsp;f:(char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;mapi&nbsp;:&nbsp;f:(int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;index_from&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;rindex_from&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;char&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;sub&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;pos:int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;len:int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;of_buffer&nbsp;:&nbsp;<span class="constructor">Buffer</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;string_for_output&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
&nbsp;&nbsp;<span class="keyword">end</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;character&nbsp;=&nbsp;char<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">B</span>.t<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;max_string_length&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="constructor">Sys</span>.max_string_length<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;empty&nbsp;=&nbsp;<span class="constructor">B</span>.empty<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compare&nbsp;=&nbsp;<span class="constructor">B</span>.compare<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_empty&nbsp;t&nbsp;=&nbsp;(compare&nbsp;<span class="constructor">B</span>.empty&nbsp;t&nbsp;=&nbsp;0)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">B</span>.make<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=&nbsp;<span class="constructor">B</span>.length<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;of_character&nbsp;=&nbsp;<span class="constructor">B</span>.make&nbsp;1<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;of_character_list&nbsp;cl&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r&nbsp;=&nbsp;ref&nbsp;cl&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">B</span>.init&nbsp;(<span class="constructor">List</span>.length&nbsp;cl)&nbsp;~f:(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">List</span>.hd&nbsp;!r&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;:=&nbsp;<span class="constructor">List</span>.tl&nbsp;!r;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_character_list&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;ref&nbsp;[]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;length&nbsp;s&nbsp;-&nbsp;1&nbsp;<span class="keyword">downto</span>&nbsp;0&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;:=&nbsp;(<span class="constructor">B</span>.get&nbsp;s&nbsp;i)&nbsp;::&nbsp;!res<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!res<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get&nbsp;s&nbsp;~index&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">B</span>.get&nbsp;s&nbsp;index)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Since&nbsp;our&nbsp;set&nbsp;always&nbsp;returns&nbsp;a&nbsp;copy!&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;set&nbsp;s&nbsp;~index&nbsp;~v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;index&nbsp;&gt;&nbsp;length&nbsp;s&nbsp;-&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">B</span>.mapi&nbsp;(<span class="keyword">fun</span>&nbsp;i&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;i&nbsp;=&nbsp;index&nbsp;<span class="keyword">then</span>&nbsp;v&nbsp;<span class="keyword">else</span>&nbsp;c)&nbsp;s)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_exn&nbsp;s&nbsp;~index&nbsp;=&nbsp;<span class="constructor">B</span>.get&nbsp;s&nbsp;index<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;set_exn&nbsp;s&nbsp;~index&nbsp;~v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;set&nbsp;s&nbsp;~index&nbsp;~v&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_arg&nbsp;<span class="string">"set_exn"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compare&nbsp;=&nbsp;<span class="constructor">B</span>.compare<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compare_substring&nbsp;(a,&nbsp;idxa,&nbsp;lena)&nbsp;(b,&nbsp;idxb,&nbsp;lenb)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">With_exns</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">exception</span>&nbsp;<span class="constructor">Return</span>&nbsp;<span class="keyword">of</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">exception</span>&nbsp;<span class="constructor">Left_out</span>&nbsp;<span class="keyword">of</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">exception</span>&nbsp;<span class="constructor">Right_out</span>&nbsp;<span class="keyword">of</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;shortest&nbsp;=&nbsp;min&nbsp;lena&nbsp;lenb&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;shortest&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ca&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">B</span>.get&nbsp;a&nbsp;(idxa&nbsp;+&nbsp;i)&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Left_out</span>&nbsp;i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cb&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">B</span>.get&nbsp;b&nbsp;(idxb&nbsp;+&nbsp;i)&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;(<span class="constructor">Right_out</span>&nbsp;i)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;<span class="constructor">Char</span>.compare&nbsp;ca&nbsp;cb&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;c&nbsp;&lt;&gt;&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;raise&nbsp;(<span class="constructor">Return</span>&nbsp;c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Pervasives</span>.compare&nbsp;(lena&nbsp;:&nbsp;int)&nbsp;lenb)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Return</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Left_out</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="comment">(*&nbsp;a&nbsp;went&nbsp;out&nbsp;of&nbsp;bounds&nbsp;at&nbsp;'c&nbsp;+&nbsp;idxa'&nbsp;*)</span>&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Right_out</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="comment">(*&nbsp;b&nbsp;went&nbsp;out&nbsp;of&nbsp;bounds&nbsp;at&nbsp;'c&nbsp;+&nbsp;idxb'&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;so,&nbsp;a&nbsp;is&nbsp;“longer”&nbsp;*)</span>&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">With_exns</span>.f&nbsp;()<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;s&nbsp;=&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">T_length_and_compsub</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=&nbsp;length<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compare_substring&nbsp;=&nbsp;compare_substring<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Compare_substring_strict_of_loose</span>(<span class="constructor">T_length_and_compsub</span>)<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Make_index_of_string</span>(<span class="constructor">T_length_and_compsub</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;?(sep=<span class="constructor">B</span>.empty)&nbsp;sl&nbsp;=&nbsp;<span class="constructor">B</span>.concat&nbsp;~sep&nbsp;sl<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fold&nbsp;t&nbsp;~init&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;ref&nbsp;init&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;length&nbsp;t&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;:=&nbsp;f&nbsp;!res&nbsp;(<span class="constructor">B</span>.get&nbsp;t&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!res<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;foldi&nbsp;t&nbsp;~init&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;ref&nbsp;init&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;length&nbsp;t&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;:=&nbsp;f&nbsp;i&nbsp;!res&nbsp;(<span class="constructor">B</span>.&nbsp;get&nbsp;t&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!res<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fold2_exn&nbsp;t1&nbsp;t2&nbsp;~init&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lgth1&nbsp;=&nbsp;(length&nbsp;t1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lgth2&nbsp;=&nbsp;(length&nbsp;t2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;lgth1,&nbsp;lgth2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0,&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;init<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;_&nbsp;<span class="keyword">when</span>&nbsp;lgth1&nbsp;&lt;&gt;&nbsp;lgth2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_arg&nbsp;<span class="string">"fold2_exn"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;lgth1,&nbsp;lgth2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;ref&nbsp;init&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;lgth1&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;:=&nbsp;f&nbsp;!res&nbsp;(<span class="constructor">B</span>.get&nbsp;t1&nbsp;i)&nbsp;(<span class="constructor">B</span>.get&nbsp;t2&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!res<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub_exn&nbsp;t&nbsp;~index&nbsp;~length&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;length&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;empty&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">B</span>.sub&nbsp;t&nbsp;~pos:index&nbsp;~len:length<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub&nbsp;t&nbsp;~index&nbsp;~length&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;length&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;empty&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">B</span>.sub&nbsp;t&nbsp;~pos:index&nbsp;~len:length)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;slice_exn&nbsp;?(start=0)&nbsp;?finish&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length_of_t&nbsp;=&nbsp;length&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bound_check&nbsp;strict&nbsp;m&nbsp;x&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;out_of_ub&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;strict&nbsp;<span class="keyword">then</span>&nbsp;x&nbsp;&gt;&nbsp;length_of_t&nbsp;<span class="keyword">else</span>&nbsp;x&nbsp;&gt;=&nbsp;length_of_t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;x&nbsp;&lt;&nbsp;0&nbsp;<span class="keywordsign">||</span>&nbsp;(not&nbsp;(is_empty&nbsp;t)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;out_of_ub)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Printf</span>.ksprintf&nbsp;invalid_arg&nbsp;<span class="string">"slice_exn:&nbsp;invalid&nbsp;%s&nbsp;%d"</span>&nbsp;m&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;_&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;bound_check&nbsp;<span class="keyword">false</span>&nbsp;<span class="string">"start"</span>&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;finish&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;finish&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;length_of_t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bound_check&nbsp;<span class="keyword">true</span>&nbsp;<span class="string">"finish"</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sub_exn&nbsp;t&nbsp;~index:start&nbsp;~length:(finish&nbsp;-&nbsp;start)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;slice&nbsp;?start&nbsp;?finish&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(slice_exn&nbsp;?start&nbsp;?finish&nbsp;t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter&nbsp;t&nbsp;~f&nbsp;=&nbsp;<span class="constructor">B</span>.iter&nbsp;t&nbsp;~f<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iteri&nbsp;t&nbsp;~f&nbsp;=&nbsp;<span class="constructor">B</span>.iteri&nbsp;t&nbsp;~f<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter_reverse&nbsp;t&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;length&nbsp;t&nbsp;-1&nbsp;<span class="keyword">downto</span>&nbsp;0&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(get_exn&nbsp;t&nbsp;i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rev&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lgth&nbsp;=&nbsp;length&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;lgth&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;empty<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;lgth&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;o&nbsp;=&nbsp;lgth&nbsp;-&nbsp;1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">B</span>.mapi&nbsp;~f:(<span class="keyword">fun</span>&nbsp;i&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">B</span>.get&nbsp;t&nbsp;(o&nbsp;-&nbsp;i))&nbsp;t<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;map&nbsp;t&nbsp;~f&nbsp;=&nbsp;<span class="constructor">B</span>.map&nbsp;t&nbsp;~f<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;map2_exn&nbsp;t1&nbsp;t2&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lgth1&nbsp;=&nbsp;(length&nbsp;t1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lgth2&nbsp;=&nbsp;(length&nbsp;t2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;lgth1,&nbsp;lgth2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0,&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;empty<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;_&nbsp;<span class="keyword">when</span>&nbsp;lgth1&nbsp;&lt;&gt;&nbsp;lgth2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_arg&nbsp;<span class="string">"map2_exn"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;lgth1,&nbsp;lgth2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">B</span>.mapi&nbsp;~f:(<span class="keyword">fun</span>&nbsp;i&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;c&nbsp;(<span class="constructor">B</span>.get&nbsp;t2&nbsp;i))&nbsp;t1<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mapi&nbsp;t&nbsp;~f&nbsp;=&nbsp;<span class="constructor">B</span>.mapi&nbsp;t&nbsp;~f<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;for_all&nbsp;t&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;(iter&nbsp;t&nbsp;(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;(f&nbsp;x)&nbsp;<span class="keyword">then</span>&nbsp;raise&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keyword">else</span>&nbsp;());&nbsp;<span class="keyword">true</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;exists&nbsp;t&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;(iter&nbsp;t&nbsp;(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;f&nbsp;x&nbsp;<span class="keyword">then</span>&nbsp;raise&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keyword">else</span>&nbsp;());&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_of_character&nbsp;t&nbsp;?(from=0)&nbsp;c&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;from&nbsp;&lt;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;0&nbsp;<span class="keyword">else</span>&nbsp;min&nbsp;(length&nbsp;t)&nbsp;from&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">B</span>.index_from&nbsp;t&nbsp;from&nbsp;c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_of_character_reverse&nbsp;t&nbsp;?from&nbsp;c&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length_of_t&nbsp;=&nbsp;length&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;from&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;length_of_t&nbsp;-&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keyword">when</span>&nbsp;s&nbsp;&lt;&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keyword">when</span>&nbsp;s&nbsp;&gt;&nbsp;length_of_t&nbsp;-&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;length_of_t&nbsp;-&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">B</span>.rindex_from&nbsp;t&nbsp;from&nbsp;c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;resize_from_length&nbsp;~from&nbsp;?length&nbsp;~length_of_s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;from&nbsp;&lt;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;0&nbsp;<span class="keyword">else</span>&nbsp;min&nbsp;length_of_s&nbsp;from&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;length&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;length_of_s&nbsp;-&nbsp;from<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;lg&nbsp;<span class="keyword">when</span>&nbsp;lg&nbsp;&lt;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;lg&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;min&nbsp;(length_of_s&nbsp;-&nbsp;from)&nbsp;lg<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(from,&nbsp;length)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;find&nbsp;?(from=0)&nbsp;?length&nbsp;s&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length_of_s&nbsp;=&nbsp;<span class="constructor">B</span>.length&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from,&nbsp;length&nbsp;=&nbsp;resize_from_length&nbsp;~from&nbsp;?length&nbsp;~length_of_s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;found&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!found&nbsp;=&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;!i&nbsp;&nbsp;&lt;&nbsp;length&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;f&nbsp;(get_exn&nbsp;s&nbsp;(!i&nbsp;+&nbsp;from))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;found&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;(!i&nbsp;+&nbsp;from)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;incr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;!found<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;find_reverse&nbsp;?from&nbsp;?length&nbsp;s&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length_of_s&nbsp;=&nbsp;<span class="constructor">B</span>.length&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;length_of_s&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;from&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;length_of_s&nbsp;-&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keyword">when</span>&nbsp;s&nbsp;&lt;&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;-1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keyword">when</span>&nbsp;s&nbsp;&gt;=&nbsp;length_of_s&nbsp;-&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;length_of_s&nbsp;-&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;length&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;from&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;l&nbsp;<span class="keyword">when</span>&nbsp;l&nbsp;&lt;=&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;l&nbsp;<span class="keyword">when</span>&nbsp;l&nbsp;&gt;=&nbsp;from&nbsp;+&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;from&nbsp;+&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;found&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;i&nbsp;=&nbsp;ref&nbsp;from&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;!found&nbsp;=&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;!i&nbsp;&gt;=&nbsp;from&nbsp;-&nbsp;length&nbsp;+&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;dbg&nbsp;"i:&nbsp;%d&nbsp;from:&nbsp;%d&nbsp;length:&nbsp;%d"&nbsp;!i&nbsp;from&nbsp;length;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;f&nbsp;(get_exn&nbsp;s&nbsp;!i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;found&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;(!i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;decr&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!found<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;filter_map&nbsp;?(from=0)&nbsp;?length&nbsp;s&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length_of_s&nbsp;=&nbsp;<span class="constructor">B</span>.length&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from,&nbsp;length&nbsp;=&nbsp;resize_from_length&nbsp;~from&nbsp;?length&nbsp;~length_of_s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;length&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span>&nbsp;empty<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">Buffer</span>.create&nbsp;length&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>&nbsp;i&nbsp;=&nbsp;0&nbsp;<span class="keyword">to</span>&nbsp;length&nbsp;-&nbsp;1&nbsp;<span class="keyword">do</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;f&nbsp;(get_exn&nbsp;s&nbsp;(i&nbsp;+&nbsp;from))&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Buffer</span>.add_char&nbsp;b&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">B</span>.of_buffer&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;filter&nbsp;?from&nbsp;?length&nbsp;s&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_map&nbsp;?from&nbsp;?length&nbsp;s&nbsp;~f:(<span class="keyword">fun</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;f&nbsp;c&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;c&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">None</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Make_strip_function</span>&nbsp;(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;character&nbsp;=&nbsp;char<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;empty&nbsp;=&nbsp;empty<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=&nbsp;length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub_exn&nbsp;=&nbsp;sub_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;find&nbsp;=&nbsp;find<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;find_reverse&nbsp;=&nbsp;find_reverse<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_whitespace&nbsp;=&nbsp;<span class="constructor">Native_character</span>.is_whitespace<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Make_split_function</span>(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;character&nbsp;=&nbsp;char<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=&nbsp;length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub_exn&nbsp;=&nbsp;sub_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_of_string&nbsp;=&nbsp;index_of_string<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_of_character&nbsp;=&nbsp;index_of_character<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Make_prefix_suffix_array</span>&nbsp;(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;character&nbsp;=&nbsp;char<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=&nbsp;length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get&nbsp;=&nbsp;<span class="constructor">B</span>.get<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub_exn&nbsp;=&nbsp;sub_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Make_split_at_index_functions</span>(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;character&nbsp;=&nbsp;char<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;empty&nbsp;=&nbsp;empty<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;length&nbsp;=&nbsp;length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub_exn&nbsp;=&nbsp;sub_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Make_output</span>&nbsp;(<span class="constructor">Model</span>:&nbsp;<span class="constructor">Api</span>.<span class="constructor">OUTPUT_MODEL</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output&nbsp;chan&nbsp;t&nbsp;=&nbsp;<span class="constructor">Model</span>.output&nbsp;chan&nbsp;(<span class="constructor">B</span>.string_for_output&nbsp;t)<br>
<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;take_while_with_index&nbsp;t&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buf&nbsp;=&nbsp;<span class="constructor">Buffer</span>.create&nbsp;(length&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;loop&nbsp;idx&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get&nbsp;t&nbsp;idx&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;c&nbsp;<span class="keyword">when</span>&nbsp;f&nbsp;idx&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Buffer</span>.add_char&nbsp;buf&nbsp;c;&nbsp;loop&nbsp;(idx&nbsp;+&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;loop&nbsp;0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">B</span>.of_buffer&nbsp;buf<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;take_while&nbsp;t&nbsp;~f&nbsp;=&nbsp;take_while_with_index&nbsp;t&nbsp;~f:(<span class="keyword">fun</span>&nbsp;_&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;c)<br>
<br>
<span class="keyword">end</span></code></body></html>