 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Sosa: Tests & Benchmarks (`src/test/main.ml`)</title></head><body><div class="container"><h1>Sosa: Tests & Benchmarks (`src/test/main.ml`)</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><ul><li><a href='#TestUtilities'>Test Utilities</a>
</li><li><a href='#Benchmarks'>Benchmarks</a>
</li><li><a href='#TestwithFirstClassModules'>Test with First-Class Modules</a>
</li><li><a href='#AUTF8SpecificTest'>A UTF-8-Specific Test</a>
</li><li><a href='#TestInstantiations'>Test Instantiations</a>
</li></ul><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='main.html'>Tests &amp; Benchmarks (<code>src/test/main.ml</code>)</a></li><li><a href='INSTALL.html'>Build instructions</a></li><li><a href='./api/index.html'>API Documentation</a></li><li>Documentation for <a href='./doc.0.0.1/index.html'>version 0.0.1</a></li><li>Documentation for <a href='./doc.0.1.0/index.html'>version 0.1.0</a></li><li>Documentation for <a href='./doc.0.2.0/index.html'>version 0.2.0</a></li><li>Repository <a href='https://github.com/hammerlab/sosa'>at Github</a></li><li>Up: <a href='../index.html'>Software Projects</a></li></ul></div><div class="col-md-9">


<h1 id="TestsoftheSosalibrary">Tests of the Sosa library</h1>

<h2 id="TestUtilities">Test Utilities</h2>
<pre><span class="text">

</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">String</span><span class="text"> = </span><span class="kw2">StringLabels</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Printf</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Sosa</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Sosa_utilities</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="id">printf</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> ^^ </span><span class="string">"\n%!"</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="id">should_do_benchmarks</span><span class="text"> =
  </span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">1</span><span class="text">) = </span><span class="string">"bench"</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">cartesian_product</span><span class="text"> </span><span class="id">list1</span><span class="text"> </span><span class="id">list2</span><span class="text"> =
  </span><span class="kw1">if</span><span class="text"> </span><span class="id">list2</span><span class="text"> = [] </span><span class="kw1">then</span><span class="text"> [] </span><span class="kw1">else</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">loop</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="id">accum</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; </span><span class="id">accum</span><span class="text">
    | (</span><span class="id">hd</span><span class="text"> :: </span><span class="id">tl</span><span class="text">) -&gt;
      </span><span class="id">loop</span><span class="text"> </span><span class="id">tl</span><span class="text"> </span><span class="id">l2</span><span class="text">
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_append</span><span class="text">
           (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; (</span><span class="id">hd</span><span class="text">,</span><span class="id">x</span><span class="text">)) </span><span class="id">l2</span><span class="text">)
           </span><span class="id">accum</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> (</span><span class="id">loop</span><span class="text"> </span><span class="id">list1</span><span class="text"> </span><span class="id">list2</span><span class="text"> [])

</span><span class="kw">let</span><span class="text"> </span><span class="id">return_code</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">should_not_return_zero</span><span class="text"> () = </span><span class="id">return_code</span><span class="text"> := </span><span class="numeric">5</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_assert</span><span class="text"> </span><span class="id">msg</span><span class="text"> </span><span class="id">cond</span><span class="text"> =
  </span><span class="kw1">if</span><span class="text"> </span><span class="id">not</span><span class="text"> </span><span class="id">cond</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
    </span><span class="id">should_not_return_zero</span><span class="text"> ();
    </span><span class="id">say</span><span class="text"> </span><span class="string">"&gt;&gt; TEST FAILED: [%s]"</span><span class="text"> </span><span class="id">msg</span><span class="text">
  ) </span><span class="kw1">else</span><span class="text"> ()

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_assertf</span><span class="text"> </span><span class="id">cond</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
  </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">test_assert</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">cond</span><span class="text">) </span><span class="id">fmt</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">make_string</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">init</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">list_dot_init</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">f</span><span class="text"> =
  </span><span class="kw2">Array</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">f</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">to_list</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">random_string</span><span class="text"> </span><span class="id">i</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">make_string</span><span class="text"> </span><span class="id">length</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">char_of_int</span><span class="text"> (</span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">256</span><span class="text">))

</span><span class="kw">let</span><span class="text"> </span><span class="id">random_ascii_string</span><span class="text"> </span><span class="id">i</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">make_string</span><span class="text"> </span><span class="id">length</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">char_of_int</span><span class="text"> (</span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">128</span><span class="text">))

</span><span class="kw">let</span><span class="text"> </span><span class="id">random_utf8_string</span><span class="text"> </span><span class="id">i</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">list_dot_init</span><span class="text"> </span><span class="id">length</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">0x10_FFFF</span><span class="text">)
  |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Int_utf8_character</span><span class="text">.</span><span class="id">to_native_string</span><span class="text">
  |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">""</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> =
  </span><span class="string">""</span><span class="text"> :: </span><span class="string">"A"</span><span class="text"> :: </span><span class="string">"\x00"</span><span class="text"> :: </span><span class="string">"Invalid UTF-8: \197"</span><span class="text">
  :: </span><span class="string">"Invalid UTF-8 again: \197\000"</span><span class="text">
  :: </span><span class="string">"Invalid UTF-8 again: \197\000 "</span><span class="text">
  :: </span><span class="id">list_dot_init</span><span class="text"> </span><span class="numeric">20</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">random_string</span><span class="text"> (</span><span class="id">i</span><span class="text"> * </span><span class="numeric">4</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))
  @  </span><span class="id">list_dot_init</span><span class="text"> </span><span class="numeric">20</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">random_ascii_string</span><span class="text"> (</span><span class="id">i</span><span class="text"> * </span><span class="numeric">4</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))
  @  </span><span class="id">list_dot_init</span><span class="text"> </span><span class="numeric">20</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="id">random_utf8_string</span><span class="text"> (</span><span class="id">i</span><span class="text"> * </span><span class="numeric">4</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))

</span></pre>


<p>This is a set of common denominator native strings, i.e., string that can be
converted to every other representation. We call them DNA and use only <a href='api/Api.A.html' title='A'><code>A</code></a>,
<a href='api/Api.C.html' title='C'><code>C</code></a>, <a href='api/Api.G.html' title='G'><code>G</code></a>, <a href='api/Api.T.html' title='T'><code>T</code></a> for future implementations which will be using only 2 or 4
bits per character.</p>

<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">dna_test_subjects</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">random_read</span><span class="text"> </span><span class="numeric">_</span><span class="text"> =
    </span><span class="id">make_string</span><span class="text"> (</span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">300</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">4</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="string">'A'</span><span class="text">
        | </span><span class="numeric">1</span><span class="text"> -&gt; </span><span class="string">'C'</span><span class="text">
        | </span><span class="numeric">2</span><span class="text"> -&gt; </span><span class="string">'G'</span><span class="text">
        | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="string">'T'</span><span class="text">
        </span><span class="kw1">end</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="id">list_dot_init</span><span class="text"> </span><span class="numeric">200</span><span class="text"> </span><span class="id">random_read</span><span class="text">

</span></pre>


<h2 id="Benchmarks">Benchmarks</h2>

<p>If asked on the command line, each test will run some benchmarks on the
implementation.</p>

<pre><span class="text">
</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Benchmark</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">now</span><span class="text"> () = </span><span class="kw2">Unix</span><span class="text">.</span><span class="id">gettimeofday</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">benchmarks_table</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> []

  </span><span class="kw">let</span><span class="text"> </span><span class="id">add</span><span class="text"> </span><span class="kw4">~implementation</span><span class="text"> </span><span class="kw4">~experiment</span><span class="text"> </span><span class="kw4">~result</span><span class="text"> =
    </span><span class="kw1">match</span><span class="text"> (</span><span class="kw1">try</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">assoc</span><span class="text"> </span><span class="id">implementation</span><span class="text"> !</span><span class="id">benchmarks_table</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">exps</span><span class="text"> -&gt;
       </span><span class="id">exps</span><span class="text"> := (</span><span class="id">experiment</span><span class="text">, </span><span class="id">result</span><span class="text">) :: !</span><span class="id">exps</span><span class="text">
    | </span><span class="kw2">None</span><span class="text"> -&gt;
       </span><span class="id">benchmarks_table</span><span class="text"> := (</span><span class="id">implementation</span><span class="text">, </span><span class="kw1">ref</span><span class="text"> [</span><span class="id">experiment</span><span class="text">, </span><span class="id">result</span><span class="text">]) :: !</span><span class="id">benchmarks_table</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">measure</span><span class="text"> ?(</span><span class="id">repeats</span><span class="text">=</span><span class="numeric">1000</span><span class="text">) </span><span class="id">f</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">start</span><span class="text"> = </span><span class="id">now</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">repeats</span><span class="text"> </span><span class="kw1">do</span><span class="text">
      </span><span class="id">f</span><span class="text"> ()
    </span><span class="kw1">done</span><span class="text">;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">stop</span><span class="text"> = (</span><span class="id">now</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
    (</span><span class="numeric">1000</span><span class="text">. *. (</span><span class="id">stop</span><span class="text"> -. </span><span class="id">start</span><span class="text">) /. (</span><span class="kw3">float</span><span class="text"> </span><span class="id">repeats</span><span class="text">))

  </span><span class="kw">let</span><span class="text"> </span><span class="id">declare</span><span class="text"> ?</span><span class="id">repeats</span><span class="text"> </span><span class="kw4">~implementation</span><span class="text"> </span><span class="kw4">~experiment</span><span class="text"> </span><span class="id">f</span><span class="text"> =
    </span><span class="kw1">if</span><span class="text"> </span><span class="id">should_do_benchmarks</span><span class="text"> </span><span class="kw1">then</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">time</span><span class="text"> = </span><span class="id">measure</span><span class="text"> ?</span><span class="id">repeats</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw">in</span><span class="text">
       </span><span class="kw">let</span><span class="text"> </span><span class="id">result</span><span class="text"> = </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%.3f ms"</span><span class="text"> </span><span class="id">time</span><span class="text"> </span><span class="kw">in</span><span class="text">
       </span><span class="id">add</span><span class="text"> </span><span class="kw4">~implementation</span><span class="text"> </span><span class="kw4">~experiment</span><span class="text"> </span><span class="kw4">~result</span><span class="text">
    </span><span class="kw1">else</span><span class="text"> ()

  </span><span class="kw">let</span><span class="text"> </span><span class="id">to_string</span><span class="text"> () =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">experiments</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> !</span><span class="id">benchmarks_table</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">l</span><span class="text">) -&gt;
          </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> !</span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">e</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt; </span><span class="id">e</span><span class="text">))
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">concat</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">dedup</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">first_row</span><span class="text"> =
      </span><span class="string">"Implementation"</span><span class="text"> :: </span><span class="id">experiments</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">row_widths</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">first_row</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="kw1">ref</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="comment">(* say "row widths: %s" (String.concat ~sep:", "
       (List.map row_widths (fun r -&gt; sprintf "%d" !r))); *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">other_rows</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> !</span><span class="id">benchmarks_table</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">impl</span><span class="text">, </span><span class="id">l</span><span class="text">) -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">w</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">nth_exn</span><span class="text"> </span><span class="id">row_widths</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">w</span><span class="text"> := </span><span class="id">max</span><span class="text"> !</span><span class="id">w</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">impl</span><span class="text">);
          </span><span class="id">impl</span><span class="text"> :: </span><span class="kw2">List</span><span class="text">.</span><span class="id">mapi</span><span class="text"> </span><span class="id">experiments</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">exp</span><span class="text"> -&gt;
              </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">assoc</span><span class="text"> </span><span class="id">exp</span><span class="text"> !</span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
               </span><span class="kw">let</span><span class="text"> </span><span class="id">w</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">nth_exn</span><span class="text"> </span><span class="id">row_widths</span><span class="text"> (</span><span class="id">i</span><span class="text">  + </span><span class="numeric">1</span><span class="text">) </span><span class="kw">in</span><span class="text">
              </span><span class="comment">(* say "w: %d, i: %d lgth: %d" !w i (String.length res); *)</span><span class="text">
              </span><span class="id">w</span><span class="text"> := </span><span class="id">max</span><span class="text"> !</span><span class="id">w</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">res</span><span class="text">);
              </span><span class="id">res</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">row_to_string</span><span class="text"> </span><span class="id">row</span><span class="text"> =
      </span><span class="id">row</span><span class="text">
      |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">mapi</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
          </span><span class="comment">(* say "%d %s %d %d" i c !(List.nth_exn row_widths i) (String.length c); *)</span><span class="text">
          </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s%s"</span><span class="text"> </span><span class="id">c</span><span class="text">
            (</span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> (</span><span class="numeric">1</span><span class="text"> + !(</span><span class="kw2">List</span><span class="text">.</span><span class="id">nth_exn</span><span class="text"> </span><span class="id">row_widths</span><span class="text"> </span><span class="id">i</span><span class="text">) - </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="string">' '</span><span class="text">))
      |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"  "</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s\n%s\n%s\n"</span><span class="text">
      (</span><span class="id">first_row</span><span class="text"> |&gt; </span><span class="id">row_to_string</span><span class="text">)
      (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">row_widths</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">make</span><span class="text"> (!</span><span class="id">s</span><span class="text">) </span><span class="string">'-'</span><span class="text">)
       |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"   "</span><span class="text">)
      (</span><span class="id">other_rows</span><span class="text">
       |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">row_to_string</span><span class="text">
       |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"\n"</span><span class="text">)

</span><span class="kw1">end</span><span class="text">

</span></pre>


<h2 id="TestwithFirstClassModules">Test with First-Class Modules</h2>

<p>The function <code>do_basic_test</code> below takes a whole OCaml module implementation as
argument; <a href='api/Api.TEST_STRING.html' title='TEST_STRING'><code>TEST_STRING</code></a> is the expected signature:</p>

<pre><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="kw2">TEST_STRING</span><span class="text"> = </span><span class="kw1">sig</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">test_name</span><span class="text">: </span><span class="kw3">string</span><span class="text">
  </span><span class="kw">val</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text">: </span><span class="kw3">bool</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">: </span><span class="kw2">Api</span><span class="text">.</span><span class="kw2">BASIC_CHARACTER</span><span class="text">
  </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Str</span><span class="text">: </span><span class="kw2">Api</span><span class="text">.</span><span class="kw2">BASIC_STRING</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> := </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">t</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">do_basic_test</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Test</span><span class="text"> : </span><span class="kw2">TEST_STRING</span><span class="text">) =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Test</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">say</span><span class="text"> </span><span class="string">"### Test %S"</span><span class="text"> </span><span class="id">test_name</span><span class="text">;

  </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text"> = </span><span class="numeric">0</span><span class="text">) </span><span class="string">"(length empty)"</span><span class="text">;
  </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">is_empty</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">) </span><span class="string">"(is_empty empty)"</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="string">""</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt; </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">is_empty</span><span class="text"> </span><span class="id">o</span><span class="text">) </span><span class="string">"(is_empty \"\")"</span><span class="text">;
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">test_assertf</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="string">"Str.of_native_string %S -&gt; Error"</span><span class="text"> </span><span class="string">""</span><span class="text">
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* test of_/to_ native_string *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_ofto</span><span class="text"> </span><span class="id">s</span><span class="text"> =
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">s2</span><span class="text"> -&gt;
        </span><span class="comment">(* We test that when we can transform from `s2`, the opposite
           conversion works: *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">back</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assert</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"test_ofto %S &lt;&gt; %S"</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">back</span><span class="text">) (</span><span class="id">s</span><span class="text"> = </span><span class="id">back</span><span class="text">);

        </span><span class="comment">(* We test `Str.fold` against a potentially *very* slow
           implementation using `Str.length` and `Str.get`. *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">folding</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">to_string</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">fold</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">refold</span><span class="text"> =
            </span><span class="kw">let</span><span class="text"> </span><span class="id">r</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="id">init</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
              </span><span class="id">r</span><span class="text"> := </span><span class="id">f</span><span class="text"> !</span><span class="id">r</span><span class="text"> (</span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">"folding"</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">i</span><span class="text">));
            </span><span class="kw1">done</span><span class="text">;
            !</span><span class="id">r</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">fold</span><span class="text"> = </span><span class="id">refold</span><span class="text">) </span><span class="string">"\nfold: %s\nrefold: %s"</span><span class="text">
            (</span><span class="id">to_string</span><span class="text"> </span><span class="id">fold</span><span class="text">) (</span><span class="id">to_string</span><span class="text"> </span><span class="id">refold</span><span class="text">)
        </span><span class="kw">in</span><span class="text">
        </span><span class="id">folding</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:[] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text"> :: </span><span class="id">p</span><span class="text">)
          (</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">", "</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text">));
        </span><span class="id">folding</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">42</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw2">Hashtbl</span><span class="text">.</span><span class="id">hash</span><span class="text"> (</span><span class="id">p</span><span class="text">, </span><span class="id">c</span><span class="text">)) (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">);

        </span><span class="comment">(* This a function that displays an Str.t (extracts the
           beginning and its size(s)) *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">str_to_hum</span><span class="text"> </span><span class="id">s</span><span class="text"> =
          </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"[%S.%d,%dB]"</span><span class="text">
            (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%s"</span><span class="text">
             |&gt; (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="numeric">0</span><span class="text"> (</span><span class="id">min</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">) </span><span class="numeric">10</span><span class="text">)))
            (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">)
            (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text">) </span><span class="kw">in</span><span class="text">


        </span><span class="comment">(* We test `Str.sub` by comparing it with an implementation
           based on `Str.get`. *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
          </span><span class="kw">let</span><span class="text"> </span><span class="id">subopt</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~index</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">r</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> [] </span><span class="kw">in</span><span class="text">
          </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">index</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">index</span><span class="text"> + </span><span class="id">length</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
            </span><span class="id">r</span><span class="text"> := </span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">i</span><span class="text"> :: !</span><span class="id">r</span><span class="text">
          </span><span class="kw1">done</span><span class="text">;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">subopt</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sub</span><span class="text"> -&gt;
            </span><span class="comment">(* If `Str.sub` returned some then `r` contains all the
               characters in reverse order: *)</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">bus</span><span class="text"> =
              </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">for_all</span><span class="text"> !</span><span class="id">r</span><span class="text"> ((&lt;&gt;) </span><span class="kw2">None</span><span class="text">)) </span><span class="string">"sub %d %d: r has a None"</span><span class="text">
                </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text">;
              </span><span class="kw2">Str</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">
                (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev_map</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_opt</span><span class="text"> !</span><span class="id">r</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character</span><span class="text">)) </span><span class="kw">in</span><span class="text">
            </span><span class="comment">(* We compare the result `sub` and the re-computed version `bus`: *)</span><span class="text">
            </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="id">bus</span><span class="text"> = </span><span class="numeric">0</span><span class="text">) </span><span class="string">"sub %s %d %d\n→ Some %s ≠ %s"</span><span class="text">
              (</span><span class="id">str_to_hum</span><span class="text"> </span><span class="id">s2</span><span class="text">) </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text"> (</span><span class="id">str_to_hum</span><span class="text"> </span><span class="id">sub</span><span class="text">) (</span><span class="id">str_to_hum</span><span class="text"> </span><span class="id">bus</span><span class="text">)
          | </span><span class="kw2">None</span><span class="text"> -&gt;
            </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">r</span><span class="text"> = [] || </span><span class="kw2">List</span><span class="text">.</span><span class="id">exists</span><span class="text"> !</span><span class="id">r</span><span class="text"> ((=) </span><span class="kw2">None</span><span class="text">))
              </span><span class="string">"sub %s %d %d → None"</span><span class="text"> (</span><span class="id">str_to_hum</span><span class="text"> </span><span class="id">s2</span><span class="text">) </span><span class="id">index</span><span class="text"> </span><span class="id">length</span><span class="text">
          </span><span class="kw1">end</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">5</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">30</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">30</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">30</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">40</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">400</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">0</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">2</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">4</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">5</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">5</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">0</span><span class="text"> - </span><span class="numeric">1</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">2</span><span class="text"> - </span><span class="numeric">1</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">4</span><span class="text"> - </span><span class="numeric">1</span><span class="text">);
        </span><span class="id">subbing</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">5</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s2</span><span class="text"> - </span><span class="numeric">5</span><span class="text"> - </span><span class="numeric">1</span><span class="text">);


      | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">i</span><span class="text">) -&gt;
        </span><span class="comment">(* If the conversion fails, we check that the error value points
           to an invalid character: *)</span><span class="text">
        </span><span class="id">test_assert</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"test_ofto %S -&gt; wrong char at index %d"</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">i</span><span class="text">)
          (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">read_from_native_string</span><span class="text"> </span><span class="kw4">~buf</span><span class="text">:</span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">i</span><span class="text"> = </span><span class="kw2">None</span><span class="text">)
      </span><span class="kw1">end</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> </span><span class="id">test_ofto</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* test concat and a bit more *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">tried_separators</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">try_separators</span><span class="text"> </span><span class="id">n</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="numeric">0</span><span class="text">
      </span><span class="kw1">then</span><span class="text">
        </span><span class="kw1">if</span><span class="text"> !</span><span class="id">tried_separators</span><span class="text"> &lt; </span><span class="numeric">10</span><span class="text"> </span><span class="kw1">then</span><span class="text">
          </span><span class="id">say</span><span class="text"> </span><span class="string">"WARNING: %s -&gt; try_separators did not try much (%d separators)"</span><span class="text">
            </span><span class="id">test_name</span><span class="text"> !</span><span class="id">tried_separators</span><span class="text">
        </span><span class="kw1">else</span><span class="text"> ()
      </span><span class="kw1">else</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sep</span><span class="text"> = </span><span class="id">random_string</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">sep</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">csep</span><span class="text"> -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">selection</span><span class="text"> =
            </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">bool</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">viable_strings</span><span class="text">, </span><span class="id">converted</span><span class="text"> =
            </span><span class="kw">let</span><span class="text"> </span><span class="id">zipped</span><span class="text"> =
              </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">selection</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
                </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
                | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">s2</span><span class="text"> -&gt;  </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">s</span><span class="text">, </span><span class="id">s2</span><span class="text">)
                | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">c</span><span class="text">) -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">zipped</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">fst</span><span class="text">, </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">zipped</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">snd</span><span class="text">
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">concated</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text"> </span><span class="id">viable_strings</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">concated2</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="id">csep</span><span class="text"> </span><span class="id">converted</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="comment">(* say "separators %S" sep; *)</span><span class="text">
          </span><span class="id">incr</span><span class="text"> </span><span class="id">tried_separators</span><span class="text">;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">concated2</span><span class="text"> = </span><span class="id">concated</span><span class="text">)
            </span><span class="string">"try_separators %d (%dth): %S %s →\n  %S Vs\n  %s"</span><span class="text"> </span><span class="id">n</span><span class="text"> !</span><span class="id">tried_separators</span><span class="text"> </span><span class="id">sep</span><span class="text">
            (</span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">", "</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">viable_strings</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%S"</span><span class="text">)))
            </span><span class="id">concated</span><span class="text">
            (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">concated2</span><span class="text">);
          </span><span class="id">try_separators</span><span class="text"> (</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">)
        | `</span><span class="kw2">Error</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">try_separators</span><span class="text"> (</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">)
        </span><span class="kw1">end</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">try_separators</span><span class="text"> </span><span class="numeric">800</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="comment">(* This tests `make` against `length` and `get`:  *)</span><span class="text">
  </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="numeric">100</span><span class="text"> </span><span class="kw1">do</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">seed</span><span class="text"> = </span><span class="numeric">50</span><span class="text"> * (</span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw3">char</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="id">seed</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="id">seed</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">character</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">make</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="id">character</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">length</span><span class="text">) </span><span class="string">"length of make"</span><span class="text">;
      </span><span class="kw1">for</span><span class="text"> </span><span class="id">j</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> ((</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">j</span><span class="text">) = </span><span class="kw2">Some</span><span class="text"> </span><span class="id">character</span><span class="text">) </span><span class="string">"nth char of make"</span><span class="text">
      </span><span class="kw1">done</span><span class="text">;
    | </span><span class="kw2">None</span><span class="text"> -&gt; ()
  </span><span class="kw1">done</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* We test the`Str.Make_output` functor with `Buffer.t` by writing
           directly the transformable functions and though Out.output and
           comparing the resulting buffer contents.  *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Out</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="kw2">Make_output</span><span class="text">(</span><span class="kw1">struct</span><span class="text">
        </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">thread</span><span class="text"> = '</span><span class="id">a</span><span class="text">
        </span><span class="kw">type</span><span class="text"> ('</span><span class="id">a</span><span class="text">, '</span><span class="id">b</span><span class="text">, '</span><span class="id">c</span><span class="text">) </span><span class="id">channel</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">t</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">return</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">x</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">bind</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">output</span><span class="text"> </span><span class="id">buf</span><span class="text"> </span><span class="id">s</span><span class="text"> =
          </span><span class="comment">(* say "adding %S" s;; *)</span><span class="text">
          </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">add_string</span><span class="text"> </span><span class="id">buf</span><span class="text"> </span><span class="id">s</span><span class="text">
      </span><span class="kw1">end</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">buf_ground</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">buf_through_str</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">there_was_an_error</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
          </span><span class="kw2">Out</span><span class="text">.</span><span class="id">output</span><span class="text"> </span><span class="id">buf_through_str</span><span class="text"> </span><span class="id">o</span><span class="text">;
          </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">add_string</span><span class="text"> </span><span class="id">buf_ground</span><span class="text"> </span><span class="id">s</span><span class="text">;
        | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">i</span><span class="text">) -&gt;
          </span><span class="id">there_was_an_error</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> </span><span class="id">i</span><span class="text">);
    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">buf_ground</span><span class="text"> = </span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">buf_through_str</span><span class="text">)
      </span><span class="string">"Str.Make_output test %S, %S"</span><span class="text">
      (</span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">buf_ground</span><span class="text">)
      (</span><span class="kw2">Buffer</span><span class="text">.</span><span class="id">contents</span><span class="text"> </span><span class="id">buf_through_str</span><span class="text">);
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Some tests of `for_all` and `exists`: *)</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">str</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">str</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) = </span><span class="constant">true</span><span class="text">) </span><span class="string">"∀ true = true"</span><span class="text">;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">) = </span><span class="constant">false</span><span class="text"> || </span><span class="kw2">Str</span><span class="text">.</span><span class="id">is_empty</span><span class="text"> </span><span class="id">o</span><span class="text">)
            </span><span class="string">"∀ false in %S = false"</span><span class="text"> </span><span class="id">str</span><span class="text">;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) = </span><span class="constant">true</span><span class="text"> || </span><span class="kw2">Str</span><span class="text">.</span><span class="id">is_empty</span><span class="text"> </span><span class="id">o</span><span class="text">)
            </span><span class="string">"∃ true =&gt; true"</span><span class="text">;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">) = </span><span class="constant">false</span><span class="text">)
            </span><span class="string">"∃ false in %S = false"</span><span class="text"> </span><span class="id">str</span><span class="text">;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">i_did_false</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">comp</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">for_all</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
              </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">bool</span><span class="text"> () </span><span class="kw1">then</span><span class="text"> </span><span class="constant">true</span><span class="text"> </span><span class="kw1">else</span><span class="text"> (</span><span class="id">i_did_false</span><span class="text"> := </span><span class="constant">true</span><span class="text">; </span><span class="constant">false</span><span class="text">)) </span><span class="kw">in</span><span class="text">
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">comp</span><span class="text"> = </span><span class="id">not</span><span class="text"> !</span><span class="id">i_did_false</span><span class="text">) </span><span class="string">"random test for_all"</span><span class="text">;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">i_did_true</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">comp</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">exists</span><span class="text"> </span><span class="id">o</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt;
              </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">bool</span><span class="text"> () </span><span class="kw1">then</span><span class="text"> (</span><span class="id">i_did_true</span><span class="text"> := </span><span class="constant">true</span><span class="text">; </span><span class="constant">true</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="constant">false</span><span class="text">) </span><span class="kw">in</span><span class="text">
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">comp</span><span class="text"> = !</span><span class="id">i_did_true</span><span class="text">) </span><span class="string">"random test exists"</span><span class="text">;
        | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">i</span><span class="text">) -&gt; ()
      );
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* of_native_substring *)</span><span class="text">
    </span><span class="comment">(* First some basic tests of Str.of_native_substring, then the
       bigger test with all the test strings. *)</span><span class="text">
    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text"> </span><span class="string">""</span><span class="text"> </span><span class="kw4">~offset</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> = `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">)
      </span><span class="string">"sub '' 0 0 = ''"</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text"> </span><span class="string">""</span><span class="text"> </span><span class="kw4">~offset</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> = `</span><span class="kw2">Error</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">)
      </span><span class="string">"sub '' 0 1 → out_of_bounds"</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text"> </span><span class="string">""</span><span class="text"> </span><span class="kw4">~offset</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> = `</span><span class="kw2">Ok</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">)
      </span><span class="string">"sub '' 1 0 → ''"</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text"> </span><span class="string">""</span><span class="text"> </span><span class="kw4">~offset</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> = `</span><span class="kw2">Error</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">)
      </span><span class="string">"sub '' 1 1 → out_of_bounds"</span><span class="text">;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i_have_been_to_ok</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i_have_been_to_wrong_char</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i_have_been_to_out_of_bounds</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> </span><span class="kw1">begin</span><span class="text"> </span><span class="kw">fun</span><span class="text"> </span><span class="id">str</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">offset</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">substr</span><span class="text"> = </span><span class="kw1">try</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">str</span><span class="text"> </span><span class="id">offset</span><span class="text"> </span><span class="id">length</span><span class="text">) </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="string">""</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">str</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">as</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
        </span><span class="id">i_have_been_to_ok</span><span class="text"> := </span><span class="constant">true</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">o</span><span class="text"> = (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">substr</span><span class="text">))
          </span><span class="string">"sub %S %d %d → Ok"</span><span class="text"> </span><span class="id">str</span><span class="text"> </span><span class="id">offset</span><span class="text"> </span><span class="id">length</span><span class="text">;
      | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> </span><span class="id">c</span><span class="text">) -&gt;
        </span><span class="id">i_have_been_to_wrong_char</span><span class="text"> := </span><span class="constant">true</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">substr</span><span class="text"> = `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="id">wrong_char_at</span><span class="text"> (</span><span class="id">c</span><span class="text"> - </span><span class="id">offset</span><span class="text">)))
          </span><span class="string">"sub %S %d %d → Ok"</span><span class="text"> </span><span class="id">str</span><span class="text"> </span><span class="id">offset</span><span class="text"> </span><span class="id">length</span><span class="text">;
      | `</span><span class="kw2">Error</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text"> -&gt;
        </span><span class="id">i_have_been_to_out_of_bounds</span><span class="text"> := </span><span class="constant">true</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">substr</span><span class="text"> = </span><span class="string">""</span><span class="text">) </span><span class="string">"sub out_of_bounds"</span><span class="text">
      </span><span class="kw1">end</span><span class="text">;
    </span><span class="kw1">end</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> !</span><span class="id">i_have_been_to_ok</span><span class="text"> </span><span class="string">"i_have_been_to_ok"</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">i_have_been_to_wrong_char</span><span class="text"> || </span><span class="id">not</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text">)
      </span><span class="string">"i_have_been_to_wrong_char"</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> !</span><span class="id">i_have_been_to_out_of_bounds</span><span class="text"> </span><span class="string">"i_have_been_to_out_of_bounds"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw">let</span><span class="text"> </span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text"> =
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"[%s]"</span><span class="text">
    (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Int</span><span class="text">.</span><span class="id">to_string</span><span class="text"> </span><span class="id">l</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">","</span><span class="text">) </span><span class="kw">in</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> =
    </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">io</span><span class="text"> =
    </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">"None"</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"Some %d"</span><span class="text">) </span><span class="id">io</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* index_of_character{,_reverse} *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">should_find</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">c</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">ch</span><span class="text"> =
        </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">"test index_of_character"</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_character</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">ch</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
        </span><span class="string">"index_of_character: %s (from: %s) expects  %s but got %s"</span><span class="text">
        (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
        </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_character</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">ch</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
          </span><span class="string">"index_of_character: %s (added-from: %s) expects  %s but got %s"</span><span class="text">
          (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      );
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text">;

    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">should_find</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">c</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">ch</span><span class="text"> =
        </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">"test index_of_character"</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_character_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">ch</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
        </span><span class="string">"index_of_character_reverse: %s (from: %s) expects  %s but got %s"</span><span class="text">
        (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
        </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">1</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_character_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">ch</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
          </span><span class="string">"index_of_character_reverse: %s (added-from: %s) expects  %s but got %s"</span><span class="text">
          (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      );
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;


    </span><span class="comment">(* A test of index_of_character and index_of_character_reverse, we
           create a big cartesian product
           (nat_string, (from_index, char_to_find)) and we run both searches. *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">froms</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="numeric">1</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">chars</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">i</span><span class="text">) |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_opt</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">to_do</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.(</span><span class="id">cartesian_product</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> (</span><span class="id">cartesian_product</span><span class="text"> </span><span class="id">froms</span><span class="text"> </span><span class="id">chars</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i_went_to_some_index</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i_went_to_none_from_length</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">i_went_to_none_from_absent</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">rev_i_went_to_some_index</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">rev_i_went_to_none_from_length</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">rev_i_went_to_none_from_absent</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">to_do</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">nat</span><span class="text">, (</span><span class="id">from</span><span class="text">, </span><span class="kw3">char</span><span class="text">)) -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">nat</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">o</span><span class="text"> -&gt;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_character</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">index</span><span class="text"> -&gt;
            </span><span class="id">incr</span><span class="text"> </span><span class="id">i_went_to_some_index</span><span class="text">;
            </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="kw3">char</span><span class="text">) </span><span class="string">"find | get"</span><span class="text">;
          | </span><span class="kw2">None</span><span class="text"> -&gt;
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">o</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">incr</span><span class="text"> </span><span class="id">i_went_to_none_from_length</span><span class="text">)
            </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
              </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">from</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">o</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
                </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">i</span><span class="text"> &lt;&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="kw3">char</span><span class="text">)
                  </span><span class="string">"not found =&gt; can't find, i: %d, from : %d, length: %d"</span><span class="text">
                  </span><span class="id">i</span><span class="text"> </span><span class="id">from</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">o</span><span class="text">);
              </span><span class="kw1">done</span><span class="text">;
              </span><span class="id">incr</span><span class="text"> </span><span class="id">i_went_to_none_from_absent</span><span class="text">;
            </span><span class="kw1">end</span><span class="text">
          </span><span class="kw1">end</span><span class="text">;
          </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_character_reverse</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">index</span><span class="text"> -&gt;
            </span><span class="id">incr</span><span class="text"> </span><span class="id">rev_i_went_to_some_index</span><span class="text">;
            </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">index</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="kw3">char</span><span class="text">) </span><span class="string">"rev, find | get"</span><span class="text">;
          | </span><span class="kw2">None</span><span class="text"> -&gt;
            </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> &gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">o</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (</span><span class="id">incr</span><span class="text"> </span><span class="id">rev_i_went_to_none_from_length</span><span class="text">)
            </span><span class="kw1">else</span><span class="text"> </span><span class="kw1">begin</span><span class="text">
              </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">from</span><span class="text"> </span><span class="kw1">downto</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">do</span><span class="text">
                </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">i</span><span class="text"> &lt;&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="kw3">char</span><span class="text">)
                  </span><span class="string">"rev, not found =&gt; can't find, i: %d, from : %d, length: %d"</span><span class="text">
                  </span><span class="id">i</span><span class="text"> </span><span class="id">from</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">o</span><span class="text">);
              </span><span class="kw1">done</span><span class="text">;
              </span><span class="id">incr</span><span class="text"> </span><span class="id">rev_i_went_to_none_from_absent</span><span class="text">;
            </span><span class="kw1">end</span><span class="text">;
          </span><span class="kw1">end</span><span class="text">;
        | </span><span class="numeric">_</span><span class="text"> -&gt; ());
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">i_went_to_some_index</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="string">""</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">i_went_to_none_from_length</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="string">""</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">i_went_to_none_from_absent</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="string">""</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">rev_i_went_to_some_index</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="string">""</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">rev_i_went_to_none_from_length</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="string">""</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">rev_i_went_to_none_from_absent</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="string">""</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test compare_substring{_strict} *)</span><span class="text">
    </span><span class="comment">(* A first test of compare_substring{_strict} with special cases, empty strings,
           and small strings, containing 'a', 'c', 'g', 't' → they should
           be convertible to any backend :) *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">is_equivalent</span><span class="text"> </span><span class="id">resopt</span><span class="text"> </span><span class="id">expected</span><span class="text"> =
      (</span><span class="kw1">match</span><span class="text"> </span><span class="id">resopt</span><span class="text"> </span><span class="kw1">with</span><span class="text">
       | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">
       | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">r</span><span class="text"> -&gt; </span><span class="id">r</span><span class="text"> = </span><span class="id">expected</span><span class="text"> || </span><span class="id">r</span><span class="text"> * </span><span class="id">expected</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">b</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) </span><span class="id">expected</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">a</span><span class="text">, </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">aa</span><span class="text">, `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">bb</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">bb</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">expected</span><span class="text"> || </span><span class="id">res</span><span class="text"> * </span><span class="id">expected</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">) </span><span class="comment">(* We test for the sign *)</span><span class="text">
          </span><span class="string">"test_compare_substring (%S, %d, %d) (%S, %d, %d) = %d, × %d &lt; 0"</span><span class="text">
          </span><span class="id">a</span><span class="text"> </span><span class="id">idxa</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">idxb</span><span class="text"> </span><span class="id">lenb</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">expected</span><span class="text">;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">resopt</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">bb</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">is_equivalent</span><span class="text"> </span><span class="id">resopt</span><span class="text"> </span><span class="id">expected</span><span class="text">)
          </span><span class="string">"test_compare_substring_strict (%S, %d, %d) (%S, %d, %d) = %d, × %d &lt; 0"</span><span class="text">
          </span><span class="id">a</span><span class="text"> </span><span class="id">idxa</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">idxb</span><span class="text"> </span><span class="id">lenb</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">expected</span><span class="text">;
        </span><span class="comment">(* And now check commutativity: *)</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">invres</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">bb</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">invres</span><span class="text"> = (~- </span><span class="id">expected</span><span class="text">) || </span><span class="id">invres</span><span class="text"> * </span><span class="id">expected</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text">) </span><span class="comment">(* We test for the sign *)</span><span class="text">
          </span><span class="string">"test_compare_substring, commutes (%S, %d, %d) (%S, %d, %d) × -1 = %d, × %d &lt; 0"</span><span class="text">
          </span><span class="id">a</span><span class="text"> </span><span class="id">idxa</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">idxb</span><span class="text"> </span><span class="id">lenb</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">expected</span><span class="text">;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">resopt</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">bb</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">is_equivalent</span><span class="text"> </span><span class="id">resopt</span><span class="text"> (~- </span><span class="id">expected</span><span class="text">))
          </span><span class="string">"test_compare_substring_strict, commutes (%S, %d, %d) (%S, %d, %d) = %d, × %d &lt; 0"</span><span class="text">
          </span><span class="id">a</span><span class="text"> </span><span class="id">idxa</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">idxb</span><span class="text"> </span><span class="id">lenb</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">expected</span><span class="text">;
      | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">test_assertf</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="string">"assumption about ACGT is wrong"</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="comment">(* Semantically well-defined tests: *)</span><span class="text">
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">""</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">""</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">)       ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">""</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">)    ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0</span><span class="text">) ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0</span><span class="text">) ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="numeric">-1</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="numeric">-1</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="numeric">-1</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aaa"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="string">"ggg"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="numeric">-1</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aga"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="string">"ggc"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aga"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="string">"gag"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) ( </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aga"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) (</span><span class="string">"gcg"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">) ( </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_compare_substring</span><span class="text"> (</span><span class="string">"aagg"</span><span class="text">, </span><span class="numeric">2</span><span class="text">, </span><span class="numeric">2</span><span class="text">) (</span><span class="string">"gg"</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">2</span><span class="text">) ( </span><span class="numeric">0</span><span class="text">);
    </span><span class="comment">(* A test of the out-of-bounds behavior: *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="id">a</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">a</span><span class="text">, </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="string">"acgt"</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">aa</span><span class="text">, `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">bb</span><span class="text"> -&gt;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) = </span><span class="kw2">None</span><span class="text">)
          </span><span class="string">"Str.compare_substring_strict out_of_bounds 1"</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">bb</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">2</span><span class="text">) = </span><span class="kw2">None</span><span class="text">)
          </span><span class="string">"Str.compare_substring_strict out_of_bounds 2"</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">0</span><span class="text">) (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) = </span><span class="kw2">None</span><span class="text">)
          </span><span class="string">"Str.compare_substring_strict out_of_bounds 3"</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">bb</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">2</span><span class="text">) (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) = </span><span class="kw2">None</span><span class="text">)
          </span><span class="string">"Str.compare_substring_strict out_of_bounds 4"</span><span class="text">;
      | </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">test_assertf</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="string">"assumption about ACGT is wrong"</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">""</span><span class="text">, </span><span class="numeric">0</span><span class="text">, </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">"a"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">"a"</span><span class="text">, </span><span class="numeric">-1</span><span class="text">, </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">"a"</span><span class="text">, </span><span class="numeric">1</span><span class="text">, </span><span class="numeric">-1</span><span class="text">);
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">"a"</span><span class="text">, </span><span class="numeric">-1</span><span class="text">, </span><span class="numeric">-1</span><span class="text">);
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">"aa"</span><span class="text">, </span><span class="numeric">10</span><span class="text">, </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_compare_substring_strictness</span><span class="text"> (</span><span class="string">"aa"</span><span class="text">, </span><span class="numeric">10</span><span class="text">, </span><span class="numeric">-1</span><span class="text">);
    </span><span class="comment">(* Now we run a bigger randomized test of compare_substring{_strict}. *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">been_to_some_0</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">been_to_some_m</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">a</span><span class="text"> -&gt;
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">test_native_subjects</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">b</span><span class="text"> -&gt;
            </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">a</span><span class="text">, </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="kw1">with</span><span class="text">
            | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">aa</span><span class="text">, `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">bb</span><span class="text"> -&gt;
              </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">n</span><span class="text"> =
                </span><span class="kw">let</span><span class="text"> </span><span class="id">length_a</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">aa</span><span class="text"> </span><span class="kw">in</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">length_b</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">bb</span><span class="text"> </span><span class="kw">in</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">lena</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> (</span><span class="id">length_a</span><span class="text"> + </span><span class="numeric">5</span><span class="text">) </span><span class="kw">in</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">idxa</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> (</span><span class="id">lena</span><span class="text"> + </span><span class="numeric">5</span><span class="text">) </span><span class="kw">in</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text"> =
                  </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">bool</span><span class="text"> ()
                  </span><span class="kw1">then</span><span class="text">  (</span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> (</span><span class="id">length_b</span><span class="text"> + </span><span class="numeric">5</span><span class="text">), </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> (</span><span class="id">length_b</span><span class="text"> + </span><span class="numeric">5</span><span class="text">))
                  </span><span class="kw1">else</span><span class="text"> (</span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) </span><span class="comment">(* half of the times with same params *)</span><span class="text">
                </span><span class="kw">in</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> =
                  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring</span><span class="text"> (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">bb</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) </span><span class="kw">in</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">resopt</span><span class="text"> =
                  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare_substring_strict</span><span class="text"> (</span><span class="id">aa</span><span class="text">, </span><span class="id">idxa</span><span class="text">, </span><span class="id">lena</span><span class="text">) (</span><span class="id">bb</span><span class="text">, </span><span class="id">idxb</span><span class="text">, </span><span class="id">lenb</span><span class="text">) </span><span class="kw">in</span><span class="text">
                </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="kw1">with</span><span class="text">
                | </span><span class="numeric">0</span><span class="text"> -&gt; </span><span class="comment">(* EQUAL *)</span><span class="text">
                  </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">lena</span><span class="text"> = </span><span class="id">lenb</span><span class="text">)
                    </span><span class="string">"compare_substring: equal but lengths %d ≠ %d"</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text">;
                  </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">min</span><span class="text"> </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
                    </span><span class="id">test_assertf</span><span class="text"> ((</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">aa</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="id">idxa</span><span class="text">)) = (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">bb</span><span class="text"> (</span><span class="id">i</span><span class="text"> + </span><span class="id">idxb</span><span class="text">)))
                      </span><span class="string">"compare_substring: equal but different …"</span><span class="text">
                  </span><span class="kw1">done</span><span class="text">;
                  </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">is_equivalent</span><span class="text"> </span><span class="id">resopt</span><span class="text"> </span><span class="id">res</span><span class="text">)
                    </span><span class="string">"resopt Vs res in EQUAL case"</span><span class="text">;
                  </span><span class="id">incr</span><span class="text"> </span><span class="id">been_to_some_0</span><span class="text">;
                | </span><span class="id">m</span><span class="text"> -&gt;
                  </span><span class="kw">let</span><span class="text"> </span><span class="id">suba</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">aa</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">idxa</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">lena</span><span class="text">) </span><span class="kw">in</span><span class="text">
                  </span><span class="kw">let</span><span class="text"> </span><span class="id">subb</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">sub</span><span class="text"> </span><span class="id">bb</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="id">idxb</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="id">lenb</span><span class="text">) </span><span class="kw">in</span><span class="text">
                  </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">suba</span><span class="text">, </span><span class="id">subb</span><span class="text"> </span><span class="kw1">with</span><span class="text">
                  | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sa</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">sb</span><span class="text"> -&gt;
                    </span><span class="comment">(* Well defined case: "sub" returns something for both *)</span><span class="text">
                    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">sa</span><span class="text"> </span><span class="id">sb</span><span class="text"> * </span><span class="id">m</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text">)
                      </span><span class="string">"%d instead of %d sa: %s sb:%s (lena: %d, lenb: %d)"</span><span class="text"> </span><span class="id">m</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">sa</span><span class="text"> </span><span class="id">sb</span><span class="text">)
                      (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">sa</span><span class="text">) (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">sb</span><span class="text">) </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text">;
                    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">is_equivalent</span><span class="text"> </span><span class="id">resopt</span><span class="text"> </span><span class="id">res</span><span class="text">)
                      </span><span class="string">"strict: %s instead of %d sa: %s sb:%s (lena: %d, lenb: %d)"</span><span class="text">
                      (</span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:</span><span class="string">"None"</span><span class="text"> </span><span class="id">resopt</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"Some %d"</span><span class="text">))
                      (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">compare</span><span class="text"> </span><span class="id">sa</span><span class="text"> </span><span class="id">sb</span><span class="text">)
                      (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">sa</span><span class="text">) (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">sb</span><span class="text">) </span><span class="id">lena</span><span class="text"> </span><span class="id">lenb</span><span class="text">;
                  | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; ()
                  </span><span class="kw1">end</span><span class="text">;
                  </span><span class="id">incr</span><span class="text"> </span><span class="id">been_to_some_m</span><span class="text">;
                  ()
                </span><span class="kw1">end</span><span class="text">;
                </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> &gt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">test</span><span class="text"> (</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">);
              </span><span class="kw">in</span><span class="text">
              </span><span class="id">test</span><span class="text"> </span><span class="numeric">4</span><span class="text">
            | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; ()
          )
      );
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">been_to_some_0</span><span class="text"> &gt; </span><span class="numeric">5</span><span class="text">) </span><span class="string">"been_to_some_0: %d"</span><span class="text"> !</span><span class="id">been_to_some_0</span><span class="text">;
    </span><span class="id">test_assertf</span><span class="text"> (!</span><span class="id">been_to_some_m</span><span class="text"> &gt; </span><span class="numeric">5</span><span class="text">) </span><span class="string">"been_to_some_m: %d"</span><span class="text"> !</span><span class="id">been_to_some_m</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* We test index_of_string and index_of_string_reverse, if we expect
           the same result we may give only `~expect` if not, we use
           `~expect_rev`. *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_index_of_string</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">sub_index</span><span class="text"> ?</span><span class="id">sub_length</span><span class="text"> ?</span><span class="id">expect_rev</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~sub</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">s</span><span class="text">, </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">sub</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">t</span><span class="text">, `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">subt</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_string</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="id">subt</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">sub_index</span><span class="text"> ?</span><span class="id">sub_length</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">shopt</span><span class="text"> = </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"Some %d"</span><span class="text">) </span><span class="kw4">~default</span><span class="text">:</span><span class="string">"None"</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">expect</span><span class="text">)
          </span><span class="string">"Str.index_of_string %s ~sub:%s ?from:%s ?sub_index:%s ?sub_length:%s gave %s not %s"</span><span class="text">
          </span><span class="id">s</span><span class="text"> </span><span class="id">sub</span><span class="text"> (</span><span class="id">shopt</span><span class="text"> </span><span class="id">from</span><span class="text">) (</span><span class="id">shopt</span><span class="text"> </span><span class="id">sub_index</span><span class="text">) (</span><span class="id">shopt</span><span class="text"> </span><span class="id">sub_length</span><span class="text">)
          (</span><span class="id">shopt</span><span class="text"> </span><span class="id">res</span><span class="text">) (</span><span class="id">shopt</span><span class="text"> </span><span class="id">expect</span><span class="text">);
        </span><span class="kw">let</span><span class="text"> </span><span class="id">erev</span><span class="text"> = </span><span class="kw1">match</span><span class="text"> </span><span class="id">expect_rev</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">expect</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">opt</span><span class="text"> -&gt; </span><span class="id">opt</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_string_reverse</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="id">subt</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">sub_index</span><span class="text"> ?</span><span class="id">sub_length</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">erev</span><span class="text">)
          </span><span class="string">"Str.index_of_string_reverse %s ~sub:%s ?from:%s ?sub_index:%s ?sub_length:%s gave %s not %s"</span><span class="text">
          </span><span class="id">s</span><span class="text"> </span><span class="id">sub</span><span class="text"> (</span><span class="id">shopt</span><span class="text"> </span><span class="id">from</span><span class="text">) (</span><span class="id">shopt</span><span class="text"> </span><span class="id">sub_index</span><span class="text">) (</span><span class="id">shopt</span><span class="text"> </span><span class="id">sub_length</span><span class="text">)
          (</span><span class="id">shopt</span><span class="text"> </span><span class="id">res</span><span class="text">) (</span><span class="id">shopt</span><span class="text"> </span><span class="id">erev</span><span class="text">);
      | </span><span class="numeric">_</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; ()
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaaa"</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"cc"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaaa"</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"ccaa"</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"cccca"</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">None</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aacca"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">None</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaccaa"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">4</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aacca"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aacca"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">4</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aacca"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~sub_length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">4</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aacca"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~sub_length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aacca"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">""</span><span class="text">  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"caaa"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaaa"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text"> </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaaa"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text"> </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaaa"</span><span class="text"> </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">5</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text"> </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"caaa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"aaaa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">3</span><span class="text">);
    </span><span class="comment">(* ┗▶ This is  searching the empty string ! Find everywhere. *)</span><span class="text">
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"caaa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">3</span><span class="text">);
    </span><span class="comment">(* ┗▶ This is also searching the empty string ! *)</span><span class="text">
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"caaa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~sub_length</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">3</span><span class="text">);
    </span><span class="id">test_index_of_string</span><span class="text"> </span><span class="string">"caaa"</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) </span><span class="kw4">~sub_length</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~sub</span><span class="text">:</span><span class="string">"aa"</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect_rev</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">2</span><span class="text">);
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `filter_map` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="comment">(* say "test: %s l : %d" name (List.length l); *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> =
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="comment">(* say "test: %s s: %d" name (Str.length s); *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">filtered</span><span class="text"> =
        </span><span class="kw2">Str</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
            </span><span class="comment">(* say "Chr: %d" (Chr.to_int c); *)</span><span class="text">
            </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="kw1">with</span><span class="text">
            | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">i</span><span class="text"> -&gt; </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">i</span><span class="text">
            | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> =
        </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">filtered</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before</span><span class="text"> =
        </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res_ints</span><span class="text">)
        </span><span class="string">"test_filter_map: [%s=%s] → [%s] &lt;&gt; [%s] (%s)"</span><span class="text">
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">","</span><span class="text">)
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">before</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">","</span><span class="text">)
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">","</span><span class="text">)
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">expect</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">","</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">some</span><span class="text"> = </span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">some</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"all empty"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">some</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">] </span><span class="string">"some 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">some</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"some 123"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">some</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="string">"some 111"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> []  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"none"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"none"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"none"</span><span class="text">;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">opt_of_cond</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw1">if</span><span class="text"> </span><span class="id">c</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">2</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 from 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 from 2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 from 3"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 from 4"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 length 0"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 length 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 length 2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 length 3"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 length 4"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `filter` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text">     = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="comment">(* say "test: %s l : %d" name (List.length l); *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text">        = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="comment">(* say "test: %s s: %d" name (Str.length s); *)</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">filtered</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">filter</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">c</span><span class="text">)) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">filtered</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before</span><span class="text">   = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text">     = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res_ints</span><span class="text">)
        </span><span class="string">"test_filter: [%s=%s] → [%s] &lt;&gt; [%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">res_ints</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">expect</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">always_true</span><span class="text"> </span><span class="numeric">_</span><span class="text">   = </span><span class="constant">true</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">always_false</span><span class="text"> </span><span class="numeric">_</span><span class="text">  = </span><span class="constant">false</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_true</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"all empty"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_true</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">] </span><span class="string">"true 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_true</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"true 123"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_true</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="string">"some 111"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> []  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_false</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"all empty"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_false</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"false 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:</span><span class="id">always_false</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"false 123"</span><span class="text">;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">opt_of_cond</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">2</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 from 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 from 2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 from 3"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 from 4"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 length 0"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"opt_of_cond _ &gt; 1 length 1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 length 2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 length 3"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">4</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1 length 4"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">opt_of_cond</span><span class="text"> ((&lt;) </span><span class="numeric">1</span><span class="text">)) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">] </span><span class="string">"opt_of_cond _ &gt; 1"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;


  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test the `split` function *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~on</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">on_converted</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">on</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">C</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
          `</span><span class="kw2">Character</span><span class="text"> (</span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_exn</span><span class="text"> </span><span class="kw4">~msg</span><span class="text">:</span><span class="string">"Chr.of_int"</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">c</span><span class="text">))
        | `</span><span class="kw2">S</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
          `</span><span class="kw2">String</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">split</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:</span><span class="id">on_converted</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_list</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text">  </span><span class="id">res</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">str_to_int_list</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res_list</span><span class="text"> = </span><span class="id">expect</span><span class="text">)
        </span><span class="string">"split: l: %s = %s on:(%s)\n    expect: {%s}\n     res: {%s}: %s."</span><span class="text">
        (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
        (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">s</span><span class="text">)
        (</span><span class="kw1">match</span><span class="text"> </span><span class="id">on</span><span class="text"> </span><span class="kw1">with</span><span class="text">
         | `</span><span class="kw2">C</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"`Character %d"</span><span class="text">  </span><span class="id">c</span><span class="text">
         | `</span><span class="kw2">S</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">sprintf</span><span class="text"> </span><span class="string">"`Bytes %s"</span><span class="text"> (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">s</span><span class="text">))
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">expect</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">" -- "</span><span class="text">)
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">res_list</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">" -- "</span><span class="text">)
        (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_string_hum</span><span class="text"> </span><span class="id">res</span><span class="text"> |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">"; "</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_one</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="id">test</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">C</span><span class="text"> </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">;
      </span><span class="id">test</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">S</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]) </span><span class="kw4">~expect</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">on_one</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[[]];
    </span><span class="id">on_one</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;] </span><span class="kw4">~expect</span><span class="text">:[[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]];
    </span><span class="id">on_one</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[]; []];
    </span><span class="id">on_one</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]];
    </span><span class="id">on_one</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]; []];
    </span><span class="id">on_one</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[]; [</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]; []];
    </span><span class="id">on_one</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[]; []; [</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]; []];

    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_123</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="id">test</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">S</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]) </span><span class="kw4">~expect</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">on_123</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[ [] ];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[ [</span><span class="numeric">1</span><span class="text">] ];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">5</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[ [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">5</span><span class="text">;] ];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[]; []];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">4</span><span class="text">]];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">]];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">]];
    </span><span class="id">on_123</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[[]; [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">1</span><span class="text">]];

    </span><span class="kw">let</span><span class="text"> </span><span class="id">on_empty</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="id">test</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:(`</span><span class="kw2">S</span><span class="text"> []) </span><span class="kw4">~expect</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">on_empty</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[ [] ];
    </span><span class="id">on_empty</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[ [</span><span class="numeric">1</span><span class="text">] ];
    </span><span class="id">on_empty</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">5</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[ [</span><span class="numeric">1</span><span class="text">]; [</span><span class="numeric">2</span><span class="text">]; [</span><span class="numeric">4</span><span class="text">]; [</span><span class="numeric">5</span><span class="text">] ];
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `find` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> ?</span><span class="id">should_find</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">find</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
        </span><span class="string">"find: %s (%s, %s) expects  %s but got %s"</span><span class="text">
        (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">length</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
        </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">find</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
          </span><span class="string">"find: %s (%s →, %s) expects  %s but got %s"</span><span class="text">
          (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">length</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      );
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &gt; </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt; </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &gt; </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt; </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt;= </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]     </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]     </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]     </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-2</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `find_reverse` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> ?</span><span class="id">should_find</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">find_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
        </span><span class="string">"find_reverse: %s (%s, %s) expects  %s but got %s"</span><span class="text">
        (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">length</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
        (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">None</span><span class="text"> </span><span class="kw1">then</span><span class="text"> (
        </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> - </span><span class="numeric">1</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">find_reverse</span><span class="text"> ?</span><span class="id">from</span><span class="text"> ?</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">should_find</span><span class="text">)
          </span><span class="string">"find_reverse: %s (%s → added, %s) expects  %s but got %s"</span><span class="text">
          (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">from</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">length</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">should_find</span><span class="text">)
          (</span><span class="id">int_option_to_string</span><span class="text"> </span><span class="id">res</span><span class="text">);
      );
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">0</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt;= </span><span class="numeric">2</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt; </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &gt; </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt; </span><span class="numeric">1</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> &lt;= </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]     </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]     </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]     </span><span class="kw4">~from</span><span class="text">:(</span><span class="numeric">-2</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">2</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">1</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] </span><span class="kw4">~from</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="kw4">~length</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) </span><span class="kw4">~should_find</span><span class="text">:</span><span class="numeric">3</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `strip` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">expect_str</span><span class="text"> =
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">expect</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt;  </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">whitespace</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="id">whitespace</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">strip</span><span class="text"> ?</span><span class="id">on</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">expect_str</span><span class="text">)
        </span><span class="string">"strip: %s ~on:%s expects %s but got %s"</span><span class="text">
        (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
        (</span><span class="kw1">match</span><span class="text"> </span><span class="id">on</span><span class="text"> </span><span class="kw1">with</span><span class="text"> </span><span class="kw2">Some</span><span class="text"> `</span><span class="kw2">Both</span><span class="text"> -&gt; </span><span class="string">"Both"</span><span class="text"> | </span><span class="kw2">Some</span><span class="text"> `</span><span class="kw2">Left</span><span class="text"> -&gt; </span><span class="string">"Left"</span><span class="text">
                     | </span><span class="kw2">Some</span><span class="text"> `</span><span class="kw2">Right</span><span class="text"> -&gt; </span><span class="string">"Right"</span><span class="text"> | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="string">"None"</span><span class="text">)
        (</span><span class="id">expect</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
        (</span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">res</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">whitespace</span><span class="text"> = [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw">in</span><span class="text">
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[    </span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[    </span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[    </span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[    </span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;     ];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[    </span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;     ];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[    </span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;     ];
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="kw">let</span><span class="text"> </span><span class="id">whitespace</span><span class="text"> = [] </span><span class="kw">in</span><span class="text">
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[];
      </span><span class="id">test</span><span class="text"> ?</span><span class="id">on</span><span class="text">:</span><span class="kw2">None</span><span class="text">   </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Both</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Left</span><span class="text">  </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
      </span><span class="id">test</span><span class="text"> </span><span class="kw4">~on</span><span class="text">:`</span><span class="kw2">Right</span><span class="text"> </span><span class="kw4">~whitespace</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">];
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `take_while{,_with_index}` *)</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">subject</span><span class="text"> -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">subject</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Error</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; ()
        | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">take_while</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">) = </span><span class="id">s</span><span class="text">)
            </span><span class="string">"take_while-true (%S)"</span><span class="text"> </span><span class="id">subject</span><span class="text">;
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">take_while</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">false</span><span class="text">) = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text">)
            </span><span class="string">"take_while-false (%S)"</span><span class="text"> </span><span class="id">subject</span><span class="text">;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw">in</span><span class="text">
          </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">take_while_with_index</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">idx</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">idx</span><span class="text"> &lt; </span><span class="id">length</span><span class="text">)
                        = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">sub_exn</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~length</span><span class="text">)
            </span><span class="string">"take_while &lt; length (%S)"</span><span class="text"> </span><span class="id">subject</span><span class="text">;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">rint</span><span class="text"> = </span><span class="kw2">Random</span><span class="text">.</span><span class="kw3">int</span><span class="text"> </span><span class="numeric">42</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">test_assertf</span><span class="text"> (
            </span><span class="kw">let</span><span class="text"> </span><span class="id">prefix</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">take_while</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">c</span><span class="text"> &lt; </span><span class="id">rint</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Str</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="id">prefix</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="constant">true</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt;
                </span><span class="id">prev</span><span class="text"> &amp;&amp; </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">c</span><span class="text"> &lt; </span><span class="id">rint</span><span class="text">))
            </span><span class="string">"take_while: char &lt; random-int (%S)"</span><span class="text"> </span><span class="id">subject</span><span class="text">;
      ) </span><span class="id">test_native_subjects</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw">let</span><span class="text"> </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">x</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text">
  </span><span class="kw">and</span><span class="text"> </span><span class="id">optionMap</span><span class="text"> </span><span class="id">f</span><span class="text">   = </span><span class="kw">function</span><span class="text"> | </span><span class="kw2">None</span><span class="text">   -&gt; </span><span class="kw2">None</span><span class="text">
                               | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text">
  </span><span class="kw">and</span><span class="text"> </span><span class="id">defOptMap</span><span class="text"> </span><span class="id">d</span><span class="text"> </span><span class="id">f</span><span class="text"> = </span><span class="kw">function</span><span class="text"> | </span><span class="kw2">None</span><span class="text">   -&gt; </span><span class="id">d</span><span class="text">
                               | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">f</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">pp_int_opt</span><span class="text"> </span><span class="id">o</span><span class="text">  = </span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="string">"Some "</span><span class="text"> ^ </span><span class="id">string_of_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="id">o</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test slice *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> ?</span><span class="id">start</span><span class="text"> ?</span><span class="id">finish</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text">   = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">exp</span><span class="text"> = </span><span class="id">optionMap</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">e</span><span class="text">)) </span><span class="id">expect</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">slice</span><span class="text"> ?</span><span class="id">start</span><span class="text"> ?</span><span class="id">finish</span><span class="text"> </span><span class="id">s</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">exp</span><span class="text">)
        </span><span class="string">"slice: %s ?start:(%s) ?finish:(%s) expects %s but got %s"</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
          (</span><span class="id">pp_int_opt</span><span class="text"> </span><span class="id">start</span><span class="text">)
          (</span><span class="id">pp_int_opt</span><span class="text"> </span><span class="id">finish</span><span class="text">)
          (</span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> </span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">expect</span><span class="text">)
          (</span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">r</span><span class="text"> -&gt; </span><span class="id">str_to_int_list</span><span class="text"> </span><span class="id">r</span><span class="text"> |&gt; </span><span class="id">int_list_to_string</span><span class="text">) </span><span class="id">res</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text">                          []       </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text">                          [</span><span class="numeric">1</span><span class="text">]      </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]);
    </span><span class="id">test</span><span class="text">                          [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">0</span><span class="text">                 []       </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">0</span><span class="text">                 [</span><span class="numeric">1</span><span class="text">]      </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">0</span><span class="text">                 [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">0</span><span class="text">    </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">0</span><span class="text">    []       </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">0</span><span class="text">    </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">1</span><span class="text">    [</span><span class="numeric">1</span><span class="text">]      </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">0</span><span class="text">    </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">3</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">1</span><span class="text">                 [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">2</span><span class="text">                 [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">1</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">]);
    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">2</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">1</span><span class="text">    </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">1</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">1</span><span class="text">    </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">2</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">2</span><span class="text">]);

    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">)              []       </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">)              [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">1</span><span class="text">                 []       </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="kw4">~start</span><span class="text">:</span><span class="numeric">2</span><span class="text">                 [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;

    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) []       </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:(</span><span class="numeric">-1</span><span class="text">) [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;

    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">1</span><span class="text">    []       </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">2</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]);
    </span><span class="id">test</span><span class="text">             </span><span class="kw4">~finish</span><span class="text">:</span><span class="numeric">3</span><span class="text">    [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;

  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* test `rev` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">reversed</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">rev</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">reversed</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res_ints</span><span class="text">)
        </span><span class="string">"test_mapi: [%s=%s] → [%s] &lt;&gt; [%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">res_ints</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">expect</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"empty"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="string">"simple 123-&gt;321"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">] </span><span class="string">"single 1"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test map *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_explicit</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_fn_exn</span><span class="text"> </span><span class="id">x</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">res</span><span class="text"> -&gt; </span><span class="id">res</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">"bad char"</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">mapped</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">test_fn_exn</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">mapped</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res_ints</span><span class="text">)
        </span><span class="string">"test_mapi: [%s=%s] → [%s] &lt;&gt; [%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">res_ints</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">expect</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test_explicit</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="string">"map"</span><span class="text">;
    </span><span class="id">test_explicit</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"map"</span><span class="text">;
    </span><span class="id">test_explicit</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="string">"map"</span><span class="text">;
    </span><span class="comment">(* Make sure map_slow works as well. *)</span><span class="text">
    </span><span class="id">test_explicit</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">))
                  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; (</span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">)
                  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; (</span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">))
                  </span><span class="string">"map large"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test mapi *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">char_upper</span><span class="text">    = </span><span class="numeric">199</span><span class="text">     </span><span class="comment">(* Not really, but not / 5 *)</span><span class="text">
    </span><span class="kw">and</span><span class="text"> </span><span class="id">char_lower</span><span class="text">    = </span><span class="numeric">33</span><span class="text"> </span><span class="kw">in</span><span class="text">   </span><span class="comment">(* Before this come the odd ones in ASCII *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">d</span><span class="text"> = </span><span class="id">char_upper</span><span class="text"> - </span><span class="id">char_lower</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">int_to_char</span><span class="text"> </span><span class="id">i</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> ((</span><span class="id">i</span><span class="text"> </span><span class="kw1">mod</span><span class="text"> </span><span class="id">d</span><span class="text">) + </span><span class="id">char_lower</span><span class="text">) </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">"bad logic"</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">c</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">make_list</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="id">n</span><span class="text"> =
      </span><span class="kw1">if</span><span class="text"> </span><span class="id">n</span><span class="text"> &lt; </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">acc</span><span class="text"> </span><span class="kw1">else</span><span class="text"> </span><span class="id">make_list</span><span class="text"> ((</span><span class="id">int_to_char</span><span class="text"> </span><span class="id">n</span><span class="text">)::</span><span class="id">acc</span><span class="text">) (</span><span class="id">n</span><span class="text"> - </span><span class="numeric">1</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">n</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">lst</span><span class="text"> = </span><span class="id">make_list</span><span class="text"> [] </span><span class="id">n</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">dum</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">make</span><span class="text"> (</span><span class="id">n</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) (</span><span class="id">int_to_char</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">exp</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="id">lst</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">mapi</span><span class="text"> </span><span class="id">dum</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">int_to_char</span><span class="text"> </span><span class="id">i</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = </span><span class="id">exp</span><span class="text">) </span><span class="string">"mapi: %d [%s] [%s]"</span><span class="text">
        </span><span class="id">n</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">exp</span><span class="text">) (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">res</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_explicit</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_fn_exn</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">res</span><span class="text"> -&gt; </span><span class="id">res</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">"bad char"</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">mapped</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">mapi</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">test_fn_exn</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">mapped</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res_ints</span><span class="text">)
        </span><span class="string">"test_mapi: [%s=%s] → [%s] &lt;&gt; [%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">res_ints</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">expect</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> </span><span class="numeric">10</span><span class="text">;
    </span><span class="id">test</span><span class="text"> </span><span class="numeric">10000</span><span class="text">;    </span><span class="comment">(* to cover that slow case *)</span><span class="text">
    </span><span class="id">test_explicit</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="string">"mapi inc"</span><span class="text">;
    </span><span class="id">test_explicit</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">i</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] </span><span class="string">"mapi indexed"</span><span class="text">;
    </span><span class="comment">(* Make sure mapi_slow works as well. *)</span><span class="text">
    </span><span class="id">test_explicit</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">))
                  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; (</span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">)
                  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; (</span><span class="id">x</span><span class="text"> + </span><span class="numeric">1</span><span class="text">) </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">))
                  </span><span class="string">"mapi large"</span><span class="text">;
    </span><span class="id">test_explicit</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">))
                  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">i</span><span class="text"> </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">)
                  </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> </span><span class="kw1">mod</span><span class="text"> </span><span class="numeric">50</span><span class="text">))
                  </span><span class="string">"mapi large"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `map2_exn` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s1</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s2</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_fn_exn</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="id">f</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">y</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">res</span><span class="text"> -&gt; </span><span class="id">res</span><span class="text">
        | </span><span class="kw2">None</span><span class="text"> -&gt; </span><span class="id">failwith</span><span class="text"> </span><span class="string">"bad char"</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">mapped</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">map2_exn</span><span class="text"> </span><span class="id">s1</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">test_fn_exn</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res_ints</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">mapped</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before1</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s1</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before2</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s2</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res_ints</span><span class="text">)
        </span><span class="string">"test_map2_exn: [%s,%s=%s,%s] → [%s] &lt;&gt; [%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l1</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">l2</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before1</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before2</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">res_ints</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">expect</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_fail</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s1</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s2</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">failed</span><span class="text"> =
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
            </span><span class="kw2">Str</span><span class="text">.</span><span class="id">map2_exn</span><span class="text"> </span><span class="id">s1</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">f</span><span class="text"> |&gt; </span><span class="id">ignore</span><span class="text">;
            </span><span class="constant">false</span><span class="text">
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> </span><span class="id">failed</span><span class="text">
        </span><span class="string">"test_map2_exn: should have failed on [%s,%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l1</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">l2</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[] </span><span class="string">"all empty"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">1</span><span class="text">] </span><span class="string">"1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">y</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">] </span><span class="string">"2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">] [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">y</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"2343"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">0</span><span class="text">] [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> + </span><span class="id">y</span><span class="text">) </span><span class="kw4">~expect</span><span class="text">:[</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] </span><span class="string">"3323"</span><span class="text">;
    </span><span class="comment">(* Make sure we hit map2_slow: *)</span><span class="text">
    </span><span class="id">test</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">)) (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">))
         </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text">)
         </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">)) </span><span class="string">"long str"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">0</span><span class="text">)) (</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">))
         </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">y</span><span class="text">)
         </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">List</span><span class="text">.</span><span class="id">init</span><span class="text"> </span><span class="numeric">10000</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">)) </span><span class="string">"long str"</span><span class="text">;
    </span><span class="comment">(* Make sure we fail on lists of different lengths: *)</span><span class="text">
    </span><span class="id">test_fail</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text">) </span><span class="string">"unequal length"</span><span class="text">;
    </span><span class="id">test_fail</span><span class="text"> [] [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">y</span><span class="text">) </span><span class="string">"other side unequal length"</span><span class="text">;
    </span><span class="id">test_fail</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">y</span><span class="text">) </span><span class="string">"nonempty unequal length"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `foldi` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">lst</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">lst</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">folded</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">foldi</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">i</span><span class="text"> + </span><span class="id">a</span><span class="text"> + </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">c</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">folded</span><span class="text"> = </span><span class="id">expect</span><span class="text">)
        </span><span class="string">"test_foldi: init %d + the indices and chars of [%s] → [%d] &lt;&gt; %d %s"</span><span class="text">
          </span><span class="id">init</span><span class="text"> (</span><span class="id">pp</span><span class="text"> </span><span class="id">lst</span><span class="text">) </span><span class="id">folded</span><span class="text"> </span><span class="id">expect</span><span class="text"> </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="string">"empty"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">0</span><span class="text">] </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">100</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">100</span><span class="text"> </span><span class="string">"singleton, zero-indexed"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">0</span><span class="text">] </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">10</span><span class="text">
      </span><span class="string">"adding the indices of 5 long string should be ten"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">100</span><span class="text">;</span><span class="numeric">100</span><span class="text">;</span><span class="numeric">100</span><span class="text">;</span><span class="numeric">100</span><span class="text">] </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">406</span><span class="text">
      </span><span class="string">"test uses string values."</span><span class="text">
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test `fold2_exn` *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">into_str</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">of_int</span><span class="text"> |&gt; </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_character_list</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">pp</span><span class="text"> </span><span class="id">l</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">l</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="string">";"</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s1</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s2</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_fn_exn</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> = </span><span class="id">f</span><span class="text"> </span><span class="id">i</span><span class="text"> (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">x</span><span class="text">) (</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="id">y</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">fold2_exn</span><span class="text"> </span><span class="id">s1</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">test_fn_exn</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="id">init</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before1</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s1</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">before2</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_character_list</span><span class="text"> </span><span class="id">s2</span><span class="text"> |&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">to_int</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="id">res</span><span class="text">)
        </span><span class="string">"test_fold2_exn: [%s,%s=%s,%s] init:%s → %s &lt;&gt; %s (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l1</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">l2</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before1</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">before2</span><span class="text">) ((</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) </span><span class="id">init</span><span class="text">)
        ((</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) </span><span class="id">res</span><span class="text">) ((</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"%d"</span><span class="text">) </span><span class="id">expect</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test_fail</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text">) </span><span class="id">fmt</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s1</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l1</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s2</span><span class="text"> = </span><span class="id">into_str</span><span class="text"> </span><span class="id">l2</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">failed</span><span class="text"> =
        </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">try</span><span class="text">
            </span><span class="kw2">Str</span><span class="text">.</span><span class="id">fold2_exn</span><span class="text"> </span><span class="id">s1</span><span class="text"> </span><span class="id">s2</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">f</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="id">init</span><span class="text"> |&gt; </span><span class="id">ignore</span><span class="text">;
            </span><span class="constant">false</span><span class="text">
          </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="constant">true</span><span class="text">
        </span><span class="kw1">end</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> </span><span class="id">failed</span><span class="text">
        </span><span class="string">"test_fold2_exn: should have failed on [%s,%s] (%s)"</span><span class="text">
        (</span><span class="id">pp</span><span class="text"> </span><span class="id">l1</span><span class="text">) (</span><span class="id">pp</span><span class="text"> </span><span class="id">l2</span><span class="text">)
        </span><span class="id">name</span><span class="text">;
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> [] [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="string">"nothing"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">i</span><span class="text">) </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="string">"1"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">] [</span><span class="numeric">2</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">y</span><span class="text">) </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">2</span><span class="text"> </span><span class="string">"2"</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">] [</span><span class="numeric">0</span><span class="text">;</span><span class="numeric">1</span><span class="text">]  </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> + </span><span class="id">y</span><span class="text"> + </span><span class="id">i</span><span class="text">)
         </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">1</span><span class="text"> </span><span class="kw4">~expect</span><span class="text">:</span><span class="numeric">3</span><span class="text"> </span><span class="string">"3"</span><span class="text">;
    </span><span class="comment">(* Make sure we fail on lists of different lengths: *)</span><span class="text">
    </span><span class="id">test_fail</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">] [] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="string">"unequal length"</span><span class="text">;
    </span><span class="id">test_fail</span><span class="text"> [] [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="string">"other side unequal length"</span><span class="text">;
    </span><span class="id">test_fail</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] [</span><span class="numeric">1</span><span class="text">] </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">y</span><span class="text"> -&gt; </span><span class="numeric">1</span><span class="text">) </span><span class="kw4">~init</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="string">"nonempty unequal length"</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test is_prefix *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~p</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text">      = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">l</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">prefix</span><span class="text"> = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">is_prefix</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~prefix</span><span class="text">)
        </span><span class="string">"is_prefix: %s prefix:(%s) expects %B"</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">p</span><span class="text">)
          </span><span class="id">expect</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~p</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">4</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">false</span><span class="text">;
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">false</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">false</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test is_suffix *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~s</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text">      = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">l</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">suffix</span><span class="text"> = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">expect</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">is_suffix</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~suffix</span><span class="text">)
        </span><span class="string">"is_suffix: %s suffix:(%s) expects %B"</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">s</span><span class="text">)
          </span><span class="id">expect</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~s</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">3</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">true</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">4</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">false</span><span class="text">;
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">false</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:</span><span class="constant">false</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test chop_prefix *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~p</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text">      = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">l</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">prefix</span><span class="text"> = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">p</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text">    = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">chop_prefix</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~prefix</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">exp</span><span class="text">    = </span><span class="id">optionMap</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">x</span><span class="text">)) </span><span class="id">expect</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">exp</span><span class="text"> = </span><span class="id">res</span><span class="text">)
        </span><span class="string">"chop_prefix: %s prefix:(%s) expected %s but got %s"</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">p</span><span class="text">)
          (</span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> </span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">expect</span><span class="text">)
          (</span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">res</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~p</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">4</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~p</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;
  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test chop_suffix *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~s</span><span class="text"> </span><span class="kw4">~expect</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text">      = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">l</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">suffix</span><span class="text"> = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text">    = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">chop_suffix</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~suffix</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">exp</span><span class="text">    = </span><span class="id">optionMap</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">x</span><span class="text">)) </span><span class="id">expect</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">exp</span><span class="text"> = </span><span class="id">res</span><span class="text">)
        </span><span class="string">"chop_suffix: %s suffix:(%s) expected %s but got %s"</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">s</span><span class="text">)
          (</span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> </span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">expect</span><span class="text">)
          (</span><span class="id">defOptMap</span><span class="text"> </span><span class="string">"None"</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">res</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~s</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[]         </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">3</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]    </span><span class="kw4">~expect</span><span class="text">:(</span><span class="kw2">Some</span><span class="text"> []);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">4</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> []       </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">1</span><span class="text">]        </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]  </span><span class="kw4">~s</span><span class="text">:[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">;</span><span class="numeric">4</span><span class="text">]  </span><span class="kw4">~expect</span><span class="text">:</span><span class="kw2">None</span><span class="text">;
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="kw1">begin</span><span class="text"> </span><span class="comment">(* Test split_at, take and drop. *)</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">test</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="id">n</span><span class="text"> (</span><span class="id">le</span><span class="text">,</span><span class="id">ri</span><span class="text">) =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text">   = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">l</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">le</span><span class="text">' = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">le</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">ri</span><span class="text">' = </span><span class="id">ints_to_str</span><span class="text"> </span><span class="id">ri</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> (</span><span class="id">rl</span><span class="text">,</span><span class="id">rr</span><span class="text">) </span><span class="kw1">as</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">split_at</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">n</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">tres</span><span class="text">  = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">take</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">n</span><span class="text">
      </span><span class="kw">and</span><span class="text"> </span><span class="id">dres</span><span class="text">  = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">drop</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">res</span><span class="text"> = (</span><span class="id">le</span><span class="text">',</span><span class="id">ri</span><span class="text">') &amp;&amp; </span><span class="id">tres</span><span class="text"> = </span><span class="id">le</span><span class="text">' &amp;&amp; </span><span class="id">dres</span><span class="text"> = </span><span class="id">ri</span><span class="text">')
        </span><span class="string">"split_at: %s %d expects (%s,%s) but got (%s,%s)"</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">l</span><span class="text">)
          </span><span class="id">n</span><span class="text">
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">le</span><span class="text">)
          (</span><span class="id">int_list_to_string</span><span class="text"> </span><span class="id">ri</span><span class="text">)
          (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">rl</span><span class="text">)
          (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">rr</span><span class="text">)
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">test</span><span class="text"> []      (</span><span class="numeric">-1</span><span class="text">) ([],[]);
    </span><span class="id">test</span><span class="text"> []      (</span><span class="numeric">0</span><span class="text">)  ([],[]);
    </span><span class="id">test</span><span class="text"> []      (</span><span class="numeric">1</span><span class="text">)  ([],[]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] (</span><span class="numeric">-1</span><span class="text">) ([],[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] (</span><span class="numeric">0</span><span class="text">)  ([],[</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] (</span><span class="numeric">1</span><span class="text">)  ([</span><span class="numeric">1</span><span class="text">],[</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] (</span><span class="numeric">2</span><span class="text">)  ([</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">],[</span><span class="numeric">3</span><span class="text">]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] (</span><span class="numeric">3</span><span class="text">)  ([</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">],[]);
    </span><span class="id">test</span><span class="text"> [</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">] (</span><span class="numeric">4</span><span class="text">)  ([</span><span class="numeric">1</span><span class="text">;</span><span class="numeric">2</span><span class="text">;</span><span class="numeric">3</span><span class="text">],[]);
  </span><span class="kw1">end</span><span class="text">;

  </span><span class="comment">(* #### BENCHMARKS #### *)</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">converted_dna_reads</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="id">all</span><span class="text"> =
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">dna_test_subjects</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt;
          </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Str</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw1">with</span><span class="text">
          | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">cs</span><span class="text"> -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">cs</span><span class="text">
          | `</span><span class="kw2">Error</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="id">test_assertf</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">dna_test_subjects</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">all</span><span class="text">)
      </span><span class="string">"Convert DNA (common denominator) %d &lt;&gt; %d"</span><span class="text">
      (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">dna_test_subjects</span><span class="text">) (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">all</span><span class="text">);
    </span><span class="id">all</span><span class="text"> </span><span class="kw">in</span><span class="text">

  </span><span class="kw">let</span><span class="text"> </span><span class="id">implementation</span><span class="text"> = </span><span class="id">test_name</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Benchmark</span><span class="text">.</span><span class="id">declare</span><span class="text">
    </span><span class="kw4">~experiment</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"Concat%d"</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">converted_dna_reads</span><span class="text">))
    </span><span class="kw4">~implementation</span><span class="text">
    (</span><span class="kw">fun</span><span class="text"> () -&gt;
       </span><span class="kw">let</span><span class="text"> </span><span class="numeric">_</span><span class="text"> =
         </span><span class="kw2">Str</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text"> </span><span class="id">converted_dna_reads</span><span class="text"> </span><span class="kw">in</span><span class="text">
       ());

  </span><span class="kw">let</span><span class="text"> </span><span class="id">cated</span><span class="text"> =
    </span><span class="kw2">Str</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="kw4">~sep</span><span class="text">:</span><span class="kw2">Str</span><span class="text">.</span><span class="id">empty</span><span class="text"> </span><span class="id">converted_dna_reads</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Benchmark</span><span class="text">.</span><span class="id">declare</span><span class="text">
    </span><span class="kw4">~experiment</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"Length"</span><span class="text">)
    </span><span class="kw4">~implementation</span><span class="text">
    </span><span class="kw4">~repeats</span><span class="text">:</span><span class="numeric">10000</span><span class="text">
    (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">ignore</span><span class="text"> (</span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">cated</span><span class="text">));
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub</span><span class="text"> =
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">nth_exn</span><span class="text"> </span><span class="id">converted_dna_reads</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">converted_dna_reads</span><span class="text"> - </span><span class="numeric">30</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_index</span><span class="text"> = </span><span class="numeric">1</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sub_length</span><span class="text"> = </span><span class="kw2">Str</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">sub</span><span class="text"> - </span><span class="id">sub_index</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="numeric">2</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Benchmark</span><span class="text">.</span><span class="id">declare</span><span class="text">
    </span><span class="kw4">~experiment</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"Find"</span><span class="text">)
    </span><span class="kw4">~implementation</span><span class="text">
    </span><span class="kw4">~repeats</span><span class="text">:</span><span class="numeric">5</span><span class="text">
    (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">ignore</span><span class="text"> (
         </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_string</span><span class="text"> </span><span class="id">cated</span><span class="text"> </span><span class="kw4">~sub</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text"> </span><span class="kw4">~sub_length</span><span class="text">
       ));
  </span><span class="kw2">Benchmark</span><span class="text">.</span><span class="id">declare</span><span class="text">
    </span><span class="kw4">~experiment</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">"R-Find"</span><span class="text">)
    </span><span class="kw4">~implementation</span><span class="text">
    </span><span class="kw4">~repeats</span><span class="text">:</span><span class="numeric">5</span><span class="text">
    (</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="id">ignore</span><span class="text"> (
         </span><span class="kw2">Str</span><span class="text">.</span><span class="id">index_of_string_reverse</span><span class="text"> </span><span class="id">cated</span><span class="text"> </span><span class="kw4">~sub</span><span class="text"> </span><span class="kw4">~from</span><span class="text"> </span><span class="kw4">~sub_index</span><span class="text"> </span><span class="kw4">~sub_length</span><span class="text">
       ));
  ()

</span></pre>


<h2 id="AUTF8SpecificTest">A UTF-8-Specific Test</h2>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> </span><span class="id">utf8_specific_test</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Utf8</span><span class="text"> = </span><span class="kw2">Int_utf8_character</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="id">say</span><span class="text"> </span><span class="string">"### UTF-8 Test"</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> </span><span class="id">ground_truth</span><span class="text"> = [
    </span><span class="string">"$"</span><span class="text">, </span><span class="numeric">0x24</span><span class="text">; </span><span class="comment">(* ASCII *)</span><span class="text">
    </span><span class="string">"¢"</span><span class="text">, </span><span class="numeric">0xA2</span><span class="text">; </span><span class="comment">(* Latin-something *)</span><span class="text">
    </span><span class="string">"€"</span><span class="text">, </span><span class="numeric">0x20AC</span><span class="text">; </span><span class="comment">(* Multi-byte *)</span><span class="text">
    </span><span class="string">"\xF0\xA4\xAD\xA2"</span><span class="text">, </span><span class="numeric">0x24B62</span><span class="text">; </span><span class="comment">(* Another example from Wikipedia *)</span><span class="text">
    </span><span class="string">"í"</span><span class="text">, </span><span class="numeric">0xED</span><span class="text">; </span><span class="comment">(* Spanish stuff *)</span><span class="text">
    </span><span class="string">"œ"</span><span class="text">, </span><span class="numeric">0x153</span><span class="text">; </span><span class="comment">(* French stuff *)</span><span class="text">
    </span><span class="string">"ß"</span><span class="text">, </span><span class="numeric">0xDF</span><span class="text">; </span><span class="comment">(* German Stuff *)</span><span class="text">
  ] </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">List</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">ground_truth</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> (</span><span class="id">s</span><span class="text">, </span><span class="id">i</span><span class="text">) -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">actual_test</span><span class="text"> = </span><span class="kw2">Utf8</span><span class="text">.</span><span class="id">to_native_string</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">actual_test</span><span class="text"> = </span><span class="id">s</span><span class="text">) </span><span class="string">"utf8_specific_test: (%S, %d) Vs %S"</span><span class="text">
        </span><span class="id">s</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">actual_test</span><span class="text">;
      </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Utf8</span><span class="text">.</span><span class="id">read_from_native_string</span><span class="text"> </span><span class="kw4">~buf</span><span class="text">:</span><span class="id">s</span><span class="text"> </span><span class="kw4">~index</span><span class="text">:</span><span class="numeric">0</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> (</span><span class="id">v</span><span class="text">, </span><span class="id">sz</span><span class="text">) -&gt;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">v</span><span class="text"> = </span><span class="id">i</span><span class="text">)
          </span><span class="string">"utf8_specific_test: Utf8.read_from_native_string: %d &lt;&gt; %d"</span><span class="text"> </span><span class="id">v</span><span class="text"> </span><span class="id">i</span><span class="text">;
        </span><span class="id">test_assertf</span><span class="text"> (</span><span class="id">sz</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">length</span><span class="text"> </span><span class="id">s</span><span class="text">)
          </span><span class="string">"utf8_specific_test: Utf8.read_from_native_string: size %d Vs %S"</span><span class="text"> </span><span class="id">sz</span><span class="text"> </span><span class="id">s</span><span class="text">;
      | </span><span class="kw2">None</span><span class="text"> -&gt;
        </span><span class="id">test_assertf</span><span class="text"> </span><span class="constant">false</span><span class="text"> </span><span class="string">"utf8_specific_test: Utf8.read_from_native_string fail"</span><span class="text">
      </span><span class="kw1">end</span><span class="text">
    );
  ()

</span></pre>


<h2 id="TestInstantiations">Test Instantiations</h2>
<pre><span class="text">
</span><span class="kw">let</span><span class="text"> () =
  </span><span class="id">do_basic_test</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_name</span><span class="text"> = </span><span class="string">"Both natives"</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text"> = </span><span class="constant">false</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Chr</span><span class="text"> = </span><span class="kw2">Native_character</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Str</span><span class="text"> = </span><span class="kw2">Native_bytes</span><span class="text">
    </span><span class="kw1">end</span><span class="text">);
  </span><span class="id">do_basic_test</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_name</span><span class="text"> = </span><span class="string">"List of natives"</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text"> = </span><span class="constant">false</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Chr</span><span class="text"> = </span><span class="kw2">Native_character</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Str</span><span class="text"> = </span><span class="kw2">List_of</span><span class="text">.</span><span class="kw2">Make</span><span class="text"> (</span><span class="kw2">Native_character</span><span class="text">)
  </span><span class="kw1">end</span><span class="text">);
  </span><span class="id">do_basic_test</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_name</span><span class="text"> = </span><span class="string">"List of UTF-8 Integers"</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text"> = </span><span class="constant">true</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Chr</span><span class="text"> = </span><span class="kw2">Int_utf8_character</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Str</span><span class="text"> = </span><span class="kw2">List_of</span><span class="text">.</span><span class="kw2">Make</span><span class="text"> (</span><span class="kw2">Int_utf8_character</span><span class="text">)
  </span><span class="kw1">end</span><span class="text">);
  </span><span class="id">do_basic_test</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_name</span><span class="text"> = </span><span class="string">"Of_mutable(utf8-int array)"</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text"> = </span><span class="constant">true</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Chr</span><span class="text"> = </span><span class="kw2">Int_utf8_character</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Str</span><span class="text"> = </span><span class="kw2">Of_mutable</span><span class="text">.</span><span class="kw2">Make</span><span class="text"> (</span><span class="kw1">struct</span><span class="text">
          </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">t</span><span class="text">
          </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="kw3">int</span><span class="text"> </span><span class="kw3">array</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = [| |]
          </span><span class="kw">let</span><span class="text"> </span><span class="id">max_string_length</span><span class="text"> = </span><span class="kw2">Some</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">max_array_length</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Array</span><span class="text">.</span><span class="id">length</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">make</span><span class="text"> = </span><span class="kw2">Array</span><span class="text">.</span><span class="id">make</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="id">t</span><span class="text">.(</span><span class="id">i</span><span class="text">)
          </span><span class="kw">let</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="id">t</span><span class="text">.(</span><span class="id">i</span><span class="text">) &lt;- </span><span class="id">c</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">blit</span><span class="text"> = </span><span class="kw2">Array</span><span class="text">.</span><span class="id">blit</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> = </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">is_whitespace</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text"> =
            </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Array</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">len</span><span class="text"> = </span><span class="id">min</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">a</span><span class="text">) (</span><span class="id">length</span><span class="text"> </span><span class="id">b</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">try</span><span class="text">
              </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">len</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">cmp</span><span class="text"> = </span><span class="id">compare</span><span class="text"> (</span><span class="id">get</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">i</span><span class="text">) (</span><span class="id">get</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">i</span><span class="text">)  </span><span class="kw">in</span><span class="text">
                </span><span class="kw1">if</span><span class="text"> </span><span class="id">cmp</span><span class="text"> = </span><span class="numeric">0</span><span class="text">
                </span><span class="kw1">then</span><span class="text"> ()
                </span><span class="kw1">else</span><span class="text"> (</span><span class="id">res</span><span class="text"> := </span><span class="id">cmp</span><span class="text">; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">)
              </span><span class="kw1">done</span><span class="text">;
              </span><span class="id">compare</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">a</span><span class="text">) (</span><span class="id">length</span><span class="text"> </span><span class="id">b</span><span class="text">)
            </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; !</span><span class="id">res</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_char</span><span class="text"> = </span><span class="kw2">Int</span><span class="text">.</span><span class="id">compare</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">natstr</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
            </span><span class="kw2">Conversions</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text">
              </span><span class="kw4">~empty</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw1">ref</span><span class="text"> [])
              </span><span class="kw4">~on_new_character</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> := </span><span class="id">c</span><span class="text"> :: !</span><span class="id">x</span><span class="text">)
              </span><span class="kw4">~finalize</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt; </span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">x</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">of_list</span><span class="text">)
              </span><span class="kw4">~read_character_from_native_string</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">read_from_native_string</span><span class="text">
              </span><span class="id">natstr</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_string</span><span class="text"> </span><span class="id">natstr</span><span class="text"> =
            </span><span class="kw2">Conversions</span><span class="text">.</span><span class="id">of_native_string</span><span class="text">
              </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">natstr</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">l</span><span class="text"> =
            </span><span class="kw2">Conversions</span><span class="text">.</span><span class="id">to_native_string_knowing_size</span><span class="text">
              </span><span class="kw4">~future_size</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">l</span><span class="text"> -&gt;
                  </span><span class="kw">let</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
                  </span><span class="kw2">Array</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">l</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">s</span><span class="text"> := !</span><span class="id">s</span><span class="text"> + </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">size</span><span class="text"> </span><span class="id">c</span><span class="text">);
                  !</span><span class="id">s</span><span class="text">)
              </span><span class="kw4">~iter</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="kw4">~f</span><span class="text"> -&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">iter</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="kw4">~f</span><span class="text">)
              </span><span class="kw4">~write_char_to_native_bytes</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">write_to_native_bytes</span><span class="text">
              </span><span class="id">l</span><span class="text">
            |&gt; </span><span class="kw2">Bytes</span><span class="text">.</span><span class="id">to_string</span><span class="text">

        </span><span class="kw1">end</span><span class="text">)
  </span><span class="kw1">end</span><span class="text">);
  </span><span class="id">do_basic_test</span><span class="text"> (</span><span class="kw">module</span><span class="text"> </span><span class="kw1">struct</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">test_name</span><span class="text"> = </span><span class="string">"Of_mutable(int8 Bigarray1.t)"</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">can_have_wrong_char</span><span class="text"> = </span><span class="constant">false</span><span class="text">
      </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Bigarray</span><span class="text">
      </span><span class="kw">type</span><span class="text"> </span><span class="id">char_bigarray</span><span class="text"> = (</span><span class="kw3">char</span><span class="text">, </span><span class="id">int8_unsigned_elt</span><span class="text">, </span><span class="id">c_layout</span><span class="text">) </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">t</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Chr</span><span class="text"> = </span><span class="kw2">Native_character</span><span class="text">
      </span><span class="kw">module</span><span class="text"> </span><span class="kw2">Str</span><span class="text"> = </span><span class="kw2">Of_mutable</span><span class="text">.</span><span class="kw2">Make</span><span class="text"> (</span><span class="kw1">struct</span><span class="text">
          </span><span class="kw">type</span><span class="text"> </span><span class="id">character</span><span class="text"> = </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">t</span><span class="text">
          </span><span class="kw">type</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">char_bigarray</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">empty</span><span class="text"> = </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="id">c_layout</span><span class="text"> </span><span class="numeric">0</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">max_string_length</span><span class="text"> = </span><span class="kw2">None</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">length</span><span class="text"> = </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">dim</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">make</span><span class="text"> </span><span class="id">len</span><span class="text"> </span><span class="id">c</span><span class="text">  =
            </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="id">c_layout</span><span class="text"> </span><span class="id">len</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">fill</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">c</span><span class="text">;
            </span><span class="id">res</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">is_whitespace</span><span class="text"> = </span><span class="kw2">Chr</span><span class="text">.</span><span class="id">is_whitespace</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">set</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="id">c</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">blit</span><span class="text"> </span><span class="kw4">~src</span><span class="text"> </span><span class="kw4">~src_pos</span><span class="text"> </span><span class="kw4">~dst</span><span class="text"> </span><span class="kw4">~dst_pos</span><span class="text"> </span><span class="kw4">~len</span><span class="text"> =
            </span><span class="kw2">Array1</span><span class="text">.(</span><span class="id">blit</span><span class="text"> (</span><span class="id">sub</span><span class="text"> </span><span class="id">src</span><span class="text"> </span><span class="id">src_pos</span><span class="text"> </span><span class="id">len</span><span class="text">) (</span><span class="id">sub</span><span class="text"> </span><span class="id">dst</span><span class="text"> </span><span class="id">dst_pos</span><span class="text"> </span><span class="id">len</span><span class="text">))

          </span><span class="kw">let</span><span class="text"> </span><span class="id">compare</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text"> =
            </span><span class="kw">let</span><span class="text"> </span><span class="id">len</span><span class="text"> = </span><span class="id">min</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">a</span><span class="text">) (</span><span class="id">length</span><span class="text"> </span><span class="id">b</span><span class="text">) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw1">try</span><span class="text">
              </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">len</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
                </span><span class="kw">let</span><span class="text"> </span><span class="id">cmp</span><span class="text"> = </span><span class="id">compare</span><span class="text"> (</span><span class="id">get</span><span class="text"> </span><span class="id">a</span><span class="text"> </span><span class="id">i</span><span class="text">) (</span><span class="id">get</span><span class="text"> </span><span class="id">b</span><span class="text"> </span><span class="id">i</span><span class="text">)  </span><span class="kw">in</span><span class="text">
                </span><span class="kw1">if</span><span class="text"> </span><span class="id">cmp</span><span class="text"> = </span><span class="numeric">0</span><span class="text">
                </span><span class="kw1">then</span><span class="text"> ()
                </span><span class="kw1">else</span><span class="text"> (</span><span class="id">res</span><span class="text"> := </span><span class="id">cmp</span><span class="text">; </span><span class="id">raise</span><span class="text"> </span><span class="kw2">Not_found</span><span class="text">)
              </span><span class="kw1">done</span><span class="text">;
              </span><span class="id">compare</span><span class="text"> (</span><span class="id">length</span><span class="text"> </span><span class="id">a</span><span class="text">) (</span><span class="id">length</span><span class="text"> </span><span class="id">b</span><span class="text">)
            </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; !</span><span class="id">res</span><span class="text">


          </span><span class="kw">let</span><span class="text"> </span><span class="id">compare_char</span><span class="text"> = </span><span class="kw2">Char</span><span class="text">.</span><span class="id">compare</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">natstr</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
            </span><span class="kw2">Conversions</span><span class="text">.</span><span class="id">of_native_substring</span><span class="text">
              </span><span class="kw4">~empty</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> () -&gt; </span><span class="kw1">ref</span><span class="text"> [])
              </span><span class="kw4">~on_new_character</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="id">x</span><span class="text"> := </span><span class="id">c</span><span class="text"> :: !</span><span class="id">x</span><span class="text">)
              </span><span class="kw4">~finalize</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">x</span><span class="text"> -&gt;
                  </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">of_array</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="id">c_layout</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">rev</span><span class="text"> !</span><span class="id">x</span><span class="text"> |&gt; </span><span class="kw2">Array</span><span class="text">.</span><span class="id">of_list</span><span class="text">))
              </span><span class="kw4">~read_character_from_native_string</span><span class="text">:</span><span class="kw2">Chr</span><span class="text">.</span><span class="id">read_from_native_string</span><span class="text">
              </span><span class="id">natstr</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">natstr</span><span class="text"> </span><span class="kw4">~offset</span><span class="text"> </span><span class="kw4">~length</span><span class="text"> =
            </span><span class="kw1">try</span><span class="text">
              </span><span class="kw">let</span><span class="text"> </span><span class="id">res</span><span class="text"> = </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">create</span><span class="text"> </span><span class="kw3">char</span><span class="text"> </span><span class="id">c_layout</span><span class="text"> </span><span class="id">length</span><span class="text"> </span><span class="kw">in</span><span class="text">
              </span><span class="kw1">for</span><span class="text"> </span><span class="id">i</span><span class="text"> = </span><span class="numeric">0</span><span class="text"> </span><span class="kw1">to</span><span class="text"> </span><span class="id">length</span><span class="text"> - </span><span class="numeric">1</span><span class="text"> </span><span class="kw1">do</span><span class="text">
                </span><span class="kw2">Array1</span><span class="text">.</span><span class="id">set</span><span class="text"> </span><span class="id">res</span><span class="text"> </span><span class="id">i</span><span class="text"> (</span><span class="id">natstr</span><span class="text">.[</span><span class="id">i</span><span class="text"> + </span><span class="id">offset</span><span class="text">])
              </span><span class="kw1">done</span><span class="text">;
              `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">res</span><span class="text">
            </span><span class="kw1">with</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; `</span><span class="kw2">Error</span><span class="text"> `</span><span class="id">out_of_bounds</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">of_native_string</span><span class="text"> </span><span class="id">natstr</span><span class="text"> =
            </span><span class="kw2">Conversions</span><span class="text">.</span><span class="id">of_native_string</span><span class="text"> </span><span class="id">of_native_substring</span><span class="text"> </span><span class="id">natstr</span><span class="text">

          </span><span class="kw">let</span><span class="text"> </span><span class="id">to_native_string</span><span class="text"> </span><span class="id">l</span><span class="text"> =
            </span><span class="kw2">String</span><span class="text">.</span><span class="id">init</span><span class="text"> (</span><span class="kw2">Array1</span><span class="text">.</span><span class="id">dim</span><span class="text"> </span><span class="id">l</span><span class="text">) (</span><span class="kw2">Array1</span><span class="text">.</span><span class="id">get</span><span class="text"> </span><span class="id">l</span><span class="text">)

        </span><span class="kw1">end</span><span class="text">)
  </span><span class="kw1">end</span><span class="text">);
  </span><span class="id">utf8_specific_test</span><span class="text"> ();
  </span><span class="id">say</span><span class="text"> </span><span class="string">"\n## Benchmarks\n\n"</span><span class="text">;
  </span><span class="id">say</span><span class="text"> </span><span class="string">"- `uname -a`: "</span><span class="text">;
  </span><span class="id">ignore</span><span class="text"> (</span><span class="kw2">Unix</span><span class="text">.</span><span class="id">system</span><span class="text"> </span><span class="string">"uname -a"</span><span class="text">);
  </span><span class="id">say</span><span class="text"> </span><span class="string">"- Word size: %d\n\n%s\n"</span><span class="text"> </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">word_size</span><span class="text"> (</span><span class="kw2">Benchmark</span><span class="text">.</span><span class="id">to_string</span><span class="text"> ());
  </span><span class="id">exit</span><span class="text"> !</span><span class="id">return_code</span><span class="text">
</span></pre></div></div></div></body><html>