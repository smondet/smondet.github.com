 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootswatch/3.2.0/readable/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css"><meta charset="utf-8"><title>Atd2cconv: Application Implementation</title></head><body><div class="container"><h1>Atd2cconv: Application Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul><li><a href='index.html'>Home</a></li><li><a href='main.html'>Application Implementation</a></li><li><a href='atd2cconv.html'>Library Implementation</a></li><li><a href='./api/index.html'>API Documentation</a></li><li><a href='../index.html'><code>master</code></a> branch</li><li>Repository <a href='https://github.com/smondet/atd2cconv'>at Github</a></li><li>Up: <a href='../../index.html'>Software Projects</a></li></ul></div><div class="col-md-9"><pre><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Printf</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="id">eprintf</span><span class="text"> </span><span class="string">&quot;%s\n%!&quot;</span><span class="text">) </span><span class="id">fmt</span><span class="text">)
</span><span class="kw">let</span><span class="text"> </span><span class="id">failwithf</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> </span><span class="id">failwith</span><span class="text"> </span><span class="id">fmt</span><span class="text">)

</span><span class="kw">let</span><span class="text"> () =
  </span><span class="kw">let</span><span class="text"> </span><span class="id">inherit_variants</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="constant">true</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">input</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">output</span><span class="text"> = </span><span class="kw1">ref</span><span class="text"> </span><span class="kw2">None</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">options</span><span class="text"> = </span><span class="kw2">Arg</span><span class="text">.(</span><span class="id">align</span><span class="text"> [
      </span><span class="string">&quot;-inline-inherit-variants&quot;</span><span class="text">,
      </span><span class="kw2">Bool</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt; </span><span class="id">inherit_variants</span><span class="text"> := </span><span class="id">v</span><span class="text">),
      </span><span class="string">&quot;&lt;true|false&gt; \n\tWrite inheriting variants inline (default: true)&quot;</span><span class="text">;
      </span><span class="string">&quot;-i&quot;</span><span class="text">,
      </span><span class="kw2">String</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">input</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text">),
      </span><span class="string">&quot;&lt;file&gt; \n\tInput ATD file (default: stdin)&quot;</span><span class="text">;
      </span><span class="string">&quot;-o&quot;</span><span class="text">,
      </span><span class="kw2">String</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">s</span><span class="text"> -&gt; </span><span class="id">output</span><span class="text"> := </span><span class="kw2">Some</span><span class="text"> </span><span class="id">s</span><span class="text">),
      </span><span class="string">&quot;&lt;file&gt; \n\tOutput ML file (default: stdout)&quot;</span><span class="text">;
    ]) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">annons</span><span class="text"> </span><span class="id">s</span><span class="text"> = </span><span class="id">say</span><span class="text"> </span><span class="string">&quot;Dunno what to do with %S&quot;</span><span class="text"> </span><span class="id">s</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">usage</span><span class="text"> =
    </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s [OPTIONS] [-i &lt;input.atd&gt;] [-o &lt;output.ml&gt;]&quot;</span><span class="text">
      </span><span class="kw2">Sys</span><span class="text">.</span><span class="id">argv</span><span class="text">.(</span><span class="numeric">0</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">Arg</span><span class="text">.</span><span class="id">parse</span><span class="text"> </span><span class="id">options</span><span class="text"> </span><span class="id">annons</span><span class="text"> </span><span class="id">usage</span><span class="text">;
  </span><span class="kw">let</span><span class="text"> (</span><span class="id">i</span><span class="text">, </span><span class="id">closi</span><span class="text">), (</span><span class="id">o</span><span class="text">, </span><span class="id">closo</span><span class="text">) =
    </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:(</span><span class="id">stdin</span><span class="text">, </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; ()) !</span><span class="id">input</span><span class="text"> 
      </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="id">open_in</span><span class="text"> </span><span class="id">f</span><span class="text">, </span><span class="id">close_in</span><span class="text">),
    </span><span class="kw2">Option</span><span class="text">.</span><span class="id">value_map</span><span class="text"> </span><span class="kw4">~default</span><span class="text">:(</span><span class="id">stdout</span><span class="text">, </span><span class="kw">fun</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; ()) !</span><span class="id">output</span><span class="text"> 
      </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="id">open_out</span><span class="text"> </span><span class="id">f</span><span class="text">, </span><span class="id">close_out</span><span class="text">) </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">atd</span><span class="text"> = 
    </span><span class="kw2">Atd_util</span><span class="text">.</span><span class="id">read_channel</span><span class="text"> 
      </span><span class="kw4">~inherit_fields</span><span class="text">:</span><span class="constant">true</span><span class="text">
      </span><span class="kw4">~inherit_variants</span><span class="text">:!</span><span class="id">inherit_variants</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (</span><span class="id">full_module</span><span class="text">, </span><span class="id">original_types</span><span class="text">) = </span><span class="id">atd</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (</span><span class="id">head</span><span class="text">, </span><span class="id">body</span><span class="text">) = </span><span class="id">full_module</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sorted</span><span class="text"> = </span><span class="kw2">Atd_util</span><span class="text">.</span><span class="id">tsort</span><span class="text"> </span><span class="id">body</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">doc</span><span class="text"> =
    </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">SmartPrint</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">try</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="id">sorted</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:(</span><span class="id">empty</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> (</span><span class="id">recur</span><span class="text">, </span><span class="id">mod_body</span><span class="text">) -&gt;
          </span><span class="id">prev</span><span class="text"> ^^ </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;module rec &quot;</span><span class="text">
          ^^ </span><span class="id">separate</span><span class="text"> (</span><span class="id">newline</span><span class="text"> ^^ </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;and&quot;</span><span class="text"> ^^ </span><span class="id">newline</span><span class="text">)
            (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">mod_body</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">item</span><span class="text"> -&gt;
                 </span><span class="kw1">match</span><span class="text"> </span><span class="kw2">Atd2cconv</span><span class="text">.</span><span class="id">transform_module_item</span><span class="text"> </span><span class="id">item</span><span class="text"> </span><span class="kw1">with</span><span class="text">
                 | `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">doc</span><span class="text"> -&gt; </span><span class="id">doc</span><span class="text">
                 | `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Not_implemented</span><span class="text"> </span><span class="id">msg</span><span class="text">) -&gt;
                   </span><span class="id">failwithf</span><span class="text"> </span><span class="string">&quot;Error: %S not implemented&quot;</span><span class="text"> </span><span class="id">msg</span><span class="text">)))
      ^^ </span><span class="id">newline</span><span class="text">
    </span><span class="kw1">with</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
      </span><span class="id">closi</span><span class="text"> </span><span class="id">i</span><span class="text">;
      </span><span class="id">closo</span><span class="text"> </span><span class="id">o</span><span class="text">;
      </span><span class="id">raise</span><span class="text"> </span><span class="id">e</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="kw2">SmartPrint</span><span class="text">.</span><span class="id">to_out_channel</span><span class="text"> </span><span class="numeric">78</span><span class="text"> </span><span class="numeric">2</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="id">doc</span><span class="text">;
  </span><span class="id">output_string</span><span class="text"> </span><span class="id">o</span><span class="text"> </span><span class="string">&quot;\n\n&quot;</span><span class="text">;
  </span><span class="id">closi</span><span class="text"> </span><span class="id">i</span><span class="text">;
  </span><span class="id">closo</span><span class="text"> </span><span class="id">o</span><span class="text">;
  ()



</span></pre></div></div></div></body><html>