 <!DOCTYPE html> <html> <head><link rel="stylesheet" href="https://cdn.rawgit.com/hammerlab/ketrew/2d1c430cca52caa71e363a765ff8775a6ae14ba9/src/doc/code_style.css" type="text/css">
<link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="http://cdn.jsdelivr.net/bootstrap/3.1.1/css/bootstrap-theme.min.css" type="text/css"><meta charset="utf-8"><title>Atd2cconv: Library Implementation</title></head><body><div class="container"><h1>Atd2cconv: Library Implementation</h1><div class="row">
<div class="col-md-3">
<h2>Contents</h2><h2>Menu</h2><ul>
 <li><a href='index.html'>Home</a></li>
 <li><a href='main.html'>Application Implementation</a></li>
 <li><a href='atd2cconv.html'>Library Implementation</a></li>
 <li><a href='./api/index.html'>API Documentation</a></li>
 <li>Repository <a href='https://github.com/smondet/atd2cconv'>at Github</a></li>
 <li>Up: <a href='../index.html'>Software Projects</a></li>
</ul>
</div><div class="col-md-9"><pre><span class="kw">open</span><span class="text"> </span><span class="kw2">Nonstd</span><span class="text">
</span><span class="kw">open</span><span class="text"> </span><span class="kw2">Printf</span><span class="text">

</span><span class="kw">module</span><span class="text"> </span><span class="kw2">Out</span><span class="text"> = </span><span class="kw1">struct</span><span class="text">
  </span><span class="kw">include</span><span class="text"> </span><span class="kw2">SmartPrint</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">fmt</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="kw2">Printf</span><span class="text">.</span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw3">string</span><span class="text">) </span><span class="id">fmt</span><span class="text">
  </span><span class="kw">let</span><span class="text"> (%) = (^-^)
  </span><span class="kw">let</span><span class="text"> (%%) </span><span class="id">a</span><span class="text"> </span><span class="id">b</span><span class="text"> = </span><span class="id">a</span><span class="text"> % </span><span class="id">space</span><span class="text"> % </span><span class="id">b</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">comment</span><span class="text"> </span><span class="id">c</span><span class="text"> = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;(*&quot;</span><span class="text"> %% </span><span class="id">c</span><span class="text"> %% </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;*)&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">commentf</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;(* &quot;</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="id">c</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot; *)&quot;</span><span class="text">) </span><span class="id">fmt</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">cmtf</span><span class="text"> </span><span class="id">fmt</span><span class="text"> =
    </span><span class="id">ksprintf</span><span class="text"> (</span><span class="kw">fun</span><span class="text"> </span><span class="id">c</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;(* &quot;</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="id">c</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot; *)&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text">) </span><span class="id">fmt</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">comma</span><span class="text"> = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;,&quot;</span><span class="text"> % </span><span class="id">space</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">apply_1</span><span class="text"> </span><span class="id">funname</span><span class="text"> </span><span class="id">sub</span><span class="text"> = </span><span class="id">parens</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="id">funname</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> (</span><span class="id">sub</span><span class="text">))
  </span><span class="kw">let</span><span class="text"> </span><span class="id">arrow</span><span class="text">  = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;-&gt;&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">pipe</span><span class="text">   = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;|&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">colon</span><span class="text">  = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;:&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">equals</span><span class="text"> = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;=&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">unit_value</span><span class="text"> = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;()&quot;</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="id">sharp</span><span class="text"> = </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;#&quot;</span><span class="text">
</span><span class="kw1">end</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">say</span><span class="text"> </span><span class="id">fmt</span><span class="text"> = </span><span class="kw2">Printf</span><span class="text">.(</span><span class="id">ksprintf</span><span class="text"> (</span><span class="id">eprintf</span><span class="text"> </span><span class="string">&quot;%s\n%!&quot;</span><span class="text">) </span><span class="id">fmt</span><span class="text">)


</span><span class="kw">let</span><span class="text"> </span><span class="id">atom</span><span class="text"> ?(</span><span class="id">t</span><span class="text">=</span><span class="kw2">Out</span><span class="text">.</span><span class="id">empty</span><span class="text">) ?(</span><span class="id">source</span><span class="text">=</span><span class="kw2">Out</span><span class="text">.</span><span class="id">empty</span><span class="text">) ?(</span><span class="id">sink</span><span class="text">=</span><span class="kw2">Out</span><span class="text">.</span><span class="id">empty</span><span class="text">) () =
  `</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">T</span><span class="text"> </span><span class="id">t</span><span class="text">, `</span><span class="kw2">Source</span><span class="text"> </span><span class="id">source</span><span class="text">, `</span><span class="kw2">Sink</span><span class="text"> </span><span class="id">sink</span><span class="text">)

</span><span class="kw">let</span><span class="text"> (&gt;&gt;=) </span><span class="id">t</span><span class="text"> </span><span class="id">f</span><span class="text"> =
  </span><span class="kw1">match</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw1">with</span><span class="text">
  | `</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">T</span><span class="text"> </span><span class="id">t</span><span class="text">, `</span><span class="kw2">Source</span><span class="text"> </span><span class="id">source</span><span class="text">, `</span><span class="kw2">Sink</span><span class="text"> </span><span class="id">sink</span><span class="text">) -&gt; </span><span class="id">f</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">
  | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text">


</span><span class="kw">let</span><span class="text"> </span><span class="id">empty_atom</span><span class="text"> = </span><span class="id">atom</span><span class="text"> ()

</span><span class="kw">let</span><span class="text"> </span><span class="id">not_implemented</span><span class="text"> </span><span class="id">msg</span><span class="text"> =
  `</span><span class="kw2">Error</span><span class="text"> (`</span><span class="kw2">Not_implemented</span><span class="text"> </span><span class="id">msg</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="id">transform_expr</span><span class="text"> </span><span class="kw4">~self_name</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="id">expr</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Out</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">go_deep</span><span class="text"> = </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Sum</span><span class="text"> (</span><span class="id">loc</span><span class="text">, </span><span class="id">variants</span><span class="text">, </span><span class="id">ann</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">backtick</span><span class="text"> </span><span class="id">n</span><span class="text"> = </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;`%s&quot;</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">variant_case</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="id">expr</span><span class="text"> =
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">expr</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="kw2">Some</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt;
        </span><span class="id">e</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">pipe</span><span class="text"> %% </span><span class="id">backtick</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;of&quot;</span><span class="text"> %% </span><span class="id">t</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> =
          </span><span class="id">pipe</span><span class="text"> %% </span><span class="id">backtick</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;elt&quot;</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> (
            </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">comma</span><span class="text"> 
            % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;hcons&quot;</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> </span><span class="id">source</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;elt @@ hnil&quot;</span><span class="text">
          ) % </span><span class="id">newline</span><span class="text">
        </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
          </span><span class="id">pipe</span><span class="text"> %% </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> %% 
          </span><span class="id">sink</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;|+|&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;elt&quot;</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> 
          %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;yield&quot;</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> (</span><span class="id">backtick</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;elt&quot;</span><span class="text">) % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> ()
      | </span><span class="kw2">None</span><span class="text"> -&gt;
        </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">pipe</span><span class="text"> %% </span><span class="id">backtick</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> = </span><span class="id">pipe</span><span class="text"> %% </span><span class="id">backtick</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">arrow</span><span class="text">
                     %% </span><span class="id">parens</span><span class="text"> (</span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">comma</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;hnil&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
        </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
          </span><span class="id">pipe</span><span class="text"> %% </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;yield&quot;</span><span class="text"> %% </span><span class="id">backtick</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> () </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">unused_name</span><span class="text"> () =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">names</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">filter_map</span><span class="text"> </span><span class="id">variants</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
        | `</span><span class="kw2">Variant</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, (</span><span class="id">n</span><span class="text">, </span><span class="numeric">_</span><span class="text">), </span><span class="numeric">_</span><span class="text">) -&gt; </span><span class="kw2">Some</span><span class="text"> </span><span class="id">n</span><span class="text">
        | `</span><span class="kw2">Inherit</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="kw">rec</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="id">t</span><span class="text"> =
        </span><span class="kw1">if</span><span class="text"> </span><span class="kw2">List</span><span class="text">.</span><span class="id">mem</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw4">~set</span><span class="text">:</span><span class="id">names</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">n</span><span class="text"> (</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;%s%s&quot;</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw1">else</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">n</span><span class="text"> </span><span class="string">&quot;I&quot;</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="id">empty_atom</span><span class="text"> </span><span class="id">variants</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">v</span><span class="text"> -&gt;
        </span><span class="id">prev</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t1</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o1</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i1</span><span class="text">  -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">v</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Variant</span><span class="text"> (</span><span class="id">loc</span><span class="text">, (</span><span class="id">name</span><span class="text">, </span><span class="id">ann</span><span class="text">), </span><span class="id">expr_opt</span><span class="text">) -&gt;
          </span><span class="id">variant_case</span><span class="text"> </span><span class="id">name</span><span class="text"> </span><span class="kw2">Option</span><span class="text">.(</span><span class="id">map</span><span class="text"> </span><span class="id">expr_opt</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="id">go_deep</span><span class="text">)
          &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
          </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">t1</span><span class="text"> % </span><span class="id">t</span><span class="text">) </span><span class="kw4">~source</span><span class="text">:(</span><span class="id">o1</span><span class="text"> % </span><span class="id">source</span><span class="text">) </span><span class="kw4">~sink</span><span class="text">:(</span><span class="id">i1</span><span class="text"> % </span><span class="id">sink</span><span class="text">) ()
        | `</span><span class="kw2">Inherit</span><span class="text"> (</span><span class="id">loc</span><span class="text">, </span><span class="id">expr</span><span class="text">) -&gt;
            </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> -&gt;
            </span><span class="kw">let</span><span class="text"> </span><span class="id">newt</span><span class="text"> = </span><span class="id">t1</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;| &quot;</span><span class="text"> % </span><span class="id">t</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">name</span><span class="text"> = </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> (</span><span class="id">unused_name</span><span class="text"> ()) </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> =
              </span><span class="id">o1</span><span class="text"> % </span><span class="id">pipe</span><span class="text"> %% </span><span class="id">sharp</span><span class="text"> % </span><span class="id">t</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; as inher&quot;</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> 
              %% </span><span class="id">name</span><span class="text"> % </span><span class="id">comma</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;hcons&quot;</span><span class="text"> 
              %% </span><span class="id">parens</span><span class="text"> </span><span class="id">source</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;inher @@ hnil&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
              </span><span class="id">i1</span><span class="text"> % </span><span class="id">pipe</span><span class="text"> %% </span><span class="id">name</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> </span><span class="id">sink</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;|+|&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun&quot;</span><span class="text"> 
              %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;inher&quot;</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;yield&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;(inher :&gt; t_alias)&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
            </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">newt</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> ())
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">brakets</span><span class="text"> (</span><span class="id">newline</span><span class="text"> % </span><span class="id">indent</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sum_fix</span><span class="text"> </span><span class="id">inside</span><span class="text"> =
      </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;sum_fix&quot;</span><span class="text"> % </span><span class="id">parens</span><span class="text"> (</span><span class="id">indent</span><span class="text"> (
        </span><span class="id">newline</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun t&quot;</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;function&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text">
        % </span><span class="id">inside</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> =  </span><span class="id">sum_fix</span><span class="text"> </span><span class="id">source</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> = 
      </span><span class="id">sum_fix</span><span class="text"> (</span><span class="id">sink</span><span class="text">
               % </span><span class="id">pipe</span><span class="text"> %% </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;other&quot;</span><span class="text"> %% </span><span class="id">arrow</span><span class="text">
               %% </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;CConv.report_error&quot;</span><span class="text">
               %% </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;unexpected variant name: %S&quot;</span><span class="text"> %% </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;other&quot;</span><span class="text">) </span><span class="kw">in</span><span class="text">
    </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> ()
  | `</span><span class="kw2">Tvar</span><span class="text"> (</span><span class="id">loc</span><span class="text">, </span><span class="id">var_name</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;'%s&quot;</span><span class="text"> </span><span class="id">var_name</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> = </span><span class="kw3">string</span><span class="text"> </span><span class="id">var_name</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =  </span><span class="kw3">string</span><span class="text"> </span><span class="id">var_name</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> ()
  | `</span><span class="kw2">Name</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, (</span><span class="id">loc</span><span class="text">, </span><span class="id">t_name</span><span class="text">, </span><span class="id">t_args</span><span class="text">), </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">with_mod_name</span><span class="text"> </span><span class="id">kind</span><span class="text"> </span><span class="id">v</span><span class="text"> </span><span class="id">inside</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">ret3strings</span><span class="text"> </span><span class="id">t</span><span class="text"> </span><span class="id">source</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">kind</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">T</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> </span><span class="id">t</span><span class="text">
        | `</span><span class="kw2">Source</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> </span><span class="id">source</span><span class="text">
        | `</span><span class="kw2">Sink</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> </span><span class="id">sink</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">same</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">t</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">call_module</span><span class="text"> </span><span class="id">f</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">kind</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">T</span><span class="text"> -&gt; </span><span class="kw3">string</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">capitalize</span><span class="text"> </span><span class="id">f</span><span class="text">) % </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;.&quot;</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="id">v</span><span class="text">
        | `</span><span class="kw2">Source</span><span class="text"> | `</span><span class="kw2">Sink</span><span class="text"> -&gt;
          </span><span class="kw3">string</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">capitalize</span><span class="text"> </span><span class="id">f</span><span class="text">) % </span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;.&quot;</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="id">v</span><span class="text"> %% </span><span class="id">inside</span><span class="text">
          %% </span><span class="id">unit_value</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">t_name</span><span class="text">, </span><span class="id">from</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="string">&quot;int&quot;</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">ret3strings</span><span class="text"> </span><span class="string">&quot;int&quot;</span><span class="text"> </span><span class="string">&quot;int_&quot;</span><span class="text"> </span><span class="string">&quot;int_&quot;</span><span class="text">
      | </span><span class="string">&quot;float&quot;</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">ret3strings</span><span class="text"> </span><span class="string">&quot;float&quot;</span><span class="text"> </span><span class="string">&quot;float_&quot;</span><span class="text"> </span><span class="string">&quot;float_&quot;</span><span class="text">
      | </span><span class="string">&quot;string&quot;</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">ret3strings</span><span class="text"> </span><span class="string">&quot;string&quot;</span><span class="text"> </span><span class="string">&quot;string_&quot;</span><span class="text"> </span><span class="string">&quot;string_&quot;</span><span class="text">
      | </span><span class="string">&quot;list&quot;</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">ret3strings</span><span class="text"> </span><span class="string">&quot;list&quot;</span><span class="text"> </span><span class="string">&quot;list_&quot;</span><span class="text"> </span><span class="string">&quot;list_&quot;</span><span class="text">
      | </span><span class="string">&quot;abstract&quot;</span><span class="text">, </span><span class="kw2">Some</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt; </span><span class="id">call_module</span><span class="text"> </span><span class="id">f</span><span class="text">
      | </span><span class="id">other</span><span class="text">, </span><span class="numeric">_</span><span class="text"> </span><span class="kw1">when</span><span class="text"> </span><span class="id">other</span><span class="text"> = </span><span class="id">self_name</span><span class="text"> -&gt;
        </span><span class="comment">(* if `t` appears as a recursive sink/source, 
           it should not be applied to ()  *)</span><span class="text">
        </span><span class="id">same</span><span class="text"> (</span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;t&quot;</span><span class="text"> %% </span><span class="id">inside</span><span class="text">)
      | </span><span class="id">other</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">call_module</span><span class="text"> </span><span class="id">other</span><span class="text">
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">t_args</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | [] -&gt; </span><span class="id">empty_atom</span><span class="text">
    | </span><span class="id">one</span><span class="text"> :: </span><span class="id">more</span><span class="text"> -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">init</span><span class="text"> = </span><span class="id">go_deep</span><span class="text"> </span><span class="id">one</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="id">more</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">arg_expr</span><span class="text"> -&gt;
          </span><span class="id">prev</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t1</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o1</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i1</span><span class="text">  -&gt;
          </span><span class="id">go_deep</span><span class="text"> </span><span class="id">arg_expr</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t2</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o2</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i2</span><span class="text">  -&gt;
          </span><span class="id">atom</span><span class="text"> ()
            </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">t1</span><span class="text"> % </span><span class="id">comma</span><span class="text"> % </span><span class="id">t2</span><span class="text">)
            </span><span class="kw4">~source</span><span class="text">:(</span><span class="id">o1</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> </span><span class="id">o2</span><span class="text">)
            </span><span class="kw4">~sink</span><span class="text">:(</span><span class="id">i1</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> </span><span class="id">i2</span><span class="text">))
    </span><span class="kw1">end</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> =
      (</span><span class="kw1">if</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">empty</span><span class="text"> </span><span class="kw1">then</span><span class="text"> </span><span class="id">empty</span><span class="text"> </span><span class="kw1">else</span><span class="text"> (</span><span class="id">parens</span><span class="text"> </span><span class="id">t</span><span class="text"> % </span><span class="id">space</span><span class="text">))
      % </span><span class="id">with_mod_name</span><span class="text"> `</span><span class="kw2">T</span><span class="text"> </span><span class="string">&quot;t&quot;</span><span class="text"> </span><span class="id">empty</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> = </span><span class="id">with_mod_name</span><span class="text"> `</span><span class="kw2">Source</span><span class="text"> </span><span class="string">&quot;source&quot;</span><span class="text"> </span><span class="id">source</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> = </span><span class="id">with_mod_name</span><span class="text"> `</span><span class="kw2">Sink</span><span class="text"> </span><span class="string">&quot;sink&quot;</span><span class="text"> </span><span class="id">sink</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text"> ()
  | `</span><span class="kw2">Tuple</span><span class="text"> (</span><span class="id">loc</span><span class="text">, [], </span><span class="id">annot</span><span class="text">) -&gt; </span><span class="id">not_implemented</span><span class="text"> </span><span class="string">&quot;Empty Tuple&quot;</span><span class="text">
  | `</span><span class="kw2">Tuple</span><span class="text"> (</span><span class="id">loc</span><span class="text">, </span><span class="id">cell</span><span class="text"> :: </span><span class="id">cell_list</span><span class="text">, </span><span class="id">annot</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) = </span><span class="id">cell</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">hconsify</span><span class="text"> </span><span class="id">inside</span><span class="text"> </span><span class="id">index</span><span class="text"> =
      </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;hcons&quot;</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> </span><span class="id">inside</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;e%d&quot;</span><span class="text"> </span><span class="id">index</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sink_plus</span><span class="text"> </span><span class="id">sink</span><span class="text"> </span><span class="id">index</span><span class="text"> =
      </span><span class="id">parens</span><span class="text"> </span><span class="id">sink</span><span class="text">  %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;|+|&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun&quot;</span><span class="text"> % </span><span class="id">space</span><span class="text"> 
      % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;e%d&quot;</span><span class="text"> </span><span class="id">index</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;-&gt;&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">init</span><span class="text"> = 
      </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> = </span><span class="id">sink_plus</span><span class="text"> </span><span class="id">sink</span><span class="text"> </span><span class="numeric">0</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="id">atom</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:(</span><span class="id">hconsify</span><span class="text"> </span><span class="id">source</span><span class="text"> </span><span class="numeric">0</span><span class="text">) </span><span class="kw4">~sink</span><span class="text"> ()
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">foldi</span><span class="text"> </span><span class="kw4">~init</span><span class="text"> </span><span class="id">cell_list</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">index</span><span class="text"> </span><span class="id">prev</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
        </span><span class="id">prev</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t1</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o1</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i1</span><span class="text">  -&gt;
        </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t2</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o2</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i2</span><span class="text"> -&gt;
        </span><span class="id">atom</span><span class="text"> ()
          </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">t1</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; *&quot;</span><span class="text"> %% </span><span class="id">t2</span><span class="text">)
          </span><span class="kw4">~source</span><span class="text">:(</span><span class="id">o1</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; @@ &quot;</span><span class="text"> % </span><span class="id">hconsify</span><span class="text"> </span><span class="id">o2</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">))
          </span><span class="kw4">~sink</span><span class="text">:(</span><span class="id">i1</span><span class="text"> % </span><span class="id">sink_plus</span><span class="text"> </span><span class="id">i2</span><span class="text"> (</span><span class="id">index</span><span class="text"> + </span><span class="numeric">1</span><span class="text">)))
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">tuple_expanded</span><span class="text"> =
      </span><span class="id">parens</span><span class="text"> (
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">mapi</span><span class="text"> (</span><span class="id">cell</span><span class="text"> :: </span><span class="id">cell_list</span><span class="text">) </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">i</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;e%d&quot;</span><span class="text"> </span><span class="id">i</span><span class="text">) 
        |&gt; </span><span class="id">separate</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;, &quot;</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> = 
      </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;tuple &quot;</span><span class="text"> % </span><span class="id">parens</span><span class="text"> (
        </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun &quot;</span><span class="text"> % </span><span class="id">tuple_expanded</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; -&gt; &quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text">
        % </span><span class="id">indent</span><span class="text"> (</span><span class="id">parens</span><span class="text"> (</span><span class="id">source</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; hnil&quot;</span><span class="text">)))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
      </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;tuple&quot;</span><span class="text"> %% </span><span class="id">parens</span><span class="text"> (
        </span><span class="id">indent</span><span class="text"> (
          </span><span class="id">newline</span><span class="text"> % </span><span class="id">sink</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;yield&quot;</span><span class="text"> %% </span><span class="id">tuple_expanded</span><span class="text">)) </span><span class="kw">in</span><span class="text">
    </span><span class="id">atom</span><span class="text"> () </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">parens</span><span class="text"> </span><span class="id">t</span><span class="text">) </span><span class="kw4">~source</span><span class="text">  </span><span class="kw4">~sink</span><span class="text">
  | `</span><span class="kw2">List</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
    </span><span class="id">atom</span><span class="text"> ()
      </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">t</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; list&quot;</span><span class="text">)
      </span><span class="kw4">~source</span><span class="text">:(</span><span class="id">apply_1</span><span class="text"> </span><span class="string">&quot;list_&quot;</span><span class="text"> </span><span class="id">source</span><span class="text">)
      </span><span class="kw4">~sink</span><span class="text">:(</span><span class="id">apply_1</span><span class="text"> </span><span class="string">&quot;list_&quot;</span><span class="text"> </span><span class="id">sink</span><span class="text">)
  | `</span><span class="kw2">Option</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text">
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
    </span><span class="id">atom</span><span class="text"> ()
      </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">t</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; option&quot;</span><span class="text">)
      </span><span class="kw4">~source</span><span class="text">:(</span><span class="id">apply_1</span><span class="text"> </span><span class="string">&quot;opt&quot;</span><span class="text"> </span><span class="id">source</span><span class="text">)
      </span><span class="kw4">~sink</span><span class="text">:(</span><span class="id">apply_1</span><span class="text"> </span><span class="string">&quot;opt&quot;</span><span class="text"> </span><span class="id">sink</span><span class="text">)
  | `</span><span class="kw2">Record</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">field_list</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="kw2">List</span><span class="text">.</span><span class="id">fold</span><span class="text"> </span><span class="kw4">~init</span><span class="text">:</span><span class="id">empty_atom</span><span class="text"> </span><span class="id">field_list</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">prev</span><span class="text"> </span><span class="id">f</span><span class="text"> -&gt;
        </span><span class="id">prev</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t1</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o1</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i1</span><span class="text">  -&gt;
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">f</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | `</span><span class="kw2">Field</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, (</span><span class="id">name</span><span class="text">, </span><span class="id">kind</span><span class="text">, </span><span class="numeric">_</span><span class="text">), </span><span class="id">expr</span><span class="text">) -&gt;
          </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text"> &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text">:</span><span class="id">t2</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">o2</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">:</span><span class="id">i2</span><span class="text">  -&gt;
          </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> = </span><span class="id">t1</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;%s: &quot;</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">indent</span><span class="text"> (</span><span class="id">t2</span><span class="text">) % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;;&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> =
            </span><span class="id">o1</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;field &quot;</span><span class="text"> % </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">space</span><span class="text">
            % </span><span class="id">parens</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun p -&gt; p.&quot;</span><span class="text"> % </span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text">) % </span><span class="id">space</span><span class="text"> 
            % </span><span class="id">parens</span><span class="text"> </span><span class="id">o2</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; @@ &quot;</span><span class="text">
            % </span><span class="id">newline</span><span class="text">
          </span><span class="kw">in</span><span class="text">
          </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
            </span><span class="id">i1</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;field&quot;</span><span class="text"> %% </span><span class="kw2">OCaml</span><span class="text">.</span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> % </span><span class="id">space</span><span class="text">
            % </span><span class="id">parens</span><span class="text"> </span><span class="id">i2</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;@@&quot;</span><span class="text"> % </span><span class="id">space</span><span class="text">
            % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun&quot;</span><span class="text"> %% </span><span class="kw3">string</span><span class="text"> </span><span class="id">name</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;-&gt;&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
          </span><span class="id">atom</span><span class="text"> () </span><span class="kw4">~t</span><span class="text">
            </span><span class="kw4">~source</span><span class="text">
            </span><span class="kw4">~sink</span><span class="text">
        | `</span><span class="kw2">Inherit</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">) -&gt; </span><span class="id">not_implemented</span><span class="text"> </span><span class="string">&quot;Inherit record fields&quot;</span><span class="text">)
    &gt;&gt;= </span><span class="kw">fun</span><span class="text"> </span><span class="kw4">~t</span><span class="text"> </span><span class="kw4">~source</span><span class="text">:</span><span class="id">source_inside</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">  -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">source</span><span class="text"> =
      </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;record_fix&quot;</span><span class="text"> %% </span><span class="id">indent</span><span class="text"> 
        (</span><span class="id">parens</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun t -&gt;&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text"> % </span><span class="id">source_inside</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;record_stop&quot;</span><span class="text">))
    </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">sink</span><span class="text"> =
      </span><span class="kw">let</span><span class="text"> </span><span class="id">names</span><span class="text"> = </span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">field_list</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
        | `</span><span class="kw2">Field</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, (</span><span class="id">name</span><span class="text">, </span><span class="id">kind</span><span class="text">, </span><span class="numeric">_</span><span class="text">), </span><span class="id">expr</span><span class="text">) -&gt; </span><span class="id">name</span><span class="text">
        | `</span><span class="kw2">Inherit</span><span class="text"> </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="comment">(* should have failed earlier *)</span><span class="text"> </span><span class="kw1">assert</span><span class="text"> </span><span class="constant">false</span><span class="text">) </span><span class="kw">in</span><span class="text">
      </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;record_fix&quot;</span><span class="text"> %% </span><span class="id">indent</span><span class="text"> 
        (</span><span class="id">parens</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun t -&gt;&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text"> % </span><span class="id">sink</span><span class="text"> 
                 % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;yield_record&quot;</span><span class="text">
                 %% </span><span class="id">braces</span><span class="text"> (</span><span class="id">separate</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;; &quot;</span><span class="text">) (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">names</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:</span><span class="kw3">string</span><span class="text">))))
    </span><span class="kw">in</span><span class="text">
    </span><span class="id">atom</span><span class="text"> ()
      </span><span class="kw4">~t</span><span class="text">:(</span><span class="id">braces</span><span class="text"> (</span><span class="id">newline</span><span class="text"> % </span><span class="id">t</span><span class="text"> |&gt; </span><span class="id">indent</span><span class="text">))
      </span><span class="kw4">~source</span><span class="text"> </span><span class="kw4">~sink</span><span class="text">
  | `</span><span class="kw2">Nullable</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="id">not_implemented</span><span class="text"> </span><span class="string">&quot;Nullable&quot;</span><span class="text">
  | `</span><span class="kw2">Shared</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="id">not_implemented</span><span class="text"> </span><span class="string">&quot;Shared&quot;</span><span class="text">
  | `</span><span class="kw2">Wrap</span><span class="text"> (</span><span class="numeric">_</span><span class="text">, </span><span class="id">expr</span><span class="text">, </span><span class="numeric">_</span><span class="text">) -&gt;
    </span><span class="id">not_implemented</span><span class="text"> </span><span class="string">&quot;Wrap&quot;</span><span class="text">
  </span><span class="kw">in</span><span class="text">
  </span><span class="id">go_deep</span><span class="text"> </span><span class="id">expr</span><span class="text">

</span><span class="kw">let</span><span class="text"> </span><span class="id">get_from_annotation</span><span class="text"> </span><span class="id">ann</span><span class="text"> =
  </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">ann</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> (</span><span class="id">section</span><span class="text">, (</span><span class="id">loc</span><span class="text">, </span><span class="id">fields</span><span class="text">)) -&gt;
      </span><span class="kw1">match</span><span class="text"> </span><span class="id">section</span><span class="text"> </span><span class="kw1">with</span><span class="text">
      | </span><span class="string">&quot;ocaml&quot;</span><span class="text"> -&gt;
        </span><span class="kw2">List</span><span class="text">.</span><span class="id">find_map</span><span class="text"> </span><span class="id">fields</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">function</span><span class="text">
          | </span><span class="string">&quot;from&quot;</span><span class="text">, (</span><span class="id">loc</span><span class="text">, </span><span class="id">val_opt</span><span class="text">) -&gt; </span><span class="id">val_opt</span><span class="text">
          | </span><span class="id">other</span><span class="text">, </span><span class="numeric">_</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)
      | </span><span class="id">other</span><span class="text"> -&gt; </span><span class="kw2">None</span><span class="text">)

</span><span class="kw">let</span><span class="text"> </span><span class="id">transform_module_item</span><span class="text"> =
  </span><span class="kw">let</span><span class="text"> </span><span class="kw">open</span><span class="text"> </span><span class="kw2">Out</span><span class="text"> </span><span class="kw">in</span><span class="text">
  </span><span class="kw">function</span><span class="text">
  | `</span><span class="kw2">Type</span><span class="text"> (</span><span class="id">loc</span><span class="text">, (</span><span class="id">name</span><span class="text">, </span><span class="id">param</span><span class="text">, </span><span class="id">ann</span><span class="text">), </span><span class="id">expr</span><span class="text">) -&gt;
    </span><span class="kw">let</span><span class="text"> </span><span class="id">from</span><span class="text"> = </span><span class="id">get_from_annotation</span><span class="text"> </span><span class="id">ann</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw">let</span><span class="text"> </span><span class="id">self_name</span><span class="text"> = </span><span class="id">name</span><span class="text"> </span><span class="kw">in</span><span class="text">
    </span><span class="kw1">begin</span><span class="text"> </span><span class="kw1">match</span><span class="text"> </span><span class="id">transform_expr</span><span class="text"> ?</span><span class="id">from</span><span class="text"> </span><span class="kw4">~self_name</span><span class="text"> </span><span class="id">expr</span><span class="text"> </span><span class="kw1">with</span><span class="text">
    | `</span><span class="kw2">Ok</span><span class="text"> (`</span><span class="kw2">T</span><span class="text"> </span><span class="id">t</span><span class="text">, `</span><span class="kw2">Source</span><span class="text"> </span><span class="id">source</span><span class="text">, `</span><span class="kw2">Sink</span><span class="text"> </span><span class="id">sink</span><span class="text">) -&gt;
      </span><span class="kw">let</span><span class="text"> </span><span class="id">type_parameters</span><span class="text"> =
        </span><span class="kw1">match</span><span class="text"> </span><span class="id">param</span><span class="text"> </span><span class="kw1">with</span><span class="text">
        | [] -&gt; </span><span class="string">&quot;&quot;</span><span class="text">
        | </span><span class="id">more</span><span class="text"> -&gt;
          </span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;(%s)&quot;</span><span class="text">
            (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">param</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="id">sprintf</span><span class="text"> </span><span class="string">&quot;'%s&quot;</span><span class="text">) |&gt; </span><span class="kw2">String</span><span class="text">.</span><span class="id">concat</span><span class="text"> </span><span class="string">&quot;, &quot;</span><span class="text">)
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">function_type</span><span class="text"> </span><span class="id">modname</span><span class="text"> =
        </span><span class="id">separate</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot; -&gt; &quot;</span><span class="text">)
          (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">param</span><span class="text"> </span><span class="kw4">~f</span><span class="text">:(</span><span class="kw">fun</span><span class="text"> </span><span class="id">n</span><span class="text"> -&gt; </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;'%s CConv.%s.t&quot;</span><span class="text"> </span><span class="id">n</span><span class="text"> </span><span class="id">modname</span><span class="text">)
           @ [</span><span class="kw3">string</span><span class="text"> </span><span class="string">&quot;unit&quot;</span><span class="text">])
        %% </span><span class="id">arrow</span><span class="text"> %% </span><span class="kw3">string</span><span class="text"> </span><span class="id">type_parameters</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;t CConv.%s.t&quot;</span><span class="text"> </span><span class="id">modname</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">fun_definition</span><span class="text"> =
        </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;fun&quot;</span><span class="text"> %% </span><span class="id">separate</span><span class="text"> </span><span class="id">space</span><span class="text"> (</span><span class="kw2">List</span><span class="text">.</span><span class="id">map</span><span class="text"> </span><span class="id">param</span><span class="text"> (</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;%s&quot;</span><span class="text">))
        %% </span><span class="id">unit_value</span><span class="text"> %% </span><span class="id">arrow</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">t_sink_source</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="id">inside</span><span class="text"> =
        </span><span class="kw">let</span><span class="text"> </span><span class="id">modname</span><span class="text"> = </span><span class="kw2">String</span><span class="text">.</span><span class="id">capitalize</span><span class="text"> </span><span class="id">what</span><span class="text"> </span><span class="kw">in</span><span class="text">
        </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;let %s :&quot;</span><span class="text"> </span><span class="id">what</span><span class="text"> %% </span><span class="id">function_type</span><span class="text"> </span><span class="id">modname</span><span class="text"> %% </span><span class="id">equals</span><span class="text"> % </span><span class="id">newline</span><span class="text">
        % </span><span class="id">indent</span><span class="text"> (</span><span class="id">fun_definition</span><span class="text"> % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;CConv.%s.&quot;</span><span class="text"> </span><span class="id">modname</span><span class="text"> % </span><span class="id">parens</span><span class="text"> </span><span class="id">inside</span><span class="text">)
        % </span><span class="id">newline</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">signature</span><span class="text"> =
        </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;sig&quot;</span><span class="text"> %% </span><span class="id">indent</span><span class="text"> (
          </span><span class="id">newline</span><span class="text"> 
          % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;type&quot;</span><span class="text"> %% </span><span class="kw3">string</span><span class="text"> </span><span class="id">type_parameters</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;t&quot;</span><span class="text"> %% </span><span class="id">equals</span><span class="text"> %% </span><span class="id">t</span><span class="text"> % </span><span class="id">newline</span><span class="text">
          % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;val&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;source&quot;</span><span class="text"> %% </span><span class="id">colon</span><span class="text"> %% </span><span class="id">function_type</span><span class="text"> </span><span class="string">&quot;Source&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text">
          % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;val&quot;</span><span class="text"> %% </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;sink&quot;</span><span class="text"> %% </span><span class="id">colon</span><span class="text"> %% </span><span class="id">function_type</span><span class="text"> </span><span class="string">&quot;Sink&quot;</span><span class="text"> % </span><span class="id">newline</span><span class="text">
          % </span><span class="id">newline</span><span class="text">
        ) 
        % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;end&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">structure</span><span class="text"> =
        </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;struct&quot;</span><span class="text"> %% </span><span class="id">indent</span><span class="text"> (
          </span><span class="id">newline</span><span class="text"> 
          % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;type %s t = &quot;</span><span class="text"> </span><span class="id">type_parameters</span><span class="text"> % </span><span class="id">t</span><span class="text"> % </span><span class="id">newline</span><span class="text">
          % </span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;type %s t_alias = %s t&quot;</span><span class="text"> </span><span class="id">type_parameters</span><span class="text"> </span><span class="id">type_parameters</span><span class="text"> % </span><span class="id">newline</span><span class="text">
          % </span><span class="id">t_sink_source</span><span class="text"> </span><span class="string">&quot;source&quot;</span><span class="text"> </span><span class="id">source</span><span class="text">
          % </span><span class="id">t_sink_source</span><span class="text"> </span><span class="string">&quot;sink&quot;</span><span class="text"> </span><span class="id">sink</span><span class="text">
          % </span><span class="id">newline</span><span class="text">
        ) %</span><span class="id">fmt</span><span class="text"> </span><span class="string">&quot;end&quot;</span><span class="text"> </span><span class="kw">in</span><span class="text">
      </span><span class="kw">let</span><span class="text"> </span><span class="id">t</span><span class="text"> =
        </span><span class="kw3">string</span><span class="text"> (</span><span class="kw2">String</span><span class="text">.</span><span class="id">capitalize</span><span class="text"> </span><span class="id">name</span><span class="text">)
        %% </span><span class="id">colon</span><span class="text"> %% </span><span class="id">signature</span><span class="text"> %% </span><span class="id">equals</span><span class="text"> %% </span><span class="id">structure</span><span class="text">
      </span><span class="kw">in</span><span class="text">
      `</span><span class="kw2">Ok</span><span class="text"> </span><span class="id">t</span><span class="text">
    | `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text"> -&gt; `</span><span class="kw2">Error</span><span class="text"> </span><span class="id">e</span><span class="text">
    </span><span class="kw1">end</span><span class="text">



</span></pre></div></div></div></body><html>